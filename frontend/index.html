<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Virtual ATA - I.E. 80002 Antonio Torres Araujo</title>
    <link rel="icon" type="image/x-icon" href="./assets/images/INSIGNIA_I.E.ANTONIO_TORRES_ARAUJO.ico">
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 para modales bonitos -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* Variables CSS con colores institucionales ATA */
        :root {
            --color-ata-verde: #006B3F;
            --color-ata-verde-claro: #4CAF50;
            --color-ata-rojo: #C1272D;
            --color-ata-rojo-claro: #F44336;
            --color-ata-dorado: #FFD700;
            --color-ata-azul: #1E90FF;
            --color-ata-negro: #2C3E50;
            --color-ata-gris: #7F8C8D;
            --color-ata-gris-claro: #ECF0F1;
            
            /* Sombras */
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 16px rgba(0, 0, 0, 0.2);
            
            /* Fuentes */
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Reset y base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        body {
            font-family: var(--font-family);
            background-color: #f8f9fa;
            color: var(--color-ata-negro);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--color-ata-verde) 0%, var(--color-ata-verde-claro) 100%);
            color: white;
            padding: 15px 0;
            box-shadow: var(--shadow-medium);
            position: relative;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 55px;
            height: 55px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--color-ata-verde);
            padding: 6px;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        .header-text h1 {
            font-size: 24px;
            margin: 0;
        }

        .header-text p {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
        }

        /* Navegación principal */
        .main-nav {
            background: var(--color-ata-verde);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .main-nav .nav-menu {
            display: flex;
            gap: 20px;
            list-style: none;
            justify-content: center;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            list-style: none;
        }

        .nav-item a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item a:hover,
        .nav-item a.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-ata-verde) 0%, var(--color-ata-azul) 100%);
            padding: 15px;
        }

        .login-card {
            background: white;
            padding: 30px 35px;
            border-radius: 20px;
            box-shadow: var(--shadow-heavy);
            width: 100%;
            max-width: 550px;
            text-align: center;
            position: relative;
        }

        /* Mejorar scroll de la card de login */
        .login-card::-webkit-scrollbar {
            width: 6px;
        }

        .login-card::-webkit-scrollbar-track {
            background: transparent;
        }

        .login-card::-webkit-scrollbar-thumb {
            background: var(--color-ata-verde);
            border-radius: 3px;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 32px;
            padding: 14px;
            box-shadow: var(--shadow-medium);
        }

        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--color-ata-negro);
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--color-ata-gris);
            margin-bottom: 25px;
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-ata-negro);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        /* Estilos para input-group con ícono de lupa */
        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-group .form-input {
            padding-right: 45px;
        }

        .input-group-append {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            z-index: 2;
        }

        .input-group-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 100%;
            color: #6c757d;
            background: transparent;
            pointer-events: none;
        }

        /* Estilos para autocompletado de búsqueda */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--color-ata-verde);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #e8f5e9;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item .student-name {
            font-weight: 600;
            color: #333;
        }

        .autocomplete-item .student-info {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .autocomplete-loading {
            padding: 15px;
            text-align: center;
            color: #666;
        }

        .autocomplete-empty {
            padding: 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .input-group-icon i {
            font-size: 16px;
        }

        .form-input:focus + .input-group-append .input-group-icon {
            color: var(--color-ata-verde);
        }

        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            color: var(--color-ata-gris);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            z-index: 10;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: var(--color-ata-verde);
        }

        .password-input {
            padding-right: 45px;
        }

        /* Estilos para el flujo de login en pasos */
        .login-step {
            overflow: hidden;
        }

        .login-step.hidden {
            display: none;
        }

        .login-step.visible {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes checkPop {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            50% {
                transform: scale(1.3);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
            }
        }

        /* Spinner de carga */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner-border {
            display: inline-block;
            width: 3rem;
            height: 3rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }

        .role-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .role-btn {
            padding: 18px 12px;
            border: 2px solid #e9ecef;
            background: #ffffff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-ata-gris);
        }
        
        .role-btn i {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        /* Botón Admin destacado */
        .admin-role-btn {
            border: 2px solid var(--color-ata-dorado) !important;
            background: linear-gradient(135deg, #fffbf0, #fff9e6) !important;
            color: var(--color-ata-dorado) !important;
        }
        
        .admin-role-btn i {
            color: var(--color-ata-dorado);
        }
        
        /* Indicador de pasos para activación */
        .steps-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
            padding: 0 10px;
        }
        
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 3px solid #e9ecef;
        }
        
        .step-item.active .step-circle {
            background: var(--color-ata-verde);
            color: white;
            border-color: var(--color-ata-verde);
            box-shadow: 0 0 0 4px rgba(0, 107, 63, 0.2);
        }
        
        .step-item.completed .step-circle {
            background: var(--color-ata-verde);
            color: white;
            border-color: var(--color-ata-verde);
        }
        
        .step-label {
            font-size: 11px;
            color: #6c757d;
            margin-top: 6px;
            text-align: center;
            max-width: 70px;
        }
        
        .step-item.active .step-label,
        .step-item.completed .step-label {
            color: var(--color-ata-verde);
            font-weight: 600;
        }
        
        .step-line {
            width: 50px;
            height: 3px;
            background: #e9ecef;
            margin: 0 8px;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }
        
        .step-line.completed {
            background: var(--color-ata-verde);
        }
        
        /* Contenido de cada paso */
        .activation-step {
            display: none;
            animation: fadeInStep 0.4s ease;
        }
        
        .activation-step.active {
            display: block;
        }
        
        @keyframes fadeInStep {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .role-btn:hover {
            border-color: var(--color-ata-verde);
            background: #f8f9fa;
            color: var(--color-ata-verde);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 107, 63, 0.15);
        }

        .role-btn.selected {
            border-color: var(--color-ata-verde);
            background: var(--color-ata-verde);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 107, 63, 0.25);
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-ata-verde);
            margin-bottom: 15px;
            text-align: center;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-ata-verde);
            box-shadow: 0 0 0 3px rgba(0, 107, 63, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-primary {
            background: var(--color-ata-verde);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-ata-verde-claro);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Main App Content (hidden initially) */
        .main-app {
            display: none !important;
            min-height: 100vh;
            flex-direction: column;
        }
        
        .main-app.show {
            display: flex !important;
        }

        .main-content {
            padding: 30px 0;
            flex: 1;
        }

        .page-title {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title h2 {
            font-size: 32px;
            color: var(--color-ata-verde);
            margin-bottom: 10px;
        }

        .page-title p {
            font-size: 18px;
            color: var(--color-ata-gris);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-light);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .card h3 {
            color: var(--color-ata-verde);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 25px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Estadísticas */
        .stats-card {
            text-align: center;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--color-ata-verde);
        }

        .stats-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--color-ata-verde);
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 14px;
            color: var(--color-ata-gris);
            margin-bottom: 10px;
        }

        .stats-trend {
            font-size: 12px;
            font-weight: bold;
        }

        .trend-up {
            color: var(--color-ata-rojo);
        }

        .trend-down {
            color: var(--color-ata-verde);
        }

        /* Botones */
        .btn-secondary {
            background: var(--color-ata-azul);
            color: white;
        }

        .btn-secondary:hover {
            background: #0066CC;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--color-ata-rojo);
            color: white;
        }

        .btn-danger:hover {
            background: var(--color-ata-rojo-claro);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--color-ata-dorado);
            color: var(--color-ata-negro);
        }

        .btn-warning:hover {
            background: #FFC107;
            transform: translateY(-2px);
        }

        .btn-info {
            background: var(--color-ata-azul);
            color: white;
        }

        .btn-info:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        /* Estilos para sistema de solicitud de cuentas */
        .account-options {
            margin: 15px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--color-ata-verde);
            max-height: 500px;
            overflow-y: auto;
        }

        .demo-warning {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            border-left: 4px solid var(--color-ata-dorado);
        }

        .demo-warning .alert {
            margin: 0;
            padding: 0;
            background: none;
            border: none;
            color: #856404;
        }

        .demo-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 15px;
        }

        .demo-actions .btn {
            width: 100%;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: 2px solid #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
            transform: translateY(-2px);
        }

        .request-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .request-form.visible {
            display: block;
            animation: slideDown 0.3s ease-in-out;
        }

        /* Mejorar el scroll del formulario */
        .request-form::-webkit-scrollbar {
            width: 8px;
        }

        .request-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .request-form::-webkit-scrollbar-thumb {
            background: var(--color-ata-verde);
            border-radius: 4px;
        }

        .request-form::-webkit-scrollbar-thumb:hover {
            background: var(--color-ata-gris);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-section h5 {
            color: var(--color-ata-verde);
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        .verification-requirements {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--color-ata-azul);
        }

        .verification-requirements h6 {
            color: var(--color-ata-azul);
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .verification-requirements ul {
            margin: 0;
            padding-left: 20px;
            color: #1565c0;
            font-size: 13px;
        }

        .verification-requirements li {
            margin-bottom: 5px;
        }

        /* Mensajes de error/éxito inline */
        .form-message {
            margin-top: 10px;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
            animation: slideInDown 0.3s ease-out;
        }

        .form-message.show {
            display: block;
        }

        .form-message.error {
            background: #fee;
            border-left: 4px solid var(--color-ata-rojo);
            color: #c62828;
        }

        .form-message.success {
            background: #e8f5e8;
            border-left: 4px solid var(--color-ata-verde);
            color: #2e7d32;
        }

        .form-message.info {
            background: #e3f2fd;
            border-left: 4px solid var(--color-ata-azul);
            color: #1565c0;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-message i {
            margin-right: 8px;
        }

        .form-message code {
            background-color: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: bold;
        }

        .form-message small {
            opacity: 0.8;
            font-size: 12px;
        }

        /* Estilos eliminados: .demo-banner - ya no se usa banner DEMO */

        /* Alertas */
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-danger {
            background: #ffebee;
            color: #c62828;
            border-left-color: var(--color-ata-rojo);
        }

        .alert-warning {
            background: #fff9e6;
            color: #f57f17;
            border-left-color: var(--color-ata-dorado);
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left-color: var(--color-ata-azul);
        }

        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left-color: var(--color-ata-verde);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .badge-merito {
            background: rgba(33, 150, 243, 0.1);
            color: #1976d2;
        }

        .badge-leve {
            background: rgba(76, 175, 80, 0.1);
            color: var(--color-ata-verde);
        }

        .badge-grave {
            background: rgba(255, 215, 0, 0.2);
            color: #f57f17;
        }

        .badge-muy-grave {
            background: rgba(193, 39, 45, 0.1);
            color: var(--color-ata-rojo);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: var(--color-ata-verde);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .detalle-row {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .detalle-row:last-child {
            border-bottom: none;
        }

        .detalle-label {
            font-weight: 600;
            color: var(--color-ata-verde);
            width: 140px;
            flex-shrink: 0;
        }

        .detalle-value {
            color: #333;
            flex: 1;
        }

        .detalle-descripcion {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            line-height: 1.6;
        }

        /* Tablas */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow-x: auto; /* IMPORTANTE: Scroll horizontal en móvil */
            -webkit-overflow-scrolling: touch;
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
            max-width: 100%;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px; /* Mínimo para que se vea bien */
        }

        .table th {
            background: var(--color-ata-verde);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        .table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 13px;
        }

        .table tr:hover {
            background: #f8f9fa;
        }
        
        /* Responsive para tablas en móvil */
        @media (max-width: 768px) {
            .table-container {
                margin-left: -10px;
                margin-right: -10px;
                border-radius: 8px;
            }
            
            .table {
                min-width: 450px;
            }
            
            .table th, .table td {
                padding: 10px 8px;
                font-size: 12px;
            }
            
            .table td button {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }
        }

        /* Footer */
        .footer {
            background: var(--color-ata-negro);
            color: white;
            text-align: center;
            padding: 30px 0;
            margin-top: auto;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-text {
            flex: 1;
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--color-ata-dorado);
        }

        /* User info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .logout-btn {
            background: var(--color-ata-rojo);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--color-ata-rojo-claro);
        }

        /* Estilos específicos para administrador */
        .admin-card {
            border-left: 4px solid var(--color-ata-dorado);
            background: linear-gradient(135deg, #ffffff, #fffbf0);
        }

        .admin-card h3 {
            color: var(--color-ata-dorado);
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }

        .mini-stat {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .admin-stats {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        /* =====================================================
           ESTILOS RESPONSIVE
           ===================================================== */
        
        /* Tablets y pantallas medianas */
        @media (max-width: 992px) {
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .rol-nombre {
                min-width: 100px;
                font-size: 12px;
            }
        }

        /* Móviles */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                padding: 10px;
            }

            .logo {
                width: 50px;
                height: 50px;
            }

            .login-screen {
                padding: 15px;
            }

            .login-logo {
                width: 90px;
                height: 90px;
                padding: 10px;
            }
            
            .login-title {
                font-size: 24px;
            }
            
            .login-subtitle {
                font-size: 14px;
                margin-bottom: 20px;
            }

            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
                gap: 5px;
            }
            
            .nav-item {
                padding: 8px 12px;
                font-size: 12px;
            }

            .page-title h2 {
                font-size: 20px;
            }

            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .stats-number {
                font-size: 24px;
            }

            .footer-content {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }

            .login-card {
                padding: 25px 20px;
                max-width: 100%;
                margin: 10px;
                border-radius: 12px;
            }
            
            .step-title {
                font-size: 16px;
            }

            .request-form {
                padding: 15px;
            }

            .account-options {
                padding: 15px;
            }

            .demo-actions {
                flex-direction: column;
            }

            .demo-actions .btn {
                min-width: auto;
                width: 100%;
            }

            .role-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .role-btn {
                padding: 12px 8px;
                font-size: 12px;
            }
            
            .role-btn i {
                font-size: 18px;
            }
            
            /* Distribución de roles en móvil */
            .rol-distribucion {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .rol-nombre {
                min-width: 100%;
                font-size: 13px;
                margin-bottom: 5px;
            }
            
            .rol-barra {
                flex: 1;
                min-width: calc(100% - 50px);
            }
            
            .rol-count {
                min-width: 40px;
            }
            
            /* Admin tabs en móvil */
            .admin-tabs {
                padding: 10px;
            }
            
            .admin-tab-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            /* Tablas responsive */
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
            
            /* Cards */
            .card {
                padding: 15px;
            }
            
            .stat-card {
                padding: 15px 10px;
            }
            
            .stat-card .stats-number {
                font-size: 28px;
            }
            
            .stat-card .stats-label {
                font-size: 11px;
            }
        }
        
        /* Móviles pequeños */
        @media (max-width: 480px) {
            .login-screen {
                padding: 10px;
            }
            
            .login-card {
                padding: 20px 15px;
                margin: 5px;
            }
            
            .login-logo {
                width: 80px;
                height: 80px;
            }
            
            .login-title {
                font-size: 22px;
            }
            
            .role-selection {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .role-btn {
                padding: 10px 6px;
                font-size: 11px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .form-input, .form-control {
                padding: 10px;
                font-size: 14px;
            }
            
            /* Stat cards más compactas */
            .stat-card .stats-number {
                font-size: 24px;
            }
            
            /* Modal responsive */
            .modal-container {
                max-width: 95%;
                margin: 10px;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-footer {
                padding: 10px 15px;
                flex-wrap: wrap;
            }
        }
        
        /* =====================================================
           ESTILOS DEL PANEL DE ADMINISTRACIÓN
           ===================================================== */
        
        /* Pestañas de navegación del admin */
        .admin-tabs {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
        }
        
        .admin-tab-btn {
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .admin-tab-btn.active {
            background: var(--color-ata-verde) !important;
            color: white !important;
        }
        
        .admin-tab-btn:not(.active):hover {
            background: #e9ecef;
        }
        
        .admin-badge {
            background: var(--color-ata-rojo);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
            font-weight: bold;
            animation: pulse-badge 2s infinite;
        }
        
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Campanita de notificaciones */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            margin-right: 10px;
        }
        
        .notification-bell:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .notification-bell i {
            font-size: 20px;
            color: white;
            transition: transform 0.3s ease;
        }
        
        .notification-bell .bell-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--color-ata-rojo);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        /* Animación suave de vibración/rebote */
        .notification-bell.bell-animate i {
            animation: bell-bounce 0.6s ease-in-out;
        }
        
        @keyframes bell-bounce {
            0%, 100% { transform: rotate(0) scale(1); }
            10% { transform: rotate(12deg) scale(1.1); }
            20% { transform: rotate(-10deg) scale(1.05); }
            30% { transform: rotate(8deg) scale(1.08); }
            40% { transform: rotate(-6deg) scale(1.03); }
            50% { transform: rotate(4deg) scale(1.05); }
            60% { transform: rotate(-2deg) scale(1.02); }
            70% { transform: rotate(1deg) scale(1); }
            80%, 100% { transform: rotate(0) scale(1); }
        }
        
        /* Dropdown de notificaciones estilo Facebook */
        .notification-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            width: 360px;
            max-height: 420px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            z-index: 9999;
            display: none;
            overflow: hidden;
            animation: dropdownSlide 0.2s ease;
        }
        
        .notification-dropdown.show {
            display: block;
        }
        
        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .notification-dropdown-header {
            padding: 15px 18px;
            background: linear-gradient(135deg, var(--color-ata-verde), var(--color-ata-verde-claro));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-dropdown-header h4 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
        }
        
        .notification-dropdown-header .ver-todas {
            color: white;
            font-size: 12px;
            text-decoration: none;
            opacity: 0.9;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .notification-dropdown-header .ver-todas:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        .notification-dropdown-list {
            max-height: 320px;
            overflow-y: auto;
        }
        
        .notification-dropdown-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .notification-dropdown-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .notification-dropdown-list::-webkit-scrollbar-thumb {
            background: var(--color-ata-verde);
            border-radius: 3px;
        }
        
        .notification-item {
            padding: 12px 18px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .notification-item:hover {
            background: #f8f9fa;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-ata-verde), var(--color-ata-verde-claro));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .notification-item-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-item-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .notification-item-desc {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }
        
        .notification-item-time {
            font-size: 11px;
            color: #999;
        }
        
        .notification-empty {
            padding: 30px 20px;
            text-align: center;
            color: #999;
        }
        
        .notification-empty i {
            font-size: 40px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .notification-empty p {
            margin: 0;
            font-size: 14px;
        }
        
        /* Flecha del dropdown */
        .notification-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid var(--color-ata-verde);
        }
        
        /* Responsive dropdown - CORREGIDO PARA MÓVILES */
        @media (max-width: 768px) {
            .notification-dropdown {
                position: fixed !important;
                top: 70px !important;
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%);
                width: calc(100vw - 30px);
                max-width: 360px;
            }
            
            .notification-dropdown::before {
                display: none;
            }
            
            .support-dropdown {
                position: fixed !important;
                top: 70px !important;
                left: 50% !important;
                right: auto !important;
                transform: translateX(-50%);
                width: calc(100vw - 30px);
                max-width: 350px;
            }
            
            .support-dropdown::before {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            .notification-dropdown,
            .support-dropdown {
                width: calc(100vw - 20px);
                max-width: none;
                left: 50% !important;
                transform: translateX(-50%);
            }
            
            .notification-item {
                padding: 10px 12px;
            }
            
            .notification-item-icon {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }
            
            .notification-item-title {
                font-size: 13px;
            }
            
            .notification-item-desc {
                font-size: 11px;
            }
        }
        
        /* Tarjetas de estadísticas del admin */
        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
        }
        
        .stat-card .stats-number {
            color: white !important;
        }
        
        .stat-card .stats-label {
            color: rgba(255,255,255,0.9);
            margin: 0;
        }
        
        /* Tablas de datos */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .data-table thead {
            background: var(--color-ata-verde);
            color: white;
        }
        
        .data-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tbody tr:nth-child(even) {
            background: #fafafa;
        }
        
        .data-table tbody tr:nth-child(even):hover {
            background: #f0f0f0;
        }
        
        /* Badges de estado */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-primary {
            background: #cce5ff;
            color: #004085;
        }
        
        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }
        
        /* Botones pequeños para tablas */
        .btn-xs {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
        }
        
        .btn-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        /* Solicitudes pendientes */
        .solicitud-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            transition: all 0.3s ease;
        }
        
        .solicitud-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateX(5px);
        }
        
        .solicitud-info {
            flex: 1;
            min-width: 250px;
        }
        
        .solicitud-info h4 {
            margin: 0 0 5px 0;
            color: var(--color-ata-verde);
        }
        
        .solicitud-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        
        .solicitud-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Actividad reciente */
        .actividad-item {
            padding: 12px 15px;
            border-left: 3px solid var(--color-ata-verde);
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .actividad-item.incidencia {
            border-left-color: var(--color-ata-rojo);
        }
        
        .actividad-item.usuario {
            border-left-color: var(--color-ata-azul);
        }
        
        .actividad-item.merito {
            border-left-color: var(--color-ata-dorado);
        }
        
        .actividad-fecha {
            color: #999;
            font-size: 12px;
        }
        
        /* Distribución por roles */
        .rol-distribucion {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            gap: 10px;
        }
        
        .rol-distribucion:last-child {
            border-bottom: none;
        }
        
        .rol-nombre {
            min-width: 120px;
            width: auto;
            font-weight: 500;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .rol-barra {
            flex: 1;
            min-width: 80px;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 15px;
        }
        
        .rol-barra-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .rol-count {
            width: 50px;
            text-align: right;
            font-weight: 600;
        }
        
        /* Modal de admin */
        .admin-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        /* Modal content genérico */
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalSlideIn 0.3s ease;
        }
        
        .modal-header {
            padding: 20px 25px;
            background: var(--color-ata-verde);
            color: white;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: white;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 15px 25px;
            background: #f8f9fa;
            border-radius: 0 0 16px 16px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .btn-close:hover {
            opacity: 0.8;
        }
        
        /* Utilidades de texto */
        .text-warning {
            color: #f0ad4e !important;
        }
        
        .text-danger {
            color: #dc3545 !important;
        }
        
        .text-success {
            color: #28a745 !important;
        }
        
        /* Item de apoderado */
        .apoderado-item {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--color-ata-verde);
        }
        
        .apoderado-item strong {
            color: var(--color-ata-verde);
        }
        
        .apoderado-item small {
            color: #666;
            display: block;
            margin-top: 5px;
        }
        
        .admin-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .admin-modal-header {
            padding: 20px 25px;
            background: var(--color-ata-verde);
            color: white;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-modal-header h3 {
            margin: 0;
            color: white;
        }
        
        .admin-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .admin-modal-body {
            padding: 25px;
        }
        
        .admin-modal-footer {
            padding: 15px 25px;
            background: #f8f9fa;
            border-radius: 0 0 16px 16px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state p {
            margin: 0;
            font-size: 16px;
        }

        /* Modal Genérico de Confirmación/Alerta */
        .modal-generic {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            padding: 15px;
            box-sizing: border-box;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-generic-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            animation: modalBounce 0.3s ease;
            overflow: hidden;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @media (max-width: 480px) {
            .modal-generic {
                padding: 10px;
            }
            .modal-generic-content {
                max-width: 100%;
                border-radius: 12px;
            }
        }
        
        @keyframes modalBounce {
            0% { transform: scale(0.8) translateY(-30px); opacity: 0; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        .modal-generic-header {
            padding: 20px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-generic-header.success {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }
        
        .modal-generic-header.error {
            background: linear-gradient(135deg, #d63031, #e74c3c);
            color: white;
        }
        
        .modal-generic-header.warning {
            background: linear-gradient(135deg, #fdcb6e, #f39c12);
            color: white;
        }
        
        .modal-generic-header.info {
            background: linear-gradient(135deg, #0984e3, #74b9ff);
            color: white;
        }
        
        .modal-generic-header.confirm {
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white;
        }
        
        .modal-generic-icon {
            font-size: 28px;
        }
        
        .modal-generic-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-generic-body {
            padding: 25px;
            font-size: 15px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }
        
        .modal-generic-footer {
            padding: 15px 25px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8f9fa;
        }
        
        .modal-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-btn-primary {
            background: var(--color-ata-verde);
            color: white;
        }
        
        .modal-btn-primary:hover {
            background: #005a3c;
            transform: translateY(-2px);
        }
        
        .modal-btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .modal-btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .modal-btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }
        
        .modal-btn-cancel {
            background: transparent;
            color: #666;
            border: 2px solid #ddd;
        }
        
        .modal-btn-cancel:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }
        
        /* Ícono de mensajes de soporte - igual que la campanita */
        .message-inbox {
            position: relative;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.1);
            margin-right: 10px;
        }
        
        .message-inbox:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .message-inbox > i {
            font-size: 20px;
            color: white;
        }
        
        .message-inbox .message-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--color-ata-azul);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Dropdown de mensajes - oculto por defecto */
        .support-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            width: 350px;
            max-height: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            z-index: 9999;
            display: none;
            overflow: hidden;
        }
        
        .support-dropdown.show {
            display: block;
            animation: dropdownSlide 0.2s ease;
        }
        
        .support-dropdown::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid var(--color-ata-azul);
        }
        
        .support-dropdown-header {
            padding: 15px 18px;
            background: linear-gradient(135deg, var(--color-ata-azul), #0066CC);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .support-dropdown-header h4 {
            margin: 0;
            font-size: 15px;
            font-weight: 600;
        }
        
        .support-dropdown-header .ver-todos {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .support-dropdown-header .ver-todos:hover {
            color: white;
            text-decoration: underline;
        }
        
        .support-dropdown-list {
            max-height: 320px;
            overflow-y: auto;
        }
        
        .message-item {
            padding: 14px 18px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .message-item:hover {
            background: #f8f9fa;
        }
        
        .message-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .message-sender {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .message-role {
            font-size: 11px;
            color: white;
            background: var(--color-ata-verde);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .message-preview {
            font-size: 13px;
            color: #666;
            margin: 0;
            line-height: 1.4;
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            display: block;
        }
        
        .message-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }
        
        .message-empty i {
            font-size: 40px;
            margin-bottom: 10px;
            color: #ddd;
            display: block;
        }
        
        /* Animación del sobre */
        .message-inbox.message-animate > i {
            animation: bell-bounce 0.6s ease;
        }
        
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">
                <img src="./assets/images/INSIGNIA_I.E.ANTONIO_TORRES_ARAUJO.png" alt="Logo ATA" />
            </div>
            <h2 class="login-title">Agenda Virtual ATA</h2>
            <p class="login-subtitle">I.E. 80002 Antonio Torres Araujo<br>Sistema de Gestión de Incidencias</p>
            
            <form id="loginForm">
                <!-- Paso 1: Selección de tipo de cuenta -->
                <div id="step1" class="login-step visible">
                    <div class="step-title">
                        <i class="fas fa-user-tag"></i> Elige tu tipo de cuenta
                    </div>
                    <div class="role-selection">
                        <button type="button" class="role-btn" onclick="selectRole('docente')">
                            <i class="fas fa-chalkboard-teacher"></i><br>
                            Docente
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('tutor')">
                            <i class="fas fa-user-graduate"></i><br>
                            Tutor
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('auxiliar')">
                            <i class="fas fa-hands-helping"></i><br>
                            Auxiliar
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('toe')">
                            <i class="fas fa-user-shield"></i><br>
                            TOE
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('direccion')">
                            <i class="fas fa-user-tie"></i><br>
                            Dirección
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('padre')">
                            <i class="fas fa-user-friends"></i><br>
                            Padre/Madre
                        </button>
                    </div>
                    
                    <!-- Línea divisora y Botón Administrador centrado -->
                    <div style="display: flex; align-items: center; margin: 18px 0 12px 0;">
                        <div style="flex: 1; height: 1px; background: linear-gradient(to right, transparent, #ddd);"></div>
                        <span style="padding: 0 15px; color: #999; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Acceso especial</span>
                        <div style="flex: 1; height: 1px; background: linear-gradient(to left, transparent, #ddd);"></div>
                    </div>
                    <div style="display: flex; justify-content: center;">
                        <button type="button" class="role-btn admin-role-btn" onclick="selectRoleAdmin()" style="width: 160px;">
                            <i class="fas fa-user-cog"></i><br>
                            Administrador
                        </button>
                    </div>
                </div>

                <!-- Paso 1b: Opciones de cuenta (Solicitar vs Demo) -->
                <div id="step1b" class="login-step hidden">
                    <div class="account-options">
                        <div class="alert alert-success" style="margin-bottom: 15px; background: #e8f5e8; border: none; color: var(--color-ata-verde);">
                            <i class="fas fa-check-circle"></i>
                            <span>Tipo de cuenta seleccionado: <strong id="selectedRoleText">Rol</strong></span>
                            <button type="button" onclick="backToRoleSelection()" style="background: none; border: none; color: var(--color-ata-verde); float: right; cursor: pointer; font-size: 16px;">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <div class="demo-warning">
                            <div class="alert">
                                <i class="fas fa-info-circle"></i>
                                <strong>¿Qué deseas hacer?</strong> Selecciona una opción para continuar
                            </div>
                            
                            <div class="demo-actions">
                                <button type="button" class="btn btn-primary" onclick="showDemoLogin()">
                                    <i class="fas fa-sign-in-alt"></i>
                                    Iniciar sesión
                                </button>
                                <button type="button" class="btn btn-warning" onclick="showActivarCuenta()">
                                    <i class="fas fa-key"></i>
                                    Activar cuenta por primera vez
                                </button>
                            </div>
                        </div>

                        <!-- Formulario de solicitud -->
                        <div id="requestForm" class="request-form">
                            <h5><i class="fas fa-file-alt"></i> Solicitud de Cuenta Oficial</h5>
                            
                            <div class="verification-requirements" id="roleRequirements">
                                <!-- Los requisitos se llenarán dinámicamente -->
                            </div>

                            <div class="form-section">
                                <h6>Datos Personales</h6>
                                <div class="form-group">
                                    <label class="form-label">Nombres y Apellidos Completos</label>
                                    <input type="text" id="solicitud_nombre" class="form-input" placeholder="Ingrese su nombre completo" style="text-transform: uppercase;" oninput="validarNombre(this)" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">DNI</label>
                                    <input type="text" id="solicitud_dni" class="form-input" placeholder="Número de DNI (8 dígitos)" maxlength="8" oninput="validarDNI(this)" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email Institucional o Personal</label>
                                    <input type="email" id="solicitud_email" class="form-input" placeholder="correo@ejemplo.com" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Teléfono/Celular</label>
                                    <input type="tel" id="solicitud_telefono" class="form-input" placeholder="999999999" maxlength="9" oninput="this.value = this.value.replace(/\\D/g, '')" required>
                                </div>
                            </div>

                            <div class="form-section" id="specificFields">
                                <!-- Campos específicos según el rol -->
                            </div>

                            <div class="demo-actions">
                                <button type="button" class="btn btn-secondary" onclick="cancelRequest()">
                                    <i class="fas fa-times"></i>
                                    Cancelar
                                </button>
                                <button type="button" class="btn btn-primary" onclick="submitRequest()">
                                    <i class="fas fa-paper-plane"></i>
                                    Enviar Solicitud
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paso 3: Activación de cuenta (Con pasos visuales) -->
                <div id="step3" class="login-step hidden">
                    <!-- Botón Volver arriba, más visible -->
                    <button type="button" onclick="backToRoleSelection()" style="display: flex; align-items: center; gap: 8px; background: none; border: 2px solid #e9ecef; color: var(--color-ata-gris); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; margin-bottom: 15px; transition: all 0.3s ease;" onmouseover="this.style.borderColor='var(--color-ata-verde)'; this.style.color='var(--color-ata-verde)';" onmouseout="this.style.borderColor='#e9ecef'; this.style.color='var(--color-ata-gris)';">
                        <i class="fas fa-arrow-left"></i> Volver a roles
                    </button>
                    
                    <div id="selectedRoleActivacion" class="alert alert-success" style="margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i>
                        <span>Activando cuenta: <strong id="roleTextActivacion">Rol seleccionado</strong></span>
                    </div>
                    
                    <!-- Indicador de pasos -->
                    <div class="steps-indicator" id="stepsIndicator">
                        <div class="step-item active" id="stepItem1">
                            <div class="step-circle">1</div>
                            <span class="step-label">Verificar</span>
                        </div>
                        <div class="step-line" id="stepLine1"></div>
                        <div class="step-item" id="stepItem2">
                            <div class="step-circle">2</div>
                            <span class="step-label">Datos</span>
                        </div>
                        <div class="step-line" id="stepLine2"></div>
                        <div class="step-item" id="stepItem3">
                            <div class="step-circle">3</div>
                            <span class="step-label">Contraseña</span>
                        </div>
                    </div>
                    
                    <!-- PASO 1: Verificar cuenta existe -->
                    <div id="activationStep1" class="activation-step active">
                        <div class="alert" style="background: #e3f2fd; border-left: 4px solid var(--color-ata-azul); padding: 12px; margin-bottom: 15px;">
                            <i class="fas fa-info-circle" style="color: var(--color-ata-azul);"></i>
                            <strong style="color: var(--color-ata-azul);">Busca tu cuenta</strong>
                            <p style="margin: 3px 0 0 0; font-size: 12px; color: #1565c0;">Ingresa tu DNI o nombre completo</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-id-card"></i> DNI (8 dígitos)</label>
                            <input type="text" id="verificar_dni" class="form-input" placeholder="Ej: 12345678" maxlength="8" oninput="validarDNI(this)">
                        </div>
                        
                        <div style="text-align: center; color: #999; font-size: 12px; margin: 10px 0;">— o busca por nombre —</div>
                        
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-user"></i> Nombre Completo</label>
                            <input type="text" id="verificar_nombre" class="form-input" placeholder="GARCIA PEREZ JUAN" style="text-transform: uppercase;" oninput="validarNombre(this)">
                            <small style="color: #856404; background: #fff3cd; padding: 6px; border-radius: 4px; font-size: 10px; display: block; margin-top: 5px;">
                                <i class="fas fa-exclamation-triangle"></i> MAYÚSCULAS, sin tildes: APELLIDOS + NOMBRES
                            </small>
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="verificarCuentaExiste()" id="btnVerificar" style="width: 100%;">
                            <i class="fas fa-search"></i> Verificar mi cuenta
                        </button>
                        
                        <div id="verificarSpinner" style="display: none; text-align: center; margin-top: 15px;">
                            <div style="width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid var(--color-ata-verde); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                            <p style="margin-top: 8px; color: var(--color-ata-verde); font-size: 13px;">Verificando...</p>
                        </div>
                        
                        <div id="verificarMessage" class="form-message"></div>
                    </div>
                    
                    <!-- PASO 2: Completar datos (DNI, Email, Teléfono) -->
                    <div id="activationStep2" class="activation-step">
                        <div class="alert alert-success" style="margin-bottom: 15px; padding: 12px; display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-check-circle" style="font-size: 24px;"></i>
                            <div>
                                <strong>¡Cuenta encontrada!</strong>
                                <p style="margin: 2px 0 0 0; font-size: 12px; opacity: 0.9;">Completa tu información y crea tu contraseña</p>
                            </div>
                        </div>
                        
                        <!-- DNI -->
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-id-card"></i> DNI (8 dígitos) <span style="color: red;">*</span></label>
                            <div style="position: relative;">
                                <input type="text" id="dni_activacion" class="form-input" placeholder="DNI ya registrado en el sistema" maxlength="8" style="padding-right: 40px;" oninput="validarDNI(this)">
                                <span id="dniCheckIcon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); display: none;">
                                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                                </span>
                            </div>
                            <div id="dniVerificacionMessage" class="form-message" style="margin-top: 5px;"></div>
                        </div>
                        
                        <!-- Correo Electrónico -->
                        <div class="form-group" id="emailSection">
                            <label class="form-label"><i class="fas fa-envelope"></i> Correo Electrónico <span style="color: red;">*</span></label>
                            <input type="email" id="email_activacion" class="form-input" placeholder="Email ya registrado en el sistema" oninput="validarEmailActivacion(this)">
                            <small style="color: #666; font-size: 11px;"><i class="fas fa-info-circle"></i> Necesario para recuperar contraseña y recibir notificaciones</small>
                            <div id="emailVerificacionMessage" class="form-message" style="margin-top: 5px;"></div>
                        </div>
                        
                        <!-- Número de Teléfono (Opcional) -->
                        <div class="form-group" id="telefonoSection">
                            <label class="form-label"><i class="fas fa-phone"></i> Número de Teléfono <span style="color: #999; font-size: 11px;">(Opcional)</span></label>
                            <div style="position: relative;">
                                <input type="tel" id="telefono_activacion" class="form-input" placeholder="987654321" maxlength="9" style="padding-right: 40px;" oninput="verificarTelefonoIngresado()">
                                <span id="telefonoCheckIcon" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); display: none;">
                                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                                </span>
                            </div>
                            <small style="color: #666; font-size: 11px;"><i class="fas fa-info-circle"></i> Opcional: Para contacto y notificaciones SMS</small>
                            <div id="telefonoVerificacionMessage" class="form-message" style="margin-top: 5px;"></div>
                            
                            <!-- Botón Continuar sin teléfono (visible por defecto) -->
                            <button type="button" id="btnContinuarSinTelefono" onclick="continuarSinTelefono()" class="btn" style="width: 100%; margin-top: 10px; background: var(--color-ata-verde); color: white; padding: 10px;">
                                Continuar sin teléfono
                            </button>
                            
                            <!-- Botón Continuar (oculto por defecto, aparece cuando escribe 9 dígitos) -->
                            <button type="button" id="btnContinuarConTelefono" onclick="continuarConTelefono()" class="btn" style="width: 100%; margin-top: 10px; background: var(--color-ata-verde); color: white; padding: 10px; display: none;">
                                Continuar <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        
                        <!-- Botón Volver - Mejor posicionado arriba -->
                        <button type="button" onclick="volverAPaso1()" style="display: flex; align-items: center; gap: 8px; background: none; border: 2px solid #e9ecef; color: var(--color-ata-gris); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; margin-top: 20px; transition: all 0.3s ease;" onmouseover="this.style.borderColor='var(--color-ata-verde)'; this.style.color='var(--color-ata-verde)';" onmouseout="this.style.borderColor='#e9ecef'; this.style.color='var(--color-ata-gris)';">
                            <i class="fas fa-arrow-left"></i> Volver al paso anterior
                        </button>
                    </div>
                    
                    <!-- PASO 3: Crear Contraseña -->
                    <div id="activationStep3" class="activation-step">
                        <!-- Título del paso -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <i class="fas fa-key" style="font-size: 32px; color: var(--color-ata-azul);"></i>
                            <h3 style="margin: 10px 0 5px 0; color: var(--color-ata-azul); font-size: 18px;">Crear Contraseña</h3>
                        </div>
                        
                        <!-- Requisitos de seguridad -->
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                            <span style="color: var(--color-ata-azul); font-size: 13px; font-weight: 600;">
                                <i class="fas fa-shield-alt"></i> Requisitos de seguridad:
                            </span>
                            <ul style="margin: 10px 0 0 0; padding: 0; list-style: none; color: #1565c0; font-size: 12px;">
                                <li id="req-length" style="margin: 5px 0;"><i class="fas fa-circle" style="font-size: 6px; margin-right: 8px;"></i>Mínimo 6 caracteres</li>
                                <li id="req-match" style="margin: 5px 0;"><i class="fas fa-circle" style="font-size: 6px; margin-right: 8px;"></i>Las contraseñas deben coincidir</li>
                            </ul>
                        </div>
                        
                        <!-- Nueva Contraseña -->
                        <div class="form-group">
                            <label class="form-label">Nueva Contraseña</label>
                            <div class="password-container">
                                <input type="password" id="nueva_password" class="form-input password-input" placeholder="Mínimo 6 caracteres" oninput="validarPasswordRequisitos()">
                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('nueva_password', 'nueva_password_icon')">
                                    <i class="fas fa-eye" id="nueva_password_icon"></i>
                                </button>
                            </div>
                        </div>
                    
                        <!-- Confirmar Contraseña -->
                        <div class="form-group">
                            <label class="form-label">Confirmar Contraseña</label>
                            <div class="password-container">
                                <input type="password" id="confirmar_password" class="form-input password-input" placeholder="Repite la contraseña" oninput="validarPasswordRequisitos()">
                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmar_password', 'confirmar_password_icon')">
                                    <i class="fas fa-eye" id="confirmar_password_icon"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div id="activarMessage" class="form-message"></div>
                        
                        <!-- Botones de acción -->
                        <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 12px;">
                            <button type="button" class="btn" onclick="activarCuentaFinal()" id="btnActivar" style="width: 100%; background: linear-gradient(135deg, var(--color-ata-verde), #00a86b); color: white; padding: 14px; border-radius: 25px; font-weight: 600; font-size: 15px;">
                                <i class="fas fa-check-circle"></i> Crear Contraseña y Activar Cuenta
                            </button>
                            
                            <!-- Botón Volver con mejor estilo -->
                            <button type="button" onclick="volverAPaso2()" style="display: flex; align-items: center; justify-content: center; gap: 8px; background: none; border: 2px solid #e9ecef; color: var(--color-ata-gris); padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.3s ease; width: 100%;" onmouseover="this.style.borderColor='var(--color-ata-verde)'; this.style.color='var(--color-ata-verde)';" onmouseout="this.style.borderColor='#e9ecef'; this.style.color='var(--color-ata-gris)';">
                                <i class="fas fa-arrow-left"></i> Volver al paso anterior
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Paso 4: Recuperación de contraseña -->
                <div id="step4" class="login-step hidden">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <i class="fas fa-key" style="font-size: 48px; color: var(--color-ata-azul);"></i>
                        <h3 class="step-title">Recuperar Contraseña</h3>
                        <p style="color: var(--color-ata-gris); font-size: 14px;">Ingresa tu DNI o Nombre Completo</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">DNI (8 dígitos) - Opcional</label>
                        <input type="text" id="recuperar_dni" class="form-input" placeholder="Ej: 12345678" maxlength="8" pattern="[0-9]{8}" oninput="validarDNI(this)">
                        <small style="color: #666; font-size: 12px;">
                            <i class="fas fa-info-circle"></i> Solo números, sin guiones ni espacios
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nombre Completo - Opcional</label>
                        <input type="text" id="recuperar_nombre" class="form-input" placeholder="APELLIDO PATERNO + APELLIDO MATERNO + NOMBRES" style="text-transform: uppercase;" oninput="validarNombre(this)">
                        <small style="color: #666; font-size: 12px;">
                            ⚠️ Todo en MAYÚSCULAS, sin tildes, sin comas. <strong>Ejemplo:</strong> GARCIA PEREZ JUAN CARLOS
                        </small>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="verificarDNIparaRecuperar()" id="btnVerificarRecuperar">
                        <i class="fas fa-search"></i>
                        Buscar mi cuenta
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="volverALogin()" style="margin-top: 10px;">
                        <i class="fas fa-arrow-left"></i>
                        Volver al login
                    </button>
                    
                    <div id="recuperarMessage" class="form-message"></div>
                    
                    <!-- Formulario para verificar email (oculto hasta verificar DNI) -->
                    <div id="step4b" style="display: none; margin-top: 25px;">
                        <div class="alert alert-success" style="margin-bottom: 20px;">
                            <i class="fas fa-check-circle"></i>
                            <strong>Identidad verificada</strong><br>
                            <small id="nombreUsuarioRecuperar"></small>
                        </div>
                        
                        <!-- Campo de email para verificar identidad -->
                        <div class="form-group">
                            <label class="form-label">Correo Electrónico <span style="color: red;">*</span></label>
                            <input type="email" id="email_verificar_recuperar" class="form-input" placeholder="ejemplo@correo.com" style="text-transform: lowercase;">
                            <small style="color: #666; font-size: 12px;">
                                <i class="fas fa-info-circle"></i> Ingresa tu correo electrónico completo para verificar tu identidad
                            </small>
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="enviarEmailRecuperacion()" id="btnEnviarRecuperacion">
                            <i class="fas fa-envelope"></i>
                            Enviar enlace de recuperación
                        </button>
                        
                        <button type="button" class="btn btn-secondary" onclick="volverALogin()" style="margin-top: 10px;">
                            <i class="fas fa-arrow-left"></i>
                            Cancelar
                        </button>
                        
                        <div id="cambiarMessage" class="form-message"></div>
                    </div>
                    
                    <!-- Step 5: Email enviado (animación) -->
                    <div id="step5" style="display: none; margin-top: 30px; text-align: center;">
                        <div style="margin-bottom: 20px;">
                            <div style="display: inline-block; width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                                <i class="fas fa-envelope-circle-check" style="font-size: 40px; color: white;"></i>
                            </div>
                        </div>
                        
                        <h3 style="color: #28a745; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> ¡Correo Enviado!
                        </h3>
                        
                        <p style="color: #666; font-size: 15px; line-height: 1.6; margin-bottom: 20px;">
                            Hemos enviado un enlace de recuperación a tu correo electrónico:<br>
                            <strong id="emailEnviadoDestino" style="color: #007bff;"></strong>
                        </p>
                        
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 13px; color: #004085; text-align: left;">
                                <i class="fas fa-lightbulb"></i> <strong>Próximos pasos:</strong><br>
                                1. Revisa tu bandeja de entrada<br>
                                2. Haz clic en el enlace del correo<br>
                                3. Crea tu nueva contraseña<br>
                                <small style="color: #666;"><i class="fas fa-clock"></i> El enlace es válido por 1 hora</small>
                            </p>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="volverALogin()" style="width: 100%;">
                            <i class="fas fa-arrow-left"></i>
                            Volver al inicio de sesión
                        </button>
                    </div>
                </div>

                <!-- Paso 2: Campos de usuario y contraseña -->
                <div id="step2" class="login-step hidden">
                    <div id="selectedRole" class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <span>Tipo de cuenta: <strong id="roleText">Rol seleccionado</strong></span>
                        <button type="button" onclick="backToRoleSelection()" style="background: none; border: none; color: var(--color-ata-verde); float: right; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">DNI o Correo Electrónico</label>
                        <input type="text" id="username" class="form-input" placeholder="Ej: 12345678 o usuario@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contraseña</label>
                        <div class="password-container">
                            <input type="password" id="password" class="form-input password-input" placeholder="Ingrese su contraseña" required>
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                                <i class="fas fa-eye" id="password-icon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="handleLoginClick()">
                        <i class="fas fa-sign-in-alt"></i>
                        Iniciar Sesión
                    </button>
                    
                    <!-- Enlace "Olvidé mi contraseña" -->
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" onclick="mostrarRecuperacionPassword(); return false;" style="color: var(--color-ata-azul); font-size: 14px; text-decoration: none;">
                            <i class="fas fa-key"></i> ¿Olvidaste tu contraseña?
                        </a>
                    </div>
                    
                    <!-- Contenedor para mensajes de login -->
                    <div id="loginMessage" class="form-message">
                        <!-- Los mensajes aparecerán aquí -->
                    </div>
                    
                    <!-- Enlace para activar cuenta -->
                    <div id="activarCuentaLink" style="display: none; text-align: center; margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <i class="fas fa-info-circle" style="color: #856404;"></i>
                        <span style="color: #856404; font-size: 14px;">
                            ¿Aún no has activado tu cuenta? 
                            <a href="#" onclick="backToStep1bAndActivate(); return false;" style="color: var(--color-ata-verde); font-weight: bold; text-decoration: underline;">Activa tu cuenta aquí</a>
                        </span>
                    </div>
                    
                    <!-- Enlace para solicitar registro -->
                    <div id="solicitarRegistroLink" style="display: none; text-align: center; margin-top: 15px; padding: 12px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <i class="fas fa-exclamation-circle" style="color: #721c24;"></i>
                        <span style="color: #721c24; font-size: 14px;">
                            ¿Tu cuenta no está en el sistema? 
                            <a href="#" onclick="backToStep1bAndRequestForm(); return false;" style="color: var(--color-ata-verde); font-weight: bold; text-decoration: underline;">Solicita tu registro aquí</a>
                        </span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Aplicación Principal (oculta inicialmente) -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo">
                            <img src="./assets/images/INSIGNIA_I.E.ANTONIO_TORRES_ARAUJO.png" alt="Logo ATA" />
                        </div>
                        <div class="header-text">
                            <h1>Agenda Virtual ATA</h1>
                            <p>I.E. 80002 Antonio Torres Araujo</p>
                        </div>
                    </div>
                    
                    <div class="user-info">
                        <!-- Ícono de mensajes de soporte (solo admin) -->
                        <div id="messageInbox" class="message-inbox" style="display: none;" onclick="toggleMessageDropdown(event)" title="Mensajes de soporte">
                            <i class="fas fa-envelope"></i>
                            <span id="messageBadge" class="message-badge" style="display: none;">0</span>
                            
                            <!-- Dropdown de mensajes de soporte -->
                            <div id="messageDropdown" class="support-dropdown">
                                <div class="support-dropdown-header">
                                    <h4><i class="fas fa-envelope-open-text"></i> Mensajes</h4>
                                    <span class="ver-todos" onclick="irABandejaSoporte(event)">Ver todos →</span>
                                </div>
                                <div id="messageDropdownList" class="support-dropdown-list">
                                    <div class="message-empty">
                                        <i class="fas fa-inbox"></i>
                                        <p>No hay mensajes nuevos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Campanita de notificaciones -->
                        <div id="notificationBell" class="notification-bell" style="display: none;" onclick="toggleNotificationDropdown(event)" title="Notificaciones">
                            <i class="fas fa-bell"></i>
                            <span id="bellBadge" class="bell-badge" style="display: none;">0</span>
                            
                            <!-- Dropdown de notificaciones -->
                            <div id="notificationDropdown" class="notification-dropdown">
                                <div class="notification-dropdown-header">
                                    <!-- Título dinámico según rol -->
                                    <h4 id="notificationDropdownTitle"><i class="fas fa-bell"></i> Notificaciones</h4>
                                    <span id="notificationVerTodas" class="ver-todas" style="display: none;" onclick="irASolicitudesDesdeDropdown(event)">Ver todas →</span>
                                </div>
                                <div id="notificationDropdownList" class="notification-dropdown-list">
                                    <div class="notification-empty">
                                        <i class="fas fa-bell-slash"></i>
                                        <p>Cargando...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div id="userName" style="font-weight: 500;">Usuario</div>
                            <div id="userRole" style="font-size: 12px; opacity: 0.8;">Rol</div>
                        </div>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            Salir
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navegación según rol -->
        <nav id="mainNav" class="main-nav" style="background: var(--color-ata-verde); padding: 10px 0; position: sticky; top: 0; z-index: 900;">
            <div class="container">
                <ul class="nav-menu" style="justify-content: center;">
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                            <i class="fas fa-home"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item nav-incidencias" style="display: none;">
                        <a href="#incidencias" class="nav-link" onclick="showSection('incidencias')">
                            <i class="fas fa-plus-circle"></i>
                            Nueva Incidencia
                        </a>
                    </li>
                    <li class="nav-item nav-historial" style="display: none;">
                        <a href="#historial" class="nav-link" onclick="showSection('historial')">
                            <i class="fas fa-history"></i>
                            Historial
                        </a>
                    </li>
                    <li class="nav-item nav-reportes" style="display: none;">
                        <a href="#reportes" class="nav-link" onclick="showSection('reportes')">
                            <i class="fas fa-chart-bar"></i>
                            Reportes
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <main class="main-content">
            <div class="container">
                <!-- Dashboard -->
                <div id="dashboardSection" class="content-section">
                    <div class="page-title">
                        <h2 id="dashboardTitle">Panel de Control</h2>
                        <p id="dashboardSubtitle">Sistema de Gestión de Incidencias Escolares</p>
                    </div>

                    <!-- ═══════════════════════════════════════════════════════════════ -->
                    <!-- SECCIÓN: ESTADÍSTICAS GENERALES DEL SISTEMA -->
                    <!-- ═══════════════════════════════════════════════════════════════ -->
                    <div id="statsSection" style="margin-bottom: 35px;">
                        <!-- Título de la sección -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, var(--color-ata-verde), var(--color-ata-verde-claro)); width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; box-shadow: 0 4px 10px rgba(0, 107, 63, 0.3);">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div>
                                <h3 style="margin: 0; font-size: 20px; color: var(--color-ata-verde); font-weight: 600;" id="statsSectionTitle">Estadísticas Generales</h3>
                                <p style="margin: 3px 0 0; font-size: 13px; color: #6c757d;" id="statsSectionSubtitle">Resumen de incidencias del sistema</p>
                            </div>
                        </div>
                        
                        <!-- Tarjetas de estadísticas con animaciones -->
                        <div class="grid grid-4" id="statsGrid">
                            <div class="stats-card" style="position: relative;">
                                <div class="stats-loading" id="loadingTotal" style="position: absolute; top: 10px; right: 10px;">
                                    <i class="fas fa-circle-notch fa-spin" style="color: var(--color-ata-verde); font-size: 16px;"></i>
                                </div>
                                <div class="stats-check" id="checkTotal" style="display: none; position: absolute; top: 10px; right: 10px;">
                                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 16px;"></i>
                                </div>
                                <div class="stats-number" id="statTotalIncidencias">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #ccc;"></i>
                                </div>
                                <div class="stats-label">Total Incidencias</div>
                                <div class="stats-trend" id="trendTotal">
                                    <i class="fas fa-minus"></i> --
                                </div>
                            </div>
                            
                            <div class="stats-card" style="position: relative;">
                                <div class="stats-loading" id="loadingMes" style="position: absolute; top: 10px; right: 10px;">
                                    <i class="fas fa-circle-notch fa-spin" style="color: var(--color-ata-azul); font-size: 16px;"></i>
                                </div>
                                <div class="stats-check" id="checkMes" style="display: none; position: absolute; top: 10px; right: 10px;">
                                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 16px;"></i>
                                </div>
                                <div class="stats-number" id="statEsteMes">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #ccc;"></i>
                                </div>
                                <div class="stats-label">Este Mes</div>
                                <div class="stats-trend" id="trendMes">
                                    <i class="fas fa-minus"></i> --
                                </div>
                            </div>
                            
                            <div class="stats-card" style="position: relative;">
                                <div class="stats-loading" id="loadingPendientes" style="position: absolute; top: 10px; right: 10px;">
                                    <i class="fas fa-circle-notch fa-spin" style="color: #ffc107; font-size: 16px;"></i>
                                </div>
                                <div class="stats-check" id="checkPendientes" style="display: none; position: absolute; top: 10px; right: 10px;">
                                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 16px;"></i>
                                </div>
                                <div class="stats-number" id="statPendientes">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #ccc;"></i>
                                </div>
                                <div class="stats-label">Pendientes</div>
                                <div class="stats-trend" id="trendPendientes">
                                    <i class="fas fa-minus"></i> --
                                </div>
                            </div>
                            
                            <div class="stats-card" style="position: relative;">
                                <div class="stats-loading" id="loadingGraves" style="position: absolute; top: 10px; right: 10px;">
                                    <i class="fas fa-circle-notch fa-spin" style="color: #dc3545; font-size: 16px;"></i>
                                </div>
                                <div class="stats-check" id="checkGraves" style="display: none; position: absolute; top: 10px; right: 10px;">
                                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 16px;"></i>
                                </div>
                                <div class="stats-number" id="statCasosGraves">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #ccc;"></i>
                                </div>
                                <div class="stats-label">Casos Graves</div>
                                <div class="stats-trend" id="trendGraves">
                                    <i class="fas fa-minus"></i> --
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ═══════════════════════════════════════════════════════════════ -->
                    <!-- SEPARADOR VISUAL -->
                    <!-- ═══════════════════════════════════════════════════════════════ -->
                    <div style="border-top: 2px solid #e9ecef; margin-bottom: 30px;"></div>

                    <!-- Vista específica según rol -->
                    <div id="roleSpecificContent">
                        <!-- Se carga dinámicamente según el rol -->
                    </div>
                </div>

                <!-- Sección de Incidencias -->
                <div id="incidenciasSection" class="content-section" style="display: none;">
                    <div class="page-title">
                        <h2>Registro de Nueva Incidencia</h2>
                        <p>Complete los datos de la incidencia</p>
                    </div>

                    <div class="card">
                        <h3>
                            <i class="fas fa-plus-circle"></i>
                            Datos de la Incidencia
                        </h3>
                        
                        <form id="incidenciaForm" onsubmit="submitIncident(event)">
                            <div class="grid grid-2">
                                <div class="form-group" style="position: relative;">
                                    <label class="form-label">Buscar Estudiante</label>
                                    <div class="input-group">
                                        <input type="text" class="form-input" id="studentSearch" 
                                               placeholder="Escriba el nombre del estudiante..." 
                                               autocomplete="off"
                                               oninput="handleStudentSearch(this.value)">
                                        <input type="hidden" id="studentId">
                                        <div class="input-group-append">
                                            <span class="input-group-icon">
                                                <i class="fas fa-search"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <!-- Dropdown de resultados -->
                                    <div id="studentSearchResults" class="autocomplete-dropdown" style="display: none;">
                                        <!-- Se llena dinámicamente -->
                                    </div>
                                    <!-- Info del estudiante seleccionado -->
                                    <div id="studentSelectedInfo" style="display: none; margin-top: 8px; padding: 10px; background: #e8f5e9; border-radius: 8px; font-size: 13px;">
                                        <i class="fas fa-check-circle" style="color: var(--color-ata-verde);"></i>
                                        <span id="studentSelectedName"></span>
                                        <button type="button" onclick="clearStudentSelection()" style="float: right; background: none; border: none; color: #999; cursor: pointer;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Nivel y Aula</label>
                                    <select class="form-input" id="aulaSelect" required>
                                        <option value="">Seleccionar nivel y aula</option>
                                        
                                        <optgroup label="🧸 INICIAL">
                                            <option value="3A">3 años - A</option>
                                            <option value="3B">3 años - B</option>
                                            <option value="3C">3 años - C</option>
                                            <option value="3D">3 años - D</option>
                                            <option value="3E">3 años - E</option>
                                            <option value="4A">4 años - A</option>
                                            <option value="4B">4 años - B</option>
                                            <option value="4C">4 años - C</option>
                                            <option value="4D">4 años - D</option>
                                            <option value="4E">4 años - E</option>
                                            <option value="5A">5 años - A</option>
                                            <option value="5B">5 años - B</option>
                                            <option value="5C">5 años - C</option>
                                            <option value="5D">5 años - D</option>
                                            <option value="5E">5 años - E</option>
                                        </optgroup>
                                        
                                        <optgroup label="📚 PRIMARIA">
                                            <option value="1PA">1° Primaria - A</option>
                                            <option value="1PB">1° Primaria - B</option>
                                            <option value="1PC">1° Primaria - C</option>
                                            <option value="1PD">1° Primaria - D</option>
                                            <option value="1PE">1° Primaria - E</option>
                                            <option value="2PA">2° Primaria - A</option>
                                            <option value="2PB">2° Primaria - B</option>
                                            <option value="2PC">2° Primaria - C</option>
                                            <option value="2PD">2° Primaria - D</option>
                                            <option value="2PE">2° Primaria - E</option>
                                            <option value="3PA">3° Primaria - A</option>
                                            <option value="3PB">3° Primaria - B</option>
                                            <option value="3PC">3° Primaria - C</option>
                                            <option value="3PD">3° Primaria - D</option>
                                            <option value="3PE">3° Primaria - E</option>
                                            <option value="4PA">4° Primaria - A</option>
                                            <option value="4PB">4° Primaria - B</option>
                                            <option value="4PC">4° Primaria - C</option>
                                            <option value="4PD">4° Primaria - D</option>
                                            <option value="4PE">4° Primaria - E</option>
                                            <option value="5PA">5° Primaria - A</option>
                                            <option value="5PB">5° Primaria - B</option>
                                            <option value="5PC">5° Primaria - C</option>
                                            <option value="5PD">5° Primaria - D</option>
                                            <option value="5PE">5° Primaria - E</option>
                                            <option value="6PA">6° Primaria - A</option>
                                            <option value="6PB">6° Primaria - B</option>
                                            <option value="6PC">6° Primaria - C</option>
                                            <option value="6PD">6° Primaria - D</option>
                                            <option value="6PE">6° Primaria - E</option>
                                        </optgroup>
                                        
                                        <optgroup label="🎓 SECUNDARIA">
                                            <option value="1SA">1° Secundaria - A</option>
                                            <option value="1SB">1° Secundaria - B</option>
                                            <option value="1SC">1° Secundaria - C</option>
                                            <option value="1SD">1° Secundaria - D</option>
                                            <option value="1SE">1° Secundaria - E</option>
                                            <option value="2SA">2° Secundaria - A</option>
                                            <option value="2SB">2° Secundaria - B</option>
                                            <option value="2SC">2° Secundaria - C</option>
                                            <option value="2SD">2° Secundaria - D</option>
                                            <option value="2SE">2° Secundaria - E</option>
                                            <option value="3SA">3° Secundaria - A</option>
                                            <option value="3SB">3° Secundaria - B</option>
                                            <option value="3SC">3° Secundaria - C</option>
                                            <option value="3SD">3° Secundaria - D</option>
                                            <option value="3SE">3° Secundaria - E</option>
                                            <option value="4SA">4° Secundaria - A</option>
                                            <option value="4SB">4° Secundaria - B</option>
                                            <option value="4SC">4° Secundaria - C</option>
                                            <option value="4SD">4° Secundaria - D</option>
                                            <option value="4SE">4° Secundaria - E</option>
                                            <option value="5SA">5° Secundaria - A</option>
                                            <option value="5SB">5° Secundaria - B</option>
                                            <option value="5SC">5° Secundaria - C</option>
                                            <option value="5SD">5° Secundaria - D</option>
                                            <option value="5SE">5° Secundaria - E</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Selector de Tipo: Mérito o Demérito -->
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label class="form-label">Tipo de Registro</label>
                                    <select class="form-input" id="tipoRegistro" onchange="toggleMeritosDemeritosSections()" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="merito">🏆 MÉRITO (Reconocimiento)</option>
                                        <option value="demerito">⚠️ DEMÉRITO (Falta)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="severidadInfo" style="display: none;">
                                    <label class="form-label">Severidad (Automática)</label>
                                    <div class="severity-info" id="severidadDisplay" style="padding: 8px; background: #f8f9fa; border-radius: 4px; color: #666;">
                                        Se calcula automáticamente según el tipo y historial
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN DE MÉRITOS -->
                            <div id="meritosSection" class="form-section" style="display: none;">
                                <h4 style="color: var(--color-ata-verde); margin: 20px 0 10px 0;"><i class="fas fa-star"></i> MÉRITOS - Seleccione el reconocimiento</h4>
                                
                                <div class="form-group">
                                    <label class="form-label">Categoría y Mérito</label>
                                    <select class="form-input" id="meritoSelect">
                                        <option value="">Seleccionar mérito</option>
                                        
                                        <optgroup label="🎯 RESPONSABILIDAD">
                                            <option value="RESP-A">A. Participación destacada en actos cívicos u otros eventos internos</option>
                                            <option value="RESP-B">B. Mantiene adecuada presentación personal durante un mes</option>
                                            <option value="RESP-C">C. Puntualidad y asistencia a actividades académicas</option>
                                            <option value="RESP-D">D. Porta siempre su diario/agenda de comportamiento</option>
                                            <option value="RESP-E">E. Cuida mobiliario e infraestructura</option>
                                            <option value="RESP-F">F. Colabora espontáneamente con la limpieza del aula y el plantel</option>
                                            <option value="RESP-G">G. Mantiene la agenda/diario en buen estado</option>
                                            <option value="RESP-H">H. Cumple los compromisos establecidos</option>
                                        </optgroup>
                                        
                                        <optgroup label="🤝 RESPETO">
                                            <option value="RESP-I">I. Saluda con cortesía a miembros de la I.E. y adultos</option>
                                            <option value="RESP-J">J. Respeta pertenencias de compañeros y devuelve objetos/dinero hallados</option>
                                            <option value="RESP-K">K. Cuida infraestructura, áreas verdes, mobiliario y equipos</option>
                                        </optgroup>
                                        
                                        <optgroup label="❤️ SOLIDARIDAD">
                                            <option value="SOL-N">N. Participa en campañas de mejora institucional</option>
                                            <option value="SOL-O">O. Participa responsablemente en actividades comunales</option>
                                            <option value="SOL-P">P. Apoya a compañeros en dificultad</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN DE DEMÉRITOS -->
                            <div id="demeritosSection" class="form-section" style="display: none;">
                                <h4 style="color: #dc3545; margin: 20px 0 10px 0;"><i class="fas fa-exclamation-triangle"></i> DEMÉRITOS - Seleccione la falta</h4>
                                
                                <div class="form-group">
                                    <label class="form-label">Categoría y Falta</label>
                                    <select class="form-input" id="demeritoSelect" onchange="updateSeverityInfo(); handleOtrasSelection();">
                                        <option value="">Cargando faltas...</option>
                                        <!-- Se carga dinámicamente desde la base de datos -->
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Descripción Detallada</label>
                                <textarea class="form-input" id="descripcionDetallada" style="min-height: 100px; resize: vertical;" placeholder="Describa la situación detalladamente..." required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Testigos (opcional)</label>
                                <input type="text" class="form-input" id="testigos" placeholder="Nombres de testigos">
                            </div>
                            
                            <!-- Información de Escalamiento (si aplica) -->
                            <div id="escalamientoInfo" class="alert" style="display: none; margin-top: 15px;">
                                <div class="alert-content">
                                    <strong><i class="fas fa-info-circle"></i> Sistema de Escalamiento Automático:</strong>
                                    <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                                        <li><strong>Faltas Leves:</strong> 3 en una semana → Alerta a tutor/padre | 5 en un bimestre → Citación TOE</li>
                                        <li><strong>Faltas Graves/Muy Graves:</strong> Derivación inmediata a TOE/Dirección</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                                <button type="button" class="btn btn-secondary" onclick="showSection('dashboard')">
                                    <i class="fas fa-times"></i>
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Registrar Incidencia
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sección de Historial -->
                <div id="historialSection" class="content-section" style="display: none;">
                    <div class="page-title">
                        <h2 id="historialTitulo">Historial de Incidencias</h2>
                        <p id="historialSubtitulo">Consulte el registro histórico</p>
                    </div>

                    <!-- Contenido para Docentes/Tutores/etc -->
                    <div id="historialDocenteContent" class="card">
                        <h3 id="historialCardTitulo">
                            <i class="fas fa-history"></i>
                            Incidencias Registradas
                        </h3>
                        
                        <div class="table-container">
                            <table class="table" id="historialTable">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Estudiante</th>
                                        <th>Aula</th>
                                        <th>Tipo</th>
                                        <th>Severidad</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historialTableBody">
                                    <!-- Se carga dinámicamente desde Supabase -->
                                    <tr id="historialEmpty">
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                            No hay incidencias registradas aún.<br>
                                            <small>Las incidencias que registres aparecerán aquí.</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Contenido especial para Padres (incidencias LEÍDAS) -->
                    <div id="historialPadreContent" style="display: none;">
                        <!-- Se carga dinámicamente -->
                    </div>
                </div>

                <!-- Sección de Reportes -->
                <div id="reportesSection" class="content-section" style="display: none;">
                    <div class="page-title">
                        <h2 id="reportesTitulo">Reportes e Indicadores</h2>
                        <p id="reportesSubtitulo">Análisis y estadísticas institucionales</p>
                    </div>

                    <div class="card">
                        <h3>
                            <i class="fas fa-chart-pie"></i>
                            Resumen por Aulas - <span id="reportesMesActual">Cargando...</span>
                        </h3>
                        
                        <div id="reportesAulasContainer" class="grid grid-3">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #666;"></i>
                                <p style="color: #666; margin-top: 10px;">Cargando estadísticas...</p>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h3>
                            <i class="fas fa-chart-bar"></i>
                            Resumen General
                        </h3>
                        <div id="reportesResumenGeneral" class="grid grid-4">
                            <div class="stats-card">
                                <div class="stats-number" id="reporteTotalIncidencias">0</div>
                                <div class="stats-label">Total Incidencias</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="reporteTotalMeritos">0</div>
                                <div class="stats-label">Méritos</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="reporteTotalDemeritos">0</div>
                                <div class="stats-label">Deméritos</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="reporteTotalEstudiantes">796</div>
                                <div class="stats-label">Estudiantes</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Administración (Solo para Administradores) -->
                <div id="adminSection" class="content-section" style="display: none;">
                    <div class="page-title">
                        <h2><i class="fas fa-crown" style="color: var(--color-ata-dorado);"></i> Panel de Administración</h2>
                        <p>Gestión completa del sistema ATA - Control total de usuarios, incidencias y configuración</p>
                    </div>
                    
                    <!-- Navegación de pestañas del Admin -->
                    <div class="admin-tabs" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-primary admin-tab-btn active" onclick="showAdminTab('dashboard')" id="tabAdminDashboard">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </button>
                        <button class="btn btn-secondary admin-tab-btn" onclick="showAdminTab('usuarios')" id="tabAdminUsuarios">
                            <i class="fas fa-users"></i> Usuarios
                        </button>
                        <button class="btn btn-secondary admin-tab-btn" onclick="showAdminTab('solicitudes')" id="tabAdminSolicitudes">
                            <i class="fas fa-clipboard-check"></i> Solicitudes <span id="badgeSolicitudes" class="admin-badge" style="display:none;">0</span>
                        </button>
                        <button class="btn btn-secondary admin-tab-btn" onclick="showAdminTab('incidencias')" id="tabAdminIncidencias">
                            <i class="fas fa-exclamation-triangle"></i> Incidencias
                        </button>
                        <button class="btn btn-secondary admin-tab-btn" onclick="showAdminTab('estudiantes')" id="tabAdminEstudiantes">
                            <i class="fas fa-user-graduate"></i> Estudiantes
                        </button>
                        <button class="btn btn-secondary admin-tab-btn" onclick="showAdminTab('exportar')" id="tabAdminExportar">
                            <i class="fas fa-file-export"></i> Exportar
                        </button>
                        <button class="btn btn-secondary admin-tab-btn" onclick="showAdminTab('soporte')" id="tabAdminSoporte">
                            <i class="fas fa-envelope"></i> Soporte <span id="badgeSoporte" class="admin-badge" style="display:none; background: var(--color-ata-azul);">0</span>
                        </button>
                    </div>
                    
                    <!-- TAB: Dashboard Principal -->
                    <div id="adminTabDashboard" class="admin-tab-content">
                        <div class="grid grid-4" style="margin-bottom: 20px;">
                            <div class="card stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                <div class="stats-number" id="adminTotalUsuarios" style="font-size: 32px;">0</div>
                                <div class="stats-label">Total Usuarios</div>
                            </div>
                            <div class="card stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                                <div class="stats-number" id="adminTotalIncidencias" style="font-size: 32px;">0</div>
                                <div class="stats-label">Total Incidencias</div>
                            </div>
                            <div class="card stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                <div class="stats-number" id="adminTotalEstudiantes" style="font-size: 32px;">0</div>
                                <div class="stats-label">Estudiantes</div>
                            </div>
                            <div class="card stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                                <div class="stats-number" id="adminSolicitudesPendientes" style="font-size: 32px;">0</div>
                                <div class="stats-label">Solicitudes Pendientes</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-2">
                            <div class="card">
                                <h3><i class="fas fa-chart-pie"></i> Distribución por Rol</h3>
                                <div id="adminDistribucionRoles" style="margin-top: 15px;">
                                    <p style="color: #666;">Cargando...</p>
                                </div>
                            </div>
                            <div class="card">
                                <h3><i class="fas fa-calendar-alt"></i> Incidencias Este Mes</h3>
                                <div class="stats-number" id="adminIncidenciasMes" style="font-size: 48px; color: var(--color-ata-rojo);">0</div>
                                <div id="adminIncidenciasPorTipo" style="margin-top: 15px;">
                                    <p style="color: #666;">Cargando...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 20px;">
                            <h3><i class="fas fa-history"></i> Actividad Reciente del Sistema</h3>
                            <div id="adminActividadReciente" style="max-height: 300px; overflow-y: auto;">
                                <p style="color: #666;">Cargando actividad...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TAB: Gestión de Usuarios -->
                    <div id="adminTabUsuarios" class="admin-tab-content" style="display: none;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                                <h3><i class="fas fa-users-cog"></i> Gestión de Usuarios</h3>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="mostrarModalCrearUsuario()">
                                        <i class="fas fa-plus-circle"></i> Crear Usuario
                                    </button>
                                    <button class="btn btn-success" onclick="exportarUsuariosCSV()">
                                        <i class="fas fa-download"></i> Exportar CSV
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtros -->
                            <div class="grid grid-4" style="gap: 10px; margin-bottom: 15px;">
                                <input type="text" id="filtroUsuarioNombre" placeholder="Buscar por nombre..." class="form-control" oninput="filtrarUsuariosAdmin()">
                                <select id="filtroUsuarioRol" class="form-control" onchange="filtrarUsuariosAdmin()">
                                    <option value="">Todos los roles</option>
                                    <option value="admin">Administrador</option>
                                    <option value="docente">Docente</option>
                                    <option value="tutor">Tutor</option>
                                    <option value="auxiliar">Auxiliar</option>
                                    <option value="toe">TOE</option>
                                    <option value="padre">Padre</option>
                                    <option value="director">Director</option>
                                </select>
                                <select id="filtroUsuarioEstado" class="form-control" onchange="filtrarUsuariosAdmin()">
                                    <option value="">Todos los estados</option>
                                    <option value="activo">Activos</option>
                                    <option value="inactivo">Inactivos</option>
                                </select>
                                <button class="btn btn-secondary" onclick="cargarUsuariosAdmin()">
                                    <i class="fas fa-sync"></i> Actualizar
                                </button>
                            </div>
                            
                            <!-- Tabla de usuarios -->
                            <div style="overflow-x: auto;">
                                <table class="data-table" id="tablaUsuariosAdmin">
                                    <thead>
                                        <tr>
                                            <th>Nombre Completo</th>
                                            <th>Email</th>
                                            <th>Rol</th>
                                            <th>Estado Sistema</th>
                                            <th>Cuenta</th>
                                            <th>Fecha Registro</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyUsuariosAdmin">
                                        <tr><td colspan="7" style="text-align: center;">Cargando usuarios...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TAB: Solicitudes Pendientes -->
                    <div id="adminTabSolicitudes" class="admin-tab-content" style="display: none;">
                        <div class="card">
                            <h3><i class="fas fa-clipboard-check"></i> Solicitudes de Registro Pendientes</h3>
                            <p style="color: #666; margin-bottom: 20px;">Usuarios que se han registrado y esperan aprobación para activar su cuenta.</p>
                            
                            <div id="listaSolicitudesPendientes">
                                <p style="color: #666;">Cargando solicitudes...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TAB: Gestión de Incidencias -->
                    <div id="adminTabIncidencias" class="admin-tab-content" style="display: none;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                                <h3><i class="fas fa-exclamation-triangle"></i> Todas las Incidencias</h3>
                                <button class="btn btn-success" onclick="exportarIncidenciasCSV()">
                                    <i class="fas fa-download"></i> Exportar CSV
                                </button>
                            </div>
                            
                            <!-- Filtros de incidencias -->
                            <div class="grid grid-4" style="gap: 10px; margin-bottom: 15px;">
                                <input type="text" id="filtroIncidenciaBuscar" placeholder="Buscar estudiante..." class="form-control" oninput="filtrarIncidenciasAdmin()">
                                <select id="filtroIncidenciaTipo" class="form-control" onchange="filtrarIncidenciasAdmin()">
                                    <option value="">Todos los tipos</option>
                                    <option value="merito">Méritos</option>
                                    <option value="demerito">Deméritos</option>
                                </select>
                                <select id="filtroIncidenciaGrado" class="form-control" onchange="filtrarIncidenciasAdmin()">
                                    <option value="">Todos los grados</option>
                                    <option value="1">1° Grado</option>
                                    <option value="2">2° Grado</option>
                                    <option value="3">3° Grado</option>
                                    <option value="4">4° Grado</option>
                                    <option value="5">5° Grado</option>
                                </select>
                                <button class="btn btn-secondary" onclick="cargarIncidenciasAdmin()">
                                    <i class="fas fa-sync"></i> Actualizar
                                </button>
                            </div>
                            
                            <!-- Tabla de incidencias -->
                            <div style="overflow-x: auto;">
                                <table class="data-table" id="tablaIncidenciasAdmin">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Estudiante</th>
                                            <th>Grado</th>
                                            <th>Tipo</th>
                                            <th>Descripción</th>
                                            <th>Registrado por</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyIncidenciasAdmin">
                                        <tr><td colspan="7" style="text-align: center;">Cargando incidencias...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TAB: Gestión de Estudiantes -->
                    <div id="adminTabEstudiantes" class="admin-tab-content" style="display: none;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                                <h3><i class="fas fa-user-graduate"></i> Gestión de Estudiantes</h3>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="mostrarModalCrearEstudiante()">
                                        <i class="fas fa-plus-circle"></i> Agregar Estudiante
                                    </button>
                                    <button class="btn btn-success" onclick="exportarEstudiantesCSV()">
                                        <i class="fas fa-download"></i> Exportar CSV
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Filtros -->
                            <div class="grid grid-4" style="gap: 10px; margin-bottom: 15px;">
                                <input type="text" id="filtroEstudianteNombre" placeholder="Buscar por nombre..." class="form-control" oninput="filtrarEstudiantesAdmin()">
                                <select id="filtroEstudianteGrado" class="form-control" onchange="filtrarEstudiantesAdmin()">
                                    <option value="">Todos los grados</option>
                                    <option value="1">1° Grado</option>
                                    <option value="2">2° Grado</option>
                                    <option value="3">3° Grado</option>
                                    <option value="4">4° Grado</option>
                                    <option value="5">5° Grado</option>
                                </select>
                                <select id="filtroEstudianteSeccion" class="form-control" onchange="filtrarEstudiantesAdmin()">
                                    <option value="">Todas las secciones</option>
                                    <option value="A">Sección A</option>
                                    <option value="B">Sección B</option>
                                    <option value="C">Sección C</option>
                                    <option value="D">Sección D</option>
                                    <option value="E">Sección E</option>
                                </select>
                                <button class="btn btn-secondary" onclick="cargarEstudiantesAdmin()">
                                    <i class="fas fa-sync"></i> Actualizar
                                </button>
                            </div>
                            
                            <!-- Tabla de estudiantes -->
                            <div style="overflow-x: auto;">
                                <table class="data-table" id="tablaEstudiantesAdmin">
                                    <thead>
                                        <tr>
                                            <th>Nombre Completo</th>
                                            <th>DNI</th>
                                            <th>Grado</th>
                                            <th>Sección</th>
                                            <th>Padre/Apoderado</th>
                                            <th>Estado Sistema</th>
                                            <th>Cuenta Apoderado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyEstudiantesAdmin">
                                        <tr><td colspan="8" style="text-align: center;">Cargando estudiantes...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- TAB: Exportar Datos -->
                    <div id="adminTabExportar" class="admin-tab-content" style="display: none;">
                        <div class="grid grid-2">
                            <div class="card">
                                <h3><i class="fas fa-file-csv"></i> Exportar a CSV</h3>
                                <p style="color: #666; margin-bottom: 20px;">Descarga los datos en formato CSV para Excel.</p>
                                <div class="grid grid-2" style="gap: 10px;">
                                    <button class="btn btn-success" onclick="exportarUsuariosCSV()">
                                        <i class="fas fa-users"></i> Usuarios
                                    </button>
                                    <button class="btn btn-success" onclick="exportarIncidenciasCSV()">
                                        <i class="fas fa-exclamation-triangle"></i> Incidencias
                                    </button>
                                    <button class="btn btn-success" onclick="exportarEstudiantesCSV()">
                                        <i class="fas fa-user-graduate"></i> Estudiantes
                                    </button>
                                    <button class="btn btn-success" onclick="exportarMeritosDemeritos()">
                                        <i class="fas fa-star"></i> Méritos/Deméritos
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h3><i class="fas fa-file-pdf"></i> Generar Reportes</h3>
                                <p style="color: #666; margin-bottom: 20px;">Genera reportes oficiales para UGEL.</p>
                                <div class="grid grid-2" style="gap: 10px;">
                                    <button class="btn btn-primary" onclick="generarReporteGeneral()">
                                        <i class="fas fa-chart-bar"></i> Reporte General
                                    </button>
                                    <button class="btn btn-primary" onclick="generarReporteMensual()">
                                        <i class="fas fa-calendar"></i> Reporte Mensual
                                    </button>
                                    <button class="btn btn-primary" onclick="generarReporteIncidencias()">
                                        <i class="fas fa-file-alt"></i> Incidencias
                                    </button>
                                    <button class="btn btn-primary" onclick="generarReporteUGEL()">
                                        <i class="fas fa-building"></i> Formato UGEL
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 20px;">
                            <h3><i class="fas fa-database"></i> Backup de Datos</h3>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> La base de datos está alojada en Supabase con backup automático diario.
                            </div>
                            <button class="btn btn-warning" onclick="exportarBackupCompleto()">
                                <i class="fas fa-save"></i> Descargar Backup Completo (JSON)
                            </button>
                        </div>
                    </div>
                    
                    <!-- TAB: Mensajes de Soporte -->
                    <div id="adminTabSoporte" class="admin-tab-content" style="display: none;">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <h3 style="margin: 0;"><i class="fas fa-envelope"></i> Bandeja de Mensajes de Soporte</h3>
                                    <p style="color: #666; margin: 5px 0 0 0;">Mensajes de ayuda enviados por usuarios del sistema.</p>
                                </div>
                                <button class="btn btn-danger" onclick="vaciarTodosMensajesTabla()" title="Vaciar todos los mensajes">
                                    <i class="fas fa-trash-alt"></i> Vaciar todo
                                </button>
                            </div>
                            
                            <div class="table-container">
                                <table class="table" id="tablaSoporte">
                                    <thead>
                                        <tr>
                                            <th>Estado</th>
                                            <th>Remitente</th>
                                            <th>Rol</th>
                                            <th>Mensaje</th>
                                            <th>Fecha</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodySoporte">
                                        <tr>
                                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                                <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                                <p>Cargando mensajes...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal para detalles de incidencia -->
        <div id="modalDetalleIncidencia" class="modal-overlay" style="display: none;">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 id="modalTitulo"><i class="fas fa-file-alt"></i> Detalle de Incidencia</h3>
                    <button class="modal-close" onclick="cerrarModalDetalle()">&times;</button>
                </div>
                <div class="modal-body" id="modalContenido">
                    <p>Cargando...</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="cerrarModalDetalle()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmación de Lectura (para padres) -->
        <div id="modalConfirmarLectura" class="modal-overlay" style="display: none;">
            <div class="modal-container" style="max-width: 450px;">
                <div class="modal-header" style="background: var(--color-ata-azul);">
                    <h3><i class="fas fa-question-circle"></i> Confirmar Lectura</h3>
                    <button class="modal-close" onclick="cerrarModalConfirmacion()">&times;</button>
                </div>
                <div class="modal-body" style="text-align: center; padding: 30px;">
                    <i class="fas fa-envelope-open-text" style="font-size: 60px; color: var(--color-ata-azul); margin-bottom: 20px;"></i>
                    <h4 style="margin-bottom: 15px; color: #333;">¿Confirmas que has leído esta incidencia?</h4>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                        Al confirmar, el docente/tutor será notificado que has revisado esta información sobre tu hijo(a).
                    </p>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; text-align: left;">
                            <i class="fas fa-comment"></i> Comentario (opcional):
                        </label>
                        <textarea id="comentarioPadreModal" class="form-input" rows="3" placeholder="Puedes agregar un comentario u opinión sobre esta incidencia..." style="width: 100%; resize: vertical;"></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="justify-content: center; gap: 15px;">
                    <button class="btn btn-secondary" onclick="cerrarModalConfirmacion()" style="width: auto; padding: 12px 30px;">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button class="btn btn-success" onclick="ejecutarConfirmacionLectura()" style="width: auto; padding: 12px 30px; background: var(--color-ata-verde);">
                        <i class="fas fa-check"></i> Confirmar Lectura
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de Éxito (Incidencia Confirmada) -->
        <div id="modalLecturaConfirmada" class="modal-overlay" style="display: none;">
            <div class="modal-container" style="max-width: 400px;">
                <div class="modal-header" style="background: var(--color-ata-verde);">
                    <h3><i class="fas fa-check-circle"></i> ¡Confirmado!</h3>
                    <button class="modal-close" onclick="cerrarModalExito()">&times;</button>
                </div>
                <div class="modal-body" style="text-align: center; padding: 40px;">
                    <div style="width: 80px; height: 80px; background: #e8f5e9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                        <i class="fas fa-check" style="font-size: 40px; color: var(--color-ata-verde);"></i>
                    </div>
                    <h4 style="color: var(--color-ata-verde); margin-bottom: 10px;">Incidencia Revisada</h4>
                    <p style="color: #666; font-size: 14px;">
                        Tu confirmación ha sido registrada exitosamente. El docente/tutor podrá ver que has revisado esta incidencia.
                    </p>
                </div>
                <div class="modal-footer" style="justify-content: center;">
                    <button class="btn btn-primary" onclick="cerrarModalExito()" style="width: auto; padding: 12px 40px;">
                        <i class="fas fa-thumbs-up"></i> Entendido
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-text">
                        <p>&copy; 2025 I.E. 80002 Antonio Torres Araujo - Agenda Virtual ATA</p>
                        <p>Sistema de Gestión de Incidencias Escolares</p>
                    </div>
                    <div class="footer-links">
                        <a href="#" onclick="mostrarFormularioSoporte(); return false;">
                            <i class="fas fa-question-circle"></i>
                            Ayuda
                        </a>
                        <a href="#" onclick="mostrarManual(); return false;">
                            <i class="fas fa-book"></i>
                            Manual
                        </a>
                        <a href="#" onclick="mostrarFormularioSoporte(); return false;">
                            <i class="fas fa-envelope"></i>
                            Contacto
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://jbdjlivrfkrcivkrnuio.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpiZGpsaXZyZmtyY2l2a3JudWlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNDA5ODgsImV4cCI6MjA3ODcxNjk4OH0.eZnzV0EJgVtYe_evH-xQX5gmT8T6uKI09D3PRUB0fcI';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Usuarios de prueba según roles acordados en las charlas
        const users = {
            // Usuarios originales
            'docente': {
                password: '123',
                name: 'Prof. María González',
                role: 'Docente',
                permissions: ['dashboard', 'incidencias', 'historial']
            },
            'tutor': {
                password: '123',
                name: 'Prof. Kelly Rodríguez',
                role: 'Tutor 1°B',
                permissions: ['dashboard', 'incidencias', 'historial']
            },
            'auxiliar': {
                password: '123',
                name: 'Aux. Carmen López',
                role: 'Auxiliar de Educación',
                permissions: ['dashboard', 'incidencias', 'historial']
            },
            'toe': {
                password: '123',
                name: 'Psic. Ana Morales',
                role: 'Coordinador TOE',
                permissions: ['dashboard', 'incidencias', 'historial', 'reportes']
            },
            'direccion': {
                password: '123',
                name: 'Dir. Carlos Vásquez',
                role: 'Director',
                permissions: ['dashboard', 'historial', 'reportes']
            },
            'padre': {
                password: '123',
                name: 'Sr. José Pérez',
                role: 'Padre de Familia',
                permissions: ['dashboard']
            },
            'admin': {
                password: '123',
                name: 'Admin. Sistema ATA',
                role: 'Administrador del Sistema',
                permissions: ['dashboard', 'incidencias', 'historial', 'reportes', 'admin', 'solicitudes']
            },
            // Usuarios demo auto-generados
            'demo_docente': {
                password: '123',
                name: 'Demo - Docente',
                role: 'Docente',
                permissions: ['dashboard', 'incidencias', 'historial'],
                isDemo: true
            },
            'demo_tutor': {
                password: '123',
                name: 'Demo - Tutor 1°B',
                role: 'Tutor',
                permissions: ['dashboard', 'incidencias', 'historial'],
                isDemo: true
            },
            'demo_auxiliar': {
                password: '123',
                name: 'Demo - Auxiliar de Educación',
                role: 'Auxiliar de Educación',
                permissions: ['dashboard', 'incidencias', 'historial'],
                isDemo: true
            },
            'demo_toe': {
                password: '123',
                name: 'Demo - Coordinador TOE',
                role: 'Coordinador TOE',
                permissions: ['dashboard', 'incidencias', 'historial', 'reportes'],
                isDemo: true
            },
            'demo_direccion': {
                password: '123',
                name: 'Demo - Director',
                role: 'Dirección',
                permissions: ['dashboard', 'historial', 'reportes'],
                isDemo: true
            },
            'demo_padre': {
                password: '123',
                name: 'Demo - Padre de Familia',
                role: 'Padre/Madre/Apoderado',
                permissions: ['dashboard'],
                isDemo: true
            },
            'demo_admin': {
                password: '123',
                name: 'Demo - Administrador Sistema',
                role: 'Administrador del Sistema',
                permissions: ['dashboard', 'incidencias', 'historial', 'reportes', 'admin', 'solicitudes'],
                isDemo: true
            }
        };

        let currentUser = null;

        // ============================================================================
        // FUNCIONES DE CONSULTA A SUPABASE - DATOS REALES
        // ============================================================================

        // Cache para evitar consultas repetidas
        let estudiantesCache = null;
        let catalogoMeritosCache = null;
        let catalogoDemeritosCache = null;
        let periodosCache = null;

        // Obtener período activo actual
        async function getPeriodoActivo() {
            if (periodosCache) return periodosCache;
            
            try {
                const { data, error } = await supabase
                    .from('periodos')
                    .select('*')
                    .eq('activo', true)
                    .single();
                
                if (error) throw error;
                periodosCache = data;
                return data;
            } catch (err) {
                console.error('Error obteniendo período activo:', err);
                return null;
            }
        }

        // Obtener estadísticas del dashboard para el usuario actual
        async function getEstadisticasUsuario(userId) {
            try {
                console.log('📊 Obteniendo estadísticas para usuario:', userId);
                
                const periodo = await getPeriodoActivo();
                const periodoId = periodo?.id;
                const now = new Date();
                const inicioMes = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-01`;
                
                console.log('📅 Parámetros de búsqueda:', {
                    userId,
                    periodoId,
                    inicioMes
                });
                
                // Total de incidencias registradas por este usuario
                const { count: totalIncidencias, error: error1 } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .eq('registrado_por', userId);
                
                console.log('📈 Total incidencias:', { count: totalIncidencias, error: error1 });
                
                // Incidencias de este mes
                const { count: esteMes, error: error2 } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .eq('registrado_por', userId)
                    .gte('fecha', inicioMes);
                
                console.log('📈 Este mes:', { count: esteMes, error: error2 });
                
                // Incidencias pendientes
                const { count: pendientes, error: error3 } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .eq('registrado_por', userId)
                    .eq('estado', 'pendiente');
                
                console.log('📈 Pendientes:', { count: pendientes, error: error3 });
                
                // Casos graves y muy graves
                const { count: casosGraves, error: error4 } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .eq('registrado_por', userId)
                    .in('severidad', ['grave', 'muy_grave']);
                
                console.log('📈 Casos graves:', { count: casosGraves, error: error4 });
                
                const result = {
                    totalIncidencias: totalIncidencias || 0,
                    esteMes: esteMes || 0,
                    pendientes: pendientes || 0,
                    casosGraves: casosGraves || 0
                };
                
                console.log('✅ Estadísticas calculadas:', result);
                
                return result;
            } catch (err) {
                console.error('❌ Error obteniendo estadísticas:', err);
                return { totalIncidencias: 0, esteMes: 0, pendientes: 0, casosGraves: 0 };
            }
        }

        // Función auxiliar para obtener el aula del tutor de forma consistente
        function obtenerAulaTutor() {
            if (!currentUser) return null;
            
            let grado = null;
            let seccion = null;
            
            // Primero intentar obtener de aulas_asignadas (BD)
            if (currentUser.aulas_asignadas) {
                const aulas = Array.isArray(currentUser.aulas_asignadas) 
                    ? currentUser.aulas_asignadas 
                    : [currentUser.aulas_asignadas];
                
                if (aulas.length > 0 && aulas[0]) {
                    const matchAula = aulas[0].match(/(\d+)([A-E])/i);
                    if (matchAula) {
                        grado = matchAula[1];
                        seccion = matchAula[2].toUpperCase();
                    }
                }
            }
            
            // Si no hay en BD, intentar con aulaAsignada (del rol)
            if (!grado && currentUser.aulaAsignada) {
                const matchAula = currentUser.aulaAsignada.match(/(\d+)°([A-E])/i);
                if (matchAula) {
                    grado = matchAula[1];
                    seccion = matchAula[2].toUpperCase();
                }
            }
            
            if (grado && seccion) {
                return { grado, seccion, aulaFormateada: `${grado}°${seccion}` };
            }
            
            return null;
        }

        // Obtener estadísticas del tutor - filtrando por SU aula asignada
        async function getEstadisticasTutor(grado, seccion) {
            try {
                console.log('📊 Obteniendo estadísticas del tutor para aula:', grado + '°' + seccion);
                
                const now = new Date();
                const inicioMes = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-01`;
                
                // Primero obtener los IDs de estudiantes de esta aula
                const { data: estudiantesAula, error: errorEstudiantes } = await supabase
                    .from('estudiantes')
                    .select('id')
                    .eq('grado', grado)
                    .eq('seccion', seccion)
                    .eq('activo', true);
                
                if (errorEstudiantes) throw errorEstudiantes;
                
                const idsEstudiantes = estudiantesAula?.map(e => e.id) || [];
                console.log('👥 Estudiantes en el aula:', idsEstudiantes.length);
                
                if (idsEstudiantes.length === 0) {
                    return { totalIncidencias: 0, esteMes: 0, pendientes: 0, casosGraves: 0 };
                }
                
                // Total de incidencias de estudiantes de esta aula
                const { count: totalIncidencias } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .in('estudiante_id', idsEstudiantes);
                
                // Incidencias de este mes
                const { count: esteMes } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .in('estudiante_id', idsEstudiantes)
                    .gte('fecha', inicioMes);
                
                // Incidencias pendientes
                const { count: pendientes } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .in('estudiante_id', idsEstudiantes)
                    .eq('estado', 'pendiente');
                
                // Casos graves y muy graves
                const { count: casosGraves } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .in('estudiante_id', idsEstudiantes)
                    .in('severidad', ['grave', 'muy_grave']);
                
                const result = {
                    totalIncidencias: totalIncidencias || 0,
                    esteMes: esteMes || 0,
                    pendientes: pendientes || 0,
                    casosGraves: casosGraves || 0
                };
                
                console.log('✅ Estadísticas del tutor calculadas:', result);
                
                return result;
            } catch (err) {
                console.error('❌ Error obteniendo estadísticas del tutor:', err);
                return { totalIncidencias: 0, esteMes: 0, pendientes: 0, casosGraves: 0 };
            }
        }

        // Actualizar UI del dashboard con estadísticas reales
        async function actualizarDashboardStats(mostrarAnimacion = true) {
            if (!currentUser || !currentUser.id) return;
            
            console.log('📊 Actualizando estadísticas del dashboard...');
            
            // Si se pide animación, mostrar efecto de actualización
            const statTotal = document.getElementById('statTotalIncidencias');
            const statMes = document.getElementById('statEsteMes');
            const statPendientes = document.getElementById('statPendientes');
            const statGraves = document.getElementById('statCasosGraves');
            
            if (mostrarAnimacion) {
                // Efecto de "actualizando" - pulso suave
                [statTotal, statMes, statPendientes, statGraves].forEach(el => {
                    if (el) {
                        el.style.opacity = '0.5';
                        el.style.transform = 'scale(0.95)';
                    }
                });
            }
            
            // Determinar qué estadísticas obtener según el rol
            let stats;
            const userRole = currentUser.role?.toLowerCase() || '';
            
            if (userRole.includes('tutor')) {
                // Para tutores, obtener estadísticas de su aula específica
                const aulaTutor = obtenerAulaTutor();
                if (aulaTutor) {
                    stats = await getEstadisticasTutor(aulaTutor.grado, aulaTutor.seccion);
                } else {
                    stats = await getEstadisticasUsuario(currentUser.id);
                }
            } else {
                // Para otros roles, estadísticas de lo que ellos registraron
                stats = await getEstadisticasUsuario(currentUser.id);
            }
            
            console.log('📈 Estadísticas obtenidas:', stats);
            
            // Función helper para mostrar el valor con animación
            function mostrarValorConCheck(elemento, valor, loadingId, checkId) {
                if (elemento) {
                    const valorAnterior = parseInt(elemento.textContent) || 0;
                    elemento.textContent = valor;
                    elemento.style.opacity = '1';
                    elemento.style.transform = 'scale(1)';
                    elemento.style.transition = 'all 0.3s ease';
                    
                    // Si el valor cambió, añadir efecto especial
                    if (valor !== valorAnterior) {
                        elemento.style.animation = 'none';
                        setTimeout(() => {
                            elemento.style.animation = 'pulse 0.5s ease';
                        }, 10);
                    } else {
                        elemento.style.animation = 'fadeInUp 0.4s ease';
                    }
                }
                // Ocultar loading y mostrar check
                const loading = document.getElementById(loadingId);
                const check = document.getElementById(checkId);
                if (loading) loading.style.display = 'none';
                if (check) {
                    check.style.display = 'block';
                    check.style.animation = 'checkPop 0.4s ease';
                }
            }
            
            // Mostrar valores con pequeño delay para efecto escalonado
            setTimeout(() => mostrarValorConCheck(statTotal, stats.totalIncidencias, 'loadingTotal', 'checkTotal'), 100);
            setTimeout(() => mostrarValorConCheck(statMes, stats.esteMes, 'loadingMes', 'checkMes'), 250);
            setTimeout(() => mostrarValorConCheck(statPendientes, stats.pendientes, 'loadingPendientes', 'checkPendientes'), 400);
            setTimeout(() => mostrarValorConCheck(statGraves, stats.casosGraves, 'loadingGraves', 'checkGraves'), 550);
            
            console.log('✅ Estadísticas del dashboard actualizadas');
        }

        // Obtener historial de incidencias del usuario actual
        async function getHistorialIncidencias(userId, limit = 50) {
            try {
                // Verificar si es tutor para mostrar todas las incidencias de su aula
                const userRole = currentUser?.role?.toLowerCase() || '';
                const esTutor = userRole.includes('tutor');
                
                let query = supabase
                    .from('incidencias')
                    .select(`
                        id,
                        fecha,
                        tipo,
                        severidad,
                        estado,
                        descripcion,
                        revisado_por_padre,
                        fecha_revision_padre,
                        comentario_padre,
                        estudiante:estudiantes(id, nombre_completo, grado, seccion),
                        catalogo_demerito:catalogo_demeritos(nombre),
                        catalogo_merito:catalogo_meritos(nombre)
                    `);
                
                // Si es tutor, obtener incidencias de su aula usando la función auxiliar
                if (esTutor) {
                    const aulaTutor = obtenerAulaTutor();
                    if (aulaTutor) {
                        // Obtener IDs de estudiantes de esta aula
                        const { data: estudiantesAula } = await supabase
                            .from('estudiantes')
                            .select('id')
                            .eq('grado', aulaTutor.grado)
                            .eq('seccion', aulaTutor.seccion)
                            .eq('activo', true);
                        
                        if (estudiantesAula && estudiantesAula.length > 0) {
                            const idsEstudiantes = estudiantesAula.map(e => e.id);
                            query = query.in('estudiante_id', idsEstudiantes);
                            console.log(`🎓 Tutor: Cargando historial del aula ${aulaTutor.aulaFormateada} (${idsEstudiantes.length} estudiantes)`);
                        }
                    }
                } else {
                    // Para otros roles, solo mostrar lo que ellos registraron
                    query = query.eq('registrado_por', userId);
                }
                
                const { data, error } = await query
                    .order('fecha', { ascending: false })
                    .limit(limit);
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Error obteniendo historial:', err);
                return [];
            }
        }

        // Renderizar tabla de historial
        async function renderizarHistorial() {
            if (!currentUser || !currentUser.id) return;
            
            const tbody = document.getElementById('historialTableBody');
            if (!tbody) return;
            
            // Actualizar títulos según el rol
            const userRole = currentUser?.role?.toLowerCase() || '';
            const esTutor = userRole.includes('tutor');
            const historialTitulo = document.getElementById('historialTitulo');
            const historialSubtitulo = document.getElementById('historialSubtitulo');
            const historialCardTitulo = document.getElementById('historialCardTitulo');
            
            if (esTutor) {
                const aulaTutor = obtenerAulaTutor();
                if (aulaTutor) {
                    if (historialTitulo) historialTitulo.textContent = `Historial del Aula ${aulaTutor.aulaFormateada}`;
                    if (historialSubtitulo) historialSubtitulo.textContent = 'Todas las incidencias de tu aula asignada';
                    if (historialCardTitulo) historialCardTitulo.innerHTML = `<i class="fas fa-history"></i> Incidencias del Aula ${aulaTutor.aulaFormateada}`;
                }
            } else {
                if (historialTitulo) historialTitulo.textContent = 'Historial de Incidencias';
                if (historialSubtitulo) historialSubtitulo.textContent = 'Consulte el registro histórico';
                if (historialCardTitulo) historialCardTitulo.innerHTML = '<i class="fas fa-history"></i> Incidencias Registradas';
            }
            
            const incidencias = await getHistorialIncidencias(currentUser.id);
            
            if (incidencias.length === 0) {
                const mensajeVacio = esTutor 
                    ? 'No hay incidencias en tu aula asignada.'
                    : 'No hay incidencias registradas aún.';
                const subMensaje = esTutor
                    ? 'Las incidencias de estudiantes de tu aula aparecerán aquí.'
                    : 'Las incidencias que registres aparecerán aquí.';
                
                tbody.innerHTML = `
                    <tr id="historialEmpty">
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            ${mensajeVacio}<br>
                            <small>${subMensaje}</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = incidencias.map(inc => {
                const estudiante = inc.estudiante;
                const aula = estudiante ? `${estudiante.grado}°${estudiante.seccion}` : '-';
                const nombreEstudiante = estudiante ? estudiante.nombre_completo : 'Desconocido';
                const tipoNombre = inc.tipo === 'merito' 
                    ? (inc.catalogo_merito?.nombre || 'Mérito')
                    : (inc.catalogo_demerito?.nombre || 'Demérito');
                
                const severidadClass = inc.severidad === 'leve' ? 'badge-leve' 
                    : inc.severidad === 'grave' ? 'badge-grave' 
                    : inc.severidad === 'muy_grave' ? 'badge-muy-grave' : '';
                
                const severidadText = inc.severidad === 'leve' ? 'Leve'
                    : inc.severidad === 'grave' ? 'Grave'
                    : inc.severidad === 'muy_grave' ? 'Muy Grave' : '-';
                
                const fecha = new Date(inc.fecha).toLocaleDateString('es-PE');
                
                // Estado de lectura del padre - más visible
                let estadoHTML = '';
                if (inc.revisado_por_padre) {
                    estadoHTML = '<span class="badge" style="background: #28a745; color: white;"><i class="fas fa-check-circle"></i> Leído</span>';
                } else {
                    estadoHTML = '<span class="badge" style="background: #6c757d; color: white;">Pendiente</span>';
                }
                
                return `
                    <tr>
                        <td>${fecha}</td>
                        <td>${nombreEstudiante}</td>
                        <td>${aula}</td>
                        <td>${tipoNombre}</td>
                        <td><span class="badge ${severidadClass}">${severidadText}</span></td>
                        <td>${estadoHTML}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="verDetalleIncidencia('${inc.id}')" style="padding: 6px 12px; font-size: 12px; width: auto;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ver detalle de una incidencia
        async function verDetalleIncidencia(incidenciaId) {
            const modal = document.getElementById('modalDetalleIncidencia');
            const contenido = document.getElementById('modalContenido');
            const titulo = document.getElementById('modalTitulo');
            
            modal.style.display = 'flex';
            contenido.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Cargando detalles...</p>';
            
            try {
                // Primero intentar con todas las relaciones
                let { data: inc, error } = await supabase
                    .from('incidencias')
                    .select(`
                        *,
                        estudiante:estudiantes(id, nombre_completo, dni, grado, seccion, nivel),
                        catalogo_demerito:catalogo_demeritos(codigo, nombre, descripcion, severidad, categoria),
                        catalogo_merito:catalogo_meritos(codigo, nombre, descripcion, area)
                    `)
                    .eq('id', incidenciaId)
                    .maybeSingle();
                
                // Si falla o no hay datos, intentar sin relaciones
                if (error || !inc) {
                    console.log('⚠️ Error con relaciones, intentando sin ellas:', error);
                    const result = await supabase
                        .from('incidencias')
                        .select('*')
                        .eq('id', incidenciaId)
                        .maybeSingle();
                    
                    if (result.error) throw result.error;
                    if (!result.data) throw new Error('Incidencia no encontrada');
                    inc = result.data;
                }
                
                // Determinar tipo y color
                const esMerito = inc.tipo === 'merito';
                const icono = esMerito ? 'fa-trophy' : 'fa-exclamation-triangle';
                const colorTipo = esMerito ? '#1976d2' : '#c1272d';
                
                titulo.innerHTML = `<i class="fas ${icono}" style="color: ${esMerito ? '#ffd700' : '#fff'}"></i> ${esMerito ? 'Mérito' : 'Demérito'} - Detalle`;
                
                const estudiante = inc.estudiante;
                const catalogo = esMerito ? inc.catalogo_merito : inc.catalogo_demerito;
                const registrador = inc.registrador;
                
                // Formatear fecha
                const fecha = new Date(inc.fecha).toLocaleDateString('es-PE', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                const fechaCreacion = new Date(inc.created_at).toLocaleString('es-PE');
                
                // Severidad badge
                let severidadHTML = '';
                if (!esMerito && inc.severidad) {
                    const sevClass = inc.severidad === 'leve' ? 'badge-leve' 
                        : inc.severidad === 'grave' ? 'badge-grave' : 'badge-muy-grave';
                    const sevText = inc.severidad === 'leve' ? 'Leve' 
                        : inc.severidad === 'grave' ? 'Grave' : 'Muy Grave';
                    severidadHTML = `<span class="badge ${sevClass}">${sevText}</span>`;
                }
                
                // Estado badge
                const estadoClass = inc.estado === 'resuelto' ? 'badge-leve' 
                    : inc.estado === 'revisado' ? 'badge-grave' : '';
                const estadoText = inc.estado === 'pendiente' ? 'Pendiente'
                    : inc.estado === 'revisado' ? 'Revisado' : 'Resuelto';
                
                contenido.innerHTML = `
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-user-graduate"></i> Estudiante:</div>
                        <div class="detalle-value">
                            <strong>${estudiante?.nombre_completo || 'N/A'}</strong>
                            <br><small>DNI: ${estudiante?.dni || 'N/A'} | ${estudiante?.grado}° ${estudiante?.seccion} - ${estudiante?.nivel}</small>
                        </div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-calendar"></i> Fecha:</div>
                        <div class="detalle-value">${fecha}</div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-tag"></i> Tipo:</div>
                        <div class="detalle-value">
                            <span style="color: ${colorTipo}; font-weight: 600;">
                                ${esMerito ? '🏆 MÉRITO' : '⚠️ DEMÉRITO'}
                            </span>
                            ${severidadHTML}
                        </div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-list-alt"></i> Categoría:</div>
                        <div class="detalle-value">
                            <strong>${catalogo?.nombre || 'N/A'}</strong>
                            <br><small>Código: ${catalogo?.codigo || inc.codigo || 'N/A'}</small>
                            ${catalogo?.descripcion ? `<br><small style="color: #666;">${catalogo.descripcion}</small>` : ''}
                        </div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-info-circle"></i> Estado:</div>
                        <div class="detalle-value"><span class="badge ${estadoClass}">${estadoText}</span></div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-user-tie"></i> Registrado por:</div>
                        <div class="detalle-value">
                            ${registrador?.nombre_completo || 'N/A'}
                            <br><small>Rol: ${registrador?.role || 'N/A'}</small>
                            <br><small>Fecha registro: ${fechaCreacion}</small>
                        </div>
                    </div>
                    
                    ${inc.descripcion ? `
                    <div style="margin-top: 20px;">
                        <div class="detalle-label" style="width: 100%; margin-bottom: 10px;">
                            <i class="fas fa-comment-alt"></i> Descripción / Observaciones:
                        </div>
                        <div class="detalle-descripcion">
                            ${inc.descripcion.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${inc.accion_requerida ? `
                    <div style="margin-top: 15px;">
                        <div class="detalle-label" style="width: 100%; margin-bottom: 10px;">
                            <i class="fas fa-tasks"></i> Acción Requerida:
                        </div>
                        <div class="detalle-descripcion" style="background: #fff3e0;">
                            ${inc.accion_requerida}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${currentUser && currentUser.role === 'padre' ? `
                    <div style="margin-top: 25px; padding: 20px; background: ${inc.revisado_por_padre ? '#e8f5e9' : '#fff3cd'}; border-radius: 8px; border-left: 4px solid ${inc.revisado_por_padre ? '#4caf50' : '#ffc107'};">
                        ${inc.revisado_por_padre ? `
                            <div style="text-align: center;">
                                <i class="fas fa-check-circle" style="font-size: 36px; color: #4caf50; margin-bottom: 10px;"></i>
                                <h4 style="color: #2e7d32; margin-bottom: 5px;">✅ Incidencia Revisada</h4>
                                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                                    Revisado el: ${new Date(inc.fecha_revision_padre).toLocaleString('es-PE')}
                                </p>
                                ${inc.comentario_padre ? `
                                    <div class="detalle-descripcion" style="background: white; text-align: left;">
                                        <strong>Tu comentario:</strong><br>
                                        ${inc.comentario_padre.replace(/\n/g, '<br>')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <h4 style="color: #856404; margin-bottom: 10px;">
                                <i class="fas fa-info-circle"></i> Confirma que has revisado esta incidencia
                            </h4>
                            <p style="color: #856404; font-size: 14px; margin-bottom: 15px;">
                                Al confirmar, el docente/tutor será notificado que has leído esta información.
                            </p>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">
                                    Comentario u opinión (opcional):
                                </label>
                                <textarea id="comentarioPadre" class="form-input" rows="3" placeholder="Puedes agregar un comentario sobre esta incidencia..." style="width: 100%; resize: vertical;"></textarea>
                            </div>
                            <button onclick="confirmarLecturaPadre('${inc.id}')" class="btn btn-success" style="width: 100%;">
                                <i class="fas fa-check"></i> Confirmar Lectura
                            </button>
                        `}
                    </div>
                    ` : ''}
                    
                    ${currentUser && currentUser.role !== 'padre' ? `
                    <div style="margin-top: 25px; padding: 20px; background: ${inc.revisado_por_padre ? '#e8f5e9' : '#fff3cd'}; border-radius: 8px; border-left: 4px solid ${inc.revisado_por_padre ? '#4caf50' : '#ffc107'};">
                        ${inc.revisado_por_padre ? `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-check-double" style="font-size: 24px; color: #4caf50;"></i>
                            <h4 style="color: #2e7d32; margin: 0;">✅ Padre/Apoderado ha revisado esta incidencia</h4>
                        </div>
                        <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            <i class="fas fa-clock"></i> Revisado el: <strong>${new Date(inc.fecha_revision_padre).toLocaleString('es-PE')}</strong>
                        </p>
                        ${inc.comentario_padre ? `
                            <div class="detalle-descripcion" style="background: white;">
                                <strong><i class="fas fa-comment"></i> Comentario del padre/apoderado:</strong><br>
                                ${inc.comentario_padre.replace(/\n/g, '<br>')}
                            </div>
                        ` : `
                            <p style="color: #666; font-size: 13px; font-style: italic;">Sin comentarios adicionales</p>
                        `}
                        ` : `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-clock" style="font-size: 20px; color: #856404;"></i>
                            <div>
                                <h4 style="color: #856404; margin: 0;">⏳ Pendiente de revisión por el padre/apoderado</h4>
                                <p style="color: #856404; font-size: 13px; margin: 5px 0 0;">El padre/apoderado aún no ha confirmado la lectura</p>
                            </div>
                        </div>
                        `}
                    </div>
                    ` : ''}
                `;
                
            } catch (err) {
                console.error('Error obteniendo detalle:', err);
                contenido.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #e74c3c;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>Error al cargar los detalles</p>
                        <small>${err.message}</small>
                    </div>
                `;
            }
        }
        
        // Cerrar modal de detalle
        function cerrarModalDetalle() {
            document.getElementById('modalDetalleIncidencia').style.display = 'none';
        }
        
        // Variable global para almacenar ID de incidencia a confirmar
        let incidenciaIdParaConfirmar = null;
        
        // Mostrar modal de confirmación de lectura (en lugar de alert)
        function confirmarLecturaPadre(incidenciaId) {
            if (!currentUser || currentUser.role !== 'padre') {
                mostrarAlerta('Solo los padres pueden confirmar la lectura de incidencias', 'Acceso Restringido', 'warning');
                return;
            }
            
            // Copiar comentario del textarea del detalle al modal de confirmación
            const comentarioOriginal = document.getElementById('comentarioPadre')?.value || '';
            document.getElementById('comentarioPadreModal').value = comentarioOriginal;
            
            // Guardar ID para usar después
            incidenciaIdParaConfirmar = incidenciaId;
            
            // Mostrar modal de confirmación
            document.getElementById('modalConfirmarLectura').style.display = 'flex';
        }
        
        // Cerrar modal de confirmación
        function cerrarModalConfirmacion() {
            document.getElementById('modalConfirmarLectura').style.display = 'none';
            incidenciaIdParaConfirmar = null;
        }
        
        // Cerrar modal de éxito
        function cerrarModalExito() {
            document.getElementById('modalLecturaConfirmada').style.display = 'none';
        }
        
        // Ejecutar la confirmación de lectura
        async function ejecutarConfirmacionLectura() {
            if (!incidenciaIdParaConfirmar) {
                console.error('No hay ID de incidencia para confirmar');
                return;
            }
            
            const comentario = document.getElementById('comentarioPadreModal')?.value || '';
            
            console.log('📝 Confirmando lectura de incidencia:', incidenciaIdParaConfirmar);
            
            try {
                // Primero verificar que la incidencia existe
                const { data: verificacion, error: errorVerif } = await supabase
                    .from('incidencias')
                    .select('id, revisado_por_padre, estudiante_id')
                    .eq('id', incidenciaIdParaConfirmar)
                    .single();
                
                console.log('🔍 Verificación incidencia:', verificacion, 'Error:', errorVerif);
                
                if (errorVerif || !verificacion) {
                    throw new Error('No se encontró la incidencia');
                }
                
                // Intentar actualización con RPC si está disponible, o directamente
                const { data, error } = await supabase
                    .from('incidencias')
                    .update({
                        revisado_por_padre: true,
                        fecha_revision_padre: new Date().toISOString(),
                        comentario_padre: comentario || null
                    })
                    .eq('id', incidenciaIdParaConfirmar)
                    .select();
                
                console.log('📤 Resultado update:', { data, error });
                
                if (error) {
                    console.error('❌ Error en update:', error);
                    throw error;
                }
                
                if (!data || data.length === 0) {
                    console.warn('⚠️ Update no afectó ninguna fila. Posible problema de permisos RLS.');
                    // Mostrar mensaje de éxito de todas formas pero avisar
                }
                
                console.log('✅ Incidencia actualizada:', data);
                
                // Cerrar modal de confirmación
                document.getElementById('modalConfirmarLectura').style.display = 'none';
                
                // Cerrar modal de detalle
                cerrarModalDetalle();
                
                // Mostrar modal de éxito
                document.getElementById('modalLecturaConfirmada').style.display = 'flex';
                
                // Recargar datos del portal del padre para ver el cambio
                if (currentUser && currentUser.role === 'padre') {
                    console.log('🔄 Recargando portal del padre...');
                    await cargarPortalPadre();
                    console.log('✅ Portal del padre recargado');
                }
                
                incidenciaIdParaConfirmar = null;
                
            } catch (err) {
                console.error('Error confirmando lectura:', err);
                mostrarAlerta('Error al confirmar la lectura: ' + err.message, 'Error', 'error');
            }
        }
        
        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('modalDetalleIncidencia');
            if (e.target === modal) {
                cerrarModalDetalle();
            }
        });

        // Buscar estudiantes para autocompletado
        async function buscarEstudiantes(query) {
            if (!query || query.length < 2) return [];
            
            try {
                const { data, error } = await supabase
                    .from('estudiantes')
                    .select('id, nombre_completo, dni, grado, seccion, nivel')
                    .ilike('nombre_completo', `%${query}%`)
                    .eq('activo', true)
                    .limit(10);
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Error buscando estudiantes:', err);
                return [];
            }
        }

        // Obtener catálogo de méritos
        async function getCatalogoMeritos() {
            if (catalogoMeritosCache) return catalogoMeritosCache;
            
            try {
                const { data, error } = await supabase
                    .from('catalogo_meritos')
                    .select('*')
                    .eq('vigente', true)
                    .order('codigo');
                
                if (error) throw error;
                catalogoMeritosCache = data || [];
                return catalogoMeritosCache;
            } catch (err) {
                console.error('Error obteniendo catálogo de méritos:', err);
                return [];
            }
        }

        // Obtener catálogo de deméritos
        async function getCatalogoDemeritros() {
            if (catalogoDemeritosCache) return catalogoDemeritosCache;
            
            try {
                const { data, error } = await supabase
                    .from('catalogo_demeritos')
                    .select('*')
                    .eq('vigente', true)
                    .order('severidad', { ascending: true })
                    .order('codigo');
                
                if (error) throw error;
                catalogoDemeritosCache = data || [];
                return catalogoDemeritosCache;
            } catch (err) {
                console.error('Error obteniendo catálogo de deméritos:', err);
                return [];
            }
        }

        // Cargar deméritos en el select dinámicamente desde la base de datos
        async function cargarDemeritosEnSelect() {
            const select = document.getElementById('demeritoSelect');
            if (!select) {
                console.log('⚠️ Select de deméritos no encontrado');
                return;
            }
            
            console.log('🔄 Cargando deméritos en select...');
            
            try {
                const demeritos = await getCatalogoDemeritros();
                console.log('📋 Deméritos obtenidos:', demeritos.length);
                
                // Limpiar select
                select.innerHTML = '<option value="">Seleccionar falta</option>';
                
                // Agrupar por severidad
                const severidades = {
                    'leve': { label: '🟡 FALTAS LEVES', items: [] },
                    'grave': { label: '🟠 FALTAS GRAVES', items: [] },
                    'muy_grave': { label: '🔴 FALTAS MUY GRAVES', items: [] }
                };
                
                // Organizar deméritos por severidad
                demeritos.forEach(d => {
                    const sev = d.severidad || 'leve';
                    if (severidades[sev]) {
                        severidades[sev].items.push(d);
                    }
                });
                
                // Crear optgroups por severidad
                Object.keys(severidades).forEach(sevKey => {
                    const grupo = severidades[sevKey];
                    if (grupo.items.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = grupo.label;
                        
                        // Agrupar por categoría dentro de cada severidad
                        const porCategoria = {};
                        grupo.items.forEach(d => {
                            const cat = d.categoria || 'General';
                            if (!porCategoria[cat]) {
                                porCategoria[cat] = [];
                            }
                            porCategoria[cat].push(d);
                        });
                        
                        // Agregar items agrupados por categoría
                        Object.keys(porCategoria).sort().forEach(cat => {
                            // Agregar separador de categoría como disabled option
                            const catOption = document.createElement('option');
                            catOption.disabled = true;
                            catOption.textContent = `    📋 ${cat.toUpperCase()}`;
                            catOption.style.fontWeight = 'bold';
                            optgroup.appendChild(catOption);
                            
                            // Agregar deméritos de esta categoría
                            porCategoria[cat].forEach(d => {
                                const option = document.createElement('option');
                                option.value = d.id; // Usar el ID de la base de datos
                                option.setAttribute('data-severity', d.severidad || 'leve');
                                option.setAttribute('data-codigo', d.codigo || '');
                                option.textContent = `${d.codigo || ''}) ${d.nombre}`;
                                optgroup.appendChild(option);
                            });
                        });
                        
                        select.appendChild(optgroup);
                    }
                });
                
                console.log('✅ Deméritos cargados en select correctamente');
                
            } catch (err) {
                console.error('❌ Error cargando deméritos en select:', err);
                select.innerHTML = '<option value="">Error cargando faltas - Reintente</option>';
            }
        }

        // Registrar nueva incidencia en Supabase
        async function registrarIncidencia(incidenciaData) {
            try {
                console.log('🔵 Iniciando registro de incidencia...');
                console.log('📋 Datos recibidos:', incidenciaData);
                
                const periodo = await getPeriodoActivo();
                console.log('📅 Período activo:', periodo);
                
                if (!periodo) {
                    throw new Error('No hay un período académico activo');
                }
                
                // Usar fecha local correctamente
                const hoy = new Date();
                const year = hoy.getFullYear();
                const month = String(hoy.getMonth() + 1).padStart(2, '0');
                const day = String(hoy.getDate()).padStart(2, '0');
                const fechaLocal = `${year}-${month}-${day}`;
                
                console.log('📆 Fecha a registrar:', fechaLocal);
                console.log('👤 Usuario registrando:', currentUser.id, currentUser.nombre);
                
                const insertData = {
                    estudiante_id: incidenciaData.estudianteId,
                    periodo_id: periodo.id,
                    tipo: incidenciaData.tipo,
                    catalogo_merito_id: incidenciaData.catalogoMeritoId || null,
                    catalogo_demerito_id: incidenciaData.catalogoDemeritoId || null,
                    codigo: incidenciaData.codigo || null,
                    descripcion: incidenciaData.descripcion,
                    severidad: incidenciaData.severidad || null,
                    registrado_por: currentUser.id,
                    estado: 'pendiente',
                    fecha: fechaLocal
                };
                
                console.log('📤 Datos a insertar:', insertData);
                
                const { data, error } = await supabase
                    .from('incidencias')
                    .insert(insertData)
                    .select()
                    .single();
                
                if (error) {
                    console.error('❌ Error de Supabase:', error);
                    throw error;
                }
                
                console.log('✅ Incidencia registrada exitosamente:', data);
                
                // =========================================================================
                // ACTUALIZAR GRADO/SECCIÓN DEL ESTUDIANTE SI CAMBIÓ
                // Esto permite que cuando un estudiante pase de año, al registrarle una
                // incidencia con su nuevo grado, se actualice automáticamente en la BD
                // =========================================================================
                if (incidenciaData.nuevoGrado && incidenciaData.nuevaSeccion) {
                    const gradoActual = incidenciaData.gradoActual;
                    const seccionActual = incidenciaData.seccionActual;
                    
                    // Verificar si el grado o sección cambió
                    if (gradoActual !== incidenciaData.nuevoGrado || seccionActual !== incidenciaData.nuevaSeccion) {
                        console.log('📝 Actualizando grado/sección del estudiante...');
                        console.log(`   Anterior: ${gradoActual}°${seccionActual} → Nuevo: ${incidenciaData.nuevoGrado}°${incidenciaData.nuevaSeccion}`);
                        
                        const { error: updateError } = await supabase
                            .from('estudiantes')
                            .update({
                                grado: incidenciaData.nuevoGrado,
                                seccion: incidenciaData.nuevaSeccion
                            })
                            .eq('id', incidenciaData.estudianteId);
                        
                        if (updateError) {
                            console.error('⚠️ Error actualizando grado/sección:', updateError);
                            // No fallamos la incidencia, solo logueamos el error
                        } else {
                            console.log('✅ Grado/sección del estudiante actualizado correctamente');
                        }
                    }
                }
                
                return { success: true, data };
            } catch (err) {
                console.error('❌ Error registrando incidencia:', err);
                console.error('❌ Detalle del error:', err.message, err.details, err.hint);
                return { success: false, error: err.message };
            }
        }

        // Obtener hijos del padre actual (para Portal de Padres)
        async function getHijosDelPadre(padreId) {
            try {
                const { data, error } = await supabase
                    .from('estudiantes')
                    .select('id, nombre_completo, dni, grado, seccion, nivel')
                    .or(`padre_id.eq.${padreId},madre_id.eq.${padreId},apoderado_id.eq.${padreId}`)
                    .eq('activo', true);
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Error obteniendo hijos:', err);
                return [];
            }
        }

        // Obtener incidencias de un estudiante (para que el padre vea)
        async function getIncidenciasEstudiante(estudianteId) {
            try {
                const { data, error } = await supabase
                    .from('incidencias')
                    .select(`
                        id,
                        fecha,
                        tipo,
                        severidad,
                        estado,
                        descripcion,
                        revisado_por_padre,
                        fecha_revision_padre,
                        comentario_padre,
                        catalogo_demerito:catalogo_demeritos(nombre, categoria),
                        catalogo_merito:catalogo_meritos(nombre, area)
                    `)
                    .eq('estudiante_id', estudianteId)
                    .order('fecha', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Error obteniendo incidencias del estudiante:', err);
                return [];
            }
        }

        // Estadísticas para el Portal del Padre
        async function getEstadisticasPadre(padreId) {
            try {
                const hijos = await getHijosDelPadre(padreId);
                const estadisticas = [];
                
                for (const hijo of hijos) {
                    const incidencias = await getIncidenciasEstudiante(hijo.id);
                    const now = new Date();
                    const inicioMes = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    const incidenciasMes = incidencias.filter(i => new Date(i.fecha) >= inicioMes);
                    const casosGraves = incidencias.filter(i => i.severidad === 'grave' || i.severidad === 'muy_grave');
                    const meritos = incidencias.filter(i => i.tipo === 'merito');
                    
                    estadisticas.push({
                        estudiante: hijo,
                        totalIncidencias: incidencias.length,
                        incidenciasMes: incidenciasMes.length,
                        casosGraves: casosGraves.length,
                        meritos: meritos.length,
                        ultimasIncidencias: incidencias,  // Todas las incidencias, no solo 5
                        todasIncidencias: incidencias     // Para los gráficos
                    });
                }
                
                return estadisticas;
            } catch (err) {
                console.error('Error obteniendo estadísticas del padre:', err);
                return [];
            }
        }

        // Variable para almacenar estudiante seleccionado
        let estudianteSeleccionado = null;

        // ============================================================================
        // FIN FUNCIONES DE CONSULTA A SUPABASE
        // ============================================================================

        // Función para mostrar mensajes inline
        function showLoginMessage(message, type = 'error') {
            const messageContainer = document.getElementById('loginMessage');
            
            // Limpiar mensaje anterior
            messageContainer.className = 'form-message';
            
            // Configurar nuevo mensaje
            const icons = {
                'error': 'fas fa-exclamation-circle',
                'success': 'fas fa-check-circle',
                'info': 'fas fa-info-circle'
            };
            
            messageContainer.innerHTML = `<i class="${icons[type]}"></i>${message}`;
            messageContainer.classList.add(type, 'show');
            
            // Auto-ocultar después de 5 segundos
            setTimeout(() => {
                messageContainer.classList.remove('show');
            }, 5000);
        }

        // Función para limpiar mensajes de login
        function clearLoginMessage() {
            const messageContainer = document.getElementById('loginMessage');
            if (messageContainer) {
                messageContainer.classList.remove('show');
                messageContainer.innerHTML = '';
            }
        }

        // Función que se ejecuta al hacer clic en "Iniciar Sesión"
        // Función que se ejecuta al hacer clic en "Iniciar Sesión"
        async function handleLoginClick() {
            console.log('🔥 BOTÓN CLICKEADO - handleLoginClick ejecutado!');
            
            // Limpiar mensaje anterior
            clearLoginMessage();
            
            // Verificar que se haya seleccionado un rol
            if (!selectedUserRole) {
                console.log('❌ No role selected');
                showLoginMessage('Por favor, selecciona tu tipo de cuenta primero', 'error');
                backToRoleSelection();
                return;
            }
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            console.log('📝 Usuario:', username);
            
            // Validar campos vacíos
            if (!username || !password) {
                console.log('❌ Empty fields');
                showLoginMessage('Por favor, complete todos los campos', 'error');
                return;
            }
            
            try {
                // 🔐 AUTENTICACIÓN REAL CON SUPABASE
                showLoginMessage('<i class="fas fa-spinner fa-spin"></i> Verificando credenciales...', 'info');
                
                // Paso 1: Buscar usuario en la tabla users (por DNI o email)
                let query = supabase.from('users').select('*');
                
                // Determinar si es DNI (solo números) o email (contiene @)
                if (/^\d{8}$/.test(username)) {
                    // Es DNI
                    query = query.eq('dni', username);
                    console.log('🔍 Buscando por DNI:', username);
                } else {
                    // Es email
                    query = query.eq('email', username.toLowerCase());
                    console.log('🔍 Buscando por email:', username);
                }
                
                const { data: userData, error: dbError } = await query.maybeSingle();
                
                if (dbError) {
                    console.error('❌ Error DB:', dbError);
                    showLoginMessage('Error al verificar credenciales', 'error');
                    return;
                }
                
                if (!userData) {
                    console.log('❌ Usuario no encontrado');
                    showLoginMessage('Usuario no encontrado en el sistema', 'error');
                    document.getElementById('solicitarRegistroLink').style.display = 'block';
                    return;
                }
                
                // Paso 2: Verificar que la cuenta esté activada
                if (!userData.activado) {
                    console.log('⚠️ Cuenta no activada');
                    showLoginMessage('Tu cuenta aún no ha sido activada', 'info');
                    document.getElementById('activarCuentaLink').style.display = 'block';
                    return;
                }
                
                // Paso 3: Verificar rol
                const userRole = userData.role.toLowerCase();
                const expectedRole = selectedUserRole;
                
                if (userRole !== expectedRole) {
                    console.log('❌ Rol incorrecto:', userRole, 'vs', expectedRole);
                    const roleNames = {
                        'docente': 'Docente',
                        'tutor': 'Tutor',
                        'auxiliar': 'Auxiliar',
                        'toe': 'TOE',
                        'direccion': 'Dirección',
                        'padre': 'Padre/Madre/Apoderado',
                        'admin': 'Administrador'
                    };
                    showLoginMessage(
                        `Este usuario no corresponde al rol ${roleNames[expectedRole]}`,
                        'error'
                    );
                    return;
                }
                
                // Paso 4: Autenticar con Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: userData.email,
                    password: password
                });
                
                if (authError) {
                    console.error('❌ Error auth:', authError);
                    if (authError.message.includes('Invalid login credentials')) {
                        showLoginMessage('Contraseña incorrecta', 'error');
                    } else {
                        showLoginMessage(`Error de autenticación: ${authError.message}`, 'error');
                    }
                    return;
                }
                
                // ✅ LOGIN EXITOSO
                console.log('✅ Login exitoso!');
                showLoginMessage('Iniciando sesión...', 'success');
                
                // Definir permisos según el rol
                const rolePermissions = {
                    'docente': ['incidencias', 'historial'],
                    'tutor': ['incidencias', 'historial', 'reportes'],
                    'auxiliar': ['incidencias', 'historial'],
                    'toe': ['incidencias', 'historial', 'reportes'],
                    'direccion': ['incidencias', 'historial', 'reportes'],
                    'padre': ['historial'],
                    'admin': ['incidencias', 'historial', 'reportes']
                };
                
                setTimeout(() => {
                    currentUser = {
                        username: userData.dni || userData.email,
                        email: userData.email,
                        role: userData.role,
                        name: userData.nombre_completo || 'Usuario',
                        nombre: userData.nombre_completo,
                        dni: userData.dni,
                        id: userData.id,
                        permissions: rolePermissions[userData.role] || ['historial'],
                        isDemo: userData.email && userData.email.includes('.demo@'),
                        aulas_asignadas: userData.aulas_asignadas || null
                    };
                    console.log('👤 Current user set:', currentUser);
                    console.log('🏫 Aulas asignadas:', currentUser.aulas_asignadas);
                    login();
                }, 1000);
                
            } catch (err) {
                console.error('❌ Error inesperado:', err);
                showLoginMessage('Error al iniciar sesión. Intenta nuevamente.', 'error');
            }
        }

        // Función de login exitoso
        async function login() {
            document.getElementById('loginScreen').style.display = 'none';
            const mainApp = document.getElementById('mainApp');
            mainApp.classList.add('show');
            
            // Actualizar información del usuario
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            
            // Mostrar campanita de notificaciones para todos los usuarios
            const notificationBell = document.getElementById('notificationBell');
            const messageInbox = document.getElementById('messageInbox');
            const dropdownTitle = document.getElementById('notificationDropdownTitle');
            const verTodasBtn = document.getElementById('notificationVerTodas');
            
            if (notificationBell) {
                const esAdmin = currentUser.role?.toLowerCase() === 'admin' || 
                               currentUser.role?.toLowerCase() === 'direccion';
                
                // CAMPANITA: Visible para TODOS los usuarios
                notificationBell.style.display = 'block';
                
                // Configurar título según rol
                if (dropdownTitle) {
                    if (esAdmin) {
                        dropdownTitle.innerHTML = '<i class="fas fa-clipboard-list"></i> Solicitudes';
                    } else {
                        dropdownTitle.innerHTML = '<i class="fas fa-bell"></i> Notificaciones';
                    }
                }
                
                // "Ver todas" solo para admin
                if (verTodasBtn) {
                    verTodasBtn.style.display = esAdmin ? 'inline' : 'none';
                }
                
                // Ícono de mensajes solo para admin
                if (messageInbox) {
                    messageInbox.style.display = esAdmin ? 'block' : 'none';
                }
                
                if (esAdmin) {
                    // ADMIN: Solicitudes de registro + Mensajes de soporte
                    actualizarContadorSolicitudes();
                    iniciarAnimacionCampanita();
                    cargarMensajesSoporte();
                    iniciarAnimacionMensajes();
                } else {
                    // OTROS USUARIOS: Cargar sus notificaciones personales
                    await cargarNotificacionesUsuario();
                    iniciarAnimacionCampanita();
                }
                
                // Suscripciones en tiempo real para TODOS
                iniciarSuscripcionesRealtime();
                
                // Inicializar Web Push Notifications
                inicializarWebPush();
                
                // Actualizar título con conteo inicial
                setTimeout(() => {
                    actualizarTituloPagina();
                    // Si hay notificaciones al iniciar, reproducir sonido de bienvenida
                    const badge = document.getElementById('bellBadge');
                    if (badge && badge.style.display !== 'none' && parseInt(badge.textContent) > 0) {
                        setTimeout(() => reproducirSonidoNotificacion(), 500);
                    }
                }, 1500);
            }
            
            // Configurar navegación según permisos
            setupNavigation();
            
            // Configurar dashboard según rol
            setupDashboard();
            
            // Si es tutor, inicializar el selector de aula con un pequeño delay para asegurar que el DOM esté listo
            if (currentUser.role?.toLowerCase() === 'tutor') {
                setTimeout(() => {
                    console.log('🏫 Inicializando selector de aula para tutor...');
                    console.log('🏫 Aulas asignadas del usuario:', currentUser.aulas_asignadas);
                    inicializarSelectorAulaTutor();
                }, 100);
            }
            
            // Cargar catálogo de deméritos en el select
            await cargarDemeritosEnSelect();
            
            // Cargar datos reales desde Supabase
            await cargarDatosReales();
        }
        
        // Cargar datos reales del usuario desde Supabase
        async function cargarDatosReales() {
            if (!currentUser || !currentUser.id) return;
            
            console.log('📊 Cargando datos reales desde Supabase...');
            
            // DEBUG: Ver TODAS las incidencias en la base de datos
            const { data: todasIncidencias, error: debugError } = await supabase
                .from('incidencias')
                .select('id, fecha, registrado_por, tipo, estado');
            
            console.log('🔍 DEBUG - Todas las incidencias en BD:', {
                total: todasIncidencias ? todasIncidencias.length : 0,
                incidencias: todasIncidencias,
                error: debugError,
                currentUserId: currentUser.id
            });
            
            // Si es padre, cargar portal especial
            if (currentUser.role === 'padre') {
                await cargarPortalPadre();
            } else {
                // Actualizar estadísticas del dashboard para roles institucionales
                await actualizarDashboardStats();
                
                // Cargar datos específicos según el rol
                await cargarDatosEspecificosRol();
            }
            
            // Cargar historial de incidencias
            await renderizarHistorial();
            
            console.log('✅ Datos cargados correctamente');
        }
        
        // Cargar datos específicos del panel según rol
        async function cargarDatosEspecificosRol() {
            if (!currentUser) return;
            
            const rol = currentUser.role.toLowerCase();
            
            try {
                // Obtener mis incidencias de hoy (usando fecha local, no UTC)
                const ahora = new Date();
                const hoy = `${ahora.getFullYear()}-${String(ahora.getMonth() + 1).padStart(2, '0')}-${String(ahora.getDate()).padStart(2, '0')}`;
                console.log('🔍 Buscando incidencias para:', {
                    fecha: hoy,
                    usuario: currentUser.id,
                    email: currentUser.email
                });
                
                const { data: incidenciasHoy, error } = await supabase
                    .from('incidencias')
                    .select('*')
                    .eq('registrado_por', currentUser.id)
                    .eq('fecha', hoy)
                    ;
                
                console.log('📊 Resultado query incidencias hoy:', {
                    data: incidenciasHoy,
                    error: error,
                    count: incidenciasHoy ? incidenciasHoy.length : 0
                });
                
                if (error) {
                    console.error('❌ Error al buscar incidencias de hoy:', error);
                }
                
                const totalHoy = incidenciasHoy ? incidenciasHoy.length : 0;
                const pendientes = incidenciasHoy ? incidenciasHoy.filter(i => i.estado === 'pendiente').length : 0;
                
                // Actualizar panel según rol
                if (rol.includes('docente')) {
                    const container = document.getElementById('docenteIncidenciasHoy');
                    if (container) {
                        container.innerHTML = `
                            <p><strong>${totalHoy}</strong> incidencias registradas hoy</p>
                            <p><strong>${pendientes}</strong> pendientes de seguimiento</p>
                        `;
                    }
                } else if (rol.includes('tutor')) {
                    const aulaInfo = document.getElementById('tutorAulaInfo');
                    const actividadReciente = document.getElementById('tutorActividadReciente');
                    
                    // Contar estudiantes del aula del tutor (si tiene aula asignada)
                    if (aulaInfo) {
                        const { data: stats } = await supabase
                            .from('incidencias')
                            .select('id')
                            .eq('registrado_por', currentUser.id);
                        
                        aulaInfo.innerHTML = `
                            <p><strong>${stats ? stats.length : 0}</strong> incidencias registradas</p>
                            <p><strong>${totalHoy}</strong> hoy</p>
                        `;
                    }
                    
                    if (actividadReciente) {
                        actividadReciente.innerHTML = `
                            <p>${totalHoy > 0 ? totalHoy + ' registros hoy' : 'Sin actividad hoy'}</p>
                        `;
                    }
                } else if (rol.includes('auxiliar')) {
                    const container = document.getElementById('auxiliarRegistrosRecientes');
                    if (container) {
                        container.innerHTML = `
                            <p><strong>${totalHoy}</strong> registros hoy</p>
                            <p>${pendientes > 0 ? pendientes + ' pendientes' : 'Todo al día'}</p>
                        `;
                    }
                } else if (rol.includes('toe')) {
                    const casosInfo = document.getElementById('toeCasosInfo');
                    if (casosInfo) {
                        // Contar casos graves/muy_graves como "seguimiento"
                        const { data: casosGraves } = await supabase
                            .from('incidencias')
                            .select('id')
                            .in('severidad', ['grave', 'muy_grave']);
                        
                        casosInfo.innerHTML = `
                            <p><strong>${casosGraves ? casosGraves.length : 0}</strong> casos graves/muy graves</p>
                            <p><strong>${totalHoy}</strong> registros hoy</p>
                        `;
                    }
                } else if (rol.includes('direc')) {
                    const resumen = document.getElementById('direccionResumen');
                    if (resumen) {
                        // Estadísticas generales
                        const { data: totalIncidencias } = await supabase
                            .from('incidencias')
                            .select('id');
                        
                        const { data: casosGraves } = await supabase
                            .from('incidencias')
                            .select('id')
                            .in('severidad', ['grave', 'muy_grave']);
                        
                        resumen.innerHTML = `
                            <p><strong>${totalIncidencias ? totalIncidencias.length : 0}</strong> incidencias totales</p>
                            <p><strong>${casosGraves ? casosGraves.length : 0}</strong> casos graves</p>
                            <p>796 estudiantes registrados</p>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error cargando datos específicos del rol:', error);
            }
        }
        
        // Cargar datos de reportes (cuando se accede a la sección)
        async function cargarDatosReportes() {
            console.log('📊 Cargando datos de reportes...');
            
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mesActual = meses[new Date().getMonth()];
            const anioActual = new Date().getFullYear();
            
            const mesLabel = document.getElementById('reportesMesActual');
            if (mesLabel) mesLabel.textContent = `${mesActual} ${anioActual}`;
            
            // Para tutores, filtrar solo por su aula asignada
            const userRole = currentUser?.role?.toLowerCase() || '';
            const esTutor = userRole.includes('tutor');
            let gradoTutor = null;
            let seccionTutor = null;
            
            if (esTutor) {
                // Primero intentar obtener de aulas_asignadas (BD)
                if (currentUser.aulas_asignadas) {
                    const aulas = Array.isArray(currentUser.aulas_asignadas) 
                        ? currentUser.aulas_asignadas 
                        : [currentUser.aulas_asignadas];
                    
                    if (aulas.length > 0 && aulas[0]) {
                        const matchAula = aulas[0].match(/(\d+)([A-E])/i);
                        if (matchAula) {
                            gradoTutor = matchAula[1];
                            seccionTutor = matchAula[2].toUpperCase();
                        }
                    }
                }
                
                // Si no hay en BD, intentar con aulaAsignada (del rol)
                if (!gradoTutor && currentUser.aulaAsignada) {
                    const matchAula = currentUser.aulaAsignada.match(/(\d+)°([A-E])/i);
                    if (matchAula) {
                        gradoTutor = matchAula[1];
                        seccionTutor = matchAula[2].toUpperCase();
                    }
                }
                
                if (gradoTutor && seccionTutor) {
                    console.log(`🎓 Tutor - Filtrando reportes para aula ${gradoTutor}°${seccionTutor}`);
                    
                    // Actualizar título para tutores
                    const tituloReportes = document.getElementById('reportesTitulo');
                    const subtituloReportes = document.getElementById('reportesSubtitulo');
                    if (tituloReportes) tituloReportes.textContent = `Reportes del Aula ${gradoTutor}°${seccionTutor}`;
                    if (subtituloReportes) subtituloReportes.textContent = `Estadísticas de tu aula asignada`;
                }
            }
            
            if (!esTutor) {
                // Para otros roles, restaurar título original
                const tituloReportes = document.getElementById('reportesTitulo');
                const subtituloReportes = document.getElementById('reportesSubtitulo');
                if (tituloReportes) tituloReportes.textContent = 'Reportes e Indicadores';
                if (subtituloReportes) subtituloReportes.textContent = 'Análisis y estadísticas institucionales';
            }
            
            try {
                // Obtener todas las incidencias con información de estudiantes
                let query = supabase
                    .from('incidencias')
                    .select(`
                        id,
                        tipo,
                        severidad,
                        estudiante_id,
                        estudiante:estudiantes!estudiante_id(grado, seccion)
                    `);
                
                const { data: incidencias, error } = await query;
                
                if (error) throw error;
                
                // Agrupar por grado y sección
                const porAula = {};
                let totalMeritos = 0;
                let totalDemeritos = 0;
                let totalFiltrado = 0;
                
                if (incidencias) {
                    incidencias.forEach(inc => {
                        // Si es tutor, solo contar incidencias de su aula
                        if (esTutor && gradoTutor && seccionTutor) {
                            if (!inc.estudiante || 
                                inc.estudiante.grado !== gradoTutor || 
                                inc.estudiante.seccion !== seccionTutor) {
                                return; // Saltar si no es de su aula
                            }
                        }
                        
                        totalFiltrado++;
                        if (inc.tipo === 'merito') totalMeritos++;
                        else totalDemeritos++;
                        
                        if (inc.estudiante) {
                            const aula = `${inc.estudiante.grado}°${inc.estudiante.seccion}`;
                            if (!porAula[aula]) {
                                porAula[aula] = { total: 0, leve: 0, grave: 0, muy_grave: 0, merito: 0 };
                            }
                            porAula[aula].total++;
                            if (inc.tipo === 'merito') {
                                porAula[aula].merito++;
                            } else if (inc.severidad) {
                                porAula[aula][inc.severidad]++;
                            }
                        }
                    });
                }
                
                // Actualizar resumen general
                const totalIncEl = document.getElementById('reporteTotalIncidencias');
                const totalMerEl = document.getElementById('reporteTotalMeritos');
                const totalDemEl = document.getElementById('reporteTotalDemeritos');
                
                if (totalIncEl) totalIncEl.textContent = totalFiltrado;
                if (totalMerEl) totalMerEl.textContent = totalMeritos;
                if (totalDemEl) totalDemEl.textContent = totalDemeritos;
                
                // Actualizar conteo de estudiantes según el rol
                const totalEstEl = document.getElementById('reporteTotalEstudiantes');
                if (totalEstEl) {
                    if (esTutor && gradoTutor && seccionTutor) {
                        // Para tutores, contar solo estudiantes de su aula
                        const { data: estudiantesAula, error: errEst } = await supabase
                            .from('estudiantes')
                            .select('id', { count: 'exact' })
                            .eq('grado', gradoTutor)
                            .eq('seccion', seccionTutor)
                            .eq('activo', true);
                        
                        if (!errEst) {
                            totalEstEl.textContent = estudiantesAula?.length || 0;
                            console.log(`📊 Estudiantes del aula ${gradoTutor}°${seccionTutor}:`, estudiantesAula?.length || 0);
                        }
                    } else {
                        // Para otros roles, contar todos los estudiantes activos
                        const { data: todosEstudiantes } = await supabase
                            .from('estudiantes')
                            .select('id', { count: 'exact' })
                            .eq('activo', true);
                        
                        totalEstEl.textContent = todosEstudiantes?.length || 796;
                    }
                }
                
                // Renderizar cards por aula
                const container = document.getElementById('reportesAulasContainer');
                if (container) {
                    if (Object.keys(porAula).length === 0) {
                        container.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <i class="fas fa-inbox" style="font-size: 48px; color: #ccc;"></i>
                                <p style="color: #666; margin-top: 15px;">No hay incidencias registradas aún</p>
                            </div>
                        `;
                    } else {
                        // Ordenar aulas
                        const aulasOrdenadas = Object.keys(porAula).sort();
                        
                        container.innerHTML = aulasOrdenadas.map(aula => {
                            const data = porAula[aula];
                            return `
                                <div class="stats-card">
                                    <div class="stats-number">${aula}</div>
                                    <div class="stats-label">${data.total} incidencias</div>
                                    <div style="margin-top: 10px;">
                                        ${data.merito > 0 ? `<span class="badge badge-merito">${data.merito} méritos</span>` : ''}
                                        ${data.leve > 0 ? `<span class="badge badge-leve">${data.leve} leves</span>` : ''}
                                        ${data.grave > 0 ? `<span class="badge badge-grave">${data.grave} graves</span>` : ''}
                                        ${data.muy_grave > 0 ? `<span class="badge badge-muy-grave">${data.muy_grave} muy graves</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                console.log('✅ Reportes cargados correctamente');
                
            } catch (error) {
                console.error('❌ Error cargando reportes:', error);
                const container = document.getElementById('reportesAulasContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c;"></i>
                            <p style="color: #666; margin-top: 15px;">Error al cargar los reportes</p>
                            <p style="color: #999; font-size: 12px; margin-top: 5px;">${error.message || 'Error desconocido'}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Cargar datos de admin
        async function cargarDatosAdmin() {
            console.log('📊 Cargando datos de administración...');
            
            // Activar el tab dashboard y cargar sus datos
            showAdminTab('dashboard');
        }

        // Configurar navegación según permisos
        function setupNavigation() {
            const navItems = {
                'incidencias': document.querySelector('.nav-incidencias'),
                'historial': document.querySelector('.nav-historial'),
                'reportes': document.querySelector('.nav-reportes')
            };

            // Ocultar todos los elementos de navegación
            Object.values(navItems).forEach(item => {
                if (item) item.style.display = 'none';
            });

            // Si es admin, NO mostrar estos items porque ya tiene todo en su Panel de Administración
            const userRole = currentUser?.role?.toLowerCase() || '';
            if (userRole === 'admin' || userRole.includes('administrador')) {
                // El admin solo ve Dashboard en el menú, su panel tiene todo lo demás
                console.log('👑 Admin detectado - Ocultando menú redundante (Historial/Reportes/Incidencias)');
                return;
            }

            // Para otros roles, mostrar según sus permisos
            if (currentUser && currentUser.permissions && Array.isArray(currentUser.permissions)) {
                currentUser.permissions.forEach(permission => {
                    if (navItems[permission]) {
                        navItems[permission].style.display = 'list-item';
                    }
                });
            }
        }

        // Configurar dashboard según rol
        function setupDashboard() {
            const title = document.getElementById('dashboardTitle');
            const subtitle = document.getElementById('dashboardSubtitle');
            const content = document.getElementById('roleSpecificContent');
            
            // Determinar el tipo de rol basado en el rol del usuario (no en el username)
            const userRole = currentUser.role.toLowerCase();
            let roleType = '';
            
            console.log('🔍 setupDashboard - userRole:', userRole);
            
            if (userRole === 'admin' || userRole.includes('administrador')) {
                roleType = 'admin';
            } else if (userRole.includes('docente')) {
                roleType = 'docente';
            } else if (userRole.includes('tutor')) {
                roleType = 'tutor';
            } else if (userRole.includes('auxiliar')) {
                roleType = 'auxiliar';
            } else if (userRole.includes('toe') || userRole.includes('coordinador')) {
                roleType = 'toe';
            } else if (userRole.includes('dirección') || userRole.includes('director') || userRole === 'direccion') {
                roleType = 'direccion';
            } else if (userRole.includes('padre') || userRole.includes('madre')) {
                roleType = 'padre';
            }
            
            console.log('🎭 setupDashboard - roleType determinado:', roleType);
            
            // Configurar contenido según el tipo de rol
            const statsTitle = document.getElementById('statsSectionTitle');
            const statsSubtitle = document.getElementById('statsSectionSubtitle');
            const statsSection = document.getElementById('statsSection');
            
            // Para tutores, obtener el aula de la base de datos (aulas_asignadas)
            let aulaTutor = '';
            if (roleType === 'tutor') {
                // Primero intentar obtener de aulas_asignadas (guardado en BD)
                if (currentUser.aulas_asignadas) {
                    // Puede ser un array ["1A"] o un string "1A"
                    const aulas = Array.isArray(currentUser.aulas_asignadas) 
                        ? currentUser.aulas_asignadas 
                        : [currentUser.aulas_asignadas];
                    
                    if (aulas.length > 0 && aulas[0]) {
                        // Formato: "1A" -> "1°A"
                        const aulaRaw = aulas[0];
                        const matchAula = aulaRaw.match(/(\d+)([A-E])/i);
                        if (matchAula) {
                            aulaTutor = `${matchAula[1]}°${matchAula[2].toUpperCase()}`;
                        } else {
                            aulaTutor = aulaRaw;
                        }
                    }
                }
                
                // Si no hay aulas_asignadas, intentar extraer del nombre del rol como fallback
                if (!aulaTutor) {
                    const roleTutor = currentUser.role || '';
                    const matchAula = roleTutor.match(/(\d+)°([A-E])/i);
                    if (matchAula) {
                        aulaTutor = `${matchAula[1]}°${matchAula[2].toUpperCase()}`;
                    } else {
                        aulaTutor = 'Sin asignar';
                    }
                }
                
                // Guardar el aula del tutor en el objeto currentUser para usarlo en filtros
                currentUser.aulaAsignada = aulaTutor;
                console.log('🏫 Aula del tutor configurada:', aulaTutor);
            }
            
            switch (roleType) {
                case 'docente':
                    title.textContent = 'Panel del Docente';
                    subtitle.textContent = 'Gestión de incidencias en aula';
                    content.innerHTML = getDocenteContent();
                    if (statsTitle) statsTitle.textContent = 'Mis Estadísticas';
                    if (statsSubtitle) statsSubtitle.textContent = 'Resumen de incidencias registradas por mí';
                    break;
                case 'tutor':
                    title.textContent = `Panel del Tutor - ${aulaTutor}`;
                    subtitle.textContent = 'Seguimiento integral del aula';
                    content.innerHTML = getTutorContent();
                    if (statsTitle) statsTitle.textContent = 'Estadísticas de Mi Aula';
                    if (statsSubtitle) statsSubtitle.textContent = `Resumen de incidencias de estudiantes de ${aulaTutor}`;
                    break;
                case 'auxiliar':
                    title.textContent = 'Panel del Auxiliar';
                    subtitle.textContent = 'Supervisión disciplinaria';
                    content.innerHTML = getAuxiliarContent();
                    if (statsTitle) statsTitle.textContent = 'Mis Registros';
                    if (statsSubtitle) statsSubtitle.textContent = 'Resumen de incidencias reportadas por mí';
                    break;
                case 'toe':
                    title.textContent = 'Panel de Coordinación TOE';
                    subtitle.textContent = 'Gestión psicopedagógica institucional';
                    content.innerHTML = getTOEContent();
                    if (statsTitle) statsTitle.textContent = 'Indicadores Institucionales';
                    if (statsSubtitle) statsSubtitle.textContent = 'Panorama general de incidencias del colegio';
                    break;
                case 'direccion':
                    title.textContent = 'Panel de Dirección';
                    subtitle.textContent = 'Vista ejecutiva institucional';
                    content.innerHTML = getDireccionContent();
                    if (statsTitle) statsTitle.textContent = 'Indicadores Ejecutivos';
                    if (statsSubtitle) statsSubtitle.textContent = 'Vista consolidada de la institución';
                    break;
                case 'padre':
                    title.textContent = 'Portal de Padres';
                    subtitle.textContent = 'Seguimiento de su hijo/a';
                    content.innerHTML = getPadreContent();
                    // Para padres, ocultamos esta sección ya que tienen su propia sección de estadísticas por hijo
                    if (statsSection) statsSection.style.display = 'none';
                    break;
                case 'admin':
                    // Para admin, ocultar dashboard genérico y mostrar adminSection directamente
                    const dashboardSection = document.getElementById('dashboardSection');
                    const adminSection = document.getElementById('adminSection');
                    
                    if (dashboardSection) dashboardSection.style.display = 'none';
                    if (adminSection) {
                        adminSection.style.display = 'block';
                    }
                    
                    // Cargar datos del dashboard admin
                    setTimeout(() => {
                        cargarDatosAdmin();
                    }, 100);
                    break;
                default:
                    title.textContent = 'Panel de Usuario';
                    subtitle.textContent = 'Bienvenido al sistema';
                    content.innerHTML = '<div class="card"><p>Bienvenido al sistema ATA.</p></div>';
            }
            
            // Mostrar sección de stats para roles que no son padre
            if (statsSection && roleType !== 'padre') {
                statsSection.style.display = 'block';
            }
        }

        // Contenido específico por rol
        function getDocenteContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-plus-circle"></i> Acciones Rápidas</h3>
                        <div class="grid grid-2" style="gap: 15px;">
                            <button class="btn btn-primary" onclick="showSection('incidencias')">
                                <i class="fas fa-plus"></i> Nueva Incidencia
                            </button>
                            <button class="btn btn-secondary" onclick="showSection('historial')">
                                <i class="fas fa-history"></i> Ver Historial
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-clock"></i> Mis Incidencias Hoy</h3>
                        <div id="docenteIncidenciasHoy">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getTutorContent() {
            // Verificar si tiene aula asignada guardada
            const tieneAulaGuardada = currentUser?.aulas_asignadas && currentUser.aulas_asignadas.length > 0;
            const aulaGuardada = tieneAulaGuardada ? 
                (Array.isArray(currentUser.aulas_asignadas) ? currentUser.aulas_asignadas[0] : currentUser.aulas_asignadas) : null;
            
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-users"></i> Mi Aula</h3>
                        <div id="tutorAulaInfo">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                        <button class="btn btn-primary" onclick="showSection('incidencias')" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Registrar Incidencia
                        </button>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-history"></i> Actividad Reciente</h3>
                        <div id="tutorActividadReciente">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sección de Configuración de Aula Asignada -->
                <div class="card" style="margin-top: 20px;">
                    <h3><i class="fas fa-cog"></i> Configurar Mi Aula Asignada</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        Selecciona el grado y sección que tienes a tu cargo como tutor. 
                        Esta configuración determinará qué estudiantes e incidencias puedes ver.
                    </p>
                    
                    <div id="configuracionAulaContainer">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                                <label class="form-label">Grado</label>
                                <select id="tutorGradoSelect" class="form-input">
                                    <option value="">Seleccionar grado...</option>
                                    <option value="1">1° Secundaria</option>
                                    <option value="2">2° Secundaria</option>
                                    <option value="3">3° Secundaria</option>
                                    <option value="4">4° Secundaria</option>
                                    <option value="5">5° Secundaria</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
                                <label class="form-label">Sección</label>
                                <select id="tutorSeccionSelect" class="form-input">
                                    <option value="">Seleccionar sección...</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                    <option value="E">E</option>
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="guardarAulaAsignada()" style="height: fit-content;">
                                <i class="fas fa-save"></i> Guardar Aula
                            </button>
                        </div>
                        
                        <div id="aulaAsignadaActual" style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px; display: ${tieneAulaGuardada ? 'block' : 'none'};">
                            <strong><i class="fas fa-check-circle" style="color: #28a745;"></i> Aula asignada actualmente:</strong>
                            <span id="aulaAsignadaTexto" style="font-size: 18px; font-weight: bold; color: var(--color-ata-verde); margin-left: 10px;">
                                ${aulaGuardada || 'Sin asignar'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        function getAuxiliarContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-eye"></i> Supervisión General</h3>
                        <p>Rondas por patios y pasillos</p>
                        <p>Control de disciplina</p>
                        <button class="btn btn-primary" onclick="showSection('incidencias')">
                            <i class="fas fa-plus"></i> Reportar Incidencia
                        </button>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-history"></i> Mis Registros Recientes</h3>
                        <div id="auxiliarRegistrosRecientes">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getTOEContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-brain"></i> Casos en Seguimiento</h3>
                        <div id="toeCasosInfo">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                        <button class="btn btn-primary" onclick="showSection('incidencias')" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Registrar Incidencia
                        </button>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Indicadores</h3>
                        <button class="btn btn-primary" onclick="showSection('reportes')">
                            <i class="fas fa-chart-bar"></i> Ver Reportes
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('historial')">
                            <i class="fas fa-history"></i> Ver Historial
                        </button>
                    </div>
                </div>
            `;
        }

        function getDireccionContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-building"></i> Vista Institucional</h3>
                        <div id="direccionResumen">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-file-pdf"></i> Acciones</h3>
                        <button class="btn btn-primary" onclick="showSection('reportes')" style="width: 100%; margin-bottom: 10px;">
                            <i class="fas fa-chart-bar"></i> Ver Reportes
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('historial')" style="width: 100%;">
                            <i class="fas fa-history"></i> Ver Historial
                        </button>
                    </div>
                </div>
            `;
        }

        function getPadreContent() {
            // Contenido inicial - se actualizará dinámicamente
            return `
                <div id="padrePortalContent">
                    <div class="card" style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--color-ata-verde); margin-bottom: 15px;"></i>
                        <p>Cargando información de sus hijos...</p>
                    </div>
                </div>
            `;
        }
        
        // Cargar datos reales del padre - DASHBOARD (solo NO leídas)
        async function cargarPortalPadre() {
            if (!currentUser || currentUser.role !== 'padre') return;
            
            const container = document.getElementById('padrePortalContent');
            if (!container) return;
            
            try {
                const estadisticas = await getEstadisticasPadre(currentUser.id);
                
                if (estadisticas.length === 0) {
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <i class="fas fa-user-graduate" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                            <h3>No se encontraron hijos registrados</h3>
                            <p style="color: #666;">Si cree que esto es un error, contacte a la administración del colegio.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                for (const stat of estadisticas) {
                    const hijo = stat.estudiante;
                    
                    // Filtrar solo incidencias NO leídas para el Dashboard
                    const incidenciasNoLeidas = stat.ultimasIncidencias.filter(inc => !inc.revisado_por_padre);
                    const incidenciasLeidas = stat.ultimasIncidencias.filter(inc => inc.revisado_por_padre);
                    
                    // Datos para gráfico mensual
                    const datosGrafico = calcularDatosMensuales(stat.todasIncidencias || stat.ultimasIncidencias);
                    
                    html += `
                        <!-- ========== SECCIÓN: INFORMACIÓN DEL ESTUDIANTE ========== -->
                        <div style="background: linear-gradient(135deg, var(--color-ata-verde) 0%, var(--color-ata-verde-claro) 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; margin-bottom: 0;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 12px; color: white;">
                                <i class="fas fa-user-graduate" style="font-size: 28px;"></i>
                                <div>
                                    <span style="font-size: 20px;">${hijo.nombre_completo}</span>
                                    <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">
                                        <i class="fas fa-school"></i> ${hijo.grado}° "${hijo.seccion}" - ${hijo.nivel.charAt(0).toUpperCase() + hijo.nivel.slice(1)}
                                    </p>
                                </div>
                            </h3>
                        </div>
                        
                        <!-- ========== SECCIÓN: RESUMEN ESTADÍSTICO ========== -->
                        <div class="card" style="margin-bottom: 0; border-radius: 0; border-top: none;">
                            <h4 style="color: var(--color-ata-verde); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                                <i class="fas fa-chart-pie"></i> Resumen General
                            </h4>
                            <div class="grid grid-4">
                                <div class="stats-card" style="border-left-color: var(--color-ata-azul);">
                                    <div class="stats-number" style="color: var(--color-ata-azul);">${stat.totalIncidencias}</div>
                                    <div class="stats-label">Total Incidencias</div>
                                </div>
                                <div class="stats-card" style="border-left-color: ${incidenciasNoLeidas.length > 0 ? '#dc3545' : '#28a745'};">
                                    <div class="stats-number" style="color: ${incidenciasNoLeidas.length > 0 ? '#dc3545' : '#28a745'};">${incidenciasNoLeidas.length}</div>
                                    <div class="stats-label">Pendientes de Leer</div>
                                </div>
                                <div class="stats-card" style="border-left-color: ${stat.casosGraves > 0 ? '#dc3545' : '#6c757d'};">
                                    <div class="stats-number" style="color: ${stat.casosGraves > 0 ? '#dc3545' : '#6c757d'};">${stat.casosGraves}</div>
                                    <div class="stats-label">Casos Graves</div>
                                </div>
                                <div class="stats-card" style="border-left-color: var(--color-ata-verde);">
                                    <div class="stats-number" style="color: var(--color-ata-verde);">${stat.meritos}</div>
                                    <div class="stats-label">Méritos</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ========== SECCIÓN: GRÁFICO DE EVOLUCIÓN ========== -->
                        <div class="card" style="margin-bottom: 0; border-radius: 0; border-top: none;">
                            <h4 style="color: var(--color-ata-verde); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef;">
                                <i class="fas fa-chart-line"></i> Evolución Mensual - ${new Date().toLocaleString('es-PE', { month: 'long', year: 'numeric' }).charAt(0).toUpperCase() + new Date().toLocaleString('es-PE', { month: 'long', year: 'numeric' }).slice(1)}
                            </h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                                <div style="height: 220px;">
                                    <canvas id="chartHijo_${hijo.id}"></canvas>
                                </div>
                                <p style="text-align: center; color: #6c757d; font-size: 12px; margin-top: 10px;">
                                    <i class="fas fa-info-circle"></i> Comparativa semanal de deméritos vs méritos del mes actual
                                </p>
                            </div>
                        </div>
                        
                        <!-- ========== SECCIÓN: INCIDENCIAS PENDIENTES ========== -->
                        <div class="card" style="margin-bottom: 30px; border-radius: 0 0 12px 12px; border-top: none;">
                            ${incidenciasNoLeidas.length > 0 ? `
                                <h4 style="color: #dc3545; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f8d7da; display: flex; align-items: center; gap: 10px;">
                                    <span style="background: #dc3545; color: white; padding: 5px 12px; border-radius: 20px; font-size: 14px;">
                                        <i class="fas fa-bell"></i> ${incidenciasNoLeidas.length}
                                    </span>
                                    Incidencias Pendientes de Revisar
                                </h4>
                                <div class="table-container" style="border: 2px solid #f8d7da;">
                                    <table class="table">
                                        <thead style="background: #dc3545;">
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Tipo</th>
                                                <th>Descripción</th>
                                                <th>Severidad</th>
                                                <th>Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${incidenciasNoLeidas.map(inc => {
                                                const fecha = new Date(inc.fecha).toLocaleDateString('es-PE');
                                                const tipoIcon = inc.tipo === 'merito' ? '🏆' : '⚠️';
                                                const nombre = inc.tipo === 'merito' 
                                                    ? (inc.catalogo_merito?.nombre || 'Mérito')
                                                    : (inc.catalogo_demerito?.nombre || 'Demérito');
                                                const severidadClass = inc.severidad === 'leve' ? 'badge-leve' 
                                                    : inc.severidad === 'grave' ? 'badge-grave' 
                                                    : inc.severidad === 'muy_grave' ? 'badge-muy-grave' : '';
                                                const severidadText = inc.tipo === 'merito' ? 'Reconocimiento'
                                                    : inc.severidad === 'leve' ? 'Leve'
                                                    : inc.severidad === 'grave' ? 'Grave'
                                                    : inc.severidad === 'muy_grave' ? 'Muy Grave' : '-';
                                                
                                                return `
                                                    <tr style="background: #fff3cd;">
                                                        <td>${fecha}</td>
                                                        <td>${tipoIcon} ${nombre}</td>
                                                        <td>${inc.descripcion ? inc.descripcion.substring(0, 50) + (inc.descripcion.length > 50 ? '...' : '') : '-'}</td>
                                                        <td><span class="badge ${severidadClass}">${severidadText}</span></td>
                                                        <td>
                                                            <button class="btn btn-primary" onclick="verDetalleIncidencia('${inc.id}')" style="padding: 8px 15px; font-size: 12px; width: auto;">
                                                                <i class="fas fa-eye"></i> Revisar
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <h4 style="color: #28a745; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #d4edda;">
                                    <i class="fas fa-clipboard-check"></i> Estado de Incidencias
                                </h4>
                                <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 12px;">
                                    <i class="fas fa-check-circle" style="font-size: 50px; color: #28a745; margin-bottom: 15px;"></i>
                                    <h3 style="color: #155724; margin-bottom: 10px;">¡Todo al día!</h3>
                                    <p style="color: #155724; margin: 0;">
                                        No hay incidencias pendientes de revisar.
                                    </p>
                                    ${incidenciasLeidas.length > 0 ? `
                                        <p style="color: #155724; margin-top: 15px; font-size: 14px;">
                                            <i class="fas fa-history"></i> Tiene <strong>${incidenciasLeidas.length}</strong> incidencia(s) revisada(s) en el 
                                            <a href="#historial" onclick="showSection('historial')" style="color: #155724; text-decoration: underline;">Historial</a>.
                                        </p>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                        
                        <!-- Espaciado entre estudiantes -->
                        <div style="margin-bottom: 40px;"></div>
                    `;
                }
                
                container.innerHTML = html;
                
                // Renderizar gráficos después de insertar el HTML
                setTimeout(() => {
                    for (const stat of estadisticas) {
                        renderizarGraficoHijo(stat.estudiante.id, stat.todasIncidencias || stat.ultimasIncidencias);
                    }
                }, 100);
                
            } catch (err) {
                console.error('Error cargando portal del padre:', err);
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 15px;"></i>
                        <h3>Error al cargar información</h3>
                        <p style="color: #666;">Por favor recargue la página o contacte soporte.</p>
                    </div>
                `;
            }
        }
        
        // Calcular datos mensuales para gráfico
        function calcularDatosMensuales(incidencias) {
            const ahora = new Date();
            const datos = {
                semanas: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                demeritos: [0, 0, 0, 0],
                meritos: [0, 0, 0, 0]
            };
            
            incidencias.forEach(inc => {
                const fechaInc = new Date(inc.fecha);
                if (fechaInc.getMonth() === ahora.getMonth() && fechaInc.getFullYear() === ahora.getFullYear()) {
                    const semana = Math.min(Math.floor((fechaInc.getDate() - 1) / 7), 3);
                    if (inc.tipo === 'merito') {
                        datos.meritos[semana]++;
                    } else {
                        datos.demeritos[semana]++;
                    }
                }
            });
            
            return datos;
        }
        
        // Renderizar gráfico para un hijo
        function renderizarGraficoHijo(hijoId, incidencias) {
            const canvas = document.getElementById(`chartHijo_${hijoId}`);
            if (!canvas) return;
            
            const datos = calcularDatosMensuales(incidencias);
            
            new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: datos.semanas,
                    datasets: [
                        {
                            label: 'Deméritos',
                            data: datos.demeritos,
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgba(220, 53, 69, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Méritos',
                            data: datos.meritos,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Cargar historial del padre (incidencias YA LEÍDAS)
        async function cargarHistorialPadre() {
            if (!currentUser || currentUser.role !== 'padre') return;
            
            const container = document.getElementById('historialPadreContent');
            if (!container) return;
            
            try {
                const estadisticas = await getEstadisticasPadre(currentUser.id);
                
                let html = '';
                let totalLeidas = 0;
                
                // Calcular total de leídas primero
                for (const stat of estadisticas) {
                    const incidenciasLeidas = stat.ultimasIncidencias.filter(inc => inc.revisado_por_padre);
                    totalLeidas += incidenciasLeidas.length;
                }
                
                // Título de sección estilizado
                html += `
                    <!-- ═══════════════════════════════════════════════════════════════ -->
                    <!-- SECCIÓN: HISTORIAL DE INCIDENCIAS REVISADAS -->
                    <div style="margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; padding: 20px 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                                <div>
                                    <h3 style="margin: 0; font-size: 22px; font-weight: 600;">
                                        <i class="fas fa-history" style="margin-right: 10px;"></i>
                                        HISTORIAL DE INCIDENCIAS
                                    </h3>
                                    <p style="margin: 8px 0 0; opacity: 0.9; font-size: 14px;">
                                        Incidencias ya revisadas y confirmadas
                                    </p>
                                </div>
                                <div style="background: rgba(255,255,255,0.2); padding: 12px 20px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 28px; font-weight: bold;">${totalLeidas}</div>
                                    <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Revisadas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Contenido por cada hijo
                for (const stat of estadisticas) {
                    const hijo = stat.estudiante;
                    
                    // Filtrar solo incidencias LEÍDAS para el Historial
                    const incidenciasLeidas = stat.ultimasIncidencias.filter(inc => inc.revisado_por_padre);
                    
                    if (incidenciasLeidas.length > 0) {
                        html += `
                            <div style="background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: hidden;">
                                <!-- Cabecera del hijo -->
                                <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 18px 25px; border-bottom: 2px solid #e0e0e0;">
                                    <div style="display: flex; align-items: center; gap: 15px;">
                                        <div style="background: linear-gradient(135deg, #28a745, #218838); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px;">
                                            <i class="fas fa-user-check"></i>
                                        </div>
                                        <div>
                                            <h4 style="margin: 0; font-size: 18px; color: #333;">${hijo.nombre_completo}</h4>
                                            <p style="margin: 3px 0 0; color: #666; font-size: 13px;">
                                                <i class="fas fa-graduation-cap" style="margin-right: 5px;"></i>
                                                ${hijo.grado}° ${hijo.seccion} 
                                                <span style="margin-left: 10px; background: #28a745; color: white; padding: 2px 10px; border-radius: 20px; font-size: 11px;">
                                                    <i class="fas fa-check-double" style="margin-right: 3px;"></i>
                                                    ${incidenciasLeidas.length} revisada(s)
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Tabla de incidencias -->
                                <div style="padding: 20px;">
                                    <div class="table-container" style="border-radius: 10px; overflow: hidden; border: 1px solid #e0e0e0;">
                                        <table class="table" style="margin: 0;">
                                            <thead>
                                                <tr style="background: #f1f8f4;">
                                                    <th style="padding: 12px 15px;">Fecha</th>
                                                    <th style="padding: 12px 15px;">Tipo</th>
                                                    <th style="padding: 12px 15px;">Descripción</th>
                                                    <th style="padding: 12px 15px;">Severidad</th>
                                                    <th style="padding: 12px 15px;">Revisado</th>
                                                    <th style="padding: 12px 15px;">Detalle</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${incidenciasLeidas.map(inc => {
                                                    const fecha = new Date(inc.fecha).toLocaleDateString('es-PE');
                                                    const tipoIcon = inc.tipo === 'merito' ? '🏆' : '⚠️';
                                                    const nombre = inc.tipo === 'merito' 
                                                        ? (inc.catalogo_merito?.nombre || 'Mérito')
                                                        : (inc.catalogo_demerito?.nombre || 'Demérito');
                                                    const severidadClass = inc.severidad === 'leve' ? 'badge-leve' 
                                                        : inc.severidad === 'grave' ? 'badge-grave' 
                                                        : inc.severidad === 'muy_grave' ? 'badge-muy-grave' : '';
                                                    const severidadText = inc.tipo === 'merito' ? 'Reconocimiento'
                                                        : inc.severidad === 'leve' ? 'Leve'
                                                        : inc.severidad === 'grave' ? 'Grave'
                                                        : inc.severidad === 'muy_grave' ? 'Muy Grave' : '-';
                                                    
                                                    const fechaRevision = inc.fecha_revision_padre 
                                                        ? new Date(inc.fecha_revision_padre).toLocaleDateString('es-PE')
                                                        : '-';
                                                    
                                                    return `
                                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                                            <td style="padding: 12px 15px;">${fecha}</td>
                                                            <td style="padding: 12px 15px;">${tipoIcon} ${nombre}</td>
                                                            <td style="padding: 12px 15px;">${inc.descripcion ? inc.descripcion.substring(0, 50) + (inc.descripcion.length > 50 ? '...' : '') : '-'}</td>
                                                            <td style="padding: 12px 15px;"><span class="badge ${severidadClass}">${severidadText}</span></td>
                                                            <td style="padding: 12px 15px;">
                                                                <span class="badge" style="background: linear-gradient(135deg, #28a745, #218838); color: white; padding: 5px 10px;">
                                                                    <i class="fas fa-check-circle" style="margin-right: 4px;"></i> ${fechaRevision}
                                                                </span>
                                                            </td>
                                                            <td style="padding: 12px 15px;">
                                                                <button class="btn btn-secondary" onclick="verDetalleIncidencia('${inc.id}')" style="padding: 8px 14px; font-size: 12px; width: auto; border-radius: 8px;">
                                                                    <i class="fas fa-eye"></i> Ver
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                if (totalLeidas === 0) {
                    html += `
                        <div style="background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 60px 40px; text-align: center;">
                            <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
                                <i class="fas fa-inbox" style="font-size: 45px; color: #adb5bd;"></i>
                            </div>
                            <h3 style="margin: 0 0 10px; color: #495057; font-size: 22px;">No hay incidencias revisadas aún</h3>
                            <p style="color: #6c757d; font-size: 15px; margin: 0;">
                                Las incidencias que confirme como leídas desde el Dashboard aparecerán aquí
                            </p>
                            <button class="btn btn-primary" onclick="showSection('padres')" style="margin-top: 25px; padding: 12px 30px;">
                                <i class="fas fa-arrow-left" style="margin-right: 8px;"></i> Ir al Dashboard
                            </button>
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error cargando historial del padre:', err);
                container.innerHTML = `
                    <div style="background: white; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); padding: 60px 40px; text-align: center;">
                        <div style="background: #fff5f5; width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 45px; color: #dc3545;"></i>
                        </div>
                        <h3 style="margin: 0 0 10px; color: #333;">Error al cargar historial</h3>
                        <p style="color: #666;">Por favor recargue la página e intente nuevamente.</p>
                        <button class="btn btn-secondary" onclick="location.reload()" style="margin-top: 20px;">
                            <i class="fas fa-redo" style="margin-right: 8px;"></i> Recargar Página
                        </button>
                    </div>
                `;
            }
        }

        function getAdminContent() {
            return `
                <div class="grid grid-3" style="margin-bottom: 30px;">
                    <div class="card admin-card">
                        <h3><i class="fas fa-users-cog"></i> Gestión de Usuarios</h3>
                        <div class="grid grid-2" style="gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary btn-sm" onclick="showUserManagement()">
                                <i class="fas fa-plus-circle"></i> Crear Usuario
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="showUserList()">
                                <i class="fas fa-list"></i> Ver Usuarios
                            </button>
                        </div>
                    </div>
                    
                    <div class="card admin-card">
                        <h3><i class="fas fa-clipboard-check"></i> Solicitudes Pendientes</h3>
                        <div class="stats-number" style="color: var(--color-ata-rojo);">5</div>
                        <div class="stats-label">Pendientes de aprobación</div>
                        <button class="btn btn-warning btn-sm" onclick="showPendingRequests()" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-eye"></i> Revisar Solicitudes
                        </button>
                    </div>
                    
                    <div class="card admin-card">
                        <h3><i class="fas fa-chart-bar"></i> Estadísticas Sistema</h3>
                        <div class="grid grid-2" style="gap: 15px; margin-top: 10px;">
                            <div class="mini-stat">
                                <div class="stats-number" style="font-size: 18px;">156</div>
                                <div class="stats-label" style="font-size: 11px;">Total Usuarios</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stats-number" style="font-size: 18px;">89</div>
                                <div class="stats-label" style="font-size: 11px;">Activos Hoy</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-cogs"></i> Configuración del Sistema</h3>
                        <div class="grid grid-2" style="gap: 10px; margin-top: 15px;">
                            <button class="btn btn-info btn-sm" onclick="showClassroomConfig()">
                                <i class="fas fa-school"></i> Gestionar Aulas
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showStudentConfig()">
                                <i class="fas fa-user-graduate"></i> Estudiantes
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showIncidentConfig()">
                                <i class="fas fa-exclamation-circle"></i> Tipos Incidencias
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showSystemConfig()">
                                <i class="fas fa-wrench"></i> Sistema
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-shield-alt"></i> Incidencias - Control Total</h3>
                        <div class="admin-stats">
                            <div class="mini-stat">
                                <div class="stats-number" style="color: var(--color-ata-rojo);">23</div>
                                <div class="stats-label">Críticas</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stats-number" style="color: var(--color-ata-dorado);">45</div>
                                <div class="stats-label">Moderadas</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stats-number" style="color: var(--color-ata-verde);">67</div>
                                <div class="stats-label">Leves</div>
                            </div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="showAllIncidents()" style="width: 100%; margin-top: 15px;">
                            <i class="fas fa-eye"></i> Gestionar Todas las Incidencias
                        </button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3><i class="fas fa-file-export"></i> Reportes Administrativos</h3>
                    <div class="grid grid-4" style="gap: 10px; margin-top: 15px;">
                        <button class="btn btn-success btn-sm" onclick="exportUsers()">
                            <i class="fas fa-users"></i> Exportar Usuarios
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportIncidents()">
                            <i class="fas fa-file-alt"></i> Exportar Incidencias
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportStats()">
                            <i class="fas fa-chart-pie"></i> Estadísticas
                        </button>
                        <button class="btn btn-success btn-sm" onclick="generateReport()">
                            <i class="fas fa-file-pdf"></i> Reporte UGEL
                        </button>
                    </div>
                </div>
            `;
        }
        
        // =====================================================
        // FUNCIÓN PARA MOSTRAR NOTIFICACIONES TOAST
        // =====================================================
        function mostrarNotificacion(mensaje, tipo = 'info') {
            // Eliminar notificación anterior si existe
            const existente = document.getElementById('notificacionToast');
            if (existente) existente.remove();
            
            // Crear el elemento de notificación
            const toast = document.createElement('div');
            toast.id = 'notificacionToast';
            
            // Colores según tipo
            const colores = {
                'success': { bg: '#d4edda', border: '#28a745', color: '#155724', icon: 'fa-check-circle' },
                'error': { bg: '#f8d7da', border: '#dc3545', color: '#721c24', icon: 'fa-exclamation-circle' },
                'warning': { bg: '#fff3cd', border: '#ffc107', color: '#856404', icon: 'fa-exclamation-triangle' },
                'info': { bg: '#d1ecf1', border: '#17a2b8', color: '#0c5460', icon: 'fa-info-circle' }
            };
            
            const estilo = colores[tipo] || colores.info;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${estilo.bg};
                border-left: 4px solid ${estilo.border};
                color: ${estilo.color};
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 99999;
                font-size: 14px;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideInRight 0.3s ease;
                max-width: 400px;
            `;
            
            toast.innerHTML = `<i class="fas ${estilo.icon}"></i> ${mensaje}`;
            
            // Agregar estilos de animación si no existen
            if (!document.getElementById('toastAnimationStyles')) {
                const style = document.createElement('style');
                style.id = 'toastAnimationStyles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Auto-cerrar después de 4 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // =====================================================
        // FUNCIONES DE MODAL GENÉRICO (REEMPLAZO DE ALERT/CONFIRM)
        // =====================================================
        
        /**
         * Muestra un modal de alerta (reemplazo de alert())
         * @param {string} mensaje - El mensaje a mostrar
         * @param {string} titulo - Título del modal (opcional)
         * @param {string} tipo - 'success', 'error', 'warning', 'info' (opcional)
         * @returns {Promise} - Se resuelve cuando el usuario cierra el modal
         */
        function mostrarAlerta(mensaje, titulo = 'Aviso', tipo = 'info') {
            return new Promise((resolve) => {
                // Eliminar modal anterior si existe
                const existente = document.getElementById('modalGenericoAlerta');
                if (existente) existente.remove();
                
                const iconos = {
                    'success': 'fa-check-circle',
                    'error': 'fa-times-circle',
                    'warning': 'fa-exclamation-triangle',
                    'info': 'fa-info-circle'
                };
                
                const modal = document.createElement('div');
                modal.id = 'modalGenericoAlerta';
                modal.className = 'modal-generic';
                modal.innerHTML = `
                    <div class="modal-generic-content">
                        <div class="modal-generic-header ${tipo}">
                            <i class="fas ${iconos[tipo] || iconos.info} modal-generic-icon"></i>
                            <h3 class="modal-generic-title">${titulo}</h3>
                        </div>
                        <div class="modal-generic-body">${mensaje}</div>
                        <div class="modal-generic-footer">
                            <button class="modal-btn modal-btn-primary" id="btnAceptarAlerta">
                                <i class="fas fa-check"></i> Aceptar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Focus en el botón
                document.getElementById('btnAceptarAlerta').focus();
                
                // Event listeners
                document.getElementById('btnAceptarAlerta').onclick = () => {
                    modal.remove();
                    resolve();
                };
                
                // Cerrar con ESC
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve();
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // Cerrar al hacer clic fuera
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve();
                    }
                };
            });
        }
        
        /**
         * Muestra un modal de confirmación (reemplazo de confirm())
         * @param {string} mensaje - El mensaje a mostrar
         * @param {string} titulo - Título del modal (opcional)
         * @param {object} opciones - Opciones adicionales { tipo, btnConfirmar, btnCancelar, peligroso }
         * @returns {Promise<boolean>} - true si confirma, false si cancela
         */
        function mostrarConfirmacion(mensaje, titulo = 'Confirmar', opciones = {}) {
            return new Promise((resolve) => {
                // Eliminar modal anterior si existe
                const existente = document.getElementById('modalGenericoConfirm');
                if (existente) existente.remove();
                
                const tipo = opciones.tipo || 'confirm';
                const btnConfirmarTexto = opciones.btnConfirmar || 'Aceptar';
                const btnCancelarTexto = opciones.btnCancelar || 'Cancelar';
                const esPeligroso = opciones.peligroso || false;
                
                const iconos = {
                    'success': 'fa-check-circle',
                    'error': 'fa-times-circle',
                    'warning': 'fa-exclamation-triangle',
                    'info': 'fa-info-circle',
                    'confirm': 'fa-question-circle'
                };
                
                const modal = document.createElement('div');
                modal.id = 'modalGenericoConfirm';
                modal.className = 'modal-generic';
                modal.innerHTML = `
                    <div class="modal-generic-content">
                        <div class="modal-generic-header ${tipo}">
                            <i class="fas ${iconos[tipo] || iconos.confirm} modal-generic-icon"></i>
                            <h3 class="modal-generic-title">${titulo}</h3>
                        </div>
                        <div class="modal-generic-body">${mensaje}</div>
                        <div class="modal-generic-footer">
                            <button class="modal-btn modal-btn-cancel" id="btnCancelarConfirm">
                                <i class="fas fa-times"></i> ${btnCancelarTexto}
                            </button>
                            <button class="modal-btn ${esPeligroso ? 'modal-btn-danger' : 'modal-btn-primary'}" id="btnAceptarConfirm">
                                <i class="fas ${esPeligroso ? 'fa-trash' : 'fa-check'}"></i> ${btnConfirmarTexto}
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Focus en el botón cancelar (más seguro)
                document.getElementById('btnCancelarConfirm').focus();
                
                // Event listeners
                document.getElementById('btnAceptarConfirm').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                
                document.getElementById('btnCancelarConfirm').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
                
                // Cerrar con ESC (cancela)
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleEsc);
                        resolve(false);
                    }
                };
                document.addEventListener('keydown', handleEsc);
                
                // Cerrar al hacer clic fuera (cancela)
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                };
            });
        }
        
        // =====================================================
        // FUNCIÓN PARA GUARDAR AULA ASIGNADA DEL TUTOR
        // =====================================================
        async function guardarAulaAsignada() {
            const gradoSelect = document.getElementById('tutorGradoSelect');
            const seccionSelect = document.getElementById('tutorSeccionSelect');
            
            if (!gradoSelect || !seccionSelect) {
                mostrarNotificacion('Error: No se encontraron los selectores', 'error');
                return;
            }
            
            const grado = gradoSelect.value;
            const seccion = seccionSelect.value;
            
            if (!grado || !seccion) {
                mostrarNotificacion('Por favor selecciona grado y sección', 'warning');
                return;
            }
            
            // Formato: "1A", "2B", etc.
            const aulaAsignada = `${grado}${seccion}`;
            
            try {
                console.log('💾 Guardando aula asignada:', aulaAsignada, 'para usuario:', currentUser.id);
                
                // Actualizar en Supabase
                const { data, error } = await supabase
                    .from('users')
                    .update({ 
                        aulas_asignadas: [aulaAsignada],
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id)
                    .select();
                
                if (error) {
                    console.error('❌ Error guardando aula:', error);
                    mostrarNotificacion(`Error al guardar: ${error.message}`, 'error');
                    return;
                }
                
                console.log('✅ Aula guardada exitosamente:', data);
                
                // Actualizar el objeto currentUser local
                currentUser.aulas_asignadas = [aulaAsignada];
                currentUser.aulaAsignada = `${grado}°${seccion}`;
                
                // Actualizar la UI
                const aulaTexto = document.getElementById('aulaAsignadaTexto');
                const aulaContainer = document.getElementById('aulaAsignadaActual');
                if (aulaTexto) aulaTexto.textContent = `${grado}°${seccion}`;
                if (aulaContainer) aulaContainer.style.display = 'block';
                
                // Actualizar el título del dashboard
                const title = document.getElementById('dashboardTitle');
                if (title) title.textContent = `Panel del Tutor - ${grado}°${seccion}`;
                
                // Actualizar subtítulo de estadísticas
                const statsSubtitle = document.getElementById('statsSectionSubtitle');
                if (statsSubtitle) statsSubtitle.textContent = `Resumen de incidencias de estudiantes de ${grado}°${seccion}`;
                
                mostrarNotificacion(`✅ Aula ${grado}°${seccion} asignada correctamente`, 'success');
                
                // Recargar estadísticas con el nuevo filtro
                await actualizarDashboardStats();
                
                // También actualizar la info del aula en la card
                await cargarInfoAulaTutor(grado, seccion);
                
            } catch (err) {
                console.error('❌ Error inesperado:', err);
                mostrarNotificacion('Error inesperado al guardar', 'error');
            }
        }
        
        // Cargar info del aula del tutor
        async function cargarInfoAulaTutor(grado, seccion) {
            const tutorAulaInfo = document.getElementById('tutorAulaInfo');
            if (!tutorAulaInfo) return;
            
            try {
                // Contar estudiantes de esta aula
                const { data: estudiantes, error } = await supabase
                    .from('estudiantes')
                    .select('id', { count: 'exact' })
                    .eq('grado', grado)
                    .eq('seccion', seccion)
                    .eq('activo', true);
                
                if (error) throw error;
                
                const totalEstudiantes = estudiantes?.length || 0;
                
                // Contar incidencias de hoy para esta aula
                const hoy = new Date().toISOString().split('T')[0];
                const idsEstudiantes = estudiantes?.map(e => e.id) || [];
                
                let incidenciasHoy = 0;
                if (idsEstudiantes.length > 0) {
                    const { data: incidencias } = await supabase
                        .from('incidencias')
                        .select('id')
                        .in('estudiante_id', idsEstudiantes)
                        .gte('fecha', hoy);
                    incidenciasHoy = incidencias?.length || 0;
                }
                
                // Contar total de incidencias
                let totalIncidencias = 0;
                if (idsEstudiantes.length > 0) {
                    const { data: todasInc } = await supabase
                        .from('incidencias')
                        .select('id')
                        .in('estudiante_id', idsEstudiantes);
                    totalIncidencias = todasInc?.length || 0;
                }
                
                tutorAulaInfo.innerHTML = `
                    <p><strong>${totalEstudiantes}</strong> estudiantes en el aula</p>
                    <p><strong>${totalIncidencias}</strong> incidencias registradas</p>
                    <p><strong>${incidenciasHoy}</strong> hoy</p>
                `;
                
            } catch (err) {
                console.error('Error cargando info del aula:', err);
                tutorAulaInfo.innerHTML = '<p style="color: #666;">Error al cargar información</p>';
            }
        }
        
        // Inicializar la selección de aula cuando se carga el dashboard del tutor
        function inicializarSelectorAulaTutor() {
            console.log('🏫 Ejecutando inicializarSelectorAulaTutor...');
            
            if (!currentUser?.aulas_asignadas) {
                console.log('🏫 No hay aulas asignadas para este tutor');
                return;
            }
            
            const aulas = Array.isArray(currentUser.aulas_asignadas) 
                ? currentUser.aulas_asignadas 
                : [currentUser.aulas_asignadas];
            
            console.log('🏫 Aulas a procesar:', aulas);
            
            if (aulas.length > 0 && aulas[0]) {
                const aulaRaw = aulas[0]; // Ej: "1A"
                const matchAula = aulaRaw.match(/(\d+)([A-E])/i);
                
                if (matchAula) {
                    const grado = matchAula[1];
                    const seccion = matchAula[2].toUpperCase();
                    
                    console.log('🏫 Configurando aula:', grado, seccion);
                    
                    // Seleccionar en los dropdowns
                    const gradoSelect = document.getElementById('tutorGradoSelect');
                    const seccionSelect = document.getElementById('tutorSeccionSelect');
                    
                    if (gradoSelect) {
                        gradoSelect.value = grado;
                        console.log('✅ Grado seleccionado:', grado);
                    }
                    if (seccionSelect) {
                        seccionSelect.value = seccion;
                        console.log('✅ Sección seleccionada:', seccion);
                    }
                    
                    // Mostrar el aula asignada actual
                    const aulaTexto = document.getElementById('aulaAsignadaTexto');
                    const aulaContainer = document.getElementById('aulaAsignadaActual');
                    if (aulaTexto) aulaTexto.textContent = `${grado}°${seccion}`;
                    if (aulaContainer) aulaContainer.style.display = 'block';
                    
                    // Cargar info del aula
                    cargarInfoAulaTutor(grado, seccion);
                }
            }
        }
        
        // Configurar navegación especial para administrador
        function setupAdminNavigation() {
            // El admin puede ver todas las secciones
            const navItems = document.querySelectorAll('.nav-link');
            navItems.forEach(item => {
                item.style.display = 'list-item';
            });
            
            // Agregar sección especial de administración si no existe
            const nav = document.querySelector('.nav-menu');
            const adminNav = document.getElementById('adminNavItem');
            if (!adminNav) {
                const adminNavItem = document.createElement('li');
                adminNavItem.id = 'adminNavItem';
                adminNavItem.innerHTML = `
                    <a href="#" class="nav-link" onclick="showSection('admin')" style="background: linear-gradient(135deg, var(--color-ata-dorado), #FFC107); color: #000; font-weight: 600;">
                        <i class="fas fa-crown"></i> Administración
                    </a>
                `;
                nav.appendChild(adminNavItem);
            }
        }

        // Navegación entre secciones
        function showSection(section) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(s => {
                s.style.display = 'none';
            });
            
            // Remover clase active de todos los enlaces
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Mostrar la sección seleccionada
            const sectionElement = document.getElementById(section + 'Section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
            
            // Activar el enlace correspondiente
            const activeLink = document.querySelector(`[onclick="showSection('${section}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Cargar datos específicos de la sección
            if (section === 'reportes') {
                cargarDatosReportes();
            } else if (section === 'admin') {
                cargarDatosAdmin();
            } else if (section === 'historial') {
                // Si es padre, mostrar historial de padre (incidencias leídas)
                if (currentUser && currentUser.role === 'padre') {
                    document.getElementById('historialDocenteContent').style.display = 'none';
                    document.getElementById('historialPadreContent').style.display = 'block';
                    cargarHistorialPadre();
                } else {
                    document.getElementById('historialDocenteContent').style.display = 'block';
                    document.getElementById('historialPadreContent').style.display = 'none';
                    renderizarHistorial();
                }
            } else if (section === 'dashboard') {
                // Si es admin, mostrar el panel de administración en lugar del dashboard genérico
                if (currentUser && currentUser.role === 'admin') {
                    // Ocultar dashboard genérico
                    const dashboardSection = document.getElementById('dashboardSection');
                    if (dashboardSection) dashboardSection.style.display = 'none';
                    
                    // Mostrar adminSection
                    const adminSection = document.getElementById('adminSection');
                    if (adminSection) {
                        adminSection.style.display = 'block';
                        cargarDatosAdmin();
                    }
                } else if (currentUser && currentUser.role === 'padre') {
                    // Recargar portal del padre si es padre
                    cargarPortalPadre();
                }
            }
        }

        // Función de logout
        async function logout() {
            try {
                // Cerrar sesión en Supabase Auth
                await supabase.auth.signOut();
                console.log('🚪 Sesión cerrada en Supabase');
            } catch (err) {
                console.error('Error al cerrar sesión:', err);
            }
            
            // Limpiar estado del usuario
            currentUser = null;
            selectedUserRole = null;
            
            // Ocultar aplicación principal
            const mainApp = document.getElementById('mainApp');
            mainApp.classList.remove('show');
            
            // Mostrar pantalla de login
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Limpiar formularios
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Resetear todos los steps
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step1').classList.add('visible');
            document.getElementById('step1').style.display = '';
            
            document.getElementById('step1b').classList.add('hidden');
            document.getElementById('step1b').classList.remove('visible');
            document.getElementById('step1b').style.display = '';
            
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step2').classList.remove('visible');
            document.getElementById('step2').style.display = '';
            
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step3').classList.remove('visible');
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step4').classList.remove('visible');
            
            // Volver a la sección dashboard
            showSection('dashboard');
            
            console.log('✅ Logout completado - Volviendo a selección de cuenta');
        }

        // Verificar si hay sesión activa al cargar la página
        async function checkExistingSession() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session && session.user) {
                    console.log('🔐 Sesión activa encontrada:', session.user.email);
                    
                    // Obtener datos del usuario desde la tabla users
                    const { data: userData, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('email', session.user.email)
                        .single();
                    
                    if (userData && !error) {
                        // Definir permisos según el rol
                        const rolePermissions = {
                            'docente': ['incidencias', 'historial'],
                            'tutor': ['incidencias', 'historial', 'reportes'],
                            'auxiliar': ['incidencias', 'historial'],
                            'toe': ['incidencias', 'historial', 'reportes'],
                            'direccion': ['incidencias', 'historial', 'reportes'],
                            'padre': ['historial'],
                            'admin': ['incidencias', 'historial', 'reportes']
                        };
                        
                        currentUser = {
                            username: userData.dni || userData.email,
                            email: userData.email,
                            role: userData.role,
                            name: userData.nombre_completo || 'Usuario',
                            nombre: userData.nombre_completo,
                            dni: userData.dni,
                            id: userData.id,
                            permissions: rolePermissions[userData.role] || ['historial'],
                            isDemo: userData.email && userData.email.includes('.demo@'),
                            aulas_asignadas: userData.aulas_asignadas || null
                        };
                        
                        selectedUserRole = userData.role;
                        console.log('✅ Sesión restaurada para:', currentUser.name);
                        console.log('🏫 Aulas asignadas cargadas:', currentUser.aulas_asignadas);
                        login();
                        return true;
                    }
                }
            } catch (err) {
                console.log('No hay sesión activa:', err.message);
            }
            return false;
        }

        // Efectos visuales
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar sesión existente primero
            const hasSession = await checkExistingSession();
            
            if (!hasSession) {
                // 🔒 FORZAR OCULTAMIENTO DE STEPS AL CARGAR (solo si no hay sesión)
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step2').classList.remove('visible');
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step3').classList.remove('visible');
                document.getElementById('step4').classList.add('hidden');
                document.getElementById('step4').classList.remove('visible');
                document.getElementById('step1b').classList.add('hidden');
                document.getElementById('step1b').classList.remove('visible');
            }
            
            // Configurar event listener del formulario de login
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('🚀 FORM SUBMIT TRIGGERED!');
                console.log('selectedUserRole:', selectedUserRole);
                
                // Limpiar mensaje anterior
                clearLoginMessage();
                
                // Verificar que se haya seleccionado un rol
                if (!selectedUserRole) {
                    console.log('❌ No role selected');
                    showLoginMessage('Por favor, selecciona tu tipo de cuenta primero', 'error');
                    backToRoleSelection();
                    return;
                }
                
                const username = document.getElementById('username').value.toLowerCase();
                const password = document.getElementById('password').value;
                console.log('📝 Username:', username, 'Password:', password);
                
                // Validar campos vacíos
                if (!username || !password) {
                    console.log('❌ Empty fields');
                    showLoginMessage('Por favor, complete todos los campos', 'error');
                    return;
                }
                
                if (users[username] && users[username].password === password) {
                    console.log('✅ User found and password correct');
                    // Validar que el usuario corresponde al rol seleccionado
                    const userRole = users[username].role.toLowerCase();
                    const expectedRole = selectedUserRole;
                    console.log('🔍 User role:', userRole, 'Expected:', expectedRole);
                    
                    // Mapear roles para validación (incluye variaciones para usuarios demo)
                    const roleMapping = {
                        'docente': ['docente'],
                        'tutor': ['tutor', 'tutor 1°b'],
                        'auxiliar': ['auxiliar', 'auxiliar de educación'],
                        'toe': ['toe', 'coordinador toe'],
                        'direccion': ['dirección', 'director'],
                        'padre': ['padre/madre'],
                        'admin': ['administrador del sistema']
                    };
                    
                    // Verificar si el rol del usuario coincide con alguna variación esperada
                    const expectedRoles = roleMapping[expectedRole] || [];
                    const isValidRole = expectedRoles.some(role => role === userRole);
                    console.log('🎯 Expected roles:', expectedRoles, 'Valid role:', isValidRole);
                    
                    if (isValidRole) {
                        console.log('🎉 Role validation successful');
                        // Mostrar mensaje de éxito antes de redirigir
                        showLoginMessage('Iniciando sesión...', 'success');
                        setTimeout(() => {
                            currentUser = { username, ...users[username] };
                            console.log('👤 Current user set:', currentUser);
                            console.log('🔥 CALLING LOGIN FUNCTION');
                            login();
                        }, 1000);
                    } else {
                        console.log('❌ Invalid role');
                        const roleNames = {
                            'docente': 'Docente',
                            'tutor': 'Tutor',
                            'auxiliar': 'Auxiliar',
                            'toe': 'TOE',
                            'direccion': 'Dirección',
                            'padre': 'Padre/Madre/Apoderado',
                            'admin': 'Administrador'
                        };
                        showLoginMessage(
                            `Este usuario no corresponde al rol ${roleNames[selectedUserRole]}. Por favor verifica tus credenciales.`, 
                            'error'
                        );
                    }
                } else {
                    console.log('❌ User not found or wrong password');
                    // Mensaje mejorado para credenciales incorrectas
                    showLoginMessage(
                        `<strong>Credenciales incorrectas.</strong><br>
                        Verifica tu usuario y contraseña.`, 
                        'error'
                    );
                    
                    // Mostrar enlace de activación de cuenta
                    document.getElementById('activarCuentaLink').style.display = 'block';
                    document.getElementById('solicitarRegistroLink').style.display = 'none';
                }
            });

            // Configurar event listener del formulario de incidencia
            document.getElementById('incidenciaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                mostrarAlerta('Incidencia registrada exitosamente', 'Éxito', 'success');
                showSection('dashboard');
            });

            // Efectos hover para las cards
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });

        // Variables para el flujo de login
        let selectedUserRole = null;

        // Función para seleccionar rol y avanzar al paso de opciones
        function selectRole(role) {
            selectedUserRole = role;
            
            // Actualizar texto del rol seleccionado
            const roleText = {
                'docente': 'Docente',
                'tutor': 'Tutor',
                'auxiliar': 'Auxiliar',
                'toe': 'TOE',
                'direccion': 'Dirección',
                'padre': 'Padre/Madre/Apoderado',
                'admin': 'Administrador del Sistema'
            };
            
            document.getElementById('selectedRoleText').textContent = roleText[role];
            
            // Transición entre pasos
            const step1 = document.getElementById('step1');
            const step1b = document.getElementById('step1b');
            
            // Ocultar paso 1 y limpiar estilos inline
            step1.classList.remove('visible');
            step1.classList.add('hidden');
            step1.style.display = '';
            
            // Mostrar paso 1b después de un breve delay
            setTimeout(() => {
                step1b.style.display = '';
                step1b.classList.remove('hidden');
                step1b.classList.add('visible');
            }, 300);
        }

        // Función especial para administrador (acceso directo)
        function selectRoleAdmin() {
            selectedUserRole = 'admin';
            
            // Actualizar texto del rol seleccionado
            document.getElementById('roleText').textContent = 'Administrador del Sistema';
            
            // Ir directamente al login sin pasar por solicitud
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            
            // Ocultar paso 1
            step1.classList.remove('visible');
            step1.classList.add('hidden');
            
            // Mostrar paso 2 directamente
            setTimeout(() => {
                step2.classList.remove('hidden');
                step2.classList.add('visible');
                
                // Enfocar en el campo de usuario
                document.getElementById('username').focus();
                
                // Mostrar mensaje especial para admin (si no existe ya)
                if (!document.getElementById('adminAccessAlert')) {
                    const adminAlert = document.createElement('div');
                    adminAlert.id = 'adminAccessAlert';
                    adminAlert.innerHTML = `
                        <div class="alert alert-warning" style="margin-bottom: 15px;">
                            <i class="fas fa-crown"></i>
                            <strong>ACCESO ADMINISTRATIVO:</strong> Ingrese las credenciales del administrador del sistema.
                        </div>
                    `;
                    step2.insertBefore(adminAlert, step2.firstChild);
                }
            }, 300);
        }

        // Función para volver a la selección de roles
        // Función para volver a la selección de roles
        function backToRoleSelection() {
            selectedUserRole = null;
            
            // Limpiar mensajes
            clearLoginMessage();
            
            const step1 = document.getElementById('step1');
            const step1b = document.getElementById('step1b');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const step4 = document.getElementById('step4');
            const requestForm = document.getElementById('requestForm');
            
            // Ocultar TODOS los pasos excepto step1 y limpiar estilos inline
            step1b.classList.remove('visible');
            step1b.classList.add('hidden');
            step1b.style.display = '';
            
            step2.classList.remove('visible');
            step2.classList.add('hidden');
            step2.style.display = '';
            
            step3.classList.remove('visible');
            step3.classList.add('hidden');
            step3.style.display = '';
            
            step4.classList.remove('visible');
            step4.classList.add('hidden');
            step4.style.display = '';
            
            // Ocultar formulario de solicitud
            requestForm.classList.remove('visible');
            
            // Eliminar mensaje de admin si existe
            const adminAlert = document.getElementById('adminAccessAlert');
            if (adminAlert) adminAlert.remove();
            
            // Resetear step3 (activación) - volver al paso 1
            irAPasoActivacion(1);
            document.getElementById('verificar_dni').value = '';
            document.getElementById('verificar_nombre').value = '';
            document.getElementById('verificarMessage').innerHTML = '';
            document.getElementById('verificarMessage').classList.remove('show');
            const nuevaPass = document.getElementById('nueva_password');
            const confirmarPass = document.getElementById('confirmar_password');
            const activarMsg = document.getElementById('activarMessage');
            if (nuevaPass) nuevaPass.value = '';
            if (confirmarPass) confirmarPass.value = '';
            if (activarMsg) {
                activarMsg.innerHTML = '';
                activarMsg.classList.remove('show');
            }
            window.cuentaVerificada = null;
            
            // Mostrar paso 1 después de un breve delay
            setTimeout(() => {
                step1.style.display = '';
                step1.classList.remove('hidden');
                step1.classList.add('visible');
                
                // Limpiar formulario de login
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }, 300);
        }

        // Función para mostrar el formulario de login
        function showDemoLogin() {
            const roleText = {
                'docente': 'Docente',
                'tutor': 'Tutor', 
                'auxiliar': 'Auxiliar',
                'toe': 'TOE',
                'direccion': 'Dirección',
                'padre': 'Padre/Madre/Apoderado',
                'admin': 'Administrador del Sistema'
            };
            
            document.getElementById('roleText').textContent = roleText[selectedUserRole];
            
            const step1b = document.getElementById('step1b');
            const step2 = document.getElementById('step2');
            
            // Ocultar paso 1b
            step1b.classList.remove('visible');
            step1b.classList.add('hidden');
            
            // Mostrar paso 2 después de un breve delay
            setTimeout(() => {
                step2.classList.remove('hidden');
                step2.classList.add('visible');
                
                // Ocultar enlaces de ayuda al iniciar sesión normal
                document.getElementById('activarCuentaLink').style.display = 'none';
                document.getElementById('solicitarRegistroLink').style.display = 'none';
                
                // Limpiar los campos para que el usuario ingrese sus credenciales
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Enfocar en el campo de usuario
                setTimeout(() => {
                    document.getElementById('username').focus();
                }, 500);
            }, 300);
        }

        // Función para mostrar formulario de activación de cuenta
        function showActivarCuenta() {
            const roleText = {
                'docente': 'Docente',
                'tutor': 'Tutor', 
                'auxiliar': 'Auxiliar',
                'toe': 'TOE',
                'direccion': 'Dirección',
                'padre': 'Padre/Madre/Apoderado',
                'admin': 'Administrador del Sistema'
            };
            
            const step1b = document.getElementById('step1b');
            const step3 = document.getElementById('step3');
            
            // Actualizar el título para activación
            document.getElementById('roleTextActivacion').textContent = roleText[selectedUserRole];
            
            // Ocultar paso 1b
            step1b.classList.remove('visible');
            step1b.classList.add('hidden');
            
            // Resetear formularios - ir al paso 1 de activación
            document.getElementById('verificar_dni').value = '';
            document.getElementById('verificar_nombre').value = '';
            document.getElementById('verificarMessage').innerHTML = '';
            document.getElementById('verificarMessage').classList.remove('show');
            
            // Mostrar paso 3 después de un breve delay
            setTimeout(() => {
                step3.classList.remove('hidden');
                step3.classList.add('visible');
                
                // Resetear al paso 1 de activación
                irAPasoActivacion(1);
                
                // Enfocar en el campo DNI
                setTimeout(() => {
                    document.getElementById('verificar_dni').focus();
                }, 500);
            }, 300);
        }
        
        // ============================================
        // FUNCIONES DE VALIDACIÓN DE CAMPOS
        // ============================================
        
        // Validar DNI: solo números, exactamente 8 dígitos
        function validarDNI(input) {
            // Eliminar cualquier caracter que no sea número
            input.value = input.value.replace(/\D/g, '');
            
            const dni = input.value;
            const warningId = input.id + '_warning';
            let warningEl = document.getElementById(warningId);
            
            // Crear elemento de advertencia si no existe
            if (!warningEl) {
                warningEl = document.createElement('div');
                warningEl.id = warningId;
                warningEl.className = 'field-warning';
                warningEl.style.cssText = 'color: #856404; background: #fff3cd; padding: 6px 10px; border-radius: 4px; font-size: 11px; margin-top: 5px; display: none; border-left: 3px solid #ffc107;';
                input.parentNode.appendChild(warningEl);
            }
            
            if (dni.length > 0 && dni.length < 8) {
                warningEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> El DNI debe tener exactamente 8 dígitos';
                warningEl.style.display = 'block';
                return false;
            } else if (dni.length === 8) {
                warningEl.style.display = 'none';
                return true;
            } else {
                warningEl.style.display = 'none';
                return false;
            }
        }
        
        // Validar Nombre: solo letras, espacios y tildes
        function validarNombre(input) {
            // Convertir a mayúsculas y eliminar caracteres no permitidos
            const valorOriginal = input.value;
            // Permitir solo letras (incluyendo ñ y tildes), espacios
            input.value = valorOriginal.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ\s]/g, '').toUpperCase();
            
            const nombre = input.value;
            const warningId = input.id + '_warning';
            let warningEl = document.getElementById(warningId);
            
            // Crear elemento de advertencia si no existe
            if (!warningEl) {
                warningEl = document.createElement('div');
                warningEl.id = warningId;
                warningEl.className = 'field-warning';
                warningEl.style.cssText = 'color: #856404; background: #fff3cd; padding: 6px 10px; border-radius: 4px; font-size: 11px; margin-top: 5px; display: none; border-left: 3px solid #ffc107;';
                input.parentNode.appendChild(warningEl);
            }
            
            // Si el usuario intentó escribir números
            if (/\d/.test(valorOriginal)) {
                warningEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> El nombre no puede contener números';
                warningEl.style.display = 'block';
                return false;
            } else if (nombre.length > 0 && nombre.trim().split(/\s+/).length < 2) {
                warningEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ingresa nombre y apellidos completos';
                warningEl.style.display = 'block';
                return false;
            } else if (nombre.length > 0) {
                warningEl.style.display = 'none';
                return true;
            } else {
                warningEl.style.display = 'none';
                return false;
            }
        }
        
        // Validar Email en activación (en tiempo real)
        function validarEmailActivacion(input) {
            const email = input.value.trim().toLowerCase();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const emailMsg = document.getElementById('emailVerificacionMessage');
            
            if (email.length === 0) {
                emailMsg.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #856404;"></i> <strong style="color: #856404;">Email obligatorio</strong>';
                emailMsg.className = 'form-message warning show';
                emailMsg.style.background = '#fff3cd';
                emailMsg.style.borderLeft = '3px solid #ffc107';
                window.emailVerificado = null;
                window.datosRegistro.emailVerificado = false;
            } else if (!emailRegex.test(email)) {
                emailMsg.innerHTML = '<i class="fas fa-times-circle" style="color: #dc3545;"></i> <strong style="color: #dc3545;">Email inválido</strong>';
                emailMsg.className = 'form-message error show';
                window.emailVerificado = null;
                window.datosRegistro.emailVerificado = false;
            } else {
                emailMsg.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> <strong style="color: #28a745;">Email válido</strong>';
                emailMsg.className = 'form-message success show';
                window.emailVerificado = email;
                window.cuentaVerificada.email = email;
                window.datosRegistro.emailVerificado = true;
            }
        }
        
        // ============================================
        // FUNCIONES DE NAVEGACIÓN DE PASOS ACTIVACIÓN
        // ============================================
        
        // Función para ir a un paso específico de activación
        function irAPasoActivacion(numeroPaso) {
            // Ocultar todos los pasos de activación
            document.querySelectorAll('.activation-step').forEach(step => {
                step.classList.remove('active');
                step.style.display = 'none';
            });
            
            // Mostrar el paso solicitado
            const pasoActual = document.getElementById(`activationStep${numeroPaso}`);
            if (pasoActual) {
                pasoActual.style.display = 'block';
                setTimeout(() => {
                    pasoActual.classList.add('active');
                }, 50);
            }
            
            // Actualizar indicador de progreso
            actualizarIndicadorPasos(numeroPaso);
        }
        
        // Función para actualizar el indicador visual de pasos
        function actualizarIndicadorPasos(pasoActual) {
            // Actualizar cada step-item
            for (let i = 1; i <= 3; i++) {
                const stepItem = document.getElementById(`stepItem${i}`);
                const stepLine = document.getElementById(`stepLine${i}`);
                
                if (stepItem) {
                    stepItem.classList.remove('active', 'completed');
                    
                    if (i < pasoActual) {
                        stepItem.classList.add('completed');
                    } else if (i === pasoActual) {
                        stepItem.classList.add('active');
                    }
                }
                
                if (stepLine) {
                    stepLine.classList.remove('completed');
                    if (i < pasoActual) {
                        stepLine.classList.add('completed');
                    }
                }
            }
        }
        
        // Función para volver al paso 1 de activación
        function volverAPaso1() {
            irAPasoActivacion(1);
            
            // Limpiar campos y mensajes
            document.getElementById('verificar_dni').value = '';
            document.getElementById('verificar_nombre').value = '';
            document.getElementById('verificarMessage').innerHTML = '';
            document.getElementById('verificarMessage').classList.remove('show');
            
            // Resetear cuenta verificada
            window.cuentaVerificada = null;
            
            // Enfocar en campo DNI
            setTimeout(() => {
                document.getElementById('verificar_dni').focus();
            }, 300);
        }
        
        // Función para volver al paso 2 de activación
        function volverAPaso2() {
            irAPasoActivacion(2);
        }
        
        // Función para verificar si la cuenta existe en Supabase
        async function verificarCuentaExiste() {
            const dni = document.getElementById('verificar_dni').value.trim();
            const nombreCompleto = document.getElementById('verificar_nombre').value.trim().toUpperCase();
            
            // Validar que al menos uno esté lleno
            if (!dni && !nombreCompleto) {
                showVerificarMessage('Por favor ingresa tu DNI o tu Nombre Completo', 'error');
                return;
            }
            
            // Validar DNI si se ingresó
            if (dni && (dni.length !== 8 || !/^\d{8}$/.test(dni))) {
                showVerificarMessage('El DNI debe tener exactamente 8 dígitos', 'error');
                return;
            }
            
            // Mostrar spinner
            document.getElementById('btnVerificar').disabled = true;
            document.getElementById('verificarSpinner').style.display = 'block';
            document.getElementById('verificarMessage').classList.remove('show');
            
            try {
                console.log('🔍 Buscando usuario con:', { dni, nombreCompleto });
                
                // Construir consulta según lo que se ingresó
                let query = supabase
                    .from('users')
                    .select('id, nombre_completo, role, activado, email, dni, telefono');
                
                if (dni && nombreCompleto) {
                    // Si ambos están llenos, buscar por DNI Y nombre (nombre con ilike para flexibilidad)
                    query = query.eq('dni', dni).ilike('nombre_completo', nombreCompleto);
                } else if (dni) {
                    // Solo DNI
                    query = query.eq('dni', dni);
                } else {
                    // Solo nombre (búsqueda flexible con ilike)
                    query = query.ilike('nombre_completo', nombreCompleto);
                }
                
                const { data, error } = await query.maybeSingle();
                
                console.log('📊 Respuesta de Supabase:', { data, error });
                
                // Ocultar spinner
                document.getElementById('verificarSpinner').style.display = 'none';
                document.getElementById('btnVerificar').disabled = false;
                
                if (error) {
                    console.error('❌ Error de Supabase:', error);
                    showVerificarMessage(
                        `<strong>Error de conexión</strong><br>
                        ${error.message}<br>
                        <small>Por favor intenta nuevamente o contacta al administrador.</small>`,
                        'error'
                    );
                    return;
                }
                
                if (!data) {
                    // No encontrado
                    const criterio = dni ? `DNI <strong>${dni}</strong>` : `nombre <strong>${nombreCompleto}</strong>`;
                    showVerificarMessage(
                        `<strong><i class="fas fa-times-circle"></i> Cuenta no encontrada</strong><br>
                        No existe una cuenta con ${criterio} en nuestro sistema.<br>
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <i class="fas fa-info-circle" style="color: #856404;"></i>
                            <span style="color: #856404;">
                                ¿Tu cuenta no está registrada? 
                                <a href="#" onclick="backToStep1bAndRequestForm(); return false;" style="color: var(--color-ata-verde); font-weight: bold; text-decoration: underline;">Solicita tu registro aquí</a>
                            </span>
                        </div>`,
                        'error'
                    );
                    return;
                }
                
                // Verificar nombre completo solo si ambos fueron ingresados
                if (dni && nombreCompleto) {
                    const nombreDB = data.nombre_completo.toUpperCase().trim();
                    if (nombreDB !== nombreCompleto) {
                        showVerificarMessage(
                            `<strong><i class="fas fa-exclamation-triangle"></i> Nombre no coincide</strong><br>
                            El nombre ingresado no coincide con el registrado para el DNI <strong>${dni}</strong>.<br>
                            <small>Nombre en sistema: <strong>${nombreDB}</strong></small>`,
                            'error'
                        );
                        return;
                    }
                }
                
                // 🔐 VERIFICAR SI LA CUENTA TIENE TODOS LOS DATOS COMPLETOS
                // Una cuenta se considera COMPLETAMENTE ACTIVADA solo si tiene:
                // 1. DNI registrado
                // 2. Email registrado
                // 3. Password creada (verificamos con password_hash)
                
                const tieneDNI = data.dni && data.dni.trim() !== '';
                const tieneEmail = data.email && data.email.trim() !== '';
                const tienePassword = data.password_hash && data.password_hash.trim() !== '';
                
                // Solo si tiene TODO completo → Ir a iniciar sesión
                if (tieneDNI && tieneEmail && tienePassword) {
                    showVerificarMessage(
                        `<strong><i class="fas fa-check-circle"></i> Cuenta completada</strong><br>
                        Tu cuenta ya tiene todos los datos registrados.<br><br>
                        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid var(--color-ata-azul);">
                            <i class="fas fa-sign-in-alt" style="color: #1565c0;"></i>
                            <span style="color: #1565c0;">
                                Si olvidaste tu contraseña, 
                                <a href="#" onclick="mostrarRecuperacionPassword(); return false;" style="color: var(--color-ata-verde); font-weight: bold; text-decoration: underline;">haz clic aquí</a>
                            </span>
                        </div>
                        <button onclick="irAIniciarSesion()" class="btn btn-primary" style="width: 100%; margin-top: 15px;">
                            <i class="fas fa-sign-in-alt"></i> Ir a Iniciar Sesión
                        </button>`,
                        'info'
                    );
                    
                    window.cuentaVerificada = data;
                    return;
                }
                
                // Si falta DNI, Email o Contraseña → Proceso progresivo
                showVerificarMessage(
                    `<strong><i class="fas fa-user-check"></i> Cuenta encontrada en el sistema</strong><br>
                    Completa el registro de tus datos para activar tu cuenta.<br><br>
                    <button onclick="mostrarCrearContrasena()" class="btn btn-success" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-key"></i> Completar Registro y Crear Contraseña
                    </button>`,
                    'success'
                );
                
                // Guardar referencia para el proceso progresivo
                window.cuentaVerificada = data;
                return;
                
            } catch (err) {
                console.error('Error verificando cuenta:', err);
                document.getElementById('verificarSpinner').style.display = 'none';
                document.getElementById('btnVerificar').disabled = false;
                showVerificarMessage('Error al conectar con el servidor. Intenta nuevamente.', 'error');
            }
        }
        
        // Función para mostrar mensajes de verificación
        function showVerificarMessage(message, type = 'error') {
            const messageContainer = document.getElementById('verificarMessage');
            messageContainer.innerHTML = message;
            messageContainer.className = `form-message ${type} show`;
        }
        
        // Función para volver a verificar (vuelve al paso 1)
        function volverAVerificar() {
            // Usar el nuevo sistema de pasos
            volverAPaso1();
        }
        
        // Función para activar cuenta final (crear contraseña)
        async function activarCuentaFinal() {
            const password = document.getElementById('nueva_password').value;
            const confirmarPassword = document.getElementById('confirmar_password').value;
            const messageContainer = document.getElementById('activarMessage');
            
            // Validaciones
            if (!password || !confirmarPassword) {
                messageContainer.innerHTML = 'Por favor completa todos los campos';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (password.length < 6) {
                messageContainer.innerHTML = 'La contraseña debe tener al menos 6 caracteres';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (password !== confirmarPassword) {
                messageContainer.innerHTML = 'Las contraseñas no coinciden';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (!window.cuentaVerificada) {
                messageContainer.innerHTML = 'Error: No hay cuenta verificada';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // 🔐 VALIDAR QUE EMAIL ESTÉ VERIFICADO
            if (!window.emailVerificado) {
                messageContainer.innerHTML = 'Por favor verifica primero tu correo electrónico';
                messageContainer.className = 'form-message error show';
                document.getElementById('email_activacion').focus();
                return;
            }
            
            // Deshabilitar botón
            document.getElementById('btnActivar').disabled = true;
            messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando cuenta...';
            messageContainer.className = 'form-message info show';
            
            try {
                // Crear usuario en Supabase Auth con el email verificado
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: window.emailVerificado,
                    password: password
                });
                
                if (authError) {
                    throw authError;
                }
                
                // Actualizar campos en la tabla users: DNI + email + teléfono + activado=true
                const updateData = { 
                    email: window.emailVerificado,
                    activado: true 
                };
                
                // Agregar DNI si se registró
                if (window.cuentaVerificada.dni) {
                    updateData.dni = window.cuentaVerificada.dni;
                }
                
                // Agregar teléfono si se registró
                if (window.cuentaVerificada.telefono) {
                    updateData.telefono = window.cuentaVerificada.telefono;
                }
                
                const { error: updateError } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', window.cuentaVerificada.id);
                
                if (updateError) {
                    throw updateError;
                }
                
                messageContainer.innerHTML = `
                    <strong><i class="fas fa-check-circle"></i> ¡Cuenta activada exitosamente!</strong><br>
                    Iniciando sesión automáticamente...
                `;
                messageContainer.className = 'form-message success show';
                
                // Auto-login: Configurar usuario actual y entrar a la app
                setTimeout(() => {
                    currentUser = {
                        username: window.cuentaVerificada.dni || window.emailVerificado,
                        email: window.emailVerificado,
                        role: window.cuentaVerificada.role,
                        nombre: window.cuentaVerificada.nombre_completo,
                        dni: window.cuentaVerificada.dni,
                        id: window.cuentaVerificada.id
                    };
                    
                    console.log('✅ Auto-login después de activación:', currentUser);
                    
                    // Entrar directamente a la aplicación
                    login();
                }, 2000);
                
            } catch (err) {
                console.error('Error activando cuenta:', err);
                document.getElementById('btnActivar').disabled = false;
                messageContainer.innerHTML = `Error al activar cuenta: ${err.message}`;
                messageContainer.className = 'form-message error show';
            }
        }
        
        // Función para mostrar recuperación de contraseña
        async function mostrarRecuperarContrasena() {
            if (!window.cuentaVerificada || !window.cuentaVerificada.email) {
                showVerificarMessage('Error: No hay cuenta verificada', 'error');
                return;
            }
            
            const confirmar = await mostrarConfirmacion(
                `¿Enviar correo de recuperación a:\n${window.cuentaVerificada.email}?\n\nRecibirás un enlace para restablecer tu contraseña.`,
                'Recuperar Contraseña',
                { tipo: 'info', btnConfirmar: 'Enviar correo', btnCancelar: 'Cancelar' }
            );
            
            if (!confirmar) return;
            
            try {
                showVerificarMessage('<i class="fas fa-spinner fa-spin"></i> Enviando correo...', 'info');
                
                const { error } = await supabase.auth.resetPasswordForEmail(
                    window.cuentaVerificada.email,
                    {
                        redirectTo: window.location.origin + '/reset-password'
                    }
                );
                
                if (error) throw error;
                
                showVerificarMessage(
                    `<strong><i class="fas fa-envelope-circle-check"></i> Correo enviado</strong><br>
                    Revisa tu bandeja de entrada en <strong>${window.cuentaVerificada.email}</strong><br>
                    <small>Si no lo ves, revisa la carpeta de spam.</small>`,
                    'success'
                );
                
            } catch (err) {
                console.error('Error enviando correo:', err);
                showVerificarMessage(
                    `<strong>Error al enviar correo</strong><br>
                    ${err.message}<br>
                    <small>Contacta al administrador del sistema.</small>`,
                    'error'
                );
            }
        }
        
        // ==================== FUNCIONES DE RECUPERACIÓN DE CONTRASEÑA ====================
        
        // Función para mostrar pantalla de recuperación desde login
        function mostrarRecuperacionPassword() {
            const step2 = document.getElementById('step2');
            const step4 = document.getElementById('step4');
            
            // Ocultar step2 (login)
            step2.classList.remove('visible');
            step2.classList.add('hidden');
            
            // Limpiar formulario de recuperación y resetear estado
            document.getElementById('recuperar_dni').value = '';
            document.getElementById('recuperar_nombre').value = '';
            document.getElementById('recuperarMessage').innerHTML = '';
            document.getElementById('recuperarMessage').className = 'form-message';
            document.getElementById('step4b').style.display = 'none';
            document.getElementById('step5').style.display = 'none';
            window.usuarioRecuperar = null;
            
            // IMPORTANTE: Resetear el botón de verificar
            const btnVerificar = document.getElementById('btnVerificarRecuperar');
            if (btnVerificar) {
                btnVerificar.disabled = false;
                btnVerificar.innerHTML = '<i class="fas fa-search"></i> Buscar mi cuenta';
            }
            
            // Mostrar step4 (recuperación)
            setTimeout(() => {
                step4.classList.remove('hidden');
                step4.classList.add('visible');
                setTimeout(() => {
                    document.getElementById('recuperar_dni').focus();
                }, 300);
            }, 300);
        }
        
        // Función para volver al login desde recuperación
        function volverALogin() {
            const step4 = document.getElementById('step4');
            const step1 = document.getElementById('step1');
            const step1b = document.getElementById('step1b');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            
            // Resetear variables globales
            selectedUserRole = null;
            window.usuarioRecuperar = null;
            
            // Limpiar campos de recuperación
            document.getElementById('recuperar_dni').value = '';
            document.getElementById('recuperar_nombre').value = '';
            document.getElementById('email_verificar_recuperar').value = '';
            document.getElementById('recuperarMessage').innerHTML = '';
            document.getElementById('recuperarMessage').className = 'form-message';
            document.getElementById('cambiarMessage').innerHTML = '';
            
            // IMPORTANTE: Resetear el botón de verificar para que funcione de nuevo
            const btnVerificar = document.getElementById('btnVerificarRecuperar');
            if (btnVerificar) {
                btnVerificar.disabled = false;
                btnVerificar.innerHTML = '<i class="fas fa-search"></i> Buscar mi cuenta';
            }
            
            // Ocultar sub-steps de recuperación
            document.getElementById('step4b').style.display = 'none';
            document.getElementById('step5').style.display = 'none';
            
            // Ocultar TODOS los steps y limpiar estilos inline
            step4.classList.remove('visible');
            step4.classList.add('hidden');
            step4.style.display = '';
            
            step1b.classList.remove('visible');
            step1b.classList.add('hidden');
            step1b.style.display = '';
            
            step2.classList.remove('visible');
            step2.classList.add('hidden');
            step2.style.display = '';
            
            step3.classList.remove('visible');
            step3.classList.add('hidden');
            step3.style.display = '';
            
            // Mostrar step1 (selección de tipo de cuenta) después del delay
            setTimeout(() => {
                step1.style.display = '';
                step1.classList.remove('hidden');
                step1.classList.add('visible');
            }, 350);
        }
        
        // Función para verificar DNI o Nombre y mostrar hint de email
        async function verificarDNIparaRecuperar() {
            const dni = document.getElementById('recuperar_dni').value.trim();
            const nombre = document.getElementById('recuperar_nombre').value.trim().toUpperCase();
            const messageContainer = document.getElementById('recuperarMessage');
            const btnVerificar = document.getElementById('btnVerificarRecuperar');
            
            // Validar que al menos uno esté lleno
            if (!dni && !nombre) {
                messageContainer.innerHTML = 'Por favor ingresa tu DNI o Nombre Completo';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // Validar DNI si se proporcionó
            if (dni && (dni.length !== 8 || !/^\d{8}$/.test(dni))) {
                messageContainer.innerHTML = 'El DNI debe tener exactamente 8 dígitos';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            try {
                btnVerificar.disabled = true;
                messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando cuenta...';
                messageContainer.className = 'form-message info show';
                
                // Construir query flexible (DNI OR Nombre)
                let query = supabase
                    .from('users')
                    .select('id, nombre_completo, email, dni, role, activado');
                
                if (dni && nombre) {
                    // Ambos: Buscar por DNI O nombre
                    query = query.or(`dni.eq.${dni},nombre_completo.ilike.%${nombre}%`);
                } else if (dni) {
                    // Solo DNI
                    query = query.eq('dni', dni);
                } else {
                    // Solo nombre
                    query = query.ilike('nombre_completo', `%${nombre}%`);
                }
                
                const { data, error } = await query.maybeSingle();
                
                if (error) throw error;
                
                if (!data) {
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-times-circle"></i> No encontrado</strong><br>
                        No existe una cuenta con ${dni ? `DNI <strong>${dni}</strong>` : ''}${dni && nombre ? ' o ' : ''}${nombre ? `nombre <strong>${nombre}</strong>` : ''} en el sistema.
                    `;
                    messageContainer.className = 'form-message error show';
                    btnVerificar.disabled = false;
                    return;
                }
                
                if (!data.activado) {
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-info-circle"></i> Cuenta no activada</strong><br>
                        Tu cuenta aún no ha sido activada. Por favor, usa "Activar cuenta" en lugar de recuperar contraseña.
                    `;
                    messageContainer.className = 'form-message info show';
                    btnVerificar.disabled = false;
                    return;
                }
                
                // Guardar usuario para recuperación
                window.usuarioRecuperar = data;
                
                // Verificar si tiene email válido
                const tieneEmail = data.email && data.email !== null && data.email.trim() !== '';
                
                if (!tieneEmail) {
                    // Usuario SIN email → No puede recuperar contraseña
                    messageContainer.innerHTML = `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                            <strong style="color: #856404;">No tienes email registrado</strong><br>
                            <p style="color: #856404; margin: 10px 0 0 0; font-size: 13px;">
                                Para recuperar tu contraseña necesitas tener un correo electrónico registrado.<br>
                                Por favor, contacta al administrador del sistema.
                            </p>
                        </div>
                    `;
                    messageContainer.className = 'form-message error show';
                    btnVerificar.disabled = false;
                    return;
                }
                
                // Usuario CON email → Mostrar nombre y pedir email completo
                document.getElementById('nombreUsuarioRecuperar').innerHTML = `
                    Usuario: <strong>${data.nombre_completo}</strong>
                `;
                
                messageContainer.innerHTML = '';
                messageContainer.classList.remove('show');
                
                // Mostrar step4b (formulario de email)
                document.getElementById('step4b').style.display = 'block';
                
                setTimeout(() => {
                    document.getElementById('email_verificar_recuperar').focus();
                }, 300);
                
            } catch (err) {
                console.error('Error verificando DNI:', err);
                messageContainer.innerHTML = `Error al buscar cuenta: ${err.message}`;
                messageContainer.className = 'form-message error show';
                btnVerificar.disabled = false;
            }
        }
        
        // Función auxiliar para censurar email
        function censurarEmail(email) {
            if (!email || !email.includes('@')) return '***@***.***';
            
            const [local, domain] = email.split('@');
            const [domainName, domainExt] = domain.split('.');
            
            // Censurar parte local (mostrar primeros 2 y últimos 2)
            let localCensurado;
            if (local.length <= 4) {
                localCensurado = local[0] + '***';
            } else {
                localCensurado = local.substring(0, 2) + '***' + local.substring(local.length - 2);
            }
            
            // Censurar dominio (mostrar primeras 2 letras)
            const dominioCensurado = domainName.substring(0, 2) + '***';
            
            return `${localCensurado}@${dominioCensurado}.${domainExt}`;
        }
        
        // Función para validar contraseña de recuperación
        function validarPasswordRecuperar() {
            const password = document.getElementById('nueva_password_recuperar')?.value || '';
            const confirmPassword = document.getElementById('confirmar_password_recuperar')?.value || '';
            
            const strengthContainer = document.getElementById('password-strength-container-2');
            const strengthBar = document.getElementById('password-strength-bar-2');
            const strengthText = document.getElementById('password-strength-text-2');
            
            // Calcular nivel de seguridad (mismo algoritmo)
            if (password.length > 0) {
                strengthContainer.style.display = 'block';
                let strength = 0;
                
                if (password.length >= 6) strength += 25;
                if (password.length >= 8) strength += 15;
                if (password.length >= 10) strength += 10;
                if (/[a-z]/.test(password)) strength += 10;
                if (/[A-Z]/.test(password)) strength += 15;
                if (/[0-9]/.test(password)) strength += 15;
                if (/[^a-zA-Z0-9]/.test(password)) strength += 10;
                
                let strengthLabel = '';
                let strengthColor = '';
                
                if (strength < 40) {
                    strengthLabel = 'Baja';
                    strengthColor = '#f44336';
                } else if (strength < 70) {
                    strengthLabel = 'Media';
                    strengthColor = '#ff9800';
                } else {
                    strengthLabel = 'Alta';
                    strengthColor = '#4caf50';
                }
                
                strengthBar.style.width = strength + '%';
                strengthBar.style.background = strengthColor;
                strengthText.textContent = strengthLabel;
                strengthText.style.color = strengthColor;
            } else {
                strengthContainer.style.display = 'none';
            }
        }
        
        // Función para enviar email de recuperación
        async function enviarEmailRecuperacion() {
            const emailIngresado = document.getElementById('email_verificar_recuperar').value.trim().toLowerCase();
            const messageContainer = document.getElementById('cambiarMessage');
            const btnEnviar = document.getElementById('btnEnviarRecuperacion');
            
            // Validaciones
            if (!emailIngresado) {
                messageContainer.innerHTML = 'Por favor ingresa tu correo electrónico';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailIngresado)) {
                messageContainer.innerHTML = 'Por favor ingresa un correo electrónico válido';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (!window.usuarioRecuperar) {
                messageContainer.innerHTML = 'Error: No hay usuario verificado';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // Verificar que el email coincida con el registrado
            const emailRegistrado = window.usuarioRecuperar.email.trim().toLowerCase();
            if (emailIngresado !== emailRegistrado) {
                messageContainer.innerHTML = `
                    <strong><i class="fas fa-times-circle"></i> Email incorrecto</strong><br>
                    El correo ingresado no coincide con el registrado en tu cuenta.<br>
                    <small>Por favor, ingresa el email correcto para verificar tu identidad.</small>
                `;
                messageContainer.className = 'form-message error show';
                return;
            }
            
            try {
                btnEnviar.disabled = true;
                messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando correo de recuperación...';
                messageContainer.className = 'form-message info show';
                
                // Enviar email de recuperación con Supabase Auth
                const { error: resetError } = await supabase.auth.resetPasswordForEmail(
                    emailRegistrado,
                    {
                        redirectTo: window.location.origin + '/?reset=true'
                    }
                );
                
                if (resetError) throw resetError;
                
                // Ocultar step4b
                document.getElementById('step4b').style.display = 'none';
                
                // Mostrar step5 con animación
                document.getElementById('emailEnviadoDestino').textContent = emailRegistrado;
                document.getElementById('step5').style.display = 'block';
                
                // Scroll suave hacia step5
                setTimeout(() => {
                    document.getElementById('step5').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
                
            } catch (err) {
                console.error('Error enviando email:', err);
                messageContainer.innerHTML = `Error al enviar correo: ${err.message}`;
                messageContainer.className = 'form-message error show';
                btnEnviar.disabled = false;
            }
        }
        
        // Función para cambiar contraseña final
        async function cambiarPasswordFinal() {
            const password = document.getElementById('nueva_password_recuperar').value;
            const confirmarPassword = document.getElementById('confirmar_password_recuperar').value;
            const nombreCompleto = document.getElementById('nombre_completo_recuperar').value.trim().toUpperCase();
            const messageContainer = document.getElementById('cambiarMessage');
            const btnCambiar = document.getElementById('btnCambiarPassword');
            
            // Validaciones básicas
            if (!password || !confirmarPassword) {
                messageContainer.innerHTML = 'Por favor completa todos los campos';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (password.length < 6) {
                messageContainer.innerHTML = 'La contraseña debe tener al menos 6 caracteres';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (password !== confirmarPassword) {
                messageContainer.innerHTML = 'Las contraseñas no coinciden';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (!window.usuarioRecuperar) {
                messageContainer.innerHTML = 'Error: No hay usuario verificado';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // Verificar si tiene email real
            const tieneEmail = window.usuarioRecuperar.email && !window.usuarioRecuperar.email.includes('@ata.local');
            
            // Si NO tiene email, validar nombre completo
            if (!tieneEmail) {
                if (!nombreCompleto) {
                    messageContainer.innerHTML = 'Por favor ingresa tu nombre completo para verificar tu identidad';
                    messageContainer.className = 'form-message error show';
                    return;
                }
                
                // Validar que el nombre coincida
                const nombreDB = window.usuarioRecuperar.nombre_completo.toUpperCase().trim();
                if (nombreDB !== nombreCompleto) {
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-times-circle"></i> Nombre no coincide</strong><br>
                        El nombre ingresado no coincide con el registrado.<br>
                        <small>Nombre esperado: <strong>${nombreDB}</strong></small>
                    `;
                    messageContainer.className = 'form-message error show';
                    return;
                }
            }
            
            try {
                btnCambiar.disabled = true;
                messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando contraseña...';
                messageContainer.className = 'form-message info show';
                
                if (tieneEmail) {
                    // CASO 1: Usuario CON email → Enviar correo de recuperación
                    const { error: resetError } = await supabase.auth.resetPasswordForEmail(
                        window.usuarioRecuperar.email,
                        {
                            redirectTo: window.location.origin + '/reset-password.html'
                        }
                    );
                    
                    if (resetError) throw resetError;
                    
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-envelope-circle-check"></i> Correo enviado</strong><br>
                        Hemos enviado un enlace de recuperación a <strong>${censurarEmail(window.usuarioRecuperar.email)}</strong><br>
                        <small>Revisa tu bandeja de entrada y sigue las instrucciones.</small>
                    `;
                    messageContainer.className = 'form-message success show';
                    
                    // Volver al login después de 5 segundos
                    setTimeout(() => {
                        volverALogin();
                    }, 5000);
                    
                } else {
                    // CASO 2: Usuario SIN email → Cambiar contraseña DIRECTAMENTE
                    // Necesitamos usar Admin API (no disponible en frontend)
                    // WORKAROUND: Crear cuenta Auth con email ficticio
                    
                    const emailFicticio = `${window.usuarioRecuperar.dni}@ata.local`;
                    
                    // Intentar crear/actualizar cuenta en Supabase Auth
                    const { data: authData, error: signUpError } = await supabase.auth.signUp({
                        email: emailFicticio,
                        password: password
                    });
                    
                    if (signUpError && !signUpError.message.includes('already registered')) {
                        throw signUpError;
                    }
                    
                    // Si ya existía, intentar login para actualizar contraseña
                    if (signUpError && signUpError.message.includes('already registered')) {
                        // Usuario ya tiene cuenta, necesitamos Admin API para cambiar contraseña
                        // Por ahora, mostrar mensaje pidiendo contactar admin
                        messageContainer.innerHTML = `
                            <strong><i class="fas fa-exclamation-triangle"></i> Cuenta ya existe</strong><br>
                            Tu cuenta ya tiene una contraseña registrada. Para cambiarla, contacta al administrador del sistema.<br>
                            <small>Email: soporte@ata.edu.pe</small>
                        `;
                        messageContainer.className = 'form-message error show';
                        btnCambiar.disabled = false;
                        return;
                    }
                    
                    // Actualizar email en tabla users si era ficticio
                    if (!window.usuarioRecuperar.email || window.usuarioRecuperar.email.includes('@ata.local')) {
                        await supabase
                            .from('users')
                            .update({ email: emailFicticio })
                            .eq('id', window.usuarioRecuperar.id);
                    }
                    
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-check-circle"></i> ¡Contraseña actualizada!</strong><br>
                        Tu contraseña ha sido cambiada exitosamente. Ya puedes iniciar sesión con tu DNI y la nueva contraseña.
                    `;
                    messageContainer.className = 'form-message success show';
                    
                    // Volver al login después de 3 segundos
                    setTimeout(() => {
                        volverALogin();
                    }, 3000);
                }
                
            } catch (err) {
                console.error('Error cambiando contraseña:', err);
                btnCambiar.disabled = false;
                messageContainer.innerHTML = `Error: ${err.message}`;
                messageContainer.className = 'form-message error show';
            }
        }
        
        // Función para volver a login
        function backToStep1bAndLogin() {
            const step3 = document.getElementById('step3');
            const step1b = document.getElementById('step1b');
            
            step3.classList.remove('visible');
            step3.classList.add('hidden');
            
            setTimeout(() => {
                step1b.classList.remove('hidden');
                step1b.classList.add('visible');
                
                setTimeout(() => {
                    showDemoLogin();
                }, 300);
            }, 300);
        }
        
        // Función para ir directamente a iniciar sesión desde verificación
        function irAIniciarSesion() {
            const step3 = document.getElementById('step3');
            const step2 = document.getElementById('step2');
            
            // Ocultar step3
            step3.classList.remove('visible');
            step3.classList.add('hidden');
            
            // Resetear pasos de activación
            irAPasoActivacion(1);
            document.getElementById('verificar_dni').value = '';
            document.getElementById('verificar_nombre').value = '';
            document.getElementById('verificarMessage').innerHTML = '';
            document.getElementById('verificarMessage').classList.remove('show');
            window.cuentaVerificada = null;
            
            // Mostrar step2 (login)
            setTimeout(() => {
                step2.classList.remove('hidden');
                step2.classList.add('visible');
                
                setTimeout(() => {
                    document.getElementById('username').focus();
                }, 300);
            }, 300);
        }
        
        // Función para mostrar el formulario de completar datos (ir al paso 2)
        function mostrarCrearContrasena() {
            if (!window.cuentaVerificada) {
                showVerificarMessage('Error: No hay cuenta verificada', 'error');
                return;
            }
            
            // Ir al paso 2 de activación (Completar datos)
            irAPasoActivacion(2);
            
            // Variables globales
            window.emailVerificado = null;
            window.datosRegistro = {
                dniVerificado: false,
                emailVerificado: false,
                telefonoVerificado: false
            };
            
            // Limpiar campos del paso 3
            const nuevaPassword = document.getElementById('nueva_password');
            const confirmarPassword = document.getElementById('confirmar_password');
            if (nuevaPassword) nuevaPassword.value = '';
            if (confirmarPassword) confirmarPassword.value = '';
            
            // Limpiar mensajes
            const dniMsg = document.getElementById('dniVerificacionMessage');
            const emailMsg = document.getElementById('emailVerificacionMessage');
            const telefonoMsg = document.getElementById('telefonoVerificacionMessage');
            const activarMsg = document.getElementById('activarMessage');
            
            if (dniMsg) dniMsg.innerHTML = '';
            if (emailMsg) emailMsg.innerHTML = '';
            if (telefonoMsg) telefonoMsg.innerHTML = '';
            if (activarMsg) activarMsg.innerHTML = '';
            
            // Resetear íconos
            const dniIcon = document.getElementById('dniCheckIcon');
            const telefonoIcon = document.getElementById('telefonoCheckIcon');
            if (dniIcon) dniIcon.style.display = 'none';
            if (telefonoIcon) telefonoIcon.style.display = 'none';
            
            // Cargar datos existentes del usuario
            cargarDatosExistentes();
        }
        
        // Función para cargar datos existentes del usuario en paso 2
        function cargarDatosExistentes() {
            const usuario = window.cuentaVerificada;
            const dniInput = document.getElementById('dni_activacion');
            const emailInput = document.getElementById('email_activacion');
            const telefonoInput = document.getElementById('telefono_activacion');
            const dniIcon = document.getElementById('dniCheckIcon');
            const dniMsg = document.getElementById('dniVerificacionMessage');
            const emailMsg = document.getElementById('emailVerificacionMessage');
            const telefonoMsg = document.getElementById('telefonoVerificacionMessage');
            
            // DNI
            if (usuario.dni && usuario.dni.trim() !== '') {
                dniInput.value = '';
                dniInput.disabled = true;
                dniInput.placeholder = 'DNI ya registrado en el sistema';
                dniIcon.style.display = 'block';
                dniMsg.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> <strong style="color: #28a745;">✓ DNI existente para este usuario</strong><br><small>Tu DNI ya está verificado en el sistema</small>';
                dniMsg.className = 'form-message success show';
                window.datosRegistro.dniVerificado = true;
            } else {
                dniInput.disabled = false;
                dniInput.value = '';
                dniInput.placeholder = '12345678';
            }
            
            // Email
            if (usuario.email && usuario.email.trim() !== '') {
                emailInput.value = '';
                emailInput.disabled = true;
                emailInput.placeholder = 'Email ya registrado en el sistema';
                emailMsg.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> <strong style="color: #28a745;">✓ Email registrado</strong><br><small>Ya tienes un correo electrónico asociado (no se muestra por seguridad)</small>';
                emailMsg.className = 'form-message success show';
                window.emailVerificado = usuario.email;
                window.datosRegistro.emailVerificado = true;
            } else {
                emailInput.disabled = false;
                emailInput.value = '';
                emailInput.placeholder = 'correo@ejemplo.com';
            }
            
            // Teléfono
            const btnSinTelefono = document.getElementById('btnContinuarSinTelefono');
            const btnConTelefono = document.getElementById('btnContinuarConTelefono');
            
            if (usuario.telefono && usuario.telefono.trim() !== '') {
                // YA TIENE TELÉFONO - Mostrar como verificado
                telefonoInput.value = '';
                telefonoInput.disabled = true;
                telefonoInput.placeholder = 'Teléfono ya registrado en el sistema';
                const telefonoIcon = document.getElementById('telefonoCheckIcon');
                if (telefonoIcon) telefonoIcon.style.display = 'block';
                telefonoMsg.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> <strong style="color: #28a745;">✓ Teléfono registrado</strong><br><small>Ya tienes un número de teléfono asociado</small>';
                telefonoMsg.className = 'form-message success show';
                window.datosRegistro.telefonoVerificado = true;
                
                // Ocultar "sin teléfono" y mostrar "Continuar" con función directa
                if (btnSinTelefono) btnSinTelefono.style.display = 'none';
                if (btnConTelefono) {
                    btnConTelefono.style.display = 'block';
                    btnConTelefono.innerHTML = 'Continuar <i class="fas fa-arrow-right"></i>';
                    btnConTelefono.onclick = function() { continuarAlPaso3(); };
                }
            } else {
                // NO TIENE TELÉFONO - Mostrar opciones
                telefonoInput.disabled = false;
                telefonoInput.value = '';
                telefonoInput.placeholder = '987654321';
                telefonoMsg.innerHTML = '<i class="fas fa-info-circle" style="color: #0066cc;"></i> <strong>Teléfono opcional</strong><br><small>Puedes ingresar tu número o continuar sin él</small>';
                telefonoMsg.className = 'form-message info show';
                
                // Mostrar botón sin teléfono, ocultar continuar
                if (btnSinTelefono) btnSinTelefono.style.display = 'block';
                if (btnConTelefono) btnConTelefono.style.display = 'none';
            }
        }
        
        // Función para verificar si el usuario ya tiene DNI
        function verificarDNIExistente() {
            const usuario = window.cuentaVerificada;
            const messageContainer = document.getElementById('dniVerificacionMessage');
            const dniInput = document.getElementById('dni_activacion');
            const dniIcon = document.getElementById('dniCheckIcon');
            
            if (usuario.dni && usuario.dni.trim() !== '') {
                // YA TIENE DNI - NO mostrar el DNI completo
                dniInput.value = '';
                dniInput.disabled = true;
                dniInput.placeholder = 'DNI ya registrado en el sistema';
                dniIcon.style.display = 'block';
                
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                    <strong style="color: #28a745;">✓ DNI existente para este usuario</strong><br>
                    <small>Tu DNI ya está verificado en el sistema</small>
                `;
                messageContainer.className = 'form-message success show';
                
                window.datosRegistro.dniVerificado = true;
                
                // Pasar automáticamente a verificar EMAIL
                setTimeout(() => {
                    verificarEmailExistente();
                }, 500);
            } else {
                // NO TIENE DNI - Debe introducirlo
                dniInput.disabled = false;
                dniInput.placeholder = '12345678';
                dniInput.focus();
                
                messageContainer.innerHTML = `
                    <i class="fas fa-info-circle" style="color: #0066cc;"></i> 
                    <strong>Debes registrar tu DNI</strong><br>
                    <small>Ingresa tu documento de identidad de 8 dígitos</small>
                `;
                messageContainer.className = 'form-message info show';
                
                // Agregar evento para validar DNI cuando lo escriba
                dniInput.addEventListener('input', function() {
                    const dni = this.value.trim();
                    if (dni.length === 8 && /^\d{8}$/.test(dni)) {
                        validarDNIIngresado(dni);
                    }
                });
            }
        }
        
        // Función para validar DNI ingresado manualmente
        async function validarDNIIngresado(dni) {
            const messageContainer = document.getElementById('dniVerificacionMessage');
            const dniIcon = document.getElementById('dniCheckIcon');
            
            try {
                // Verificar que el DNI no esté ya registrado
                const { data, error } = await supabase
                    .from('users')
                    .select('id')
                    .eq('dni', dni)
                    .maybeSingle();
                
                if (data) {
                    // DNI ya existe en otro usuario
                    messageContainer.innerHTML = `
                        <i class="fas fa-times-circle"></i> 
                        <strong>DNI ya registrado</strong><br>
                        <small>Este DNI ya está asignado a otra cuenta</small>
                    `;
                    messageContainer.className = 'form-message error show';
                    dniIcon.style.display = 'none';
                    window.datosRegistro.dniVerificado = false;
                    return;
                }
                
                // DNI válido y disponible
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                    <strong style="color: #28a745;">DNI válido</strong>
                `;
                messageContainer.className = 'form-message success show';
                dniIcon.style.display = 'block';
                document.getElementById('dni_activacion').disabled = true;
                
                window.datosRegistro.dniVerificado = true;
                
                // Guardar DNI en cuentaVerificada
                window.cuentaVerificada.dni = dni;
                
                // Pasar a EMAIL
                setTimeout(() => {
                    verificarEmailExistente();
                }, 500);
                
            } catch (err) {
                messageContainer.innerHTML = 'Error al validar DNI';
                messageContainer.className = 'form-message error show';
            }
        }
        
        // Función para verificar si el usuario ya tiene EMAIL
        function verificarEmailExistente() {
            const usuario = window.cuentaVerificada;
            const messageContainer = document.getElementById('emailVerificacionMessage');
            const emailInput = document.getElementById('email_activacion');
            const emailSection = document.getElementById('emailSection');
            
            // Mostrar sección de email
            emailSection.style.display = 'block';
            
            if (usuario.email && usuario.email.trim() !== '') {
                // YA TIENE EMAIL - NO mostrar el email completo
                window.emailVerificado = usuario.email;
                emailInput.value = '';
                emailInput.disabled = true;
                emailInput.placeholder = 'Email ya registrado en el sistema';
                document.getElementById('btnVerificarEmail').style.display = 'none';
                
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                    <strong style="color: #28a745;">✓ Email registrado</strong><br>
                    <small>Ya tienes un correo electrónico asociado (no se muestra por seguridad)</small>
                `;
                messageContainer.className = 'form-message success show';
                
                window.datosRegistro.emailVerificado = true;
                
                // Pasar automáticamente a TELÉFONO
                setTimeout(() => {
                    verificarTelefonoExistente();
                }, 500);
            } else {
                // NO TIENE EMAIL - Debe introducirlo (validación automática)
                emailInput.disabled = false;
                emailInput.value = '';
                emailInput.placeholder = 'ejemplo@correo.com';
                document.getElementById('btnVerificarEmail').style.display = 'none'; // OCULTAR botón verificar
                
                messageContainer.innerHTML = `
                    <i class="fas fa-exclamation-circle" style="color: #ff6b6b;"></i> 
                    <strong style="color: #ff6b6b;">Este usuario no tiene correo electrónico registrado</strong><br>
                    <small>Ingresa tu email para continuar (se validará automáticamente)</small>
                `;
                messageContainer.className = 'form-message error show';
                
                // Validación automática mientras escribe
                emailInput.addEventListener('blur', async function() {
                    const email = this.value.trim().toLowerCase();
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    
                    if (!email) return;
                    
                    if (!emailRegex.test(email)) {
                        messageContainer.innerHTML = `
                            <i class="fas fa-times-circle"></i> 
                            <strong style="color: #dc3545;">Email inválido</strong><br>
                            <small>Por favor ingresa un correo válido</small>
                        `;
                        messageContainer.className = 'form-message error show';
                        return;
                    }
                    
                    // Verificar unicidad en la base de datos
                    try {
                        messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validando email...';
                        messageContainer.className = 'form-message info show';
                        
                        const { data, error } = await supabase
                            .from('users')
                            .select('id')
                            .eq('email', email)
                            .maybeSingle();
                        
                        if (error) throw error;
                        
                        if (data) {
                            // Email ya existe
                            messageContainer.innerHTML = `
                                <i class="fas fa-times-circle"></i> 
                                <strong style="color: #dc3545;">Email ya registrado</strong><br>
                                <small>Este correo ya está en uso. Usa otro.</small>
                            `;
                            messageContainer.className = 'form-message error show';
                            emailInput.value = '';
                            emailInput.focus();
                            return;
                        }
                        
                        // Email disponible ✅
                        messageContainer.innerHTML = `
                            <i class="fas fa-check-circle"></i> 
                            <strong style="color: #28a745;">✓ Email disponible</strong><br>
                            <small>Este correo se usará para tu cuenta</small>
                        `;
                        messageContainer.className = 'form-message success show';
                        
                        window.emailVerificado = email;
                        window.cuentaVerificada.email = email;
                        window.datosRegistro.emailVerificado = true;
                        emailInput.disabled = true;
                        
                        // Pasar automáticamente a TELÉFONO
                        setTimeout(() => {
                            verificarTelefonoExistente();
                        }, 500);
                        
                    } catch (err) {
                        console.error('Error:', err);
                        messageContainer.innerHTML = 'Error al validar email';
                        messageContainer.className = 'form-message error show';
                    }
                });
                
                setTimeout(() => {
                    emailInput.focus();
                }, 300);
            }
        }
        
        // Función para verificar si el usuario ya tiene TELÉFONO
        function verificarTelefonoExistente() {
            const usuario = window.cuentaVerificada;
            const messageContainer = document.getElementById('telefonoVerificacionMessage');
            const telefonoInput = document.getElementById('telefono_activacion');
            const telefonoSection = document.getElementById('telefonoSection');
            const telefonoIcon = document.getElementById('telefonoCheckIcon');
            
            // Mostrar sección de teléfono
            telefonoSection.style.display = 'block';
            
            if (usuario.telefono && usuario.telefono.trim() !== '') {
                // YA TIENE TELÉFONO - NO mostrar el número completo
                telefonoInput.value = '';
                telefonoInput.disabled = true;
                telefonoInput.placeholder = 'Teléfono ya registrado en el sistema';
                telefonoIcon.style.display = 'block';
                
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                    <strong style="color: #28a745;">✓ Teléfono registrado</strong><br>
                    <small>Ya tienes un número asociado (no se muestra por seguridad)</small>
                `;
                messageContainer.className = 'form-message success show';
                
                window.datosRegistro.telefonoVerificado = true;
                
                // Pasar automáticamente a CONTRASEÑA
                setTimeout(() => {
                    mostrarSeccionPassword();
                }, 500);
            } else {
                // NO TIENE TELÉFONO - Es opcional
                telefonoInput.disabled = false;
                telefonoInput.value = '';
                telefonoInput.placeholder = '987654321';
                
                messageContainer.innerHTML = `
                    <i class="fas fa-info-circle" style="color: #0066cc;"></i> 
                    <strong>Teléfono opcional</strong><br>
                    <small>Puedes ingresar tu número o continuar sin él</small>
                `;
                messageContainer.className = 'form-message info show';
                
                // Agregar validación en tiempo real
                telefonoInput.addEventListener('input', function() {
                    const tel = this.value.trim();
                    if (tel.length === 9 && /^\d{9}$/.test(tel)) {
                        telefonoIcon.style.display = 'block';
                        window.datosRegistro.telefonoVerificado = true;
                        window.cuentaVerificada.telefono = tel;
                        
                        // Auto-continuar a contraseña
                        setTimeout(() => {
                            mostrarSeccionPassword();
                        }, 800);
                    } else {
                        telefonoIcon.style.display = 'none';
                    }
                });
                
                setTimeout(() => {
                    telefonoInput.focus();
                }, 300);
            }
        }
        
        // Función para verificar teléfono mientras el usuario escribe
        function verificarTelefonoIngresado() {
            const telefonoInput = document.getElementById('telefono_activacion');
            const telefono = telefonoInput.value.trim();
            const btnSinTelefono = document.getElementById('btnContinuarSinTelefono');
            const btnConTelefono = document.getElementById('btnContinuarConTelefono');
            const telefonoIcon = document.getElementById('telefonoCheckIcon');
            const telefonoMsg = document.getElementById('telefonoVerificacionMessage');
            
            // Solo números
            telefonoInput.value = telefono.replace(/\D/g, '');
            
            if (telefono.length === 9 && /^\d{9}$/.test(telefono)) {
                // Teléfono válido (9 dígitos)
                telefonoIcon.style.display = 'block';
                btnSinTelefono.style.display = 'none';
                btnConTelefono.style.display = 'block';
                telefonoMsg.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> <strong style="color: #28a745;">Número válido</strong>';
                telefonoMsg.className = 'form-message success show';
                window.cuentaVerificada.telefono = telefono;
                window.datosRegistro.telefonoVerificado = true;
            } else if (telefono.length > 0) {
                // Escribiendo pero no completo
                telefonoIcon.style.display = 'none';
                btnSinTelefono.style.display = 'none';
                btnConTelefono.style.display = 'none';
                telefonoMsg.innerHTML = '<i class="fas fa-info-circle" style="color: #0066cc;"></i> Ingresa 9 dígitos';
                telefonoMsg.className = 'form-message info show';
            } else {
                // Campo vacío - mostrar botón sin teléfono
                telefonoIcon.style.display = 'none';
                btnSinTelefono.style.display = 'block';
                btnConTelefono.style.display = 'none';
                telefonoMsg.innerHTML = '<i class="fas fa-info-circle" style="color: #0066cc;"></i> <strong>Teléfono opcional</strong><br><small>Puedes ingresar tu número o continuar sin él</small>';
                telefonoMsg.className = 'form-message info show';
            }
        }
        
        // Función para validar que se puede continuar al paso 3
        function puedeIrAPaso3() {
            // Verificar que el email esté completo (obligatorio)
            if (!window.datosRegistro.emailVerificado && !window.emailVerificado) {
                const emailMsg = document.getElementById('emailVerificacionMessage');
                if (emailMsg) {
                    emailMsg.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #856404;"></i> <strong style="color: #856404;">Email obligatorio</strong><br><small>Debes registrar tu correo electrónico para continuar</small>';
                    emailMsg.className = 'form-message warning show';
                    emailMsg.style.background = '#fff3cd';
                    emailMsg.style.borderLeft = '3px solid #ffc107';
                }
                document.getElementById('email_activacion').focus();
                return false;
            }
            return true;
        }
        
        // Función para continuar con teléfono (cuando escribe 9 dígitos)
        function continuarConTelefono() {
            // Validar email primero
            if (!puedeIrAPaso3()) return;
            
            const telefono = document.getElementById('telefono_activacion').value.trim();
            
            if (telefono.length === 9 && /^\d{9}$/.test(telefono)) {
                window.cuentaVerificada.telefono = telefono;
                window.datosRegistro.telefonoVerificado = true;
                
                // Ir al paso 3
                irAPasoActivacion(3);
                setTimeout(() => {
                    const nuevaPassword = document.getElementById('nueva_password');
                    if (nuevaPassword) nuevaPassword.focus();
                }, 300);
            }
        }
        
        // Función para continuar sin teléfono (ir directamente al paso 3)
        function continuarSinTelefono() {
            // Validar email primero
            if (!puedeIrAPaso3()) return;
            
            window.datosRegistro.telefonoVerificado = true;
            
            // Mostrar mensaje de confirmación
            const telefonoMsg = document.getElementById('telefonoVerificacionMessage');
            if (telefonoMsg) {
                telefonoMsg.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> <strong style="color: #28a745;">Continuando sin teléfono</strong>';
                telefonoMsg.className = 'form-message success show';
            }
            
            // Ir directamente al paso 3
            setTimeout(() => {
                irAPasoActivacion(3);
                const nuevaPassword = document.getElementById('nueva_password');
                if (nuevaPassword) nuevaPassword.focus();
            }, 500);
        }
        
        // Función para continuar directamente al paso 3 (cuando ya tiene datos completos)
        function continuarAlPaso3() {
            // Validar email primero
            if (!puedeIrAPaso3()) return;
            
            // Ir al paso 3
            irAPasoActivacion(3);
            setTimeout(() => {
                const nuevaPassword = document.getElementById('nueva_password');
                if (nuevaPassword) nuevaPassword.focus();
            }, 300);
        }
        
        // Función para mostrar sección de contraseña (Paso 3)
        function mostrarSeccionPassword() {
            // Ir al paso 3 de activación
            irAPasoActivacion(3);
            
            setTimeout(() => {
                const nuevaPassword = document.getElementById('nueva_password');
                if (nuevaPassword) nuevaPassword.focus();
            }, 300);
        }
        
        // Función para verificar que el email no esté ya registrado
        async function verificarEmailDisponible() {
            const email = document.getElementById('email_activacion').value.trim().toLowerCase();
            const messageContainer = document.getElementById('emailVerificacionMessage');
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                messageContainer.innerHTML = '<i class="fas fa-times-circle"></i> Por favor ingresa un email válido';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            try {
                messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando email...';
                messageContainer.className = 'form-message info show';
                
                // Buscar si el email ya existe en la tabla users
                const { data, error } = await supabase
                    .from('users')
                    .select('id, email')
                    .eq('email', email)
                    .maybeSingle();
                
                if (error) throw error;
                
                if (data) {
                    // Email ya existe
                    messageContainer.innerHTML = `
                        <i class="fas fa-times-circle"></i> 
                        <strong>Email ya registrado</strong><br>
                        Este correo ya está en uso. Por favor usa otro.
                    `;
                    messageContainer.className = 'form-message error show';
                    window.emailVerificado = null;
                    return;
                }
                
                // Email disponible
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle"></i> 
                    <strong>Email disponible</strong><br>
                    Puedes usar este correo para tu cuenta.
                `;
                messageContainer.className = 'form-message success show';
                
                // Guardar email verificado
                window.emailVerificado = email;
                window.cuentaVerificada.email = email;
                window.datosRegistro.emailVerificado = true;
                
                // Deshabilitar campo email
                document.getElementById('email_activacion').disabled = true;
                document.getElementById('btnVerificarEmail').style.display = 'none';
                
                // Pasar automáticamente a TELÉFONO
                setTimeout(() => {
                    verificarTelefonoExistente();
                }, 500);
                
            } catch (err) {
                console.error('Error verificando email:', err);
                messageContainer.innerHTML = `Error: ${err.message}`;
                messageContainer.className = 'form-message error show';
                window.emailVerificado = null;
            }
        }
                step2.classList.remove('hidden');
                step2.classList.add('visible');
                
                // Limpiar campos
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Mostrar mensaje informativo sobre activación
        // Función para volver a step1b y mostrar activación
        function backToStep1bAndActivate() {
            const step2 = document.getElementById('step2');
            const step1b = document.getElementById('step1b');
            
            // Ocultar step2
            step2.classList.remove('visible');
            step2.classList.add('hidden');
            
            // Mostrar step1b
            setTimeout(() => {
                step1b.classList.remove('hidden');
                step1b.classList.add('visible');
                
                // Hacer clic automático en el botón de activar cuenta
                setTimeout(() => {
                    showActivarCuenta();
                }, 300);
            }, 300);
        }
        
        // Función para volver a step1b y mostrar formulario de solicitud
        function backToStep1bAndRequestForm() {
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const step1b = document.getElementById('step1b');
            
            // Ocultar todos los steps
            if (step2) {
                step2.classList.remove('visible');
                step2.classList.add('hidden');
            }
            if (step3) {
                step3.classList.remove('visible');
                step3.classList.add('hidden');
            }
            
            // Mostrar step1b
            step1b.classList.remove('hidden');
            step1b.classList.add('visible');
            step1b.style.display = 'block';
            
            // Hacer scroll arriba
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Abrir el formulario de solicitud después de un breve delay
            setTimeout(() => {
                showRequestForm();
            }, 500);
        }

        // Función eliminada: showDemoBanner() - sistema ya no muestra banner DEMO

        // Función eliminada: hideDemoBanner() - banner DEMO ya no se usa

        // Función para mostrar el formulario de solicitud
        function showRequestForm() {
            const requestForm = document.getElementById('requestForm');
            const roleRequirements = document.getElementById('roleRequirements');
            const specificFields = document.getElementById('specificFields');
            
            // Configurar requisitos según el rol
            const requirements = {
                'docente': {
                    title: 'Requisitos para Cuenta de Docente',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Constancia de trabajo vigente en la I.E. 80002',
                        'Resolución de nombramiento (si aplica)',
                        'Foto tamaño carnet actualizada'
                    ],
                    fields: `
                        <h6>Información Profesional</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_docente" required>
                                <option value="">Seleccione el rol</option>
                                <option value="docente">Docente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Especialidad</label>
                            <select class="form-input" required>
                                <option value="">Seleccione su especialidad</option>
                                <option value="matematica">Matemática</option>
                                <option value="comunicacion">Comunicación</option>
                                <option value="ciencias">Ciencias Naturales</option>
                                <option value="sociales">Ciencias Sociales</option>
                                <option value="ingles">Inglés</option>
                                <option value="educacion-fisica">Educación Física</option>
                                <option value="arte">Arte y Cultura</option>
                                <option value="religion">Educación Religiosa</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Años de experiencia en la I.E.</label>
                            <input type="number" class="form-input" placeholder="Ej: 5" min="0" required>
                        </div>
                    `
                },
                'tutor': {
                    title: 'Requisitos para Cuenta de Tutor',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Resolución de designación como tutor',
                        'Constancia de trabajo en la I.E.',
                        'Capacitación en tutoría (si aplica)'
                    ],
                    fields: `
                        <h6>Información de Tutoría</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_tutor" required>
                                <option value="">Seleccione el rol</option>
                                <option value="tutor">Tutor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Grado y Sección asignada</label>
                            <select class="form-input" required>
                                <option value="">Seleccione el grado</option>
                                <option value="1a">1° A</option>
                                <option value="1b">1° B</option>
                                <option value="2a">2° A</option>
                                <option value="2b">2° B</option>
                                <option value="3a">3° A</option>
                                <option value="3b">3° B</option>
                                <option value="4a">4° A</option>
                                <option value="4b">4° B</option>
                                <option value="5a">5° A</option>
                                <option value="5b">5° B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Número aproximado de estudiantes</label>
                            <input type="number" class="form-input" placeholder="Ej: 25" min="1" max="40" required>
                        </div>
                    `
                },
                'auxiliar': {
                    title: 'Requisitos para Cuenta de Auxiliar',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Contrato o constancia como auxiliar de educación',
                        'Certificado de antecedentes penales',
                        'Certificado de antecedentes policiales'
                    ],
                    fields: `
                        <h6>Información de Trabajo</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_auxiliar" required>
                                <option value="">Seleccione el rol</option>
                                <option value="auxiliar">Auxiliar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nivel asignado</label>
                            <select class="form-input" required>
                                <option value="">Seleccione el nivel</option>
                                <option value="primaria">Primaria</option>
                                <option value="secundaria">Secundaria</option>
                                <option value="ambos">Ambos niveles</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Turno de trabajo</label>
                            <select class="form-input" required>
                                <option value="">Seleccione el turno</option>
                                <option value="mañana">Mañana</option>
                                <option value="tarde">Tarde</option>
                                <option value="completo">Jornada completa</option>
                            </select>
                        </div>
                    `
                },
                'toe': {
                    title: 'Requisitos para Cuenta de Coordinador TOE',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Resolución de designación como Coordinador TOE',
                        'Título profesional en Psicología, Trabajo Social o afines',
                        'Certificación en programas TOE (si aplica)'
                    ],
                    fields: `
                        <h6>Información Profesional TOE</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_toe" required>
                                <option value="">Seleccione el rol</option>
                                <option value="toe">TOE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Profesión</label>
                            <select class="form-input" required>
                                <option value="">Seleccione su profesión</option>
                                <option value="psicologo">Psicólogo(a)</option>
                                <option value="trabajador-social">Trabajador(a) Social</option>
                                <option value="docente-especializado">Docente Especializado</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Años de experiencia en TOE</label>
                            <input type="number" class="form-input" placeholder="Ej: 3" min="0" required>
                        </div>
                    `
                },
                'direccion': {
                    title: 'Requisitos para Cuenta de Personal Directivo',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Resolución de nombramiento en cargo directivo',
                        'Título profesional en Educación',
                        'Estudios de especialización en gestión (si aplica)'
                    ],
                    fields: `
                        <h6>Información Directiva</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_direccion" required>
                                <option value="">Seleccione el rol</option>
                                <option value="direccion">Dirección</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Años en cargo directivo</label>
                            <input type="number" class="form-input" placeholder="Ej: 2" min="0" required>
                        </div>
                    `
                },
                'padre': {
                    title: 'Requisitos para Cuenta de Padre/Madre/Apoderado',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Ficha de matrícula del estudiante',
                        'Documento que acredite parentesco o tutela legal (si es apoderado)',
                        'Número de celular activo para notificaciones'
                    ],
                    fields: `
                        <h6>Información del Estudiante</h6>
                        <div class="form-group">
                            <label class="form-label">Tipo de parentesco</label>
                            <select class="form-input" id="rol_padre" required>
                                <option value="">Seleccione su relación</option>
                                <option value="padre">Padre</option>
                                <option value="madre">Madre</option>
                                <option value="apoderado">Apoderado Legal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nombre completo del estudiante</label>
                            <input type="text" class="form-input" placeholder="Nombres y apellidos del hijo(a)" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Grado y sección del estudiante</label>
                            <select class="form-input" required>
                                <option value="">Seleccione grado y sección</option>
                                <optgroup label="1° Secundaria">
                                    <option value="1a">1° A</option>
                                    <option value="1b">1° B</option>
                                    <option value="1c">1° C</option>
                                    <option value="1d">1° D</option>
                                    <option value="1e">1° E</option>
                                </optgroup>
                                <optgroup label="2° Secundaria">
                                    <option value="2a">2° A</option>
                                    <option value="2b">2° B</option>
                                    <option value="2c">2° C</option>
                                    <option value="2d">2° D</option>
                                    <option value="2e">2° E</option>
                                </optgroup>
                                <optgroup label="3° Secundaria">
                                    <option value="3a">3° A</option>
                                    <option value="3b">3° B</option>
                                    <option value="3c">3° C</option>
                                    <option value="3d">3° D</option>
                                    <option value="3e">3° E</option>
                                </optgroup>
                                <optgroup label="4° Secundaria">
                                    <option value="4a">4° A</option>
                                    <option value="4b">4° B</option>
                                    <option value="4c">4° C</option>
                                    <option value="4d">4° D</option>
                                    <option value="4e">4° E</option>
                                </optgroup>
                                <optgroup label="5° Secundaria">
                                    <option value="5a">5° A</option>
                                    <option value="5b">5° B</option>
                                    <option value="5c">5° C</option>
                                    <option value="5d">5° D</option>
                                    <option value="5e">5° E</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Parentesco</label>
                            <select class="form-input" required>
                                <option value="">Seleccione parentesco</option>
                                <option value="padre">Padre</option>
                                <option value="madre">Madre</option>
                                <option value="abuelo">Abuelo(a)</option>
                                <option value="tio">Tío(a)</option>
                                <option value="tutor-legal">Tutor Legal</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    `
                },
                'admin': {
                    title: 'Requisitos para Cuenta de Administrador del Sistema',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Resolución o carta de autorización de la Dirección',
                        'Certificación en administración de sistemas (si aplica)',
                        'Compromiso de confidencialidad firmado'
                    ],
                    fields: `
                        <h6>Información del Administrador</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_admin" required>
                                <option value="">Seleccione el rol</option>
                                <option value="admin">Administrador del Sistema</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Justificación para acceso administrativo</label>
                            <textarea class="form-input" rows="3" placeholder="Explique por qué necesita acceso administrativo al sistema" required></textarea>
                        </div>
                        <div class="alert alert-warning" style="font-size: 12px; margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>IMPORTANTE:</strong> Las cuentas de administrador requieren aprobación especial de la Dirección y pueden tardar hasta 72 horas en procesarse.
                        </div>
                    `
                }
            };
            
            const roleReq = requirements[selectedUserRole];
            roleRequirements.innerHTML = `
                <h6>${roleReq.title}</h6>
                <ul>
                    ${roleReq.docs.map(doc => `<li>${doc}</li>`).join('')}
                </ul>
            `;
            
            specificFields.innerHTML = roleReq.fields;
            
            requestForm.classList.add('visible');
            
            // Scroll mejorado con delay para que la animación termine
            setTimeout(() => {
                requestForm.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
                
                // También hacer scroll del contenedor padre si es necesario
                const loginCard = document.querySelector('.login-card');
                if (loginCard) {
                    loginCard.scrollTop = loginCard.scrollHeight - loginCard.clientHeight;
                }
            }, 100);
        }

        // Función para cancelar solicitud
        function cancelRequest() {
            const requestForm = document.getElementById('requestForm');
            requestForm.classList.remove('visible');
        }

        // Función para enviar solicitud
        async function submitRequest() {
            const roleNames = {
                'docente': 'Docente',
                'tutor': 'Tutor',
                'auxiliar': 'Auxiliar',
                'toe': 'Coordinador TOE',
                'direccion': 'Personal Directivo',
                'padre': 'Padre/Madre/Apoderado',
                'admin': 'Administrador del Sistema'
            };
            
            // Obtener datos del formulario
            const nombre = document.getElementById('solicitud_nombre')?.value?.trim().toUpperCase();
            const dni = document.getElementById('solicitud_dni')?.value?.trim();
            const email = document.getElementById('solicitud_email')?.value?.trim().toLowerCase();
            const telefono = document.getElementById('solicitud_telefono')?.value?.trim();
            
            // Validaciones
            if (!nombre || nombre.length < 3) {
                mostrarAlerta('Por favor ingrese su nombre completo.', 'Error', 'error');
                return;
            }
            
            if (!dni || dni.length !== 8 || !/^\d{8}$/.test(dni)) {
                mostrarAlerta('El DNI debe tener exactamente 8 dígitos numéricos.', 'Error', 'error');
                return;
            }
            
            if (!email || !email.includes('@')) {
                mostrarAlerta('Por favor ingrese un correo electrónico válido.', 'Error', 'error');
                return;
            }
            
            if (!telefono || telefono.length !== 9 || !/^\d{9}$/.test(telefono)) {
                mostrarAlerta('El teléfono debe tener 9 dígitos.', 'Error', 'error');
                return;
            }
            
            // Obtener datos específicos del rol (para padres: grado/sección, nombre estudiante, parentesco)
            let datosAdicionales = {};
            if (selectedUserRole === 'padre') {
                const nombreEstudiante = document.querySelector('#specificFields input[placeholder*="hijo"]')?.value?.trim();
                const gradoSeccion = document.querySelector('#specificFields select')?.value;
                const parentesco = document.querySelectorAll('#specificFields select')[1]?.value;
                
                if (nombreEstudiante) datosAdicionales.nombre_estudiante = nombreEstudiante.toUpperCase();
                if (gradoSeccion) datosAdicionales.grado_seccion = gradoSeccion;
                if (parentesco) datosAdicionales.parentesco = parentesco;
            }
            
            try {
                // Verificar si ya existe una solicitud pendiente con ese DNI o email
                const { data: solicitudExistente } = await supabase
                    .from('solicitudes_registro')
                    .select('id, dni, email, estado')
                    .or(`dni.eq.${dni},email.eq.${email}`)
                    .eq('estado', 'pendiente')
                    .limit(1);
                
                if (solicitudExistente && solicitudExistente.length > 0) {
                    mostrarAlerta('Ya existe una solicitud pendiente con este DNI o correo. Por favor espere la respuesta del administrador.', 'Solicitud Existente', 'warning');
                    return;
                }
                
                // Verificar si ya existe un usuario registrado con ese DNI o email
                const { data: usuarioExistente } = await supabase
                    .from('users')
                    .select('id, dni, email')
                    .or(`dni.eq.${dni},email.eq.${email}`)
                    .limit(1);
                
                if (usuarioExistente && usuarioExistente.length > 0) {
                    const usuario = usuarioExistente[0];
                    if (usuario.dni === dni) {
                        mostrarAlerta('Ya existe una cuenta registrada con este DNI. Si ya tiene cuenta, intente activarla.', 'Usuario Existente', 'warning');
                    } else {
                        mostrarAlerta('Ya existe una cuenta registrada con este correo electrónico.', 'Usuario Existente', 'warning');
                    }
                    return;
                }
                
                // Insertar la solicitud en la tabla solicitudes_registro
                const { data, error } = await supabase
                    .from('solicitudes_registro')
                    .insert([{
                        dni: dni,
                        nombre_completo: nombre,
                        email: email,
                        telefono: telefono,
                        role: selectedUserRole,
                        estado: 'pendiente'
                    }])
                    .select();
                
                if (error) throw error;
                
                console.log('Solicitud guardada:', data);
                
                mostrarAlerta(
                    `<strong>Tipo de cuenta:</strong> ${roleNames[selectedUserRole]}<br><br>` +
                    `Su solicitud será revisada por el administrador del sistema.<br>` +
                    `Recibirá una respuesta en las próximas 24-48 horas al correo proporcionado.<br><br>` +
                    `<small><i class="fas fa-info-circle"></i> Asegúrese de tener todos los documentos requeridos listos para el proceso de verificación.</small>`,
                    '✅ Solicitud Enviada',
                    'success'
                );
                
                // Limpiar formulario
                document.getElementById('solicitud_nombre').value = '';
                document.getElementById('solicitud_dni').value = '';
                document.getElementById('solicitud_email').value = '';
                document.getElementById('solicitud_telefono').value = '';
                
                // Volver al inicio
                backToRoleSelection();
                
            } catch (error) {
                console.error('Error al enviar solicitud:', error);
                mostrarAlerta(
                    'Hubo un error al enviar su solicitud. Por favor intente nuevamente.<br><br>' +
                    `<small>Error: ${error.message}</small>`,
                    'Error',
                    'error'
                );
            }
        }

        // Función para mostrar/ocultar contraseña
        // Función para mostrar/ocultar contraseña
        function togglePasswordVisibility(fieldId = 'password', iconId = 'password-icon') {
            const passwordField = document.getElementById(fieldId);
            const passwordIcon = document.getElementById(iconId);
            
            if (!passwordField || !passwordIcon) return;
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                passwordIcon.classList.remove('fa-eye');
                passwordIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                passwordIcon.classList.remove('fa-eye-slash');
                passwordIcon.classList.add('fa-eye');
            }
        }
        
        // Función para validar requisitos de contraseña en tiempo real
        function validarPasswordRequisitos() {
            const password = document.getElementById('nueva_password')?.value || '';
            const confirmPassword = document.getElementById('confirmar_password')?.value || '';
            
            const reqLength = document.getElementById('req-length');
            const reqMatch = document.getElementById('req-match');
            const strengthContainer = document.getElementById('password-strength-container');
            const strengthBar = document.getElementById('password-strength-bar');
            const strengthText = document.getElementById('password-strength-text');
            
            if (!reqLength || !reqMatch) return;
            
            // Validar longitud mínima
            if (password.length >= 6) {
                reqLength.style.color = '#2e7d32';
                reqLength.innerHTML = '<i class="fas fa-check-circle" style="font-size: 12px; margin-right: 5px;"></i> Mínimo 6 caracteres';
            } else {
                reqLength.style.color = '#1565c0';
                reqLength.innerHTML = '<i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i> Mínimo 6 caracteres';
            }
            
            // Validar que coincidan (solo si ambos campos tienen texto)
            if (password && confirmPassword) {
                if (password === confirmPassword) {
                    reqMatch.style.color = '#2e7d32';
                    reqMatch.innerHTML = '<i class="fas fa-check-circle" style="font-size: 12px; margin-right: 5px;"></i> Las contraseñas coinciden';
                } else {
                    reqMatch.style.color = '#c62828';
                    reqMatch.innerHTML = '<i class="fas fa-times-circle" style="font-size: 12px; margin-right: 5px;"></i> Las contraseñas NO coinciden';
                }
            } else {
                reqMatch.style.color = '#1565c0';
                reqMatch.innerHTML = '<i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i> Las contraseñas deben coincidir';
            }
            
            // Calcular nivel de seguridad
            if (password.length > 0) {
                strengthContainer.style.display = 'block';
                let strength = 0;
                let strengthLabel = '';
                let strengthColor = '';
                
                // Criterios de seguridad
                if (password.length >= 6) strength += 25;
                if (password.length >= 8) strength += 15;
                if (password.length >= 10) strength += 10;
                if (/[a-z]/.test(password)) strength += 10; // Minúsculas
                if (/[A-Z]/.test(password)) strength += 15; // Mayúsculas
                if (/[0-9]/.test(password)) strength += 15; // Números
                if (/[^a-zA-Z0-9]/.test(password)) strength += 10; // Símbolos
                
                // Determinar nivel
                if (strength < 40) {
                    strengthLabel = 'Baja';
                    strengthColor = '#f44336';
                } else if (strength < 70) {
                    strengthLabel = 'Media';
                    strengthColor = '#ff9800';
                } else {
                    strengthLabel = 'Alta';
                    strengthColor = '#4caf50';
                }
                
                strengthBar.style.width = strength + '%';
                strengthBar.style.background = strengthColor;
                strengthText.textContent = strengthLabel;
                strengthText.style.color = strengthColor;
            } else {
                strengthContainer.style.display = 'none';
            }
        }

        // ==================== FUNCIONES DE ADMINISTRACIÓN ====================
        
        // Variables globales para el admin
        let usuariosAdmin = [];
        let incidenciasAdmin = [];
        let estudiantesAdmin = [];
        let solicitudesAdmin = [];
        
        // ===== NAVEGACIÓN DE PESTAÑAS DEL ADMIN =====
        function showAdminTab(tabName) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Quitar clase active de todos los botones
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('btn-secondary');
                btn.classList.remove('btn-primary');
            });
            
            // Mostrar el tab seleccionado
            const selectedTab = document.getElementById(`adminTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // Activar el botón
            const selectedBtn = document.getElementById(`tabAdmin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                selectedBtn.classList.remove('btn-secondary');
                selectedBtn.classList.add('btn-primary');
            }
            
            // Cargar datos según el tab
            if (tabName === 'dashboard') {
                cargarDashboardAdmin();
            } else if (tabName === 'usuarios') {
                cargarUsuariosAdmin();
            } else if (tabName === 'solicitudes') {
                cargarSolicitudesAdmin();
            } else if (tabName === 'incidencias') {
                cargarIncidenciasAdmin();
            } else if (tabName === 'estudiantes') {
                cargarEstudiantesAdmin();
            } else if (tabName === 'soporte') {
                cargarTablaSoporte();
            }
        }
        
        // ===== DASHBOARD DEL ADMIN =====
        async function cargarDashboardAdmin() {
            try {
                // Contar usuarios
                const { data: usuarios, error: errorUsuarios } = await supabase
                    .from('users')
                    .select('id, role, activo, created_at');
                
                // Contar estudiantes
                const { data: estudiantes, error: errorEst } = await supabase
                    .from('estudiantes')
                    .select('id, activo');
                
                // Contar incidencias
                const { data: incidencias, error: errorInc } = await supabase
                    .from('incidencias')
                    .select('id, tipo, fecha, created_at');
                
                // Contar solicitudes pendientes desde solicitudes_registro
                const { count: countSolicitudes, error: errorSol } = await supabase
                    .from('solicitudes_registro')
                    .select('*', { count: 'exact', head: true })
                    .eq('estado', 'pendiente');
                
                const solicitudesPendientes = countSolicitudes || 0;
                
                // Actualizar números
                document.getElementById('adminTotalUsuarios').textContent = usuarios?.length || 0;
                document.getElementById('adminTotalEstudiantes').textContent = estudiantes?.length || 0;
                document.getElementById('adminTotalIncidencias').textContent = incidencias?.length || 0;
                document.getElementById('adminSolicitudesPendientes').textContent = solicitudesPendientes;
                
                // Actualizar badge de solicitudes y campanita
                actualizarContadorSolicitudes();
                
                // Incidencias del mes
                const inicioMes = new Date();
                inicioMes.setDate(1);
                const incidenciasMes = incidencias?.filter(inc => {
                    const fecha = new Date(inc.fecha || inc.created_at);
                    return fecha >= inicioMes;
                }) || [];
                document.getElementById('adminIncidenciasMes').textContent = incidenciasMes.length;
                
                // Distribución por roles - Mostrar TODOS los roles aunque estén en 0
                const todosLosRoles = ['admin', 'direccion', 'toe', 'docente', 'tutor', 'auxiliar', 'padre'];
                const nombresRoles = {
                    'admin': 'Administrador',
                    'direccion': 'Dirección',
                    'toe': 'TOE',
                    'docente': 'Docente',
                    'tutor': 'Tutor',
                    'auxiliar': 'Auxiliar',
                    'padre': 'Padre/Madre/Apoderado'
                };
                const coloresRoles = {
                    'admin': '#667eea',
                    'direccion': '#764ba2',
                    'toe': '#fee140',
                    'docente': '#4facfe',
                    'tutor': '#fa709a',
                    'auxiliar': '#f093fb',
                    'padre': '#00f2fe'
                };
                
                // Contar usuarios por rol
                const distribucionRoles = {};
                todosLosRoles.forEach(rol => distribucionRoles[rol] = 0);
                usuarios?.forEach(u => {
                    if (u.role && distribucionRoles.hasOwnProperty(u.role)) {
                        distribucionRoles[u.role]++;
                    }
                });
                
                // Encontrar el máximo para escalar las barras proporcionalmente
                const maxCount = Math.max(...Object.values(distribucionRoles), 1);
                
                let htmlDistribucion = '';
                for (const rol of todosLosRoles) {
                    const count = distribucionRoles[rol];
                    const porcentaje = (count / maxCount * 100).toFixed(1);
                    htmlDistribucion += `
                        <div class="rol-distribucion">
                            <div class="rol-nombre">${nombresRoles[rol]}</div>
                            <div class="rol-barra">
                                <div class="rol-barra-fill" style="width: ${porcentaje}%; background: ${coloresRoles[rol]};"></div>
                            </div>
                            <div class="rol-count">${count}</div>
                        </div>
                    `;
                }
                document.getElementById('adminDistribucionRoles').innerHTML = htmlDistribucion;
                
                // Incidencias por tipo
                const incidenciasPorTipo = { merito: 0, demerito: 0 };
                incidenciasMes.forEach(inc => {
                    if (inc.tipo === 'merito') incidenciasPorTipo.merito++;
                    else incidenciasPorTipo.demerito++;
                });
                
                document.getElementById('adminIncidenciasPorTipo').innerHTML = `
                    <div class="grid grid-2" style="gap: 15px; margin-top: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--color-ata-dorado);">${incidenciasPorTipo.merito}</div>
                            <div style="font-size: 12px; color: #666;">Méritos</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--color-ata-rojo);">${incidenciasPorTipo.demerito}</div>
                            <div style="font-size: 12px; color: #666;">Deméritos</div>
                        </div>
                    </div>
                `;
                
                // Actividad reciente
                const actividadReciente = [...(usuarios || []), ...(incidencias || [])]
                    .map(item => ({
                        ...item,
                        timestamp: new Date(item.created_at || item.fecha)
                    }))
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 10);
                
                let htmlActividad = '';
                actividadReciente.forEach(item => {
                    const esUsuario = item.role !== undefined;
                    const clase = esUsuario ? 'usuario' : (item.tipo === 'merito' ? 'merito' : 'incidencia');
                    const icono = esUsuario ? 'fa-user-plus' : (item.tipo === 'merito' ? 'fa-star' : 'fa-exclamation-triangle');
                    const texto = esUsuario 
                        ? `Nuevo usuario registrado: ${item.role}`
                        : `Nueva ${item.tipo === 'merito' ? 'mérito' : 'incidencia'} registrada`;
                    
                    htmlActividad += `
                        <div class="actividad-item ${clase}">
                            <div>
                                <i class="fas ${icono}"></i> ${texto}
                            </div>
                            <div class="actividad-fecha">${item.timestamp.toLocaleDateString()}</div>
                        </div>
                    `;
                });
                document.getElementById('adminActividadReciente').innerHTML = htmlActividad || '<div class="empty-state"><i class="fas fa-inbox"></i><p>No hay actividad reciente</p></div>';
                
            } catch (error) {
                console.error('Error cargando dashboard admin:', error);
                mostrarNotificacion('Error al cargar el dashboard', 'error');
            }
        }
        
        // ===== GESTIÓN DE USUARIOS =====
        async function cargarUsuariosAdmin() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                usuariosAdmin = data || [];
                renderizarTablaUsuarios(usuariosAdmin);
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                mostrarNotificacion('Error al cargar usuarios', 'error');
            }
        }
        
        function renderizarTablaUsuarios(usuarios) {
            const tbody = document.getElementById('tbodyUsuariosAdmin');
            if (!tbody) return;
            
            if (!usuarios || usuarios.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-users-slash"></i><p>No hay usuarios registrados</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = usuarios.map(user => {
                // Determinar si la cuenta está activada
                // Solo es activada si el campo 'activado' es explícitamente true
                const cuentaActivada = user.activado === true;
                
                return `
                <tr>
                    <td>${user.nombre_completo || 'Sin nombre'}</td>
                    <td>${user.email || 'Sin email'}</td>
                    <td><span class="badge badge-primary">${user.role?.toUpperCase() || 'SIN ROL'}</span></td>
                    <td>
                        <span class="badge ${user.activo ? 'badge-success' : 'badge-danger'}">
                            ${user.activo ? 'ACTIVO' : 'INACTIVO'}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${cuentaActivada ? 'badge-success' : 'badge-warning'}">
                            ${cuentaActivada ? '✓ ACTIVADA' : '⏳ SIN ACTIVAR'}
                        </span>
                    </td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-info btn-xs" onclick="editarUsuario('${user.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-${user.activo ? 'warning' : 'success'} btn-xs" 
                                    onclick="toggleActivoUsuario('${user.id}', ${!user.activo})" 
                                    title="${user.activo ? 'Desactivar' : 'Activar'}">
                                <i class="fas fa-${user.activo ? 'ban' : 'check'}"></i>
                            </button>
                            <button class="btn btn-danger btn-xs" onclick="eliminarUsuario('${user.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        function filtrarUsuariosAdmin() {
            const filtroNombre = document.getElementById('filtroUsuarioNombre')?.value.toLowerCase() || '';
            const filtroRol = document.getElementById('filtroUsuarioRol')?.value || '';
            const filtroEstado = document.getElementById('filtroUsuarioEstado')?.value || '';
            
            const usuariosFiltrados = usuariosAdmin.filter(user => {
                const coincideNombre = !filtroNombre || 
                    (user.nombre_completo?.toLowerCase().includes(filtroNombre)) ||
                    (user.email?.toLowerCase().includes(filtroNombre));
                const coincideRol = !filtroRol || user.role === filtroRol;
                const coincideEstado = !filtroEstado || 
                    (filtroEstado === 'activo' && user.activo) ||
                    (filtroEstado === 'inactivo' && !user.activo);
                
                return coincideNombre && coincideRol && coincideEstado;
            });
            
            renderizarTablaUsuarios(usuariosFiltrados);
        }
        
        async function toggleActivoUsuario(userId, nuevoEstado) {
            const confirmar = await mostrarConfirmacion(
                `¿Confirmar ${nuevoEstado ? 'activación' : 'desactivación'} del usuario?`,
                nuevoEstado ? 'Activar Usuario' : 'Desactivar Usuario',
                { tipo: nuevoEstado ? 'success' : 'warning', btnConfirmar: nuevoEstado ? 'Activar' : 'Desactivar' }
            );
            if (!confirmar) return;
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ activo: nuevoEstado, activado: nuevoEstado })
                    .eq('id', userId);
                
                if (error) throw error;
                
                mostrarNotificacion(`Usuario ${nuevoEstado ? 'activado' : 'desactivado'} correctamente`, 'success');
                cargarUsuariosAdmin();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al actualizar usuario', 'error');
            }
        }
        
        async function eliminarUsuario(userId) {
            const confirmar = await mostrarConfirmacion(
                '¿Está seguro de eliminar este usuario?<br><br><strong style="color:#e74c3c">Esta acción NO se puede deshacer.</strong>',
                '⚠️ Eliminar Usuario',
                { tipo: 'warning', btnConfirmar: 'Eliminar', peligroso: true }
            );
            if (!confirmar) return;
            
            try {
                const { error } = await supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                
                if (error) throw error;
                
                mostrarNotificacion('Usuario eliminado correctamente', 'success');
                cargarUsuariosAdmin();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar usuario', 'error');
            }
        }
        
        function editarUsuario(userId) {
            const usuario = usuariosAdmin.find(u => u.id === userId);
            if (!usuario) return;
            
            const roles = ['docente', 'tutor', 'auxiliar', 'toe', 'direccion', 'padre', 'admin'];
            const rolesOptions = roles.map(r => 
                `<option value="${r}" ${usuario.role === r ? 'selected' : ''}>${r.charAt(0).toUpperCase() + r.slice(1)}</option>`
            ).join('');
            
            const modalHTML = `
                <div class="modal-overlay" id="modalEditarUsuario" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-user-edit"></i> Editar Usuario</h3>
                            <button class="btn-close" onclick="document.getElementById('modalEditarUsuario').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="formEditarUsuario">
                                <input type="hidden" id="editUserId" value="${usuario.id}">
                                <div class="form-group">
                                    <label>Nombre Completo</label>
                                    <input type="text" class="form-control" id="editUserNombre" value="${usuario.nombre_completo || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" class="form-control" id="editUserEmail" value="${usuario.email || ''}" readonly>
                                    <small style="color: #666;">El email no se puede modificar</small>
                                </div>
                                <div class="form-group">
                                    <label>DNI</label>
                                    <input type="text" class="form-control" id="editUserDni" value="${usuario.dni || ''}" maxlength="8">
                                </div>
                                <div class="form-group">
                                    <label>Teléfono</label>
                                    <input type="text" class="form-control" id="editUserTelefono" value="${usuario.telefono || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Rol</label>
                                    <select class="form-control" id="editUserRol">${rolesOptions}</select>
                                </div>
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="editUserActivo" ${usuario.activo ? 'checked' : ''}>
                                        Usuario Activo
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="guardarEdicionUsuario()"><i class="fas fa-save"></i> Guardar Cambios</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalEditarUsuario').remove()">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        async function guardarEdicionUsuario() {
            const userId = document.getElementById('editUserId').value;
            const datos = {
                nombre_completo: document.getElementById('editUserNombre').value,
                dni: document.getElementById('editUserDni').value,
                telefono: document.getElementById('editUserTelefono').value,
                role: document.getElementById('editUserRol').value,
                activo: document.getElementById('editUserActivo').checked
            };
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update(datos)
                    .eq('id', userId);
                
                if (error) throw error;
                
                document.getElementById('modalEditarUsuario').remove();
                mostrarNotificacion('Usuario actualizado correctamente', 'success');
                cargarUsuariosAdmin();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al actualizar usuario', 'error');
            }
        }
        
        function mostrarModalCrearUsuario() {
            const roles = ['docente', 'tutor', 'auxiliar', 'toe', 'direccion', 'padre', 'admin'];
            const rolesOptions = roles.map(r => 
                `<option value="${r}">${r.charAt(0).toUpperCase() + r.slice(1)}</option>`
            ).join('');
            
            const modalHTML = `
                <div class="modal-overlay" id="modalCrearUsuario" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-user-plus"></i> Crear Nuevo Usuario</h3>
                            <button class="btn-close" onclick="document.getElementById('modalCrearUsuario').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="formCrearUsuario">
                                <div class="form-group">
                                    <label>Nombre Completo *</label>
                                    <input type="text" class="form-control" id="newUserNombre" required>
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" class="form-control" id="newUserEmail" required>
                                </div>
                                <div class="form-group">
                                    <label>Contraseña *</label>
                                    <input type="password" class="form-control" id="newUserPassword" minlength="6" required>
                                    <small style="color: #666;">Mínimo 6 caracteres</small>
                                </div>
                                <div class="form-group">
                                    <label>DNI</label>
                                    <input type="text" class="form-control" id="newUserDni" maxlength="8">
                                </div>
                                <div class="form-group">
                                    <label>Teléfono</label>
                                    <input type="text" class="form-control" id="newUserTelefono">
                                </div>
                                <div class="form-group">
                                    <label>Rol *</label>
                                    <select class="form-control" id="newUserRol" required>${rolesOptions}</select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="guardarNuevoUsuario()"><i class="fas fa-save"></i> Crear Usuario</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalCrearUsuario').remove()">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        async function guardarNuevoUsuario() {
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const nombre = document.getElementById('newUserNombre').value;
            const dni = document.getElementById('newUserDni').value;
            const telefono = document.getElementById('newUserTelefono').value;
            const role = document.getElementById('newUserRol').value;
            
            if (!email || !password || !nombre || !role) {
                mostrarNotificacion('Por favor complete los campos obligatorios', 'warning');
                return;
            }
            
            try {
                // Crear usuario en la tabla users (sin Auth porque requiere Admin API)
                const { data, error } = await supabase
                    .from('users')
                    .insert([{
                        email: email,
                        nombre_completo: nombre,
                        dni: dni,
                        telefono: telefono,
                        role: role,
                        activo: true,
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                document.getElementById('modalCrearUsuario').remove();
                mostrarNotificacion('Usuario creado correctamente. El usuario deberá registrarse con este email.', 'success');
                cargarUsuariosAdmin();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al crear usuario: ' + error.message, 'error');
            }
        }
        
        // ===== GESTIÓN DE SOLICITUDES =====
        async function cargarSolicitudesAdmin() {
            try {
                const { data, error } = await supabase
                    .from('solicitudes_registro')
                    .select('*')
                    .eq('estado', 'pendiente')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                solicitudesAdmin = data || [];
                renderizarSolicitudes(solicitudesAdmin);
            } catch (error) {
                console.error('Error cargando solicitudes:', error);
                mostrarNotificacion('Error al cargar solicitudes', 'error');
            }
        }
        
        function renderizarSolicitudes(solicitudes) {
            const container = document.getElementById('listaSolicitudesPendientes');
            if (!container) return;
            
            if (!solicitudes || solicitudes.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-check"></i><p>No hay solicitudes pendientes</p></div>';
                return;
            }
            
            container.innerHTML = solicitudes.map(sol => `
                <div class="solicitud-card">
                    <div class="solicitud-info">
                        <h4>${sol.nombre_completo || 'Sin nombre'}</h4>
                        <p><i class="fas fa-envelope"></i> ${sol.email || 'Sin email'}</p>
                        <p><i class="fas fa-user-tag"></i> Rol solicitado: <strong>${sol.role}</strong></p>
                        <p><i class="fas fa-calendar"></i> Fecha: ${new Date(sol.created_at).toLocaleString()}</p>
                    </div>
                    <div class="solicitud-actions">
                        <button class="btn btn-info" onclick="verDetallesSolicitud('${sol.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-success" onclick="aprobarSolicitud('${sol.id}')">
                            <i class="fas fa-check"></i> Aprobar
                        </button>
                        <button class="btn btn-danger" onclick="rechazarSolicitud('${sol.id}')">
                            <i class="fas fa-times"></i> Rechazar
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        async function aprobarSolicitud(solicitudId) {
            const confirmar = await mostrarConfirmacion(
                '¿Aprobar esta solicitud y crear la cuenta del usuario?<br><br>El usuario podrá iniciar sesión inmediatamente.',
                'Aprobar Solicitud',
                { tipo: 'success', btnConfirmar: 'Aprobar' }
            );
            if (!confirmar) return;
            
            try {
                // Obtener los datos de la solicitud
                const { data: solicitud, error: errorSolicitud } = await supabase
                    .from('solicitudes_registro')
                    .select('*')
                    .eq('id', solicitudId)
                    .single();
                
                if (errorSolicitud) throw errorSolicitud;
                
                // Crear el usuario en la tabla users
                const { error: errorCrear } = await supabase
                    .from('users')
                    .insert([{
                        dni: solicitud.dni,
                        nombre_completo: solicitud.nombre_completo,
                        email: solicitud.email,
                        telefono: solicitud.telefono,
                        role: solicitud.role,
                        activo: true
                    }]);
                
                if (errorCrear) throw errorCrear;
                
                // Actualizar el estado de la solicitud a 'aprobado'
                const { error: errorActualizar } = await supabase
                    .from('solicitudes_registro')
                    .update({ 
                        estado: 'aprobado',
                        revisado_at: new Date().toISOString()
                    })
                    .eq('id', solicitudId);
                
                if (errorActualizar) throw errorActualizar;
                
                mostrarNotificacion('Solicitud aprobada - Cuenta creada correctamente', 'success');
                cargarSolicitudesAdmin();
                cargarDashboardAdmin(); // Actualizar dashboard
                actualizarContadorSolicitudes(); // Actualizar badge y campanita
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al aprobar solicitud: ' + error.message, 'error');
            }
        }
        
        async function rechazarSolicitud(solicitudId) {
            const confirmar = await mostrarConfirmacion(
                '¿Rechazar esta solicitud?<br><br>El solicitante deberá enviar una nueva solicitud si desea registrarse.',
                '⚠️ Rechazar Solicitud',
                { tipo: 'warning', btnConfirmar: 'Rechazar', peligroso: true }
            );
            if (!confirmar) return;
            
            try {
                const { error } = await supabase
                    .from('solicitudes_registro')
                    .update({ 
                        estado: 'rechazado',
                        revisado_at: new Date().toISOString()
                    })
                    .eq('id', solicitudId);
                
                if (error) throw error;
                
                mostrarNotificacion('Solicitud rechazada', 'success');
                cargarSolicitudesAdmin();
                cargarDashboardAdmin();
                actualizarContadorSolicitudes(); // Actualizar badge
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al rechazar solicitud', 'error');
            }
        }
        
        // Función para ver detalles de una solicitud
        async function verDetallesSolicitud(solicitudId) {
            try {
                const solicitud = solicitudesAdmin.find(s => s.id === solicitudId);
                if (!solicitud) {
                    mostrarNotificacion('Solicitud no encontrada', 'error');
                    return;
                }
                
                const rolTexto = {
                    'padre': 'Padre/Madre/Apoderado',
                    'docente': 'Docente',
                    'auxiliar': 'Auxiliar',
                    'direccion': 'Dirección',
                    'admin': 'Administrador'
                };
                
                const fechaSolicitud = new Date(solicitud.created_at);
                const fechaFormateada = fechaSolicitud.toLocaleDateString('es-PE', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const modalHtml = `
                    <div class="modal-overlay" id="modalDetallesSolicitud" style="display:flex; align-items:center; justify-content:center;">
                        <div class="modal-container" style="max-width: 500px; width: 95%;">
                            <div class="modal-header" style="background: linear-gradient(135deg, var(--color-ata-verde), var(--color-ata-verde-claro)); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                                <h3 style="margin: 0;"><i class="fas fa-user-plus"></i> Detalles de Solicitud</h3>
                                <button onclick="document.getElementById('modalDetallesSolicitud').remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; position: absolute; right: 15px; top: 15px;">&times;</button>
                            </div>
                            <div class="modal-body" style="padding: 25px;">
                                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                        <div style="width: 60px; height: 60px; background: var(--color-ata-verde); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div>
                                            <h4 style="margin: 0; color: #333;">${solicitud.nombre_completo}</h4>
                                            <span style="background: var(--color-ata-verde); color: white; padding: 3px 10px; border-radius: 15px; font-size: 12px;">${rolTexto[solicitud.role] || solicitud.role}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; gap: 15px;">
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fff; border: 1px solid #e9ecef; border-radius: 8px;">
                                        <i class="fas fa-id-card" style="color: var(--color-ata-verde); width: 25px;"></i>
                                        <div>
                                            <small style="color: #666;">DNI</small>
                                            <div style="font-weight: 600;">${solicitud.dni}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fff; border: 1px solid #e9ecef; border-radius: 8px;">
                                        <i class="fas fa-envelope" style="color: var(--color-ata-azul); width: 25px;"></i>
                                        <div>
                                            <small style="color: #666;">Correo Electrónico</small>
                                            <div style="font-weight: 600;">${solicitud.email}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fff; border: 1px solid #e9ecef; border-radius: 8px;">
                                        <i class="fas fa-phone" style="color: #27ae60; width: 25px;"></i>
                                        <div>
                                            <small style="color: #666;">Teléfono</small>
                                            <div style="font-weight: 600;">${solicitud.telefono || 'No proporcionado'}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fff; border: 1px solid #e9ecef; border-radius: 8px;">
                                        <i class="fas fa-calendar-alt" style="color: #e67e22; width: 25px;"></i>
                                        <div>
                                            <small style="color: #666;">Fecha de Solicitud</small>
                                            <div style="font-weight: 600;">${fechaFormateada}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #fffbeb; border: 1px solid #f59e0b; border-radius: 8px;">
                                        <i class="fas fa-clock" style="color: #f59e0b; width: 25px;"></i>
                                        <div>
                                            <small style="color: #666;">Estado</small>
                                            <div style="font-weight: 600; color: #f59e0b;">⏳ Pendiente de revisión</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer" style="padding: 15px 25px; border-top: 1px solid #e9ecef; display: flex; gap: 10px; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="document.getElementById('modalDetallesSolicitud').remove()">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                                <button class="btn btn-success" onclick="document.getElementById('modalDetallesSolicitud').remove(); aprobarSolicitud('${solicitud.id}')">
                                    <i class="fas fa-check"></i> Aprobar
                                </button>
                                <button class="btn btn-danger" onclick="document.getElementById('modalDetallesSolicitud').remove(); rechazarSolicitud('${solicitud.id}')">
                                    <i class="fas fa-times"></i> Rechazar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al cargar detalles', 'error');
            }
        }
        
        // Función para actualizar contador de solicitudes pendientes
        async function actualizarContadorSolicitudes() {
            try {
                const { data, error } = await supabase
                    .from('solicitudes_registro')
                    .select('*')
                    .eq('estado', 'pendiente')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                const solicitudes = data || [];
                const cantidad = solicitudes.length;
                
                // Guardar en variable global para el dropdown
                window.solicitudesPendientesDropdown = solicitudes;
                
                // Actualizar badge en el botón de Solicitudes
                const badgeSolicitudes = document.getElementById('badgeSolicitudes');
                if (badgeSolicitudes) {
                    if (cantidad > 0) {
                        badgeSolicitudes.textContent = cantidad > 999 ? '999+' : cantidad;
                        badgeSolicitudes.style.display = 'inline-block';
                    } else {
                        badgeSolicitudes.style.display = 'none';
                    }
                }
                
                // Actualizar campanita en el header
                const bellBadge = document.getElementById('bellBadge');
                if (bellBadge) {
                    if (cantidad > 0) {
                        bellBadge.textContent = cantidad > 999 ? '999+' : cantidad;
                        bellBadge.style.display = 'block';
                    } else {
                        bellBadge.style.display = 'none';
                    }
                }
                
                // Actualizar título de la página con contador
                actualizarTituloPagina();
                
                // Actualizar el contador en el dashboard de admin
                const adminSolicitudes = document.getElementById('adminSolicitudesPendientes');
                if (adminSolicitudes) {
                    adminSolicitudes.textContent = cantidad;
                }
                
                // Actualizar contenido del dropdown
                renderizarDropdownSolicitudes(solicitudes);
                
                console.log(`📬 Solicitudes pendientes: ${cantidad}`);
            } catch (error) {
                console.error('Error actualizando contador:', error);
            }
        }
        
        // Renderizar lista de solicitudes en el dropdown
        function renderizarDropdownSolicitudes(solicitudes) {
            const container = document.getElementById('notificationDropdownList');
            if (!container) return;
            
            if (!solicitudes || solicitudes.length === 0) {
                container.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-check-circle"></i>
                        <p>No hay solicitudes pendientes</p>
                    </div>
                `;
                return;
            }
            
            const rolTexto = {
                'padre': 'Padre/Apoderado',
                'docente': 'Docente',
                'auxiliar': 'Auxiliar',
                'direccion': 'Dirección',
                'admin': 'Administrador',
                'tutor': 'Tutor',
                'toe': 'TOE'
            };
            
            container.innerHTML = solicitudes.map(sol => {
                const fecha = new Date(sol.created_at);
                const tiempoTranscurrido = calcularTiempoTranscurrido(fecha);
                
                return `
                    <div class="notification-item" onclick="irASolicitudDesdeDropdown('${sol.id}')">
                        <div class="notification-item-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="notification-item-content">
                            <div class="notification-item-title">${sol.nombre_completo}</div>
                            <div class="notification-item-desc">Solicita: ${rolTexto[sol.role] || sol.role}</div>
                            <div class="notification-item-time"><i class="fas fa-clock"></i> ${tiempoTranscurrido}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Calcular tiempo transcurrido (hace X minutos, horas, días)
        function calcularTiempoTranscurrido(fechaStr) {
            const fecha = new Date(fechaStr);
            const ahora = new Date();
            const diff = ahora - fecha;
            const minutos = Math.floor(diff / 60000);
            const horas = Math.floor(diff / 3600000);
            const dias = Math.floor(diff / 86400000);
            
            if (minutos < 1) return 'Justo ahora';
            if (minutos < 60) return `Hace ${minutos} min`;
            if (horas < 24) return `Hace ${horas} hora${horas > 1 ? 's' : ''}`;
            if (dias < 7) return `Hace ${dias} día${dias > 1 ? 's' : ''}`;
            return fecha.toLocaleDateString('es-PE');
        }
        
        // Toggle del dropdown de notificaciones
        function toggleNotificationDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }
        
        // Ir a solicitudes desde el dropdown (cerrar y navegar)
        function irASolicitudesDesdeDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) dropdown.classList.remove('show');
            irASolicitudes();
        }
        
        // Ir a una solicitud específica desde el dropdown
        function irASolicitudDesdeDropdown(solicitudId) {
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            // Navegar a la sección de solicitudes
            showSection('admin');
            setTimeout(() => {
                showAdminTab('solicitudes');
                // Después de cargar, mostrar detalles
                setTimeout(() => {
                    verDetallesSolicitud(solicitudId);
                }, 300);
            }, 100);
        }
        
        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notificationDropdown');
            const bell = document.getElementById('notificationBell');
            if (dropdown && bell && !bell.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Animación periódica de la campanita (cada 30 segundos)
        let bellAnimationInterval = null;
        
        function iniciarAnimacionCampanita() {
            // Limpiar intervalo anterior si existe
            if (bellAnimationInterval) {
                clearInterval(bellAnimationInterval);
            }
            
            // Animar cada 30 segundos si hay notificaciones
            bellAnimationInterval = setInterval(() => {
                const bellBadge = document.getElementById('bellBadge');
                const notificationBell = document.getElementById('notificationBell');
                
                if (bellBadge && notificationBell && bellBadge.style.display !== 'none') {
                    // Agregar clase de animación
                    notificationBell.classList.add('bell-animate');
                    
                    // Quitar después de la animación
                    setTimeout(() => {
                        notificationBell.classList.remove('bell-animate');
                    }, 700);
                }
            }, 30000); // Cada 30 segundos
        }
        
        // Función para ir a la sección de solicitudes
        function irASolicitudes() {
            showSection('admin');
            setTimeout(() => {
                showAdminTab('solicitudes');
            }, 100);
        }

        // ===== SISTEMA DE SOPORTE Y AYUDA =====
        let mensajesSoporte = [];
        let messageAnimationInterval = null;
        let realtimeSubscription = null;
        const tituloOriginal = 'Agenda Virtual ATA - I.E. 80002 Antonio Torres Araujo';
        let notificacionesUsuario = []; // Para usuarios no-admin
        let audioContextReady = false;
        let audioContext = null;
        let userHasInteracted = false;
        
        // ===== SISTEMA DE SONIDO DING - MEJORADO PARA MÓVILES =====
        // Detectar interacción del usuario (requerido por navegadores móviles)
        function marcarInteraccionUsuario() {
            if (!userHasInteracted) {
                userHasInteracted = true;
                console.log('👆 Usuario ha interactuado - sonido habilitado');
                initAudioContext();
            }
        }
        
        // Inicializar AudioContext al primer click/touch
        function initAudioContext() {
            if (audioContextReady && audioContext) return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                // Crear y tocar un nodo silencioso para "desbloquear" el audio
                const silentBuffer = audioContext.createBuffer(1, 1, 22050);
                const source = audioContext.createBufferSource();
                source.buffer = silentBuffer;
                source.connect(audioContext.destination);
                source.start();
                audioContextReady = true;
                console.log('🔊 AudioContext inicializado y desbloqueado');
            } catch(e) {
                console.log('Error creando AudioContext:', e);
            }
        }
        
        // Eventos de interacción - requerido por navegadores móviles
        ['click', 'touchstart', 'touchend', 'keydown', 'mousedown'].forEach(evt => {
            document.addEventListener(evt, () => {
                marcarInteraccionUsuario();
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log('🔊 AudioContext resumed');
                    });
                }
            }, { passive: true, once: false });
        });
        
        // ===== FUNCIÓN PARA REPRODUCIR DING - MEJORADA CON FALLBACK =====
        // Sonido DING en Base64 (muy corto, tipo campana)
        const DING_SOUND_BASE64 = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH2Onp+dmIyAdnd4hpGbop2WjH52cHN9ipafopmPg3ZtcHiEkpqgm5GGfXJvd4OQmp+amY2Bf3V0eoaSmJ2blYuCfHd4f4qVm5qWkIZ+eXl+iZSamp2XjYN9eXp/iZOYmpiTioB7eHuBi5WZmpeSiIB6eHyDjJaYl5KMhH56e4GHkZaXlZGJgXx5fIKKkpWWk46HgHt5fYSMkpSUkYyFf3p6foaOkpOSkYuEfnt6gIePkpKQjoiCfXt7gYiPkZCPjIaDfnt7goqPkI+NioSAe3t9hYuOjo2LhoJ+e3uAh4yNjIuIhIF9e3yDiYuLioiFgn58fIGGiouKiYaCf3x8gYaJioqIhYJ/fHyChomJiIeFgn99fIKGiImIh4WCf318goaIiIeGhIJ/fX2DhoeHhoWDgX59fYOFhoeGhYOBf359g4WGhoWEg4F/fn6DhYaFhYSDgX9+foOFhYWEhIOBf35+g4WFhYSEgoB/fn6DhIWEhISCgH9+foOEhISEg4KAf35+g4SEhIODgoB/fn+DhISEg4OCgH9+f4OEhIODgoGAf39/g4ODg4OCgYB/f3+Dg4ODgoKBgH9/f4ODg4OCgoGAf3+Ag4ODg4KCgYB/f4CDg4OCgoKBgH9/gIODgoKCgoGAf3+Ag4KCgoKCgYB/gICDgoKCgoKBgH+AgIOCgoKCgoGAgICAgYKCgoKCgYCAgICBgoKCgoKBgICAgIGCgoKCgoGAgICAgYKCgoKCgYCAgICBgoKCgoGBgICAgIGCgoKCgYGAgICAgYKCgoKBgYCAgICBgoKCgoGBgICAgIGCgoKBgYGAgICAgYKCgoGBgYCAgICBgoKCgYGBgICAgIGCgoKBgYGAgICAgYKCgYGBgYCAgICBgoKBgYGBgICAgIGCgoGBgYGAgICAgYKCgYGBgYCAgICBgoGBgYGBgICAgIGCgYGBgYGAgICAgYKBgYGBgYCAgICBgoGBgYGBgICAgIGBgYGBgYGAgICAgYGBgYGBgYCAgICBgYGBgYGBgICAgIGBgYGBgYGAgICAgYGBgYGBgYCAgICBgYGBgYGBgICAgIGBgYGBgYCAgICAgYGBgYGBgICAgICBgYGBgYGAgICAgIGBgYGBgYCAgICAgYGBgYGAgICAgICBgYGBgYCAgICAgIGBgYGBgICAgICAgYGBgYCAgICAgICBgYGBgICAgICAgIGBgYCAgICAgICBgYGBgICAgICAgIGBgYCAgICAgICAgYGAgICAgICAgIGBgICAgICAgICBgYCAgICAgICAgYGAgICAgICAgIGAgICAgICAgICBgICAgICAgICBgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA';
        
        // Audio element como fallback
        let dingAudio = null;
        
        function crearDingAudio() {
            if (!dingAudio) {
                dingAudio = new Audio(DING_SOUND_BASE64);
                dingAudio.volume = 0.7;
                // Pre-cargar
                dingAudio.load();
            }
            return dingAudio;
        }
        
        function reproducirSonidoNotificacion() {
            console.log('🔔 === INTENTANDO REPRODUCIR DING ===');
            
            let sonidoReproducido = false;
            
            // MÉTODO 1: Crear Audio HTML5 NUEVO cada vez (más agresivo)
            try {
                const audioNuevo = new Audio(DING_SOUND_BASE64);
                audioNuevo.volume = 1.0; // Volumen máximo
                audioNuevo.play().then(() => {
                    console.log('🔔✅ DING reproducido con Audio HTML5 NUEVO!');
                    sonidoReproducido = true;
                }).catch(e => {
                    console.log('🔔⚠️ Audio nuevo bloqueado:', e.message);
                });
            } catch(e) {
                console.log('🔔 Audio nuevo falló:', e);
            }
            
            // MÉTODO 2: Audio HTML5 cacheado como respaldo
            try {
                const audio = crearDingAudio();
                audio.currentTime = 0;
                audio.volume = 1.0;
                const playPromise = audio.play();
                if (playPromise) {
                    playPromise.then(() => {
                        console.log('🔔✅ DING reproducido con Audio HTML5 cacheado!');
                        sonidoReproducido = true;
                    }).catch(e => {
                        console.log('🔔⚠️ Audio HTML5 cacheado bloqueado:', e.message);
                    });
                }
            } catch(e) {
                console.log('🔔 Audio HTML5 cacheado falló:', e);
            }
            
            // MÉTODO 3: AudioContext con osciladores (sonido sintético)
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // Intentar resumir siempre
                const intentarReproducir = () => {
                    if (audioContext.state === 'running') {
                        const ctx = audioContext;
                        const now = ctx.currentTime;
                        
                        // DING tipo campana - acordes mayores
                        const frequencies = [880, 1108.73, 1318.51]; // A5, C#6, E6
                        
                        frequencies.forEach((freq, i) => {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            
                            osc.type = 'sine';
                            osc.frequency.value = freq;
                            
                            const startTime = now + (i * 0.02);
                            gain.gain.setValueAtTime(0, startTime);
                            gain.gain.linearRampToValueAtTime(0.8, startTime + 0.01);
                            gain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.0);
                            
                            osc.start(startTime);
                            osc.stop(startTime + 1.2);
                        });
                        
                        console.log('🔔✅ DING AudioContext reproducido!');
                        sonidoReproducido = true;
                    }
                };
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(intentarReproducir);
                } else {
                    intentarReproducir();
                }
            } catch(e) {
                console.log('🔔 AudioContext falló:', e);
            }
            
            // MÉTODO 4: Vibración en móvil (siempre intentar)
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 300]);
                console.log('📳 Vibración activada');
            }
            
            return sonidoReproducido;
        }
        
        // Pedir permiso de notificaciones al cargar
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                console.log('📢 Permiso de notificaciones:', permission);
            });
        }
        
        // ===== PRUEBA DE SONIDO (llamar desde consola: probarSonido()) =====
        window.probarSonido = function() {
            console.log('🔊 Probando sonido manualmente...');
            marcarInteraccionUsuario();
            reproducirSonidoNotificacion();
            return 'Sonido enviado - revisa si escuchaste el DING';
        };
        
        // =====================================================
        // ===== WEB PUSH NOTIFICATIONS - PWA =====
        // =====================================================
        
        // Clave pública VAPID (generada para @negrel/webpush)
        const VAPID_PUBLIC_KEY = 'BGL5muzqqmNCsT3D-CMOi1H7CrxBeqfSa3AqV5ruFjKadZJO9BlcdyNrcMeGomBMVC64DvCUDAT4ApWM5i1qETY';
        
        let swRegistration = null;
        let pushSubscription = null;
        
        // Convertir clave VAPID de base64 a Uint8Array
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        // Registrar Service Worker
        async function registrarServiceWorker() {
            if (!('serviceWorker' in navigator)) {
                console.log('❌ Service Worker no soportado');
                return null;
            }
            
            try {
                const registration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/'
                });
                
                console.log('✅ Service Worker registrado:', registration.scope);
                swRegistration = registration;
                
                // Escuchar mensajes del Service Worker (para reproducir DING)
                navigator.serviceWorker.addEventListener('message', (event) => {
                    console.log('📩 Mensaje del SW:', event.data);
                    if (event.data && event.data.type === 'PUSH_RECEIVED' && event.data.playSound) {
                        console.log('🔔 Push recibido - reproduciendo DING');
                        reproducirSonidoNotificacion();
                        // También mostrar toast visual
                        if (typeof mostrarNotificacionVisual === 'function') {
                            mostrarNotificacionVisual(event.data.title, event.data.body);
                        }
                    }
                });
                
                // Esperar a que el SW esté activo
                if (registration.installing) {
                    console.log('⏳ Service Worker instalándose...');
                } else if (registration.waiting) {
                    console.log('⏳ Service Worker esperando...');
                } else if (registration.active) {
                    console.log('✅ Service Worker activo');
                }
                
                return registration;
            } catch (error) {
                console.error('❌ Error registrando Service Worker:', error);
                return null;
            }
        }
        
        // Suscribir a notificaciones push
        async function suscribirAPush() {
            if (!swRegistration) {
                console.log('❌ No hay Service Worker registrado');
                return null;
            }
            
            try {
                // Verificar permiso de notificaciones
                const permission = await Notification.requestPermission();
                
                if (permission !== 'granted') {
                    console.log('❌ Permiso de notificaciones denegado');
                    return null;
                }
                
                console.log('✅ Permiso de notificaciones concedido');
                
                // Verificar si ya hay suscripción
                let subscription = await swRegistration.pushManager.getSubscription();
                
                if (subscription) {
                    console.log('📱 Ya existe suscripción push');
                    pushSubscription = subscription;
                    await guardarSuscripcionEnBD(subscription);
                    return subscription;
                }
                
                // Crear nueva suscripción
                subscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                console.log('🔔 Nueva suscripción push creada');
                pushSubscription = subscription;
                
                // Guardar en BD
                await guardarSuscripcionEnBD(subscription);
                
                return subscription;
                
            } catch (error) {
                console.error('❌ Error suscribiendo a push:', error);
                return null;
            }
        }
        
        // Guardar suscripción en Supabase
        async function guardarSuscripcionEnBD(subscription) {
            if (!currentUser || !subscription) return;
            
            try {
                const subscriptionJson = subscription.toJSON();
                debugLog('📤 Guardando suscripción push...', 'info');
                
                const { data, error } = await supabase
                    .from('push_subscriptions')
                    .upsert({
                        user_id: currentUser.id,
                        endpoint: subscriptionJson.endpoint,
                        p256dh: subscriptionJson.keys.p256dh,
                        auth: subscriptionJson.keys.auth,
                        user_agent: navigator.userAgent,
                        activa: true,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'user_id,endpoint'
                    });
                
                if (error) {
                    debugLog(`❌ Error guardando suscripción: ${error.message}`, 'error');
                } else {
                    debugLog('✅ Push subscription guardada!', 'success');
                }
            } catch (error) {
                debugLog(`❌ Error: ${error.message}`, 'error');
            }
        }
        
        // Cancelar suscripción
        async function cancelarSuscripcionPush() {
            if (!pushSubscription) return;
            
            try {
                await pushSubscription.unsubscribe();
                
                // Desactivar en BD
                if (currentUser) {
                    await supabase
                        .from('push_subscriptions')
                        .update({ activa: false })
                        .eq('user_id', currentUser.id)
                        .eq('endpoint', pushSubscription.endpoint);
                }
                
                pushSubscription = null;
                console.log('🔕 Suscripción push cancelada');
            } catch (error) {
                console.error('❌ Error cancelando suscripción:', error);
            }
        }
        
        // Verificar estado de suscripción
        async function verificarEstadoPush() {
            if (!swRegistration) return { soportado: false };
            
            try {
                const subscription = await swRegistration.pushManager.getSubscription();
                return {
                    soportado: true,
                    permiso: Notification.permission,
                    suscrito: !!subscription
                };
            } catch (error) {
                return { soportado: false, error: error.message };
            }
        }
        
        // Inicializar Push al cargar (después del login)
        async function inicializarWebPush() {
            debugLog('🚀 Inicializando Web Push...', 'info');
            
            // 1. Registrar Service Worker
            const sw = await registrarServiceWorker();
            if (sw) {
                debugLog('✅ Service Worker OK', 'success');
            } else {
                debugLog('❌ Service Worker falló', 'error');
            }
            
            // 2. Si hay usuario logueado, intentar suscribir
            if (currentUser) {
                debugLog(`Permiso actual: ${Notification.permission}`, 'info');
                
                // Solo preguntar si no ha denegado antes
                if (Notification.permission === 'default') {
                    // Mostrar mensaje explicativo antes de pedir permiso
                    setTimeout(async () => {
                        const sub = await suscribirAPush();
                        if (sub) {
                            debugLog('🔔 Suscripción push activa!', 'success');
                        }
                    }, 3000); // Esperar 3 segundos después del login
                } else if (Notification.permission === 'granted') {
                    const sub = await suscribirAPush();
                    if (sub) {
                        debugLog('🔔 Suscripción push activa!', 'success');
                    }
                } else {
                    debugLog('⚠️ Notificaciones bloqueadas', 'warning');
                }
            }
        }
        
        // Función de prueba para enviar push local (solo para testing)
        window.probarPush = async function() {
            if (!swRegistration) {
                return 'Error: Service Worker no registrado. Recarga la página.';
            }
            
            if (Notification.permission !== 'granted') {
                return 'Error: Permiso de notificaciones no concedido.';
            }
            
            // Enviar notificación de prueba localmente
            swRegistration.showNotification('🧪 Prueba de Notificación', {
                body: 'Esta es una prueba de Web Push - ¡Funciona!',
                icon: '/logo-ata-192.png',
                badge: '/logo-ata-192.png',
                tag: 'test-notification',
                requireInteraction: true,
                vibrate: [200, 100, 200]
            });
            
            return '✅ Notificación de prueba enviada';
        };
        
        // Registrar SW al cargar la página
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                registrarServiceWorker();
            });
        }
        
        // Mostrar notificación visual en pantalla (toast)
        function mostrarNotificacionVisual(titulo, mensaje) {
            // Crear toast notification
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-bell" style="font-size: 24px; color: var(--color-ata-dorado);"></i>
                    <div>
                        <strong style="display: block;">${titulo}</strong>
                        <small>${mensaje}</small>
                    </div>
                </div>
            `;
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                border-left: 4px solid var(--color-ata-dorado);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                cursor: pointer;
            `;
            
            // Agregar estilos de animación si no existen
            if (!document.getElementById('toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(toast);
            
            // Cerrar al hacer clic
            toast.onclick = () => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            };
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }
        
        // ===== ACTUALIZAR TÍTULO DE LA PÁGINA CON CONTADOR =====
        function actualizarTituloPagina() {
            // Contar notificaciones no leídas (solicitudes) y mensajes de soporte
            const bellBadge = document.getElementById('bellBadge');
            const messageBadge = document.getElementById('messageBadge');
            
            let totalNotificaciones = 0;
            
            if (bellBadge && bellBadge.style.display !== 'none') {
                const countBell = parseInt(bellBadge.textContent) || 0;
                totalNotificaciones += countBell;
            }
            
            if (messageBadge && messageBadge.style.display !== 'none') {
                const countMsg = parseInt(messageBadge.textContent) || 0;
                totalNotificaciones += countMsg;
            }
            
            // Actualizar título
            if (totalNotificaciones > 0) {
                document.title = `(${totalNotificaciones}) ${tituloOriginal}`;
            } else {
                document.title = tituloOriginal;
            }
        }
        
        // ===== DEBUG VISUAL PARA MÓVILES =====
        let debugMode = false; // Desactivado - cambiar a true para depurar
        
        function debugLog(mensaje, tipo = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${mensaje}`);
            
            if (debugMode) {
                // Mostrar toast con el mensaje de debug
                const colores = {
                    'info': '#17a2b8',
                    'success': '#28a745', 
                    'error': '#dc3545',
                    'warning': '#ffc107'
                };
                
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    bottom: ${20 + (document.querySelectorAll('.debug-toast').length * 50)}px;
                    left: 10px;
                    right: 10px;
                    background: ${colores[tipo] || '#333'};
                    color: white;
                    padding: 8px 12px;
                    border-radius: 6px;
                    font-size: 11px;
                    z-index: 99999;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                    animation: slideUp 0.3s ease;
                `;
                toast.className = 'debug-toast';
                toast.innerHTML = `<strong>[${timestamp}]</strong> ${mensaje}`;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.remove(), 4000);
            }
        }
        
        // ===== SUSCRIPCIÓN EN TIEMPO REAL (SUPABASE REALTIME) - MEJORADO =====
        let canalesActivos = [];
        
        function iniciarSuscripcionesRealtime() {
            if (!currentUser) {
                debugLog('❌ No hay usuario para suscripciones', 'error');
                return;
            }
            
            const role = currentUser.role?.toLowerCase();
            const esAdmin = role === 'admin' || role === 'direccion';
            const esPadre = role === 'padre';
            
            debugLog(`🔴 Iniciando Realtime para: ${role}`, 'info');
            
            // Limpiar canales anteriores
            canalesActivos.forEach(canal => {
                try { supabase.removeChannel(canal); } catch(e) {}
            });
            canalesActivos = [];
            
            // Función auxiliar para manejar notificaciones
            const manejarNotificacion = async (titulo, descripcion, callback) => {
                debugLog(`🔔 ${titulo}: ${descripcion}`, 'success');
                
                // 1. Reproducir sonido (garantizado)
                try {
                    reproducirSonidoNotificacion();
                } catch(e) { debugLog('Error sonido: ' + e, 'error'); }
                
                // 2. Mostrar toast visual
                mostrarNotificacionVisual(titulo, descripcion);
                
                // 3. Mostrar notificación del navegador (usando Service Worker para móviles)
                if (Notification.permission === 'granted' && swRegistration) {
                    try {
                        await swRegistration.showNotification(titulo, {
                            body: descripcion,
                            icon: '/assets/images/INSIGNIA_I.E.ANTONIO_TORRES_ARAUJO.png',
                            badge: '/assets/images/INSIGNIA_I.E.ANTONIO_TORRES_ARAUJO.png',
                            vibrate: [200, 100, 200],
                            tag: 'ata-' + Date.now(),
                            requireInteraction: true,
                            data: { url: window.location.href }
                        });
                        debugLog('✅ Notificación del sistema mostrada', 'success');
                    } catch(e) {
                        debugLog('Error notificación SW: ' + e, 'warning');
                    }
                } else if (Notification.permission === 'granted') {
                    // Fallback para escritorio sin SW
                    try {
                        new Notification(titulo, { body: descripcion });
                    } catch(e) { }
                }
                
                // 4. Animar campanita
                animarCampanita();
                
                // 4. Actualizar contador
                actualizarTituloPagina();
                
                // 5. Callback adicional
                if (callback) await callback();
            };
            
            if (esAdmin) {
                // ADMIN: Recibe solicitudes de registro
                const canalSolicitudes = supabase
                    .channel('admin-solicitudes-' + Date.now())
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'solicitudes_registro' },
                        async (payload) => {
                            debugLog('📬 NUEVA SOLICITUD RECIBIDA!', 'success');
                            const solicitud = payload.new;
                            await manejarNotificacion(
                                '📋 Nueva Solicitud de Registro', 
                                `${solicitud.nombre_completo || 'Usuario'} (${solicitud.rol || 'Sin rol'}) - DNI: ${solicitud.dni || 'N/A'}`,
                                () => actualizarContadorSolicitudes()
                            );
                        }
                    )
                    .subscribe((status, err) => {
                        debugLog(`Canal solicitudes: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning');
                        if (err) debugLog(`Error: ${err}`, 'error');
                    });
                canalesActivos.push(canalSolicitudes);
                
                // ADMIN: Recibe mensajes de soporte
                const canalSoporte = supabase
                    .channel('admin-soporte-' + Date.now())
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'mensajes_soporte' },
                        async (payload) => {
                            debugLog('📨 NUEVO MENSAJE RECIBIDO!', 'success');
                            const msg = payload.new;
                            await manejarNotificacion(
                                '💬 Nuevo Mensaje de Soporte', 
                                `De: ${msg.remitente_nombre || 'Usuario'}\n"${(msg.mensaje || '').substring(0, 80)}${msg.mensaje?.length > 80 ? '...' : ''}"`,
                                async () => {
                                    await cargarMensajesSoporte();
                                    await cargarTablaSoporte();
                                    animarMensajes();
                                }
                            );
                        }
                    )
                    .subscribe((status, err) => {
                        debugLog(`Canal soporte: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning');
                    });
                canalesActivos.push(canalSoporte);
            }
            
            if (esPadre) {
                // PADRE: Recibe TODAS las nuevas incidencias y filtra por hijo
                const canalIncidencias = supabase
                    .channel('padre-incidencias-' + Date.now())
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'incidencias' },
                        async (payload) => {
                            debugLog('📋 Incidencia detectada, verificando...', 'info');
                            const incidencia = payload.new;
                            const esDeHijo = await verificarIncidenciaDeHijo(incidencia.estudiante_id);
                            if (esDeHijo) {
                                debugLog('🚨 ¡INCIDENCIA DE TU HIJO!', 'success');
                                const inc = incidencia;
                                await manejarNotificacion(
                                    '🚨 Incidencia de tu hijo/a', 
                                    `Tipo: ${inc.tipo_incidencia || 'No especificado'}\nMotivo: ${(inc.descripcion || inc.motivo || 'Sin descripción').substring(0, 100)}`,
                                    () => cargarNotificacionesUsuario()
                                );
                            } else {
                                debugLog('Incidencia no es de tu hijo', 'warning');
                            }
                        }
                    )
                    .subscribe((status, err) => {
                        debugLog(`Canal incidencias: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning');
                    });
                canalesActivos.push(canalIncidencias);
                
                // PADRE: Respuestas a mensajes de soporte
                const canalRespuestas = supabase
                    .channel('padre-respuestas-' + Date.now())
                    .on('postgres_changes',
                        { event: 'UPDATE', schema: 'public', table: 'mensajes_soporte' },
                        async (payload) => {
                            // Verificar si es para este usuario
                            if (payload.new.remitente_id === currentUser.id && payload.new.respuesta_admin) {
                                // Solo notificar si hay respuesta nueva
                                const oldResp = payload.old?.respuesta_admin || '';
                                const newResp = payload.new.respuesta_admin || '';
                                
                                if (newResp && newResp !== oldResp) {
                                    debugLog('💬 RESPUESTA DEL ADMIN!', 'success');
                                    await manejarNotificacion(
                                        '📩 Te ha respondido el Administrador', 
                                        `"${newResp.substring(0, 120)}${newResp.length > 120 ? '...' : ''}"`,
                                        () => cargarNotificacionesUsuario()
                                    );
                                }
                            }
                        }
                    )
                    .subscribe((status, err) => {
                        debugLog(`Canal respuestas-padre: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning');
                    });
                canalesActivos.push(canalRespuestas);
            }
            
            if (!esAdmin && !esPadre && role) {
                // DOCENTE/AUXILIAR/OTROS: Respuestas a sus mensajes de soporte
                const canalUsuario = supabase
                    .channel('usuario-respuestas-' + Date.now())
                    .on('postgres_changes',
                        { event: 'UPDATE', schema: 'public', table: 'mensajes_soporte' },
                        async (payload) => {
                            // Verificar si es para este usuario Y si hay respuesta (no solo leído)
                            if (payload.new.remitente_id === currentUser.id && payload.new.respuesta_admin) {
                                // Solo notificar si hay respuesta real, no cuando solo leen
                                const oldResp = payload.old?.respuesta_admin || '';
                                const newResp = payload.new.respuesta_admin || '';
                                
                                // Solo notificar si la respuesta es nueva
                                if (newResp && newResp !== oldResp) {
                                    debugLog('💬 RESPUESTA DEL ADMIN!', 'success');
                                    await manejarNotificacion(
                                        '📩 Te ha respondido el Administrador', 
                                        `"${newResp.substring(0, 120)}${newResp.length > 120 ? '...' : ''}"`,
                                        () => cargarNotificacionesUsuario()
                                    );
                                }
                            }
                        }
                    )
                    .subscribe((status, err) => {
                        debugLog(`Canal usuario: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning');
                    });
                canalesActivos.push(canalUsuario);
                
                // DOCENTE: Recibir confirmaciones de padres sobre incidencias
                const canalConfirmaciones = supabase
                    .channel('docente-confirmaciones-' + Date.now())
                    .on('postgres_changes',
                        { event: 'UPDATE', schema: 'public', table: 'incidencias' },
                        async (payload) => {
                            const inc = payload.new;
                            const oldInc = payload.old || {};
                            
                            // Verificar si es una incidencia registrada por este docente
                            if (inc.docente_id === currentUser.id || inc.registrado_por === currentUser.id) {
                                // Padre confirmó/revisó la incidencia
                                if (inc.revisado_por_padre && !oldInc.revisado_por_padre) {
                                    debugLog('✅ PADRE CONFIRMÓ INCIDENCIA!', 'success');
                                    
                                    // Obtener nombre del estudiante para el mensaje
                                    let nombreEstudiante = 'un estudiante';
                                    try {
                                        const { data: estudiante } = await supabase
                                            .from('estudiantes')
                                            .select('nombre_completo')
                                            .eq('id', inc.estudiante_id)
                                            .single();
                                        if (estudiante) nombreEstudiante = estudiante.nombre_completo;
                                    } catch(e) {}
                                    
                                    // Mensaje con o sin comentario del padre
                                    let mensaje = `Incidencia de ${nombreEstudiante} ha sido revisada`;
                                    if (inc.comentario_padre) {
                                        mensaje += `\n💬 "${inc.comentario_padre.substring(0, 80)}${inc.comentario_padre.length > 80 ? '...' : ''}"`;
                                    }
                                    
                                    await manejarNotificacion(
                                        '✅ Padre confirmó lectura',
                                        mensaje,
                                        () => {
                                            cargarNotificacionesUsuario();
                                            // Actualizar historial si está visible
                                            if (typeof renderizarHistorial === 'function') {
                                                renderizarHistorial();
                                            }
                                        }
                                    );
                                }
                            }
                        }
                    )
                    .subscribe((status, err) => {
                        debugLog(`Canal confirmaciones: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'warning');
                    });
                canalesActivos.push(canalConfirmaciones);
            }
            
            debugLog(`✅ ${canalesActivos.length} canales activos para ${role}`, 'success');
        }
        
        // Verificar si una incidencia pertenece a un hijo del padre actual
        async function verificarIncidenciaDeHijo(estudianteId) {
            if (!currentUser || currentUser.role !== 'padre') return false;
            
            try {
                const { data, error } = await supabase
                    .from('estudiantes')
                    .select('id')
                    .eq('id', estudianteId)
                    .eq('apoderado_id', currentUser.id)
                    .single();
                
                return !error && data;
            } catch (e) {
                return false;
            }
        }
        
        // Animar campanita
        function animarCampanita() {
            const bell = document.getElementById('notificationBell');
            if (bell) {
                bell.classList.add('bell-animate');
                setTimeout(() => bell.classList.remove('bell-animate'), 700);
            }
        }
        
        // Animar ícono de mensajes
        function animarMensajes() {
            const inbox = document.getElementById('messageInbox');
            if (inbox) {
                inbox.classList.add('message-animate');
                setTimeout(() => inbox.classList.remove('message-animate'), 700);
            }
        }
        
        // ===== SISTEMA DE NOTIFICACIONES PARA USUARIOS NO-ADMIN =====
        async function cargarNotificacionesUsuario() {
            if (!currentUser) return;
            
            const role = currentUser.role?.toLowerCase();
            const esAdmin = role === 'admin' || role === 'direccion';
            
            if (esAdmin) return; // Admin usa otro sistema
            
            let notificaciones = [];
            
            try {
                // 1. Mensajes de soporte con respuesta del admin
                const { data: mensajesRespondidos, error: err1 } = await supabase
                    .from('mensajes_soporte')
                    .select('*')
                    .eq('remitente_id', currentUser.id)
                    .not('respuesta_admin', 'is', null)
                    .eq('respuesta_vista', false)
                    .order('updated_at', { ascending: false });
                
                if (!err1 && mensajesRespondidos) {
                    mensajesRespondidos.forEach(msg => {
                        notificaciones.push({
                            id: msg.id,
                            tipo: 'respuesta_soporte',
                            titulo: 'Respuesta del administrador',
                            descripcion: msg.respuesta_admin?.substring(0, 60) + '...',
                            fecha: msg.updated_at,
                            icono: 'fa-comment-dots',
                            color: 'var(--color-ata-azul)'
                        });
                    });
                }
                
                // 2. Para PADRES: Incidencias de sus hijos
                if (role === 'padre') {
                    // Obtener hijos del padre
                    const { data: hijos } = await supabase
                        .from('estudiantes')
                        .select('id, nombre_completo')
                        .eq('apoderado_id', currentUser.id);
                    
                    if (hijos && hijos.length > 0) {
                        const hijosIds = hijos.map(h => h.id);
                        
                        // Obtener incidencias no vistas
                        const { data: incidencias, error: err2 } = await supabase
                            .from('incidencias')
                            .select('*, estudiante:estudiantes(nombre_completo)')
                            .in('estudiante_id', hijosIds)
                            .eq('vista_por_padre', false)
                            .order('created_at', { ascending: false })
                            .limit(20);
                        
                        if (!err2 && incidencias) {
                            incidencias.forEach(inc => {
                                const tipoColor = {
                                    'merito': 'var(--color-ata-dorado)',
                                    'leve': 'var(--color-ata-verde)',
                                    'grave': '#f39c12',
                                    'muy_grave': 'var(--color-ata-rojo)'
                                };
                                const tipoIcono = {
                                    'merito': 'fa-star',
                                    'leve': 'fa-info-circle',
                                    'grave': 'fa-exclamation-triangle',
                                    'muy_grave': 'fa-exclamation-circle'
                                };
                                
                                notificaciones.push({
                                    id: inc.id,
                                    tipo: 'incidencia',
                                    titulo: inc.tipo === 'merito' ? '⭐ Mérito registrado' : `Incidencia: ${inc.tipo}`,
                                    descripcion: `${inc.estudiante?.nombre_completo || 'Tu hijo/a'} - ${inc.descripcion?.substring(0, 50)}...`,
                                    fecha: inc.created_at,
                                    icono: tipoIcono[inc.tipo] || 'fa-bell',
                                    color: tipoColor[inc.tipo] || 'var(--color-ata-verde)',
                                    data: inc
                                });
                            });
                        }
                    }
                }
                
                // 3. Mensajes marcados como leídos (para todos)
                const { data: mensajesLeidos, error: err3 } = await supabase
                    .from('mensajes_soporte')
                    .select('*')
                    .eq('remitente_id', currentUser.id)
                    .eq('leido', true)
                    .is('respuesta_admin', null)
                    .eq('leido_notificado', false)
                    .order('updated_at', { ascending: false });
                
                if (!err3 && mensajesLeidos) {
                    mensajesLeidos.forEach(msg => {
                        notificaciones.push({
                            id: msg.id,
                            tipo: 'mensaje_leido',
                            titulo: 'Mensaje recibido',
                            descripcion: 'El administrador ha visto tu mensaje de ayuda',
                            fecha: msg.updated_at,
                            icono: 'fa-check-circle',
                            color: 'var(--color-ata-verde)'
                        });
                    });
                }
                
            } catch (error) {
                console.error('Error cargando notificaciones:', error);
            }
            
            notificacionesUsuario = notificaciones;
            actualizarUINotificacionesUsuario(notificaciones);
        }
        
        // Actualizar UI de notificaciones para usuarios
        function actualizarUINotificacionesUsuario(notificaciones) {
            const badge = document.getElementById('bellBadge');
            const lista = document.getElementById('notificationDropdownList');
            
            const count = notificaciones.length;
            
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            if (lista) {
                if (count === 0) {
                    lista.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-check-circle"></i>
                            <p>No tienes notificaciones</p>
                        </div>
                    `;
                } else {
                    lista.innerHTML = `
                        <div style="display: flex; justify-content: flex-end; padding: 5px 10px; border-bottom: 1px solid #eee; gap: 5px;">
                            <button onclick="marcarTodasNotificacionesLeidas(event)" style="background: var(--color-ata-verde); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <i class="fas fa-check-double"></i> Marcar leídas
                            </button>
                            <button onclick="vaciarNotificacionesUsuario(event)" style="background: #dc3545; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                <i class="fas fa-trash-alt"></i> Vaciar todo
                            </button>
                        </div>
                    ` + notificaciones.slice(0, 10).map(n => `
                        <div class="notification-item" style="position: relative; padding-right: 65px;">
                            <div onclick="verNotificacionUsuario('${n.id}', '${n.tipo}')" style="display: flex; cursor: pointer;">
                                <div class="notification-item-icon" style="background: ${n.color};">
                                    <i class="fas ${n.icono}"></i>
                                </div>
                                <div class="notification-item-content">
                                    <div class="notification-item-title">${n.titulo}</div>
                                    <div class="notification-item-desc">${n.descripcion}</div>
                                    <div class="notification-item-time">${calcularTiempoTranscurrido(n.fecha)}</div>
                                </div>
                            </div>
                            <!-- Botones: Leído (verde) + Cerrar (rojo) -->
                            <div style="position: absolute; top: 50%; right: 8px; transform: translateY(-50%); display: flex; gap: 4px;">
                                <button onclick="marcarNotificacionLeida(event, '${n.id}', '${n.tipo}')" title="Marcar como leída" style="background: #28a745; color: white; border: none; width: 22px; height: 22px; border-radius: 50%; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button onclick="cerrarNotificacionUsuario(event, '${n.id}', '${n.tipo}')" title="Cerrar/Eliminar" style="background: #dc3545; color: white; border: none; width: 22px; height: 22px; border-radius: 50%; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            }
            
            actualizarTituloPagina();
        }
        
        // Marcar UNA notificación como leída (botón verde check)
        async function marcarNotificacionLeida(event, id, tipo) {
            event.stopPropagation();
            
            try {
                if (tipo === 'incidencia') {
                    await supabase
                        .from('incidencias')
                        .update({ vista_por_padre: true })
                        .eq('id', id);
                } else if (tipo === 'respuesta_soporte' || tipo === 'mensaje_leido') {
                    await supabase
                        .from('mensajes_soporte')
                        .update({ respuesta_vista: true, leido_notificado: true })
                        .eq('id', id);
                }
                
                // Remover de la lista local
                notificacionesUsuario = notificacionesUsuario.filter(n => n.id !== id);
                actualizarUINotificacionesUsuario(notificacionesUsuario);
                mostrarNotificacion('Notificación marcada como leída', 'success');
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Marcar TODAS las notificaciones como leídas
        async function marcarTodasNotificacionesLeidas(event) {
            event.stopPropagation();
            
            try {
                // Marcar incidencias como vistas
                const incidenciasIds = notificacionesUsuario.filter(n => n.tipo === 'incidencia').map(n => n.id);
                if (incidenciasIds.length > 0) {
                    await supabase
                        .from('incidencias')
                        .update({ vista_por_padre: true })
                        .in('id', incidenciasIds);
                }
                
                // Marcar mensajes de soporte como vistos
                const soporteIds = notificacionesUsuario.filter(n => n.tipo === 'respuesta_soporte' || n.tipo === 'mensaje_leido').map(n => n.id);
                if (soporteIds.length > 0) {
                    await supabase
                        .from('mensajes_soporte')
                        .update({ respuesta_vista: true, leido_notificado: true })
                        .in('id', soporteIds);
                }
                
                // Limpiar lista local
                notificacionesUsuario = [];
                actualizarUINotificacionesUsuario(notificacionesUsuario);
                mostrarNotificacion('Todas marcadas como leídas', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al marcar notificaciones', 'error');
            }
        }
        
        // Cerrar una notificación de usuario (eliminar/ocultar)
        async function cerrarNotificacionUsuario(event, id, tipo) {
            event.stopPropagation();
            
            try {
                if (tipo === 'incidencia') {
                    // Marcar incidencia como vista por padre
                    await supabase
                        .from('incidencias')
                        .update({ vista_por_padre: true })
                        .eq('id', id);
                } else if (tipo === 'respuesta_soporte' || tipo === 'mensaje_leido') {
                    // Marcar respuesta como vista
                    await supabase
                        .from('mensajes_soporte')
                        .update({ respuesta_vista: true })
                        .eq('id', id);
                }
                
                // Remover de la lista local
                notificacionesUsuario = notificacionesUsuario.filter(n => n.id !== id);
                actualizarUINotificacionesUsuario(notificacionesUsuario);
                mostrarNotificacion('Notificación cerrada', 'success');
            } catch (error) {
                console.error('Error cerrando notificación:', error);
            }
        }
        
        // Vaciar todas las notificaciones de usuario
        async function vaciarNotificacionesUsuario(event) {
            event.stopPropagation();
            
            const result = await Swal.fire({
                title: '¿Vaciar notificaciones?',
                text: 'Se marcarán todas como vistas',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check"></i> Sí, vaciar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: 'var(--color-ata-verde)',
            });
            
            if (result.isConfirmed) {
                try {
                    // Marcar todas las incidencias como vistas
                    const incidenciasIds = notificacionesUsuario.filter(n => n.tipo === 'incidencia').map(n => n.id);
                    if (incidenciasIds.length > 0) {
                        await supabase
                            .from('incidencias')
                            .update({ vista_por_padre: true })
                            .in('id', incidenciasIds);
                    }
                    
                    // Marcar todos los mensajes de soporte como vistos
                    const soporteIds = notificacionesUsuario.filter(n => n.tipo === 'respuesta_soporte' || n.tipo === 'mensaje_leido').map(n => n.id);
                    if (soporteIds.length > 0) {
                        await supabase
                            .from('mensajes_soporte')
                            .update({ respuesta_vista: true })
                            .in('id', soporteIds);
                    }
                    
                    // Limpiar lista local
                    notificacionesUsuario = [];
                    actualizarUINotificacionesUsuario(notificacionesUsuario);
                    mostrarNotificacion('Todas las notificaciones han sido cerradas', 'success');
                    
                    // Cerrar dropdown
                    const dropdown = document.getElementById('notificationDropdown');
                    if (dropdown) dropdown.classList.remove('show');
                } catch (error) {
                    console.error('Error vaciando notificaciones:', error);
                    mostrarNotificacion('Error al vaciar notificaciones', 'error');
                }
            }
        }
        
        // Ver notificación de usuario
        async function verNotificacionUsuario(id, tipo) {
            // Cerrar dropdown
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            if (tipo === 'incidencia') {
                // Mostrar detalle de incidencia
                const notif = notificacionesUsuario.find(n => n.id === id && n.tipo === 'incidencia');
                if (notif && notif.data) {
                    mostrarDetalleIncidenciaPadre(notif.data);
                }
            } else if (tipo === 'respuesta_soporte') {
                // Mostrar respuesta del admin
                await mostrarRespuestaSoporte(id);
            } else if (tipo === 'mensaje_leido') {
                // Marcar como notificado
                await marcarMensajeNotificado(id);
                Swal.fire({
                    icon: 'info',
                    title: 'Mensaje visto',
                    text: 'El administrador ha revisado tu mensaje de ayuda.',
                    confirmButtonColor: 'var(--color-ata-verde)'
                });
            }
        }
        
        // Mostrar respuesta de soporte
        async function mostrarRespuestaSoporte(id) {
            try {
                const { data: msg, error } = await supabase
                    .from('mensajes_soporte')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                Swal.fire({
                    title: '<i class="fas fa-reply"></i> Respuesta del Administrador',
                    html: `
                        <div style="text-align: left;">
                            <div style="background: #f0f0f0; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                <small style="color: #666;">Tu mensaje original:</small>
                                <p style="margin: 5px 0 0 0; color: #333;">${msg.mensaje}</p>
                            </div>
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid var(--color-ata-azul);">
                                <small style="color: var(--color-ata-azul);"><i class="fas fa-user-shield"></i> Respuesta:</small>
                                <p style="margin: 8px 0 0 0; color: #333; line-height: 1.6;">${msg.respuesta_admin}</p>
                            </div>
                        </div>
                    `,
                    width: 550,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: 'var(--color-ata-verde)'
                }).then(async () => {
                    // Marcar como vista
                    await supabase
                        .from('mensajes_soporte')
                        .update({ respuesta_vista: true })
                        .eq('id', id);
                    cargarNotificacionesUsuario();
                });
                
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Marcar mensaje como notificado
        async function marcarMensajeNotificado(id) {
            try {
                await supabase
                    .from('mensajes_soporte')
                    .update({ leido_notificado: true })
                    .eq('id', id);
                cargarNotificacionesUsuario();
            } catch (e) {
                console.error('Error:', e);
            }
        }
        
        // Mostrar detalle de incidencia para padre
        function mostrarDetalleIncidenciaPadre(incidencia) {
            const tipoTexto = {
                'merito': '⭐ Mérito',
                'leve': 'Falta Leve',
                'grave': 'Falta Grave',
                'muy_grave': 'Falta Muy Grave'
            };
            
            Swal.fire({
                title: `<i class="fas fa-file-alt"></i> ${tipoTexto[incidencia.tipo] || 'Incidencia'}`,
                html: `
                    <div style="text-align: left;">
                        <div style="margin-bottom: 15px;">
                            <strong>Estudiante:</strong> ${incidencia.estudiante?.nombre_completo || 'N/A'}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Fecha:</strong> ${new Date(incidencia.fecha || incidencia.created_at).toLocaleDateString('es-PE')}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Descripción:</strong>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 5px;">
                                ${incidencia.descripcion || 'Sin descripción'}
                            </div>
                        </div>
                        ${incidencia.accion_tomada ? `
                            <div style="margin-bottom: 15px;">
                                <strong>Acción tomada:</strong>
                                <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-top: 5px;">
                                    ${incidencia.accion_tomada}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `,
                width: 550,
                showCancelButton: false,
                confirmButtonText: 'Marcar como visto',
                confirmButtonColor: 'var(--color-ata-verde)'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // Marcar incidencia como vista por padre
                    await supabase
                        .from('incidencias')
                        .update({ vista_por_padre: true })
                        .eq('id', incidencia.id);
                    
                    cargarNotificacionesUsuario();
                    mostrarNotificacion('Incidencia marcada como vista', 'success');
                }
            });
        }
        
        // Toggle del dropdown de mensajes
        function toggleMessageDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('messageDropdown');
            const notifDropdown = document.getElementById('notificationDropdown');
            
            // Cerrar el otro dropdown si está abierto
            if (notifDropdown) notifDropdown.classList.remove('show');
            
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }
        
        // Cerrar dropdown de mensajes al hacer clic fuera
        document.addEventListener('click', function(event) {
            const messageDropdown = document.getElementById('messageDropdown');
            const messageInbox = document.getElementById('messageInbox');
            if (messageDropdown && messageInbox && !messageInbox.contains(event.target)) {
                messageDropdown.classList.remove('show');
            }
        });
        
        // Cargar mensajes de soporte para admin
        async function cargarMensajesSoporte() {
            try {
                const { data, error } = await supabase
                    .from('mensajes_soporte')
                    .select('*')
                    .eq('leido', false)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                mensajesSoporte = data || [];
                actualizarContadorMensajes(mensajesSoporte.length);
                actualizarDropdownMensajes(mensajesSoporte);
            } catch (error) {
                console.error('Error cargando mensajes de soporte:', error);
            }
        }
        
        // Actualizar contador de mensajes
        function actualizarContadorMensajes(count) {
            const badge = document.getElementById('messageBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
            // Actualizar título de la página con el contador total
            actualizarTituloPagina();
        }
        
        // Actualizar dropdown con mensajes
        function actualizarDropdownMensajes(mensajes) {
            const lista = document.getElementById('messageDropdownList');
            if (!lista) return;
            
            if (mensajes.length === 0) {
                lista.innerHTML = `
                    <div class="message-empty">
                        <i class="fas fa-inbox"></i>
                        <p>No hay mensajes nuevos</p>
                    </div>
                `;
                return;
            }
            
            lista.innerHTML = `
                <div style="display: flex; justify-content: flex-end; padding: 5px 10px; border-bottom: 1px solid #eee;">
                    <button onclick="marcarTodosLeidosYVaciar(event)" style="background: var(--color-ata-verde); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 5px;">
                        <i class="fas fa-check-double"></i> Marcar todos leídos
                    </button>
                    <button onclick="vaciarTodosMensajes(event)" style="background: #dc3545; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                        <i class="fas fa-trash-alt"></i> Vaciar todo
                    </button>
                </div>
            ` + mensajes.slice(0, 10).map(msg => `
                <div class="message-item" style="position: relative; padding-right: 70px;">
                    <div onclick="verMensajeSoporte('${msg.id}')" style="cursor: pointer;">
                        <div class="message-item-header">
                            <span class="message-sender">${msg.remitente_nombre || 'Usuario'}</span>
                            <span class="message-role">${msg.remitente_role || ''}</span>
                        </div>
                        <p class="message-preview">${(msg.mensaje || '').substring(0, 50)}${(msg.mensaje || '').length > 50 ? '...' : ''}</p>
                        <span class="message-time">${calcularTiempoTranscurrido(msg.created_at)}</span>
                    </div>
                    <!-- Botones: Leído (verde) + Eliminar (rojo) -->
                    <div style="position: absolute; top: 50%; right: 8px; transform: translateY(-50%); display: flex; gap: 4px;">
                        <button onclick="marcarMensajeLeidoDropdown(event, '${msg.id}')" title="Marcar como leído" style="background: #28a745; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="eliminarMensajeSoporte(event, '${msg.id}')" title="Eliminar" style="background: #dc3545; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; font-size: 11px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Ver mensaje de soporte individual (desde dropdown)
        async function verMensajeSoporte(id) {
            const mensaje = mensajesSoporte.find(m => m.id === id);
            if (!mensaje) return;
            
            // Cerrar dropdown
            const dropdown = document.getElementById('messageDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            // Mostrar modal con detalles del mensaje Y OPCIÓN DE RESPONDER
            Swal.fire({
                title: '<i class="fas fa-envelope-open-text"></i> Mensaje de Soporte',
                html: `
                    <div style="text-align: left;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                            <div>
                                <strong style="color: var(--color-ata-verde);">${mensaje.remitente_nombre || 'Usuario'}</strong>
                                <span style="color: #6c757d; font-size: 12px; margin-left: 10px;">${mensaje.remitente_role || ''}</span>
                            </div>
                            <span style="color: #6c757d; font-size: 12px;">${new Date(mensaje.created_at).toLocaleString('es-PE')}</span>
                        </div>
                        ${mensaje.remitente_email ? `<p style="color: #6c757d; font-size: 13px; margin-bottom: 10px;"><i class="fas fa-envelope"></i> ${mensaje.remitente_email}</p>` : ''}
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; min-height: 80px; white-space: pre-wrap; line-height: 1.6; margin-bottom: 15px;">${mensaje.mensaje || ''}</div>
                        
                        <!-- TEXTAREA PARA RESPONDER -->
                        <div style="border-top: 1px solid #eee; padding-top: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057;">
                                <i class="fas fa-reply" style="margin-right: 5px;"></i>Responder al usuario:
                            </label>
                            <textarea id="respuestaDropdown" class="swal2-textarea" placeholder="Escribe tu respuesta aquí..." style="width: 100%; margin: 0; min-height: 100px; resize: vertical;"></textarea>
                        </div>
                    </div>
                `,
                width: 650,
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: '<i class="fas fa-paper-plane"></i> Enviar respuesta',
                denyButtonText: '<i class="fas fa-check"></i> Solo marcar leído',
                cancelButtonText: '<i class="fas fa-times"></i> Cerrar',
                confirmButtonColor: 'var(--color-ata-verde)',
                denyButtonColor: 'var(--color-ata-azul)',
                cancelButtonColor: '#6c757d',
                preConfirm: () => {
                    const respuesta = document.getElementById('respuestaDropdown')?.value?.trim();
                    if (!respuesta) {
                        Swal.showValidationMessage('Por favor escribe una respuesta');
                        return false;
                    }
                    return respuesta;
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // Enviar respuesta
                    await responderMensajeSoporte(id, result.value);
                } else if (result.isDenied) {
                    // Solo marcar como leído
                    await marcarMensajeLeido(id);
                }
            });
        }
        
        // Marcar mensaje como leído
        async function marcarMensajeLeido(id) {
            try {
                const { error } = await supabase
                    .from('mensajes_soporte')
                    .update({ leido: true })
                    .eq('id', id);
                
                if (error) throw error;
                
                mostrarNotificacion('Mensaje marcado como leído', 'success');
                cargarMensajesSoporte(); // Recargar lista
            } catch (error) {
                console.error('Error marcando mensaje:', error);
                mostrarNotificacion('Error al actualizar mensaje', 'error');
            }
        }
        
        // Eliminar un mensaje de soporte
        async function eliminarMensajeSoporte(event, id) {
            event.stopPropagation();
            
            const result = await Swal.fire({
                title: '¿Eliminar mensaje?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-trash"></i> Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545',
            });
            
            if (result.isConfirmed) {
                try {
                    const { error } = await supabase
                        .from('mensajes_soporte')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    mostrarNotificacion('Mensaje eliminado', 'success');
                    cargarMensajesSoporte();
                    cargarTablaSoporte();
                } catch (error) {
                    console.error('Error eliminando mensaje:', error);
                    mostrarNotificacion('Error al eliminar mensaje', 'error');
                }
            }
        }
        
        // Marcar como leído desde el dropdown (botón verde)
        async function marcarMensajeLeidoDropdown(event, id) {
            event.stopPropagation();
            try {
                const { error } = await supabase
                    .from('mensajes_soporte')
                    .update({ leido: true })
                    .eq('id', id);
                
                if (error) throw error;
                
                mostrarNotificacion('Mensaje marcado como leído', 'success');
                cargarMensajesSoporte();
                cargarTablaSoporte();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al marcar mensaje', 'error');
            }
        }
        
        // Marcar todos como leídos (botón arriba del dropdown)
        async function marcarTodosLeidosYVaciar(event) {
            event.stopPropagation();
            
            const result = await Swal.fire({
                title: '¿Marcar todos como leídos?',
                text: 'Todos los mensajes nuevos se marcarán como leídos',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-check-double"></i> Sí, marcar todos',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: 'var(--color-ata-verde)',
            });
            
            if (result.isConfirmed) {
                try {
                    const { error } = await supabase
                        .from('mensajes_soporte')
                        .update({ leido: true })
                        .eq('leido', false);
                    
                    if (error) throw error;
                    
                    mostrarNotificacion('Todos los mensajes marcados como leídos', 'success');
                    cargarMensajesSoporte();
                    cargarTablaSoporte();
                    
                    // Cerrar dropdown
                    const dropdown = document.getElementById('messageDropdown');
                    if (dropdown) dropdown.classList.remove('show');
                } catch (error) {
                    console.error('Error:', error);
                    mostrarNotificacion('Error al marcar mensajes', 'error');
                }
            }
        }
        
        // Vaciar todos los mensajes de soporte (solo admin)
        async function vaciarTodosMensajes(event) {
            event.stopPropagation();
            
            const result = await Swal.fire({
                title: '¿Vaciar todos los mensajes?',
                html: '<p style="color: #dc3545;"><strong>⚠️ ADVERTENCIA:</strong> Se eliminarán TODOS los mensajes de soporte.</p><p>Esta acción no se puede deshacer.</p>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-trash-alt"></i> Sí, vaciar todo',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545',
            });
            
            if (result.isConfirmed) {
                try {
                    // Solo eliminar los no leídos (los que aparecen en el dropdown)
                    const { error } = await supabase
                        .from('mensajes_soporte')
                        .delete()
                        .eq('leido', false);
                    
                    if (error) throw error;
                    
                    mostrarNotificacion('Todos los mensajes nuevos han sido eliminados', 'success');
                    cargarMensajesSoporte();
                    cargarTablaSoporte();
                    
                    // Cerrar dropdown
                    const dropdown = document.getElementById('messageDropdown');
                    if (dropdown) dropdown.classList.remove('show');
                } catch (error) {
                    console.error('Error vaciando mensajes:', error);
                    mostrarNotificacion('Error al vaciar mensajes', 'error');
                }
            }
        }
        
        // Eliminar mensaje desde la tabla
        async function eliminarMensajeSoporteTabla(id) {
            const result = await Swal.fire({
                title: '¿Eliminar mensaje?',
                text: 'Esta acción no se puede deshacer',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-trash"></i> Sí, eliminar',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545',
            });
            
            if (result.isConfirmed) {
                try {
                    // Mostrar loading
                    Swal.fire({
                        title: 'Eliminando...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                    
                    const { error } = await supabase
                        .from('mensajes_soporte')
                        .delete()
                        .eq('id', id);
                    
                    if (error) {
                        console.error('Error Supabase:', error);
                        throw new Error(error.message || 'Error de permisos. Ejecuta el SQL en Supabase.');
                    }
                    
                    Swal.close();
                    mostrarNotificacion('Mensaje eliminado', 'success');
                    
                    // Recargar ambas vistas
                    await cargarMensajesSoporte();
                    await cargarTablaSoporte();
                } catch (error) {
                    console.error('Error eliminando mensaje:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al eliminar',
                        html: `<p>${error.message}</p><p style="font-size: 12px; color: #666;">Asegúrate de ejecutar el SQL de permisos en Supabase.</p>`,
                        confirmButtonColor: 'var(--color-ata-verde)'
                    });
                }
            }
        }
        
        // Vaciar TODOS los mensajes de soporte (desde la tabla)
        async function vaciarTodosMensajesTabla() {
            const result = await Swal.fire({
                title: '¿Vaciar TODOS los mensajes?',
                html: `
                    <p style="color: #dc3545;"><strong>⚠️ ADVERTENCIA:</strong></p>
                    <p>Se eliminarán <strong>TODOS</strong> los mensajes de soporte (leídos y no leídos).</p>
                    <p style="font-size: 13px; color: #666;">Esta acción no se puede deshacer.</p>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-trash-alt"></i> Sí, vaciar TODO',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545',
            });
            
            if (result.isConfirmed) {
                try {
                    // Mostrar loading
                    Swal.fire({
                        title: 'Eliminando todos...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                    
                    // Eliminar TODOS los mensajes
                    const { error } = await supabase
                        .from('mensajes_soporte')
                        .delete()
                        .neq('id', '00000000-0000-0000-0000-000000000000'); // Elimina todos
                    
                    if (error) {
                        console.error('Error Supabase:', error);
                        throw new Error(error.message || 'Error de permisos. Ejecuta el SQL en Supabase.');
                    }
                    
                    Swal.close();
                    mostrarNotificacion('Todos los mensajes han sido eliminados', 'success');
                    
                    // Recargar ambas vistas
                    await cargarMensajesSoporte();
                    await cargarTablaSoporte();
                } catch (error) {
                    console.error('Error vaciando mensajes:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al vaciar',
                        html: `<p>${error.message}</p><p style="font-size: 12px; color: #666;">Asegúrate de ejecutar el SQL de permisos en Supabase.</p>`,
                        confirmButtonColor: 'var(--color-ata-verde)'
                    });
                }
            }
        }
        
        // Ir a bandeja de soporte completa
        function irABandejaSoporte(event) {
            if (event) event.stopPropagation();
            const dropdown = document.getElementById('messageDropdown');
            if (dropdown) dropdown.classList.remove('show');
            
            // Navegar a la sección de soporte en el panel admin
            showSection('admin');
            setTimeout(() => {
                showAdminTab('soporte');
            }, 100);
        }
        
        // Cargar tabla de soporte en el panel admin
        async function cargarTablaSoporte() {
            const tbody = document.getElementById('tbodySoporte');
            if (!tbody) return;
            
            try {
                const { data, error } = await supabase
                    .from('mensajes_soporte')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                const mensajes = data || [];
                
                // Actualizar badge
                const noLeidos = mensajes.filter(m => !m.leido).length;
                const badge = document.getElementById('badgeSoporte');
                if (badge) {
                    if (noLeidos > 0) {
                        badge.textContent = noLeidos;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                if (mensajes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                                <i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                                <p>No hay mensajes de soporte</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = mensajes.map(msg => `
                    <tr style="${!msg.leido ? 'background: #e3f2fd;' : ''}">
                        <td>
                            ${msg.leido 
                                ? (msg.respuesta_admin 
                                    ? '<span style="color: var(--color-ata-azul);"><i class="fas fa-reply"></i> Respondido</span>'
                                    : '<span style="color: #28a745;"><i class="fas fa-check-circle"></i> Leído</span>')
                                : '<span style="color: var(--color-ata-azul);"><i class="fas fa-circle"></i> Nuevo</span>'}
                        </td>
                        <td>
                            <strong>${msg.remitente_nombre || 'Usuario'}</strong>
                            ${msg.remitente_email ? `<br><small style="color: #666;">${msg.remitente_email}</small>` : ''}
                        </td>
                        <td><span class="badge" style="background: var(--color-ata-verde); color: white;">${msg.remitente_role || 'visitante'}</span></td>
                        <td style="max-width: 300px;">
                            <span title="${(msg.mensaje || '').replace(/"/g, '&quot;')}">${(msg.mensaje || '').substring(0, 80)}${(msg.mensaje || '').length > 80 ? '...' : ''}</span>
                            ${msg.respuesta_admin ? '<br><small style="color: var(--color-ata-azul);"><i class="fas fa-reply"></i> Con respuesta</small>' : ''}
                        </td>
                        <td><small>${new Date(msg.created_at).toLocaleString('es-PE')}</small></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="verMensajeSoporteCompleto('${msg.id}')" title="Ver mensaje">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="abrirResponderMensaje('${msg.id}')" title="Responder al usuario">
                                <i class="fas fa-reply"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="marcarMensajeLeidoYRecargar('${msg.id}')" title="Marcar como leído">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="eliminarMensajeSoporteTabla('${msg.id}')" title="Eliminar mensaje">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Error cargando mensajes:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                            <p>Error al cargar mensajes</p>
                            <small>${error.message || ''}</small>
                        </td>
                    </tr>
                `;
            }
        }
        
        // Ver mensaje completo
        function verMensajeSoporteCompleto(id) {
            const msg = mensajesSoporte.find(m => m.id === id);
            
            // Si no está en el array, buscar en la tabla
            cargarYMostrarMensaje(id);
        }
        
        async function cargarYMostrarMensaje(id) {
            try {
                const { data, error } = await supabase
                    .from('mensajes_soporte')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                const msg = data;
                const yaLeido = msg.leido;
                
                // Modal SIEMPRE muestra opción de responder
                Swal.fire({
                    title: '<i class="fas fa-envelope-open-text"></i> Mensaje de Soporte',
                    html: `
                        <div style="text-align: left;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                                <div>
                                    <strong style="color: var(--color-ata-verde);">${msg.remitente_nombre || 'Usuario'}</strong>
                                    <span style="color: #6c757d; font-size: 12px; margin-left: 10px;">${msg.remitente_role || ''}</span>
                                </div>
                                <span style="color: #6c757d; font-size: 12px;">${new Date(msg.created_at).toLocaleString('es-PE')}</span>
                            </div>
                            ${msg.remitente_email ? `<p style="color: #6c757d; font-size: 13px; margin-bottom: 10px;"><i class="fas fa-envelope"></i> ${msg.remitente_email}</p>` : ''}
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; min-height: 80px; white-space: pre-wrap; line-height: 1.6; margin-bottom: 15px;">${msg.mensaje || ''}</div>
                            
                            ${msg.respuesta_admin ? `
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid var(--color-ata-azul); margin-bottom: 15px;">
                                    <small style="color: var(--color-ata-azul);"><i class="fas fa-reply"></i> Tu respuesta anterior:</small>
                                    <p style="margin: 8px 0 0 0;">${msg.respuesta_admin}</p>
                                </div>
                            ` : ''}
                            
                            <!-- SIEMPRE mostrar textarea para responder -->
                            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057;">
                                    <i class="fas fa-reply" style="margin-right: 5px;"></i>${msg.respuesta_admin ? 'Actualizar respuesta:' : 'Responder al usuario:'}
                                </label>
                                <textarea id="respuestaAdmin" class="swal2-textarea" placeholder="Escribe tu respuesta aquí..." style="width: 100%; margin: 0; min-height: 100px; resize: vertical;">${msg.respuesta_admin || ''}</textarea>
                            </div>
                        </div>
                    `,
                    width: 650,
                    showCancelButton: true,
                    showDenyButton: !yaLeido,
                    confirmButtonText: '<i class="fas fa-paper-plane"></i> Enviar respuesta',
                    denyButtonText: '<i class="fas fa-check"></i> Solo marcar leído',
                    cancelButtonText: '<i class="fas fa-times"></i> Cerrar',
                    confirmButtonColor: 'var(--color-ata-verde)',
                    denyButtonColor: 'var(--color-ata-azul)',
                    cancelButtonColor: '#6c757d',
                    preConfirm: () => {
                        const respuesta = document.getElementById('respuestaAdmin')?.value?.trim();
                        if (!respuesta) {
                            Swal.showValidationMessage('Por favor escribe una respuesta');
                            return false;
                        }
                        return respuesta;
                    }
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        // Enviar respuesta
                        await responderMensajeSoporte(id, result.value);
                    } else if (result.isDenied) {
                        // Solo marcar como leído sin respuesta
                        await marcarMensajeLeidoYRecargar(id);
                    }
                });
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al cargar el mensaje', 'error');
            }
        }
        
        // Responder mensaje de soporte
        async function responderMensajeSoporte(id, respuesta) {
            try {
                const updateData = { 
                    leido: true,
                    respuesta_vista: false // Para que el usuario vea que hay respuesta
                };
                
                if (respuesta) {
                    updateData.respuesta_admin = respuesta;
                    updateData.updated_at = new Date().toISOString();
                }
                
                const { error } = await supabase
                    .from('mensajes_soporte')
                    .update(updateData)
                    .eq('id', id);
                
                if (error) throw error;
                
                if (respuesta) {
                    mostrarNotificacion('Mensaje respondido correctamente', 'success');
                } else {
                    mostrarNotificacion('Mensaje marcado como leído', 'success');
                }
                
                cargarTablaSoporte();
                cargarMensajesSoporte();
            } catch (error) {
                console.error('Error respondiendo mensaje:', error);
                mostrarNotificacion('Error al procesar el mensaje', 'error');
            }
        }
        
        // Marcar leído y recargar tabla
        async function marcarMensajeLeidoYRecargar(id) {
            try {
                const { error } = await supabase
                    .from('mensajes_soporte')
                    .update({ leido: true })
                    .eq('id', id);
                
                if (error) throw error;
                
                mostrarNotificacion('Mensaje marcado como leído', 'success');
                cargarTablaSoporte();
                cargarMensajesSoporte(); // Actualizar dropdown también
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al actualizar mensaje', 'error');
            }
        }
        
        // Abrir modal para responder mensaje (desde botón amarillo)
        async function abrirResponderMensaje(id) {
            try {
                const { data: msg, error } = await supabase
                    .from('mensajes_soporte')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                Swal.fire({
                    title: '<i class="fas fa-reply"></i> Responder Mensaje',
                    html: `
                        <div style="text-align: left;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid var(--color-ata-verde);">
                                <small style="color: #666;">Mensaje de <strong>${msg.remitente_nombre || 'Usuario'}</strong> (${msg.remitente_role || ''}):</small>
                                <p style="margin: 8px 0 0 0; color: #333;">${msg.mensaje || ''}</p>
                            </div>
                            
                            ${msg.respuesta_admin ? `
                                <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid var(--color-ata-azul);">
                                    <small style="color: var(--color-ata-azul);"><i class="fas fa-reply"></i> Tu respuesta anterior:</small>
                                    <p style="margin: 8px 0 0 0; color: #333;">${msg.respuesta_admin}</p>
                                </div>
                            ` : ''}
                            
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #495057;">
                                <i class="fas fa-pen"></i> ${msg.respuesta_admin ? 'Actualizar respuesta:' : 'Escribir respuesta:'}
                            </label>
                            <textarea id="respuestaAdminDirecta" class="swal2-textarea" placeholder="Escribe tu respuesta al usuario..." style="width: 100%; margin: 0; min-height: 120px; resize: vertical;">${msg.respuesta_admin || ''}</textarea>
                        </div>
                    `,
                    width: 600,
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-paper-plane"></i> Enviar respuesta',
                    cancelButtonText: '<i class="fas fa-times"></i> Cancelar',
                    confirmButtonColor: 'var(--color-ata-verde)',
                    cancelButtonColor: '#6c757d',
                    preConfirm: () => {
                        const respuesta = document.getElementById('respuestaAdminDirecta')?.value?.trim();
                        if (!respuesta) {
                            Swal.showValidationMessage('Por favor escribe una respuesta');
                            return false;
                        }
                        return respuesta;
                    }
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        await responderMensajeSoporte(id, result.value);
                    }
                });
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al cargar mensaje', 'error');
            }
        }
        
        // Mostrar bandeja de soporte completa (legacy - redirige al tab)
        async function mostrarBandejaSoporteCompleta() {
            try {
                const { data, error } = await supabase
                    .from('mensajes_soporte')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const mensajes = data || [];
                
                let htmlMensajes = '';
                if (mensajes.length === 0) {
                    htmlMensajes = '<p style="text-align: center; color: #6c757d; padding: 40px;"><i class="fas fa-inbox" style="font-size: 48px; display: block; margin-bottom: 15px;"></i>No hay mensajes de soporte</p>';
                } else {
                    htmlMensajes = mensajes.map(msg => `
                        <div style="background: ${msg.leido ? '#f8f9fa' : '#fff'}; border: 1px solid ${msg.leido ? '#e9ecef' : 'var(--color-ata-verde)'}; border-radius: 8px; padding: 15px; margin-bottom: 10px; ${!msg.leido ? 'border-left: 4px solid var(--color-ata-verde);' : ''}">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: ${msg.leido ? '#495057' : 'var(--color-ata-verde)'};">${msg.remitente_nombre || 'Usuario'}</strong>
                                    <span style="color: #6c757d; font-size: 12px; margin-left: 10px;">${msg.remitente_role || ''}</span>
                                    ${!msg.leido ? '<span style="background: var(--color-ata-verde); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 10px;">Nuevo</span>' : ''}
                                </div>
                                <span style="color: #6c757d; font-size: 12px;">${new Date(msg.created_at).toLocaleString('es-PE')}</span>
                            </div>
                            <p style="margin: 0; color: #495057; font-size: 14px;">${(msg.mensaje || '').substring(0, 150)}${(msg.mensaje || '').length > 150 ? '...' : ''}</p>
                            <div style="margin-top: 10px; text-align: right;">
                                ${!msg.leido ? `<button onclick="marcarMensajeLeido('${msg.id}'); Swal.close(); setTimeout(mostrarBandejaSoporteCompleta, 300);" style="background: var(--color-ata-verde); color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;"><i class="fas fa-check"></i> Marcar leído</button>` : '<span style="color: #6c757d; font-size: 12px;"><i class="fas fa-check-double"></i> Leído</span>'}
                            </div>
                        </div>
                    `).join('');
                }
                
                Swal.fire({
                    title: '<i class="fas fa-headset"></i> Bandeja de Soporte',
                    html: `
                        <div style="max-height: 500px; overflow-y: auto; text-align: left;">
                            ${htmlMensajes}
                        </div>
                    `,
                    width: 700,
                    showConfirmButton: false,
                    showCloseButton: true,
                });
            } catch (error) {
                console.error('Error cargando bandeja:', error);
                mostrarNotificacion('Error al cargar bandeja de soporte', 'error');
            }
        }
        
        // Animación periódica del ícono de mensajes (cada 30 segundos)
        function iniciarAnimacionMensajes() {
            if (messageAnimationInterval) {
                clearInterval(messageAnimationInterval);
            }
            
            messageAnimationInterval = setInterval(() => {
                const messageBadge = document.getElementById('messageBadge');
                const messageInbox = document.getElementById('messageInbox');
                
                if (messageBadge && messageInbox && messageBadge.style.display !== 'none') {
                    messageInbox.classList.add('message-animate');
                    
                    setTimeout(() => {
                        messageInbox.classList.remove('message-animate');
                    }, 700);
                }
            }, 35000); // Cada 35 segundos (diferente de la campanita)
        }
        
        // ===== FORMULARIO DE SOPORTE (Para todos los usuarios) =====
        function mostrarFormularioSoporte() {
            // Detectar automáticamente los datos del usuario si está logueado
            const estaLogueado = currentUser && currentUser.id;
            
            let nombreUsuario = '';
            let emailUsuario = '';
            let roleUsuario = '';
            let aulasUsuario = '';
            let dniUsuario = '';
            
            if (estaLogueado) {
                nombreUsuario = currentUser.nombre || currentUser.name || currentUser.nombre_completo || '';
                emailUsuario = currentUser.email || '';
                roleUsuario = currentUser.role || '';
                dniUsuario = currentUser.dni || '';
                
                // Formatear aulas asignadas
                if (currentUser.aulas_asignadas) {
                    if (Array.isArray(currentUser.aulas_asignadas)) {
                        aulasUsuario = currentUser.aulas_asignadas.join(', ');
                    } else {
                        aulasUsuario = currentUser.aulas_asignadas;
                    }
                }
            }
            
            // Formatear nombre del rol para mostrar
            const rolesFormato = {
                'admin': 'Administrador',
                'direccion': 'Dirección',
                'docente': 'Docente',
                'auxiliar': 'Auxiliar',
                'padre': 'Padre/Apoderado',
                'estudiante': 'Estudiante'
            };
            const roleMostrar = rolesFormato[roleUsuario?.toLowerCase()] || roleUsuario || 'Visitante';
            
            Swal.fire({
                title: '<i class="fas fa-headset" style="color: var(--color-ata-verde);"></i> ¿Necesitas Ayuda?',
                html: `
                    <div style="text-align: left;">
                        <p style="color: #6c757d; margin-bottom: 20px;">
                            ${estaLogueado 
                                ? 'Tus datos fueron detectados automáticamente. Escribe tu mensaje y te responderemos pronto.' 
                                : 'Envíanos tu consulta y te responderemos lo antes posible.'}
                        </p>
                        
                        ${estaLogueado ? `
                            <!-- Usuario logueado: mostrar datos de solo lectura -->
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid var(--color-ata-verde);">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <i class="fas fa-user-check" style="color: var(--color-ata-verde);"></i>
                                    <strong style="color: var(--color-ata-verde);">${nombreUsuario}</strong>
                                </div>
                                <div style="font-size: 13px; color: #555; margin-left: 24px;">
                                    <div><i class="fas fa-id-badge" style="width: 16px; margin-right: 5px;"></i> <strong>Rol:</strong> ${roleMostrar}</div>
                                    ${dniUsuario ? `<div><i class="fas fa-address-card" style="width: 16px; margin-right: 5px;"></i> <strong>DNI:</strong> ${dniUsuario}</div>` : ''}
                                    <div><i class="fas fa-envelope" style="width: 16px; margin-right: 5px;"></i> <strong>Email:</strong> ${emailUsuario}</div>
                                    ${aulasUsuario ? `<div><i class="fas fa-chalkboard" style="width: 16px; margin-right: 5px;"></i> <strong>Aula(s):</strong> ${aulasUsuario}</div>` : ''}
                                </div>
                            </div>
                        ` : `
                            <!-- Usuario no logueado: mostrar campos editables -->
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">Tu nombre:</label>
                                <input type="text" id="soporteNombre" class="swal2-input" placeholder="Tu nombre completo" style="width: 100%; margin: 0;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">Correo electrónico:</label>
                                <input type="email" id="soporteEmail" class="swal2-input" placeholder="correo@ejemplo.com" style="width: 100%; margin: 0;">
                            </div>
                        `}
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #495057;">
                                <i class="fas fa-comment-alt" style="margin-right: 5px;"></i>Tu mensaje:
                            </label>
                            <textarea id="soporteMensaje" class="swal2-textarea" placeholder="Describe tu consulta, problema o sugerencia..." style="width: 100%; margin: 0; min-height: 120px;"></textarea>
                        </div>
                    </div>
                `,
                width: 520,
                showCancelButton: true,
                confirmButtonText: '<i class="fas fa-paper-plane"></i> Enviar mensaje',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: 'var(--color-ata-verde)',
                preConfirm: () => {
                    let nombre, email;
                    
                    if (estaLogueado) {
                        // Usuario logueado: usar datos detectados
                        nombre = nombreUsuario;
                        email = emailUsuario;
                    } else {
                        // Usuario no logueado: obtener de campos
                        nombre = document.getElementById('soporteNombre')?.value.trim() || '';
                        email = document.getElementById('soporteEmail')?.value.trim() || '';
                        
                        if (!nombre) {
                            Swal.showValidationMessage('Por favor ingresa tu nombre');
                            return false;
                        }
                        if (!email) {
                            Swal.showValidationMessage('Por favor ingresa tu correo');
                            return false;
                        }
                    }
                    
                    const mensaje = document.getElementById('soporteMensaje').value.trim();
                    
                    if (!mensaje) {
                        Swal.showValidationMessage('Por favor escribe tu mensaje');
                        return false;
                    }
                    if (mensaje.length < 10) {
                        Swal.showValidationMessage('El mensaje debe tener al menos 10 caracteres');
                        return false;
                    }
                    
                    return { 
                        nombre, 
                        email, 
                        mensaje, 
                        role: roleUsuario || 'visitante',
                        aulas: aulasUsuario,
                        dni: dniUsuario
                    };
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await enviarMensajeSoporte(result.value);
                }
            });
        }
        
        // Enviar mensaje de soporte a la base de datos
        async function enviarMensajeSoporte(datos) {
            try {
                Swal.fire({
                    title: 'Enviando mensaje...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                
                const { error } = await supabase
                    .from('mensajes_soporte')
                    .insert([{
                        remitente_id: currentUser?.id || null,
                        remitente_nombre: datos.nombre,
                        remitente_email: datos.email,
                        remitente_role: datos.role || 'visitante',
                        mensaje: datos.mensaje,
                        leido: false
                    }]);
                
                if (error) throw error;
                
                Swal.fire({
                    icon: 'success',
                    title: '¡Mensaje enviado!',
                    html: `
                        <p style="color: #6c757d;">Tu mensaje ha sido recibido correctamente.</p>
                        <p style="color: #6c757d; font-size: 14px; margin-top: 10px;">Te responderemos pronto a <strong>${datos.email}</strong></p>
                    `,
                    confirmButtonColor: 'var(--color-ata-verde)'
                });
                
            } catch (error) {
                console.error('Error enviando mensaje:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo enviar el mensaje. Inténtalo nuevamente.',
                    confirmButtonColor: 'var(--color-ata-verde)'
                });
            }
        }
        
        // ===== GESTIÓN DE INCIDENCIAS =====
        async function cargarIncidenciasAdmin() {
            try {
                const { data, error } = await supabase
                    .from('incidencias')
                    .select(`
                        *,
                        estudiante:estudiantes(nombre_completo, grado, seccion),
                        registrado_por:users(nombre_completo)
                    `)
                    .order('fecha', { ascending: false });
                
                if (error) throw error;
                
                incidenciasAdmin = data || [];
                renderizarTablaIncidencias(incidenciasAdmin);
            } catch (error) {
                console.error('Error cargando incidencias:', error);
                mostrarNotificacion('Error al cargar incidencias', 'error');
            }
        }
        
        function renderizarTablaIncidencias(incidencias) {
            const tbody = document.getElementById('tbodyIncidenciasAdmin');
            if (!tbody) return;
            
            if (!incidencias || incidencias.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i class="fas fa-clipboard"></i><p>No hay incidencias registradas</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = incidencias.map(inc => `
                <tr>
                    <td>${new Date(inc.fecha).toLocaleDateString()}</td>
                    <td>${inc.estudiante?.nombre_completo || 'Desconocido'}</td>
                    <td>${inc.estudiante?.grado || '-'}°${inc.estudiante?.seccion || '-'}</td>
                    <td>
                        <span class="badge badge-${inc.tipo === 'merito' ? 'success' : 'warning'}">
                            ${inc.tipo === 'merito' ? 'Mérito' : 'Demérito'}
                        </span>
                    </td>
                    <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${inc.descripcion || '-'}</td>
                    <td>${inc.registrado_por?.nombre_completo || 'Sistema'}</td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-info btn-xs" onclick="verDetalleIncidenciaAdmin('${inc.id}')" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-danger btn-xs" onclick="eliminarIncidencia('${inc.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function filtrarIncidenciasAdmin() {
            const filtroBuscar = document.getElementById('filtroIncidenciaBuscar')?.value.toLowerCase() || '';
            const filtroTipo = document.getElementById('filtroIncidenciaTipo')?.value || '';
            const filtroGrado = document.getElementById('filtroIncidenciaGrado')?.value || '';
            
            const incidenciasFiltradas = incidenciasAdmin.filter(inc => {
                const coincideBuscar = !filtroBuscar || 
                    (inc.estudiante?.nombre_completo?.toLowerCase().includes(filtroBuscar));
                const coincideTipo = !filtroTipo || inc.tipo === filtroTipo;
                const coincideGrado = !filtroGrado || inc.estudiante?.grado === filtroGrado;
                
                return coincideBuscar && coincideTipo && coincideGrado;
            });
            
            renderizarTablaIncidencias(incidenciasFiltradas);
        }
        
        async function eliminarIncidencia(incidenciaId) {
            const confirmar = await mostrarConfirmacion(
                '¿Está seguro de eliminar esta incidencia?<br><br><strong style="color:#e74c3c">Esta acción NO se puede deshacer.</strong>',
                '⚠️ Eliminar Incidencia',
                { tipo: 'warning', btnConfirmar: 'Eliminar', peligroso: true }
            );
            if (!confirmar) return;
            
            try {
                const { error } = await supabase
                    .from('incidencias')
                    .delete()
                    .eq('id', incidenciaId);
                
                if (error) throw error;
                
                mostrarNotificacion('Incidencia eliminada correctamente', 'success');
                cargarIncidenciasAdmin();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar incidencia', 'error');
            }
        }
        
        function verDetalleIncidenciaAdmin(incidenciaId) {
            const inc = incidenciasAdmin.find(i => i.id === incidenciaId);
            if (!inc) return;
            
            const esMerito = inc.tipo === 'merito';
            const fecha = new Date(inc.fecha).toLocaleDateString('es-PE', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            
            // Determinar severidad
            let severidadHTML = '';
            if (!esMerito && inc.severidad) {
                const sevClass = inc.severidad === 'leve' ? 'badge-success' 
                    : inc.severidad === 'grave' ? 'badge-warning' : 'badge-danger';
                const sevText = inc.severidad === 'leve' ? 'Leve' 
                    : inc.severidad === 'grave' ? 'Grave' : 'Muy Grave';
                severidadHTML = `<span class="badge ${sevClass}">${sevText}</span>`;
            }
            
            // Sección de estado de lectura del padre/apoderado
            let estadoLecturaPadreHTML = '';
            if (inc.revisado_por_padre) {
                const fechaRevision = inc.fecha_revision_padre ? new Date(inc.fecha_revision_padre).toLocaleString('es-PE') : 'Fecha no registrada';
                estadoLecturaPadreHTML = `
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border-left: 4px solid #4caf50; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-check-double" style="font-size: 24px; color: #4caf50;"></i>
                            <h4 style="color: #2e7d32; margin: 0;">✅ Padre/Apoderado ha revisado</h4>
                        </div>
                        <p style="color: #666; font-size: 13px; margin: 0 0 10px;">
                            <i class="fas fa-clock"></i> Revisado el: <strong>${fechaRevision}</strong>
                        </p>
                        ${inc.comentario_padre ? `
                            <div style="background: white; padding: 12px; border-radius: 8px; margin-top: 10px;">
                                <p style="color: #666; margin: 0 0 5px; font-size: 12px;">
                                    <i class="fas fa-comment"></i> COMENTARIO DEL PADRE/APODERADO:
                                </p>
                                <p style="margin: 0; color: #333; line-height: 1.5;">${inc.comentario_padre.replace(/\n/g, '<br>')}</p>
                            </div>
                        ` : '<p style="color: #666; font-size: 13px; margin: 0; font-style: italic;">Sin comentarios adicionales</p>'}
                    </div>
                `;
            } else {
                estadoLecturaPadreHTML = `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-clock" style="font-size: 20px; color: #856404;"></i>
                            <div>
                                <h4 style="color: #856404; margin: 0;">⏳ Pendiente de revisión</h4>
                                <p style="color: #856404; font-size: 13px; margin: 5px 0 0;">El padre/apoderado aún no ha confirmado la lectura de esta incidencia</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            const modalHTML = `
                <div class="modal-overlay" id="modalDetalleIncAdmin" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 650px;">
                        <div class="modal-header" style="background: ${esMerito ? 'linear-gradient(135deg, #1976d2, #42a5f5)' : 'linear-gradient(135deg, #c1272d, #e53935)'};">
                            <h3 style="color: white; margin: 0;">
                                <i class="fas ${esMerito ? 'fa-trophy' : 'fa-exclamation-triangle'}"></i> 
                                ${esMerito ? 'Mérito' : 'Demérito'} - Detalle
                            </h3>
                            <button class="btn-close" onclick="document.getElementById('modalDetalleIncAdmin').remove()" style="color: white; font-size: 24px;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 25px; max-height: 70vh; overflow-y: auto;">
                            <!-- Información del Estudiante -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px; color: var(--color-ata-verde);">
                                    <i class="fas fa-user-graduate"></i> Estudiante
                                </h4>
                                <p style="margin: 5px 0; font-size: 16px;"><strong>${inc.estudiante?.nombre_completo || 'Desconocido'}</strong></p>
                                <p style="margin: 5px 0; color: #666;">
                                    <i class="fas fa-school"></i> ${inc.estudiante?.grado || '-'}° ${inc.estudiante?.seccion || '-'}
                                    ${inc.estudiante?.dni ? ` &nbsp;|&nbsp; <i class="fas fa-id-card"></i> DNI: ${inc.estudiante.dni}` : ''}
                                </p>
                            </div>
                            
                            <!-- Detalles de la Incidencia -->
                            <div style="margin-bottom: 20px;">
                                <div class="grid grid-2" style="gap: 15px;">
                                    <div>
                                        <p style="color: #666; margin: 0; font-size: 12px;">TIPO</p>
                                        <p style="margin: 5px 0;">
                                            <span class="badge badge-${esMerito ? 'primary' : 'danger'}">
                                                ${esMerito ? 'MÉRITO' : 'DEMÉRITO'}
                                            </span>
                                            ${severidadHTML}
                                        </p>
                                    </div>
                                    <div>
                                        <p style="color: #666; margin: 0; font-size: 12px;">FECHA</p>
                                        <p style="margin: 5px 0;"><i class="fas fa-calendar"></i> ${fecha}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Descripción -->
                            <div style="background: #fff3e0; padding: 15px; border-radius: 10px; border-left: 4px solid ${esMerito ? '#1976d2' : '#c1272d'}; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px; color: #333;">
                                    <i class="fas fa-file-alt"></i> Descripción
                                </h4>
                                <p style="margin: 0; line-height: 1.6;">${inc.descripcion || 'Sin descripción'}</p>
                            </div>
                            
                            <!-- Testigos (si hay) -->
                            ${inc.testigos ? `
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px; color: #1565c0;">
                                    <i class="fas fa-users"></i> Testigos
                                </h4>
                                <p style="margin: 0;">${inc.testigos}</p>
                            </div>
                            ` : ''}
                            
                            <!-- Estado de Lectura del Padre/Apoderado -->
                            ${estadoLecturaPadreHTML}
                            
                            <!-- Registrado por -->
                            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                                <p style="color: #666; margin: 0; font-size: 13px;">
                                    <i class="fas fa-user-edit"></i> Registrado por: 
                                    <strong>${inc.registrado_por?.nombre_completo || 'Sistema'}</strong>
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer" style="background: #f8f9fa; padding: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                            <button class="btn btn-danger" onclick="eliminarIncidencia('${inc.id}'); document.getElementById('modalDetalleIncAdmin').remove();">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalDetalleIncAdmin').remove()">
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // ===== GESTIÓN DE ESTUDIANTES =====
        async function cargarEstudiantesAdmin() {
            try {
                // Cargar estudiantes con información del padre/madre/apoderado
                const { data, error } = await supabase
                    .from('estudiantes')
                    .select(`
                        *,
                        padre:padre_id (id, nombre_completo, email, telefono),
                        madre:madre_id (id, nombre_completo, email, telefono),
                        apoderado:apoderado_id (id, nombre_completo, email, telefono)
                    `)
                    .order('grado', { ascending: true })
                    .order('seccion', { ascending: true })
                    .order('nombre_completo', { ascending: true });
                
                if (error) throw error;
                
                estudiantesAdmin = data || [];
                console.log('📚 Estudiantes cargados:', estudiantesAdmin.length);
                renderizarTablaEstudiantes(estudiantesAdmin);
            } catch (error) {
                console.error('Error cargando estudiantes:', error);
                mostrarNotificacion('Error al cargar estudiantes', 'error');
            }
        }
        
        function renderizarTablaEstudiantes(estudiantes) {
            const tbody = document.getElementById('tbodyEstudiantesAdmin');
            if (!tbody) return;
            
            if (!estudiantes || estudiantes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fas fa-user-graduate"></i><p>No hay estudiantes registrados</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = estudiantes.map(est => {
                // Obtener nombre del apoderado principal (padre, madre o apoderado)
                let apoderadoInfo = 'Sin apoderado asignado';
                let apoderadoTipo = '';
                let apoderadoData = null;
                
                if (est.padre && est.padre.nombre_completo) {
                    apoderadoInfo = est.padre.nombre_completo;
                    apoderadoTipo = '(Padre)';
                    apoderadoData = est.padre;
                } else if (est.madre && est.madre.nombre_completo) {
                    apoderadoInfo = est.madre.nombre_completo;
                    apoderadoTipo = '(Madre)';
                    apoderadoData = est.madre;
                } else if (est.apoderado && est.apoderado.nombre_completo) {
                    apoderadoInfo = est.apoderado.nombre_completo;
                    apoderadoTipo = '(Apoderado)';
                    apoderadoData = est.apoderado;
                }
                
                // Determinar estado de cuenta del apoderado
                let estadoCuenta = 'N/A';
                let badgeCuenta = 'secondary';
                if (apoderadoData) {
                    // Solo es activada si el campo 'activado' es explícitamente true
                    if (apoderadoData.activado === true) {
                        estadoCuenta = '✓ Activada';
                        badgeCuenta = 'success';
                    } else {
                        estadoCuenta = '⏳ Sin Activar';
                        badgeCuenta = 'warning';
                    }
                }
                
                return `
                <tr>
                    <td>${est.nombre_completo || 'Sin nombre'}</td>
                    <td>${est.dni || 'Sin DNI'}</td>
                    <td>${est.grado || '-'}°</td>
                    <td>${est.seccion || '-'}</td>
                    <td>
                        <span class="${apoderadoInfo === 'Sin apoderado asignado' ? 'text-warning' : ''}">
                            ${apoderadoInfo}
                        </span>
                        <small style="color: #666;">${apoderadoTipo}</small>
                    </td>
                    <td>
                        <span class="badge badge-${est.activo !== false ? 'success' : 'secondary'}">
                            ${est.activo !== false ? 'Activo' : 'Inactivo'}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-${badgeCuenta}">
                            ${estadoCuenta}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-info btn-xs" onclick="verDetalleEstudiante('${est.id}')" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-primary btn-xs" onclick="asignarApoderado('${est.id}')" title="Asignar apoderado">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            <button class="btn btn-danger btn-xs" onclick="eliminarEstudiante('${est.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }
        
        function filtrarEstudiantesAdmin() {
            const filtroNombre = document.getElementById('filtroEstudianteNombre')?.value.toLowerCase() || '';
            const filtroGrado = document.getElementById('filtroEstudianteGrado')?.value || '';
            const filtroSeccion = document.getElementById('filtroEstudianteSeccion')?.value || '';
            
            const estudiantesFiltrados = estudiantesAdmin.filter(est => {
                const coincideNombre = !filtroNombre || 
                    (est.nombre_completo?.toLowerCase().includes(filtroNombre));
                const coincideGrado = !filtroGrado || est.grado === filtroGrado;
                const coincideSeccion = !filtroSeccion || est.seccion === filtroSeccion;
                
                return coincideNombre && coincideGrado && coincideSeccion;
            });
            
            renderizarTablaEstudiantes(estudiantesFiltrados);
        }
        
        async function eliminarEstudiante(estudianteId) {
            const confirmar = await mostrarConfirmacion(
                '¿Está seguro de eliminar este estudiante?<br><br><strong style="color:#e74c3c">Se eliminarán también todas sus incidencias.</strong>',
                '⚠️ Eliminar Estudiante',
                { tipo: 'warning', btnConfirmar: 'Eliminar', peligroso: true }
            );
            if (!confirmar) return;
            
            try {
                const { error } = await supabase
                    .from('estudiantes')
                    .delete()
                    .eq('id', estudianteId);
                
                if (error) throw error;
                
                mostrarNotificacion('Estudiante eliminado correctamente', 'success');
                cargarEstudiantesAdmin();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar estudiante', 'error');
            }
        }
        
        // Ver detalle completo del estudiante
        async function verDetalleEstudiante(estudianteId) {
            const est = estudiantesAdmin.find(e => e.id === estudianteId);
            if (!est) return;
            
            // Construir información del apoderado
            let apoderadosHTML = '';
            if (est.padre && est.padre.nombre_completo) {
                apoderadosHTML += `
                    <div class="apoderado-item">
                        <strong><i class="fas fa-male"></i> Padre:</strong> ${est.padre.nombre_completo}<br>
                        <small>Email: ${est.padre.email || 'No registrado'} | Tel: ${est.padre.telefono || 'No registrado'}</small>
                    </div>`;
            }
            if (est.madre && est.madre.nombre_completo) {
                apoderadosHTML += `
                    <div class="apoderado-item">
                        <strong><i class="fas fa-female"></i> Madre:</strong> ${est.madre.nombre_completo}<br>
                        <small>Email: ${est.madre.email || 'No registrado'} | Tel: ${est.madre.telefono || 'No registrado'}</small>
                    </div>`;
            }
            if (est.apoderado && est.apoderado.nombre_completo) {
                apoderadosHTML += `
                    <div class="apoderado-item">
                        <strong><i class="fas fa-user"></i> Apoderado:</strong> ${est.apoderado.nombre_completo}<br>
                        <small>Email: ${est.apoderado.email || 'No registrado'} | Tel: ${est.apoderado.telefono || 'No registrado'}</small>
                    </div>`;
            }
            if (!apoderadosHTML) {
                apoderadosHTML = '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Sin apoderados asignados</p>';
            }
            
            const modalHTML = `
                <div class="modal-overlay" id="modalDetalleEstudiante" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-user-graduate"></i> Detalle del Estudiante</h3>
                            <button class="btn-close" onclick="document.getElementById('modalDetalleEstudiante').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="grid grid-2" style="gap: 20px;">
                                <div>
                                    <h4>Datos del Estudiante</h4>
                                    <p><strong>Nombre:</strong> ${est.nombre_completo}</p>
                                    <p><strong>DNI:</strong> ${est.dni || 'No registrado'}</p>
                                    <p><strong>Grado:</strong> ${est.grado}° ${est.seccion}</p>
                                    <p><strong>Sexo:</strong> ${est.sexo === 'M' ? 'Masculino' : est.sexo === 'F' ? 'Femenino' : 'No especificado'}</p>
                                    <p><strong>Estado:</strong> <span class="badge badge-${est.activo !== false ? 'success' : 'secondary'}">${est.activo !== false ? 'Activo' : 'Inactivo'}</span></p>
                                </div>
                                <div>
                                    <h4>Apoderados Asignados</h4>
                                    ${apoderadosHTML}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="asignarApoderado('${est.id}'); document.getElementById('modalDetalleEstudiante').remove();">
                                <i class="fas fa-user-plus"></i> Asignar/Cambiar Apoderado
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalDetalleEstudiante').remove()">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        // Asignar apoderado a estudiante
        async function asignarApoderado(estudianteId) {
            const est = estudiantesAdmin.find(e => e.id === estudianteId);
            if (!est) return;
            
            // Verificar si ya tiene apoderados asignados
            const tieneApoderados = est.padre_id || est.madre_id || est.apoderado_id;
            let infoApoderadosActuales = '';
            
            if (tieneApoderados) {
                // Cargar información de apoderados actuales
                const apoderadoIds = [est.padre_id, est.madre_id, est.apoderado_id].filter(Boolean);
                
                if (apoderadoIds.length > 0) {
                    const { data: apoderadosActuales } = await supabase
                        .from('users')
                        .select('id, nombre_completo, dni')
                        .in('id', apoderadoIds);
                    
                    if (apoderadosActuales && apoderadosActuales.length > 0) {
                        infoApoderadosActuales = `
                            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                <p style="margin: 0 0 10px 0; font-weight: 600; color: #856404;">
                                    <i class="fas fa-exclamation-triangle"></i> Este estudiante ya tiene apoderado(s) asignado(s):
                                </p>
                                <ul style="margin: 0; padding-left: 20px; color: #856404;">
                                    ${est.padre_id ? `<li><strong>Padre:</strong> ${apoderadosActuales.find(a => a.id === est.padre_id)?.nombre_completo || 'No encontrado'}</li>` : ''}
                                    ${est.madre_id ? `<li><strong>Madre:</strong> ${apoderadosActuales.find(a => a.id === est.madre_id)?.nombre_completo || 'No encontrado'}</li>` : ''}
                                    ${est.apoderado_id ? `<li><strong>Apoderado:</strong> ${apoderadosActuales.find(a => a.id === est.apoderado_id)?.nombre_completo || 'No encontrado'}</li>` : ''}
                                </ul>
                                <p style="margin: 10px 0 0 0; font-size: 13px; color: #856404;">
                                    <i class="fas fa-info-circle"></i> Si asigna un nuevo apoderado del mismo tipo, se reemplazará el actual.
                                </p>
                            </div>
                        `;
                    }
                }
            }
            
            // Cargar usuarios tipo padre
            const { data: padres, error } = await supabase
                .from('users')
                .select('id, nombre_completo, dni, email')
                .eq('role', 'padre')
                .order('nombre_completo', { ascending: true });
            
            if (error) {
                console.error('Error cargando padres:', error);
                mostrarNotificacion('Error al cargar lista de padres', 'error');
                return;
            }
            
            const opcionesPadres = padres.map(p => 
                `<option value="${p.id}">${p.nombre_completo} (DNI: ${p.dni || 'N/A'})</option>`
            ).join('');
            
            // Determinar qué tipos de relación ya están ocupados
            const tipoPadreOcupado = est.padre_id ? 'disabled title="Ya tiene padre asignado"' : '';
            const tipoMadreOcupado = est.madre_id ? 'disabled title="Ya tiene madre asignada"' : '';
            const tipoApoderadoOcupado = est.apoderado_id ? 'disabled title="Ya tiene apoderado asignado"' : '';
            
            const modalHTML = `
                <div class="modal-overlay" id="modalAsignarApoderado" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 550px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-user-plus"></i> Asignar Apoderado</h3>
                            <button class="btn-close" onclick="document.getElementById('modalAsignarApoderado').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Estudiante:</strong> ${est.nombre_completo} (${est.grado}° ${est.seccion})</p>
                            <hr>
                            ${infoApoderadosActuales}
                            <div class="form-group">
                                <label>Tipo de relación:</label>
                                <select id="tipoApoderado" class="form-control">
                                    <option value="padre_id" ${tipoPadreOcupado}>Padre ${est.padre_id ? '(Ya asignado)' : ''}</option>
                                    <option value="madre_id" ${tipoMadreOcupado}>Madre ${est.madre_id ? '(Ya asignada)' : ''}</option>
                                    <option value="apoderado_id" ${tipoApoderadoOcupado}>Otro Apoderado ${est.apoderado_id ? '(Ya asignado)' : ''}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Seleccionar persona:</label>
                                <select id="selectApoderado" class="form-control">
                                    <option value="">-- Seleccione --</option>
                                    ${opcionesPadres}
                                </select>
                            </div>
                            ${padres.length === 0 ? '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> No hay usuarios tipo "padre" registrados. Primero debe crear un usuario con rol padre.</p>' : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="guardarAsignacionApoderado('${est.id}')" ${padres.length === 0 ? 'disabled' : ''}>
                                <i class="fas fa-save"></i> Guardar
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalAsignarApoderado').remove()">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Seleccionar automáticamente el primer tipo disponible
            const selectTipo = document.getElementById('tipoApoderado');
            if (selectTipo) {
                const primeraOpcionDisponible = selectTipo.querySelector('option:not([disabled])');
                if (primeraOpcionDisponible) {
                    primeraOpcionDisponible.selected = true;
                }
            }
        }
        
        async function guardarAsignacionApoderado(estudianteId) {
            const tipoApoderado = document.getElementById('tipoApoderado').value;
            const apoderadoId = document.getElementById('selectApoderado').value;
            
            if (!apoderadoId) {
                mostrarNotificacion('Debe seleccionar un apoderado', 'warning');
                return;
            }
            
            try {
                const updateData = {};
                updateData[tipoApoderado] = apoderadoId;
                
                const { error } = await supabase
                    .from('estudiantes')
                    .update(updateData)
                    .eq('id', estudianteId);
                
                if (error) throw error;
                
                document.getElementById('modalAsignarApoderado').remove();
                mostrarNotificacion('Apoderado asignado correctamente', 'success');
                cargarEstudiantesAdmin();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al asignar apoderado', 'error');
            }
        }
        
        function mostrarModalCrearEstudiante() {
            const grados = ['1', '2', '3', '4', '5'];
            const secciones = ['A', 'B', 'C', 'D', 'E'];
            
            const gradosOptions = grados.map(g => `<option value="${g}">${g}°</option>`).join('');
            const seccionesOptions = secciones.map(s => `<option value="${s}">${s}</option>`).join('');
            
            const modalHTML = `
                <div class="modal-overlay" id="modalCrearEstudiante" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-user-graduate"></i> Registrar Nuevo Estudiante</h3>
                            <button class="btn-close" onclick="document.getElementById('modalCrearEstudiante').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="formCrearEstudiante">
                                <div class="form-group">
                                    <label>Nombre Completo *</label>
                                    <input type="text" class="form-control" id="newEstNombre" required placeholder="Apellidos y Nombres">
                                </div>
                                <div class="form-group">
                                    <label>DNI *</label>
                                    <input type="text" class="form-control" id="newEstDni" maxlength="8" required placeholder="12345678">
                                </div>
                                <div class="grid grid-2" style="gap: 15px;">
                                    <div class="form-group">
                                        <label>Grado *</label>
                                        <select class="form-control" id="newEstGrado" required>${gradosOptions}</select>
                                    </div>
                                    <div class="form-group">
                                        <label>Sección *</label>
                                        <select class="form-control" id="newEstSeccion" required>${seccionesOptions}</select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Sexo *</label>
                                    <select class="form-control" id="newEstSexo" required>
                                        <option value="M">Masculino</option>
                                        <option value="F">Femenino</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Fecha de Nacimiento</label>
                                    <input type="date" class="form-control" id="newEstFechaNac">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="guardarNuevoEstudiante()"><i class="fas fa-save"></i> Registrar Estudiante</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('modalCrearEstudiante').remove()">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        async function guardarNuevoEstudiante() {
            const nombre = document.getElementById('newEstNombre').value;
            const dni = document.getElementById('newEstDni').value;
            const grado = document.getElementById('newEstGrado').value;
            const seccion = document.getElementById('newEstSeccion').value;
            const sexo = document.getElementById('newEstSexo').value;
            const fechaNac = document.getElementById('newEstFechaNac').value;
            
            if (!nombre || !dni || !grado || !seccion || !sexo) {
                mostrarNotificacion('Por favor complete los campos obligatorios', 'warning');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('estudiantes')
                    .insert([{
                        nombre_completo: nombre.toUpperCase(),
                        dni: dni,
                        grado: grado,
                        seccion: seccion,
                        sexo: sexo,
                        fecha_nacimiento: fechaNac || null,
                        activo: true
                    }])
                    .select();
                
                if (error) throw error;
                
                document.getElementById('modalCrearEstudiante').remove();
                mostrarNotificacion('Estudiante registrado correctamente', 'success');
                cargarEstudiantesAdmin();
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al registrar estudiante: ' + error.message, 'error');
            }
        }
        
        // ===== FUNCIONES DE EXPORTACIÓN =====
        async function exportarUsuariosCSV() {
            try {
                // Cargar datos frescos de la base de datos
                const { data: usuarios, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('nombre_completo', { ascending: true });
                
                if (error) throw error;
                
                if (!usuarios || usuarios.length === 0) {
                    mostrarNotificacion('No hay usuarios para exportar', 'warning');
                    return;
                }
                
                // Preparar datos con formato mejorado
                const datosFormateados = usuarios.map(u => ({
                    nombre_completo: u.nombre_completo || '',
                    email: u.email || '',
                    dni: u.dni || '',
                    telefono: u.telefono || '',
                    role: u.role || '',
                    estado_cuenta: u.activo ? 'Activa' : 'Sin Activar',
                    fecha_registro: u.created_at ? new Date(u.created_at).toLocaleDateString('es-PE') : ''
                }));
                
                const csv = convertirACSV(datosFormateados, [
                    { key: 'nombre_completo', label: 'Nombre Completo' },
                    { key: 'email', label: 'Email' },
                    { key: 'dni', label: 'DNI' },
                    { key: 'telefono', label: 'Teléfono' },
                    { key: 'role', label: 'Rol' },
                    { key: 'estado_cuenta', label: 'Estado Cuenta' },
                    { key: 'fecha_registro', label: 'Fecha Registro' }
                ]);
                
                descargarCSV(csv, `usuarios_ata_${new Date().toISOString().split('T')[0]}.csv`);
                mostrarNotificacion(`${usuarios.length} usuarios exportados correctamente`, 'success');
            } catch (error) {
                console.error('Error exportando usuarios:', error);
                mostrarNotificacion('Error al exportar usuarios', 'error');
            }
        }
        
        async function exportarIncidenciasCSV() {
            try {
                // Cargar datos frescos con relaciones
                const { data: incidencias, error } = await supabase
                    .from('incidencias')
                    .select(`
                        *,
                        estudiante:estudiantes(nombre_completo, dni, grado, seccion),
                        registrado_por:users!registrado_por(nombre_completo, role)
                    `)
                    .order('fecha', { ascending: false });
                
                if (error) throw error;
                
                if (!incidencias || incidencias.length === 0) {
                    mostrarNotificacion('No hay incidencias para exportar', 'warning');
                    return;
                }
                
                const datosFormateados = incidencias.map(inc => ({
                    fecha: inc.fecha ? new Date(inc.fecha).toLocaleDateString('es-PE') : '',
                    estudiante: inc.estudiante?.nombre_completo || '',
                    dni_estudiante: inc.estudiante?.dni || '',
                    grado: inc.estudiante?.grado || '',
                    seccion: inc.estudiante?.seccion || '',
                    tipo: inc.tipo === 'merito' ? 'MÉRITO' : 'DEMÉRITO',
                    severidad: inc.severidad || '',
                    codigo: inc.codigo || '',
                    descripcion: inc.descripcion || '',
                    testigos: inc.testigos || '',
                    registrado_por: inc.registrado_por?.nombre_completo || '',
                    rol_registrador: inc.registrado_por?.role || '',
                    revisado_padre: inc.revisado_por_padre ? 'SÍ' : 'NO',
                    fecha_revision_padre: inc.fecha_revision_padre ? new Date(inc.fecha_revision_padre).toLocaleDateString('es-PE') : '',
                    comentario_padre: inc.comentario_padre || ''
                }));
                
                const csv = convertirACSV(datosFormateados, [
                    { key: 'fecha', label: 'Fecha' },
                    { key: 'estudiante', label: 'Estudiante' },
                    { key: 'dni_estudiante', label: 'DNI Estudiante' },
                    { key: 'grado', label: 'Grado' },
                    { key: 'seccion', label: 'Sección' },
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'severidad', label: 'Severidad' },
                    { key: 'codigo', label: 'Código' },
                    { key: 'descripcion', label: 'Descripción' },
                    { key: 'testigos', label: 'Testigos' },
                    { key: 'registrado_por', label: 'Registrado Por' },
                    { key: 'rol_registrador', label: 'Rol' },
                    { key: 'revisado_padre', label: 'Revisado por Padre' },
                    { key: 'fecha_revision_padre', label: 'Fecha Revisión Padre' },
                    { key: 'comentario_padre', label: 'Comentario Padre' }
                ]);
                
                descargarCSV(csv, `incidencias_ata_${new Date().toISOString().split('T')[0]}.csv`);
                mostrarNotificacion(`${incidencias.length} incidencias exportadas correctamente`, 'success');
            } catch (error) {
                console.error('Error exportando incidencias:', error);
                mostrarNotificacion('Error al exportar incidencias', 'error');
            }
        }
        
        async function exportarEstudiantesCSV() {
            try {
                // Cargar datos frescos con relaciones de apoderados
                const { data: estudiantes, error } = await supabase
                    .from('estudiantes')
                    .select(`
                        *,
                        padre:padre_id(nombre_completo, dni, telefono, email),
                        madre:madre_id(nombre_completo, dni, telefono, email),
                        apoderado:apoderado_id(nombre_completo, dni, telefono, email)
                    `)
                    .order('grado', { ascending: true })
                    .order('seccion', { ascending: true })
                    .order('nombre_completo', { ascending: true });
                
                if (error) throw error;
                
                if (!estudiantes || estudiantes.length === 0) {
                    mostrarNotificacion('No hay estudiantes para exportar', 'warning');
                    return;
                }
                
                const datosFormateados = estudiantes.map(est => {
                    // Determinar apoderado principal
                    let apoderadoNombre = '';
                    let apoderadoDNI = '';
                    let apoderadoTelefono = '';
                    let apoderadoEmail = '';
                    let tipoApoderado = '';
                    
                    if (est.padre?.nombre_completo) {
                        apoderadoNombre = est.padre.nombre_completo;
                        apoderadoDNI = est.padre.dni || '';
                        apoderadoTelefono = est.padre.telefono || '';
                        apoderadoEmail = est.padre.email || '';
                        tipoApoderado = 'Padre';
                    } else if (est.madre?.nombre_completo) {
                        apoderadoNombre = est.madre.nombre_completo;
                        apoderadoDNI = est.madre.dni || '';
                        apoderadoTelefono = est.madre.telefono || '';
                        apoderadoEmail = est.madre.email || '';
                        tipoApoderado = 'Madre';
                    } else if (est.apoderado?.nombre_completo) {
                        apoderadoNombre = est.apoderado.nombre_completo;
                        apoderadoDNI = est.apoderado.dni || '';
                        apoderadoTelefono = est.apoderado.telefono || '';
                        apoderadoEmail = est.apoderado.email || '';
                        tipoApoderado = 'Apoderado';
                    }
                    
                    return {
                        nombre_completo: est.nombre_completo || '',
                        dni: est.dni || '',
                        grado: est.grado || '',
                        seccion: est.seccion || '',
                        sexo: est.sexo === 'M' ? 'Masculino' : est.sexo === 'F' ? 'Femenino' : '',
                        fecha_nacimiento: est.fecha_nacimiento || '',
                        estado: est.activo !== false ? 'Activo' : 'Inactivo',
                        apoderado_nombre: apoderadoNombre,
                        apoderado_tipo: tipoApoderado,
                        apoderado_dni: apoderadoDNI,
                        apoderado_telefono: apoderadoTelefono,
                        apoderado_email: apoderadoEmail
                    };
                });
                
                const csv = convertirACSV(datosFormateados, [
                    { key: 'nombre_completo', label: 'Nombre Estudiante' },
                    { key: 'dni', label: 'DNI Estudiante' },
                    { key: 'grado', label: 'Grado' },
                    { key: 'seccion', label: 'Sección' },
                    { key: 'sexo', label: 'Sexo' },
                    { key: 'fecha_nacimiento', label: 'Fecha Nacimiento' },
                    { key: 'estado', label: 'Estado' },
                    { key: 'apoderado_nombre', label: 'Apoderado' },
                    { key: 'apoderado_tipo', label: 'Parentesco' },
                    { key: 'apoderado_dni', label: 'DNI Apoderado' },
                    { key: 'apoderado_telefono', label: 'Teléfono Apoderado' },
                    { key: 'apoderado_email', label: 'Email Apoderado' }
                ]);
                
                descargarCSV(csv, `estudiantes_ata_${new Date().toISOString().split('T')[0]}.csv`);
                mostrarNotificacion(`${estudiantes.length} estudiantes exportados correctamente`, 'success');
            } catch (error) {
                console.error('Error exportando estudiantes:', error);
                mostrarNotificacion('Error al exportar estudiantes', 'error');
            }
        }
        
        async function exportarMeritosDemeritos() {
            await exportarIncidenciasCSV();
        }
        
        function convertirACSV(datos, columnas) {
            const encabezados = columnas.map(c => c.label).join(',');
            const filas = datos.map(item => {
                return columnas.map(col => {
                    let valor = item[col.key];
                    if (valor === null || valor === undefined) valor = '';
                    if (typeof valor === 'string') {
                        valor = valor.replace(/"/g, '""');
                        valor = `"${valor}"`;
                    }
                    return valor;
                }).join(',');
            });
            
            return [encabezados, ...filas].join('\n');
        }
        
        function descargarCSV(contenidoCSV, nombreArchivo) {
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + contenidoCSV], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = nombreArchivo;
            link.click();
        }
        
        async function generarReporteGeneral() {
            try {
                // Cargar datos frescos
                const { data: usuarios } = await supabase.from('users').select('id, role, activo');
                const { data: estudiantes } = await supabase.from('estudiantes').select('id, activo');
                const { data: incidencias } = await supabase.from('incidencias').select('id, tipo');
                
                const fecha = new Date().toLocaleDateString('es-PE', { year: 'numeric', month: 'long', day: 'numeric' });
                const totalUsuarios = usuarios?.length || 0;
                const totalEstudiantes = estudiantes?.length || 0;
                const totalIncidencias = incidencias?.length || 0;
                const meritos = incidencias?.filter(i => i.tipo === 'merito').length || 0;
                const demeritos = incidencias?.filter(i => i.tipo === 'demerito').length || 0;
                
                // Distribución por roles
                const distribucionRoles = {};
                usuarios?.forEach(u => {
                    distribucionRoles[u.role] = (distribucionRoles[u.role] || 0) + 1;
                });
                
                const contenido = `
REPORTE GENERAL DEL SISTEMA
Agenda Virtual ATA - I.E. 80002 Antonio Torres Araujo
${'='.repeat(60)}
Fecha de generación: ${fecha}

RESUMEN ESTADÍSTICO
${'-'.repeat(40)}
• Total de usuarios registrados: ${totalUsuarios}
• Total de estudiantes: ${totalEstudiantes}
• Total de incidencias: ${totalIncidencias}
  - Méritos: ${meritos}
  - Deméritos: ${demeritos}

DISTRIBUCIÓN POR ROLES
${'-'.repeat(40)}
${Object.entries(distribucionRoles).map(([rol, count]) => 
    `• ${rol.charAt(0).toUpperCase() + rol.slice(1)}: ${count}`
).join('\n')}

ESTADO DE CUENTAS
${'-'.repeat(40)}
• Cuentas activadas: ${usuarios?.filter(u => u.activo).length || 0}
• Cuentas sin activar: ${usuarios?.filter(u => !u.activo).length || 0}

${'='.repeat(60)}
Generado automáticamente por Agenda Virtual ATA
                `;
                
                descargarTXT(contenido, `reporte_general_${new Date().toISOString().split('T')[0]}.txt`);
                mostrarNotificacion('Reporte general descargado', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al generar reporte', 'error');
            }
        }
        
        async function generarReporteMensual() {
            try {
                // Cargar datos frescos
                const { data: incidencias } = await supabase
                    .from('incidencias')
                    .select(`*, estudiante:estudiantes(nombre_completo, grado, seccion)`)
                    .order('fecha', { ascending: false });
                
                const mesActual = new Date().toLocaleDateString('es-PE', { year: 'numeric', month: 'long' });
                const inicioMes = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();
                
                const incidenciasMes = incidencias?.filter(i => i.fecha >= inicioMes) || [];
                const meritos = incidenciasMes.filter(i => i.tipo === 'merito');
                const demeritos = incidenciasMes.filter(i => i.tipo === 'demerito');
                
                // Agrupar por grado
                const porGrado = {};
                incidenciasMes.forEach(inc => {
                    const grado = inc.estudiante?.grado || 'Sin grado';
                    if (!porGrado[grado]) porGrado[grado] = { meritos: 0, demeritos: 0 };
                    if (inc.tipo === 'merito') porGrado[grado].meritos++;
                    else porGrado[grado].demeritos++;
                });
                
                const contenido = `
REPORTE MENSUAL DE INCIDENCIAS
Agenda Virtual ATA - I.E. 80002 Antonio Torres Araujo
${'='.repeat(60)}
Período: ${mesActual}

RESUMEN DEL MES
${'-'.repeat(40)}
• Total incidencias: ${incidenciasMes.length}
• Méritos: ${meritos.length}
• Deméritos: ${demeritos.length}

DISTRIBUCIÓN POR GRADO
${'-'.repeat(40)}
${Object.entries(porGrado).sort((a,b) => a[0].localeCompare(b[0])).map(([grado, datos]) => 
    `• ${grado}° Grado: ${datos.meritos} méritos, ${datos.demeritos} deméritos`
).join('\n') || 'Sin datos'}

DETALLE DE INCIDENCIAS DEL MES
${'-'.repeat(40)}
${incidenciasMes.map((inc, idx) => 
    `${idx+1}. [${new Date(inc.fecha).toLocaleDateString('es-PE')}] ${inc.estudiante?.nombre_completo || 'N/A'} (${inc.estudiante?.grado}°${inc.estudiante?.seccion}) - ${inc.tipo === 'merito' ? 'MÉRITO' : 'DEMÉRITO'}`
).join('\n') || 'Sin incidencias este mes'}

${'='.repeat(60)}
Generado automáticamente por Agenda Virtual ATA
                `;
                
                descargarTXT(contenido, `reporte_mensual_${new Date().toISOString().slice(0,7)}.txt`);
                mostrarNotificacion('Reporte mensual descargado', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al generar reporte', 'error');
            }
        }
        
        async function generarReporteIncidencias() {
            try {
                // Cargar datos frescos
                const { data: incidencias } = await supabase
                    .from('incidencias')
                    .select(`
                        *,
                        estudiante:estudiantes(nombre_completo, dni, grado, seccion),
                        registrado_por:users!registrado_por(nombre_completo, role)
                    `)
                    .order('fecha', { ascending: false });
                
                if (!incidencias || incidencias.length === 0) {
                    mostrarNotificacion('No hay incidencias para exportar', 'warning');
                    return;
                }
                
                let contenido = `REPORTE DETALLADO DE INCIDENCIAS\nAgenda Virtual ATA - I.E. 80002 Antonio Torres Araujo\n${'='.repeat(80)}\nFecha de generación: ${new Date().toLocaleDateString('es-PE')}\nTotal de incidencias: ${incidencias.length}\n${'='.repeat(80)}\n\n`;
                
                incidencias.forEach((inc, idx) => {
                    contenido += `[${idx + 1}] ${new Date(inc.fecha).toLocaleDateString('es-PE')}\n`;
                    contenido += `    Estudiante: ${inc.estudiante?.nombre_completo || 'Desconocido'}\n`;
                    contenido += `    DNI: ${inc.estudiante?.dni || 'N/A'}\n`;
                    contenido += `    Aula: ${inc.estudiante?.grado || '-'}° ${inc.estudiante?.seccion || '-'}\n`;
                    contenido += `    Tipo: ${inc.tipo === 'merito' ? 'MÉRITO' : 'DEMÉRITO'}\n`;
                    contenido += `    Severidad: ${inc.severidad || 'N/A'}\n`;
                    contenido += `    Código: ${inc.codigo || 'N/A'}\n`;
                    contenido += `    Descripción: ${inc.descripcion || 'Sin descripción'}\n`;
                    contenido += `    Testigos: ${inc.testigos || 'N/A'}\n`;
                    contenido += `    Registrado por: ${inc.registrado_por?.nombre_completo || 'Sistema'} (${inc.registrado_por?.role || ''})\n`;
                    contenido += `    Revisado por padre: ${inc.revisado_por_padre ? 'SÍ' : 'NO'}\n`;
                    if (inc.comentario_padre) {
                        contenido += `    Comentario padre: ${inc.comentario_padre}\n`;
                    }
                    contenido += `${'-'.repeat(80)}\n`;
                });
                
                descargarTXT(contenido, `incidencias_detalle_${new Date().toISOString().split('T')[0]}.txt`);
                mostrarNotificacion(`${incidencias.length} incidencias exportadas correctamente`, 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al generar reporte', 'error');
            }
        }
        
        async function generarReporteUGEL() {
            try {
                // Cargar datos frescos
                const { data: estudiantes } = await supabase.from('estudiantes').select('id, grado');
                const { data: incidencias } = await supabase
                    .from('incidencias')
                    .select(`*, estudiante:estudiantes(grado)`);
                
                const fecha = new Date().toLocaleDateString('es-PE', { year: 'numeric', month: 'long', day: 'numeric' });
                const totalEstudiantes = estudiantes?.length || 0;
                const totalIncidencias = incidencias?.length || 0;
                
                // Calcular estadísticas por severidad
                const graves = incidencias?.filter(i => i.severidad === 'grave' || i.severidad === 'muy_grave').length || 0;
                const meritos = incidencias?.filter(i => i.tipo === 'merito').length || 0;
                const demeritos = incidencias?.filter(i => i.tipo === 'demerito').length || 0;
                
                const contenido = `
${'='.repeat(70)}
INFORME PARA UGEL - CONSOLIDADO DE INCIDENCIAS
I.E. 80002 "ANTONIO TORRES ARAUJO"
${'='.repeat(70)}

DATOS DE LA INSTITUCIÓN
${'-'.repeat(50)}
Nombre: I.E. 80002 "Antonio Torres Araujo"
Nivel: Secundaria
Dirección: Av. América Norte S/N, Trujillo
UGEL: 04 - Trujillo Sur Este
DRE: La Libertad

PERÍODO REPORTADO
${'-'.repeat(50)}
Fecha de corte: ${fecha}
Año escolar: 2025

ESTADÍSTICAS GENERALES
${'-'.repeat(50)}
• Población estudiantil: ${totalEstudiantes} estudiantes
• Total de incidencias registradas: ${totalIncidencias}
  - Méritos: ${meritos}
  - Deméritos: ${demeritos}
• Incidencias graves o muy graves: ${graves}

DISTRIBUCIÓN POR GRADO
${'-'.repeat(50)}
${'12345'.split('').map(g => {
    const estGrado = estudiantes?.filter(e => e.grado === g).length || 0;
    const incGrado = incidencias?.filter(i => i.estudiante?.grado === g) || [];
    const meritosG = incGrado.filter(i => i.tipo === 'merito').length;
    const demeritosG = incGrado.filter(i => i.tipo === 'demerito').length;
    return `• ${g}° Grado: ${estGrado} estudiantes | ${meritosG} méritos, ${demeritosG} deméritos`;
}).join('\n')}

OBSERVACIONES
${'-'.repeat(50)}
El presente informe es generado automáticamente por el
Sistema Agenda Virtual ATA para fines de control y
seguimiento de la convivencia escolar.

${'='.repeat(70)}
Firma del Director: ________________________

Fecha: ${fecha}
${'='.repeat(70)}
                `;
                
                descargarTXT(contenido, `informe_ugel_${new Date().toISOString().split('T')[0]}.txt`);
                mostrarNotificacion('Informe UGEL generado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al generar informe UGEL', 'error');
            }
        }
        
        function descargarTXT(contenido, nombreArchivo) {
            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = nombreArchivo;
            link.click();
        }
        
        async function exportarBackupCompleto() {
            try {
                const backup = {
                    fecha: new Date().toISOString(),
                    usuarios: usuariosAdmin,
                    incidencias: incidenciasAdmin,
                    estudiantes: estudiantesAdmin
                };
                
                const json = JSON.stringify(backup, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `backup_ata_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                mostrarNotificacion('Backup descargado correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al generar backup', 'error');
            }
        }
        
        // Funciones legacy (por compatibilidad)
        function showUserManagement() { mostrarModalCrearUsuario(); }
        function showUserList() { showAdminTab('usuarios'); }
        function showPendingRequests() { showAdminTab('solicitudes'); }
        function showClassroomConfig() {
            const modalHTML = `
                <div class="modal-overlay" id="modalConfigAulas" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-school"></i> Configuración de Aulas</h3>
                            <button class="btn-close" onclick="document.getElementById('modalConfigAulas').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <h4>Estructura Actual del Colegio</h4>
                            <div class="grid grid-5" style="gap: 10px; margin: 20px 0;">
                                ${['1°', '2°', '3°', '4°', '5°'].map(g => `
                                    <div class="card" style="text-align: center; padding: 15px;">
                                        <strong style="font-size: 18px; color: var(--color-ata-verde);">${g}</strong>
                                        <p style="margin: 5px 0 0; color: #666;">Secciones: A-E</p>
                                        <small>5 secciones</small>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                                <p><strong>Resumen:</strong></p>
                                <ul style="margin: 10px 0 0; padding-left: 20px;">
                                    <li>5 grados (1° a 5° de secundaria)</li>
                                    <li>5 secciones por grado (A, B, C, D, E)</li>
                                    <li>Total: 25 aulas</li>
                                    <li>Capacidad promedio: 30-35 estudiantes por aula</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalConfigAulas').remove()">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        function showStudentConfig() { showAdminTab('estudiantes'); }
        function showIncidentConfig() {
            const modalHTML = `
                <div class="modal-overlay" id="modalConfigIncidencias" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-cogs"></i> Configuración de Incidencias</h3>
                            <button class="btn-close" onclick="document.getElementById('modalConfigIncidencias').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="grid grid-2" style="gap: 20px;">
                                <div>
                                    <h4 style="color: var(--color-ata-verde);"><i class="fas fa-star"></i> Catálogo de Méritos</h4>
                                    <p>14 tipos de méritos configurados</p>
                                    <ul style="font-size: 13px; max-height: 200px; overflow-y: auto;">
                                        <li>Mejor promedio del aula</li>
                                        <li>Participación destacada</li>
                                        <li>Representación institucional</li>
                                        <li>Apoyo a compañeros</li>
                                        <li>Y 10 más...</li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Catálogo de Deméritos</h4>
                                    <p>54 tipos de deméritos por severidad</p>
                                    <ul style="font-size: 13px;">
                                        <li><span class="badge badge-info">Leves (L)</span> 15 tipos</li>
                                        <li><span class="badge badge-warning">Graves (G)</span> 24 tipos</li>
                                        <li><span class="badge badge-danger">Muy Graves (MG)</span> 15 tipos</li>
                                    </ul>
                                </div>
                            </div>
                            <hr>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                                <p><strong>ℹ️ Nota:</strong> Los catálogos están basados en el Reglamento Interno del colegio y las normativas del MINEDU.</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalConfigIncidencias').remove()">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        function showSystemConfig() {
            const modalHTML = `
                <div class="modal-overlay" id="modalConfigSistema" onclick="if(event.target===this)this.remove()">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-server"></i> Configuración del Sistema</h3>
                            <button class="btn-close" onclick="document.getElementById('modalConfigSistema').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="card" style="margin-bottom: 15px;">
                                <h4><i class="fas fa-database"></i> Base de Datos</h4>
                                <p>Proveedor: <strong>Supabase (PostgreSQL)</strong></p>
                                <p>Estado: <span class="badge badge-success">Conectado</span></p>
                            </div>
                            <div class="card" style="margin-bottom: 15px;">
                                <h4><i class="fas fa-calendar-alt"></i> Período Académico</h4>
                                <p>Año: <strong>2025</strong></p>
                                <p>Estado: <span class="badge badge-success">Activo</span></p>
                            </div>
                            <div class="card">
                                <h4><i class="fas fa-shield-alt"></i> Seguridad</h4>
                                <p>Autenticación: <strong>Supabase Auth</strong></p>
                                <p>RLS (Row Level Security): <span class="badge badge-success">Habilitado</span></p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalConfigSistema').remove()">Cerrar</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        function showAllIncidents() { showAdminTab('incidencias'); }
        function exportUsers() { exportarUsuariosCSV(); }
        function exportIncidents() { exportarIncidenciasCSV(); }
        function exportStats() {
            // Exportar estadísticas en formato CSV
            const stats = {
                fecha_generacion: new Date().toISOString(),
                total_usuarios: usuariosAdmin?.length || 0,
                total_estudiantes: estudiantesAdmin?.length || 0,
                total_incidencias: incidenciasAdmin?.length || 0,
                meritos: incidenciasAdmin?.filter(i => i.tipo === 'merito').length || 0,
                demeritos: incidenciasAdmin?.filter(i => i.tipo === 'demerito').length || 0,
                usuarios_activos: usuariosAdmin?.filter(u => u.activo).length || 0,
                estudiantes_activos: estudiantesAdmin?.filter(e => e.activo !== false).length || 0
            };
            
            const csv = Object.entries(stats).map(([key, val]) => `${key},${val}`).join('\n');
            descargarCSV('Métrica,Valor\n' + csv, 'estadisticas_ata.csv');
            mostrarNotificacion('Estadísticas exportadas correctamente', 'success');
        }
        function generateReport() { generarReporteUGEL(); }
        function performBackup() { exportarBackupCompleto(); }
        function generateSystemReport() { generarReporteGeneral(); }

        // ==================== SISTEMA DE MÉRITOS Y DEMÉRITOS ====================
        
        // Base de datos simulada para historial de incidencias por estudiante
        const studentIncidentHistory = {
            // Simulando algunos estudiantes con historial
            'ana_garcia_torres': [
                { date: '2025-09-20', type: 'LEVE-C', severity: 'leve', description: 'Llegó tarde a clase' },
                { date: '2025-09-18', type: 'LEVE-T', severity: 'leve', description: 'Uniforme incompleto' }
            ],
            'luis_morales_cruz': [
                { date: '2025-09-19', type: 'LEVE-C', severity: 'leve', description: 'Tardanza reiterada' },
                { date: '2025-09-17', type: 'LEVE-C', severity: 'leve', description: 'Llegó tarde nuevamente' },
                { date: '2025-09-16', type: 'LEVE-C', severity: 'leve', description: 'Tercera tardanza esta semana' }
            ]
        };

        // Toggle entre secciones de méritos y deméritos
        function toggleMeritosDemeritosSections() {
            const tipoRegistro = document.getElementById('tipoRegistro').value;
            const meritosSection = document.getElementById('meritosSection');
            const demeritosSection = document.getElementById('demeritosSection');
            const severidadInfo = document.getElementById('severidadInfo');
            const escalamientoInfo = document.getElementById('escalamientoInfo');
            
            // Reset de selecciones previas
            document.getElementById('meritoSelect').selectedIndex = 0;
            document.getElementById('demeritoSelect').selectedIndex = 0;
            
            if (tipoRegistro === 'merito') {
                meritosSection.style.display = 'block';
                demeritosSection.style.display = 'none';
                severidadInfo.style.display = 'none';
                escalamientoInfo.style.display = 'none';
                document.getElementById('severidadDisplay').innerHTML = '✅ Los méritos no tienen severidad - son reconocimientos positivos';
                document.getElementById('severidadDisplay').style.background = '#d4edda';
                document.getElementById('severidadDisplay').style.color = '#155724';
            } else if (tipoRegistro === 'demerito') {
                meritosSection.style.display = 'none';
                demeritosSection.style.display = 'block';
                severidadInfo.style.display = 'block';
                escalamientoInfo.style.display = 'block';
                document.getElementById('severidadDisplay').innerHTML = 'Se calculará automáticamente según el tipo de falta y historial';
                document.getElementById('severidadDisplay').style.background = '#f8f9fa';
                document.getElementById('severidadDisplay').style.color = '#666';
            } else {
                meritosSection.style.display = 'none';
                demeritosSection.style.display = 'none';
                severidadInfo.style.display = 'none';
                escalamientoInfo.style.display = 'none';
            }
        }

        // Actualizar información de severidad automática
        function updateSeverityInfo() {
            const demeritoSelect = document.getElementById('demeritoSelect');
            const selectedOption = demeritoSelect.options[demeritoSelect.selectedIndex];
            const severidadDisplay = document.getElementById('severidadDisplay');
            const studentName = document.getElementById('studentSearch').value.toLowerCase().replace(/\s+/g, '_');
            
            if (!selectedOption || !selectedOption.value) {
                severidadDisplay.innerHTML = 'Se calculará automáticamente según el tipo de falta y historial';
                severidadDisplay.style.background = '#f8f9fa';
                severidadDisplay.style.color = '#666';
                return;
            }

            const baseSeverity = selectedOption.getAttribute('data-severity');
            const faltaCode = selectedOption.value;
            
            // Simular verificación de historial del estudiante
            const studentHistory = studentIncidentHistory[studentName] || [];
            const currentWeekIncidents = countIncidentsInCurrentWeek(studentHistory);
            const currentBimesterIncidents = countIncidentsInCurrentBimester(studentHistory);
            
            let finalSeverity = baseSeverity;
            let escalationInfo = '';
            let alertStyle = '';

            if (baseSeverity === 'leve') {
                // Aplicar reglas de escalamiento para faltas leves
                if (currentWeekIncidents >= 2) {
                    // Ya tiene 2+ faltas esta semana, la siguiente sería la 3ra (Alerta)
                    finalSeverity = 'alerta';
                    escalationInfo = '⚠️ ESCALAMIENTO: 3+ faltas leves en una semana → ALERTA A TUTOR/PADRE';
                    alertStyle = 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;';
                } else if (currentBimesterIncidents >= 4) {
                    // Ya tiene 4+ faltas este bimestre, la siguiente sería la 5ta (TOE)
                    finalSeverity = 'toe';
                    escalationInfo = '🚨 ESCALAMIENTO: 5+ faltas leves en bimestre → CITACIÓN FORMAL EN TOE';
                    alertStyle = 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;';
                } else {
                    escalationInfo = `📊 Historial: ${currentWeekIncidents} falta(s) esta semana, ${currentBimesterIncidents} este bimestre`;
                    alertStyle = 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;';
                }
            } else if (baseSeverity === 'grave' || baseSeverity === 'muy_grave') {
                escalationInfo = '🔴 DERIVACIÓN INMEDIATA A TOE/DIRECCIÓN (sin esperar conteos)';
                alertStyle = 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; font-weight: bold;';
            }

            // Mostrar información de severidad final
            let severityColor = getSeverityColor(finalSeverity);
            let severityLabel = getSeverityLabel(finalSeverity);
            
            severidadDisplay.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: ${severityColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                        ${severityLabel.toUpperCase()}
                    </span>
                    <span>${escalationInfo}</span>
                </div>
            `;
            severidadDisplay.style.cssText = alertStyle + ' padding: 12px; border-radius: 6px;';
        }

        // Funciones auxiliares para conteo de incidencias
        function countIncidentsInCurrentWeek(history) {
            const now = new Date();
            const currentWeekStart = new Date(now);
            currentWeekStart.setDate(now.getDate() - now.getDay()); // Inicio de semana (domingo)
            
            return history.filter(incident => {
                const incidentDate = new Date(incident.date);
                return incidentDate >= currentWeekStart && incident.severity === 'leve';
            }).length;
        }

        function countIncidentsInCurrentBimester(history) {
            const now = new Date();
            const currentBimesterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 2) * 2, 1);
            
            return history.filter(incident => {
                const incidentDate = new Date(incident.date);
                return incidentDate >= currentBimesterStart && incident.severity === 'leve';
            }).length;
        }

        function getSeverityColor(severity) {
            const colors = {
                'leve': '#28a745',
                'alerta': '#ffc107',
                'toe': '#fd7e14',
                'grave': '#dc3545',
                'muy_grave': '#6f42c1'
            };
            return colors[severity] || '#6c757d';
        }

        function getSeverityLabel(severity) {
            const labels = {
                'leve': 'Leve',
                'alerta': 'Alerta - Tutor',
                'toe': 'TOE - Citación',
                'grave': 'Grave',
                'muy_grave': 'Muy Grave'
            };
            return labels[severity] || 'No definida';
        }

        // Manejar selección de "Otras que la autoridad indique"
        function handleOtrasSelection() {
            const demeritoSelect = document.getElementById('demeritoSelect');
            const selectedOption = demeritoSelect.options[demeritoSelect.selectedIndex];
            const descripcionTextarea = document.getElementById('descripcionDetallada');
            
            // Obtener el código del atributo data-codigo para verificar si es "Otras"
            const codigo = selectedOption ? selectedOption.getAttribute('data-codigo') : '';
            
            // Si se seleccionó una opción de "Otras" (códigos que empiezan con Q u otros similares)
            const esOtras = codigo && (codigo.toUpperCase() === 'Q' || codigo.toLowerCase().includes('otra'));
            
            if (esOtras) {
                setTimeout(() => {
                    descripcionTextarea.focus();
                    descripcionTextarea.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    
                    // Cambiar el placeholder para dar más contexto
                    descripcionTextarea.placeholder = '📝 Describa detalladamente la otra falta cometida por el estudiante (especifique qué norma o acuerdo incumplió)...';
                    
                    // Agregar un efecto visual temporal
                    descripcionTextarea.style.border = '2px solid var(--color-ata-dorado)';
                    descripcionTextarea.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.3)';
                    
                    setTimeout(() => {
                        descripcionTextarea.style.border = '2px solid #e9ecef';
                        descripcionTextarea.style.boxShadow = 'none';
                    }, 2000);
                }, 100);
            } else {
                // Restablecer el placeholder original
                descripcionTextarea.placeholder = 'Describa la situación detalladamente...';
            }
        }

        // Procesar envío del formulario de incidencia (REAL - Supabase)
        async function submitIncident(event) {
            event.preventDefault();
            
            // Verificar que hay estudiante seleccionado
            if (!estudianteSeleccionado) {
                mostrarAlerta('Por favor seleccione un estudiante de la lista', 'Estudiante Requerido', 'warning');
                document.getElementById('studentSearch').focus();
                return;
            }
            
            const tipoRegistro = document.getElementById('tipoRegistro').value;
            const descripcion = document.getElementById('descripcionDetallada').value;
            const testigos = document.getElementById('testigos').value;
            const aulaSeleccionada = document.getElementById('aulaSelect').value;
            
            if (!tipoRegistro) {
                mostrarAlerta('Por favor seleccione el tipo de registro (Mérito o Demérito)', 'Tipo Requerido', 'warning');
                return;
            }
            
            // Extraer grado y sección del aula seleccionada
            // Formato: "1SA" = 1° Secundaria A, "3PA" = 3° Primaria A, "5A" = Inicial 5 años A
            let nuevoGrado = null;
            let nuevaSeccion = null;
            
            if (aulaSeleccionada) {
                if (aulaSeleccionada.includes('S')) {
                    // Secundaria: 1SA, 2SB, etc.
                    nuevoGrado = aulaSeleccionada.charAt(0);
                    nuevaSeccion = aulaSeleccionada.charAt(2);
                } else if (aulaSeleccionada.includes('P')) {
                    // Primaria: 1PA, 2PB, etc.
                    nuevoGrado = aulaSeleccionada.charAt(0);
                    nuevaSeccion = aulaSeleccionada.charAt(2);
                } else {
                    // Inicial: 3A, 4B, 5C, etc.
                    nuevoGrado = aulaSeleccionada.charAt(0);
                    nuevaSeccion = aulaSeleccionada.charAt(1);
                }
            }
            
            // Preparar datos de la incidencia
            let incidenciaData = {
                estudianteId: estudianteSeleccionado.id,
                tipo: tipoRegistro,
                descripcion: descripcion + (testigos ? `\n\nTestigos: ${testigos}` : ''),
                catalogoMeritoId: null,
                catalogoDemeritoId: null,
                severidad: null,
                codigo: null,
                // Datos para actualizar grado/sección si cambió
                gradoActual: estudianteSeleccionado.grado,
                seccionActual: estudianteSeleccionado.seccion,
                nuevoGrado: nuevoGrado,
                nuevaSeccion: nuevaSeccion
            };

            if (tipoRegistro === 'merito') {
                const meritoSelect = document.getElementById('meritoSelect');
                const meritoValue = meritoSelect.value;
                if (!meritoValue) {
                    mostrarAlerta('Por favor seleccione un mérito de la lista', 'Mérito Requerido', 'warning');
                    return;
                }
                // Buscar el ID del mérito en el catálogo
                const meritos = await getCatalogoMeritos();
                const merito = meritos.find(m => m.codigo === meritoValue.split('-')[1] || m.codigo === meritoValue);
                if (merito) {
                    incidenciaData.catalogoMeritoId = merito.id;
                    incidenciaData.codigo = merito.codigo;
                }
                
            } else if (tipoRegistro === 'demerito') {
                const demeritoSelect = document.getElementById('demeritoSelect');
                const demeritoValue = demeritoSelect.value;
                
                console.log('🔍 DEBUG Demérito - Valor seleccionado:', demeritoValue);
                
                if (!demeritoValue) {
                    mostrarAlerta('Por favor seleccione una falta de la lista', 'Falta Requerida', 'warning');
                    return;
                }
                
                const selectedOption = demeritoSelect.options[demeritoSelect.selectedIndex];
                const severidad = selectedOption.getAttribute('data-severity');
                
                // Buscar el ID del demérito en el catálogo
                const demeritos = await getCatalogoDemeritros();
                console.log('📋 Catálogo de deméritos cargado:', demeritos);
                console.log('🔍 Buscando código:', demeritoValue, 'o', demeritoValue.split('-')[1]);
                
                // Buscar por ID directamente (el value del select es el ID del demérito)
                let demerito = demeritos.find(d => d.id === demeritoValue);
                
                // Si no encuentra por ID, buscar por código
                if (!demerito) {
                    demerito = demeritos.find(d => d.codigo === demeritoValue.split('-')[1] || d.codigo === demeritoValue);
                }
                
                console.log('✅ Demérito encontrado:', demerito);
                
                if (demerito) {
                    incidenciaData.catalogoDemeritoId = demerito.id;
                    incidenciaData.codigo = demerito.codigo;
                    incidenciaData.severidad = demerito.severidad || severidad;
                } else {
                    console.error('❌ NO se encontró el demérito en el catálogo!');
                    mostrarAlerta('No se pudo encontrar el demérito seleccionado. Por favor intente de nuevo.', 'Error', 'error');
                    return;
                }
            }
            
            // Mostrar loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
            submitBtn.disabled = true;
            
            // Registrar en Supabase
            const resultado = await registrarIncidencia(incidenciaData);
            
            // Restaurar botón
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (resultado.success) {
                const tipoTexto = tipoRegistro === 'merito' ? '🏆 MÉRITO' : '⚠️ DEMÉRITO';
                await mostrarAlerta(
                    `<div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 15px;">${tipoRegistro === 'merito' ? '🏆' : '⚠️'}</div>
                        <strong style="font-size: 18px;">${tipoTexto} REGISTRADO</strong>
                    </div>
                    <hr style="margin: 15px 0;">
                    <p><i class="fas fa-user-graduate"></i> <strong>Estudiante:</strong> ${estudianteSeleccionado.nombre_completo}</p>
                    <p><i class="fas fa-school"></i> <strong>Aula:</strong> ${estudianteSeleccionado.grado}°${estudianteSeleccionado.seccion}</p>
                    <hr style="margin: 15px 0;">
                    <p style="color: #666;"><i class="fas fa-save"></i> La incidencia ha sido guardada en el sistema.</p>
                    <p style="color: #666;"><i class="fas fa-envelope"></i> El padre de familia será notificado.</p>`,
                    '✅ Registro Exitoso',
                    'success'
                );
                
                // Reset del formulario
                document.getElementById('incidenciaForm').reset();
                clearStudentSelection();
                toggleMeritosDemeritosSections();
                
                // Actualizar TODOS los datos SIN recargar página
                console.log('🔄 Actualizando datos después de registro...');
                
                // Actualizar estadísticas del dashboard
                await actualizarDashboardStats();
                
                // Actualizar contadores específicos del rol
                await cargarDatosEspecificosRol();
                
                // Actualizar historial
                await renderizarHistorial();
                
                // Si el usuario tiene acceso a reportes, también actualizarlos en background
                const rolActual = currentUser?.role?.toLowerCase() || '';
                if (rolActual.includes('tutor') || rolActual.includes('toe') || rolActual.includes('direc') || rolActual.includes('admin')) {
                    // Actualizar reportes en background (sin esperar)
                    cargarDatosReportes().catch(e => console.log('Reportes se actualizarán cuando se acceda'));
                }
                
                console.log('✅ Todos los datos actualizados correctamente');
                
                // Volver al dashboard
                setTimeout(() => {
                    showSection('dashboard');
                }, 1500);
            } else {
                mostrarAlerta(
                    `<p><strong>Error al registrar incidencia:</strong></p>
                    <p style="color: #e74c3c;">${resultado.error}</p>
                    <hr style="margin: 15px 0;">
                    <p>Por favor intente nuevamente.</p>`,
                    '❌ Error',
                    'error'
                );
            }
        }

        // Funciones para el buscador de estudiantes
        let searchTimeout = null;
        
        async function handleStudentSearch(query) {
            const resultsContainer = document.getElementById('studentSearchResults');
            
            // Limpiar timeout anterior
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (!query || query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Mostrar loading
            resultsContainer.innerHTML = '<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
            resultsContainer.style.display = 'block';
            
            // Debounce de 300ms
            searchTimeout = setTimeout(async () => {
                const estudiantes = await buscarEstudiantes(query);
                
                if (estudiantes.length === 0) {
                    resultsContainer.innerHTML = '<div class="autocomplete-empty">No se encontraron estudiantes</div>';
                } else {
                    resultsContainer.innerHTML = estudiantes.map(est => `
                        <div class="autocomplete-item" onclick="selectStudent(${JSON.stringify(est).replace(/"/g, '&quot;')})">
                            <div class="student-name">${est.nombre_completo}</div>
                            <div class="student-info">
                                ${est.grado}° ${est.seccion} - ${est.nivel.charAt(0).toUpperCase() + est.nivel.slice(1)}
                                ${est.dni ? ` | DNI: ${est.dni}` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }, 300);
        }
        
        function selectStudent(estudiante) {
            estudianteSeleccionado = estudiante;
            
            // Actualizar UI
            document.getElementById('studentSearch').value = estudiante.nombre_completo;
            document.getElementById('studentId').value = estudiante.id;
            document.getElementById('studentSearchResults').style.display = 'none';
            
            // Mostrar info del estudiante seleccionado
            document.getElementById('studentSelectedInfo').style.display = 'block';
            document.getElementById('studentSelectedName').textContent = 
                `${estudiante.nombre_completo} - ${estudiante.grado}°${estudiante.seccion}`;
            
            // Auto-seleccionar el aula
            const aulaValue = `${estudiante.grado}S${estudiante.seccion}`;
            const aulaSelect = document.getElementById('aulaSelect');
            for (let option of aulaSelect.options) {
                if (option.value === aulaValue) {
                    aulaSelect.value = aulaValue;
                    break;
                }
            }
        }
        
        function clearStudentSelection() {
            estudianteSeleccionado = null;
            document.getElementById('studentSearch').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentSelectedInfo').style.display = 'none';
            document.getElementById('aulaSelect').value = '';
        }

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.form-group[style*="position: relative"]');
            const resultsContainer = document.getElementById('studentSearchResults');
            if (searchContainer && resultsContainer && !searchContainer.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });

        // ==================== FUNCIONES ADMINISTRATIVAS ADICIONALES ====================
        
        // Sistema de Backup
        function performBackup() {
            mostrarAlerta(
                `<div style="text-align: center; margin-bottom: 15px;">
                    <i class="fas fa-database" style="font-size: 48px; color: var(--color-ata-verde);"></i>
                </div>
                <p><i class="fas fa-sync fa-spin"></i> <strong>Iniciando backup completo...</strong></p>
                <hr style="margin: 15px 0;">
                <p><strong>📋 INCLUYE:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Base de datos de usuarios</li>
                    <li>Historial completo de incidencias</li>
                    <li>Configuración del sistema</li>
                    <li>Archivos adjuntos y documentos</li>
                    <li>Logs de auditoría</li>
                </ul>
                <hr style="margin: 15px 0;">
                <p><i class="fas fa-folder"></i> <strong>Ubicación:</strong> /backups/backup_${new Date().toISOString().slice(0,10)}.sql</p>
                <p><i class="fas fa-clock"></i> <strong>Tiempo estimado:</strong> 3-5 minutos</p>
                <p style="color: #28a745;"><i class="fas fa-check-circle"></i> El sistema seguirá funcionando normalmente</p>`,
                '💾 Backup del Sistema',
                'info'
            );
        }

        // Reportes del Sistema
        function generateSystemReport() {
            mostrarAlerta(
                `<div style="text-align: center; margin-bottom: 15px;">
                    <i class="fas fa-chart-bar" style="font-size: 48px; color: var(--color-ata-verde);"></i>
                </div>
                <p><strong>📈 ESTADÍSTICAS DE USO (${new Date().toLocaleDateString('es-PE', {month: 'long', year: 'numeric'})}):</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Sesiones de usuario: 1,847</li>
                    <li>Incidencias registradas: 89</li>
                    <li>Usuarios activos: 156</li>
                    <li>Promedio diario: 12 incidencias</li>
                </ul>
                <hr style="margin: 15px 0;">
                <p><strong>🏆 TOP USUARIOS MÁS ACTIVOS:</strong></p>
                <ol style="margin-left: 20px;">
                    <li>Prof. María González (Docente) - 23 registros</li>
                    <li>Ana Torres (Auxiliar) - 18 registros</li>
                    <li>Carlos Ruiz (Tutor) - 15 registros</li>
                </ol>
                <hr style="margin: 15px 0;">
                <p><strong>🎯 INDICADORES CLAVE:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Tiempo respuesta promedio: 2.3 horas</li>
                    <li>Satisfacción usuarios: 94%</li>
                    <li>Casos resueltos: 87%</li>
                </ul>`,
                '📊 Reporte General del Sistema',
                'info'
            );
        }

        // Configuración Avanzada de Estudiantes
        function showStudentConfig() {
            mostrarAlerta(
                `<div style="text-align: center; margin-bottom: 15px;">
                    <i class="fas fa-user-graduate" style="font-size: 48px; color: var(--color-ata-verde);"></i>
                </div>
                <p><strong>📊 CONFIGURACIÓN ACTUAL:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Total estudiantes: 847</li>
                    <li>Promedio por aula: 28.2 estudiantes</li>
                    <li>Edad promedio: 9.3 años</li>
                </ul>
                <hr style="margin: 15px 0;">
                <p><strong>📋 DATOS DISPONIBLES:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Información personal completa</li>
                    <li>Historial académico</li>
                    <li>Contactos de emergencia</li>
                    <li>Problemas de salud registrados</li>
                    <li>Evaluaciones TOE</li>
                </ul>
                <hr style="margin: 15px 0;">
                <p><strong>🔧 FUNCIONES ADMINISTRATIVAS:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Matricular nuevos estudiantes</li>
                    <li>Transferir entre secciones</li>
                    <li>Actualizar datos personales</li>
                    <li>Generar carnés estudiantiles</li>
                    <li>Exportar listas por grado/sección</li>
                </ul>
                <p style="color: #666; margin-top: 15px;"><i class="fas fa-hand-pointer"></i> Use los botones de acción para gestionar estudiantes.</p>`,
                '👨‍🎓 Gestión Avanzada de Estudiantes',
                'info'
            );
        }

        // 🚨 FUNCIÓN DE DEBUG TEMPORAL - Para probar login
        function debugLogin() {
            console.log('🧪 === DEBUG LOGIN ===');
            console.log('selectedUserRole:', selectedUserRole);
            console.log('users object:', users);
            console.log('loginForm element:', document.getElementById('loginForm'));
            console.log('username value:', document.getElementById('username').value);
            console.log('password value:', document.getElementById('password').value);
            
            // Forzar login con demo_docente
            selectedUserRole = 'docente';
            currentUser = { username: 'demo_docente', ...users['demo_docente'] };
            console.log('currentUser set:', currentUser);
            login();
        }
        
        // Hacer función disponible globalmente
        window.debugLogin = debugLogin;
        
        // Función de prueba simple para verificar que JavaScript funciona
        function testButton() {
            mostrarAlerta('¡JavaScript funciona! El botón responde.', 'Test Exitoso', 'success');
            console.log('🎯 TEST: El botón funciona correctamente');
        }
        
        // Hacer la función de prueba disponible globalmente
        window.testButton = testButton;
        window.handleLoginClick = handleLoginClick;
        
        console.log('🚀 JavaScript cargado completamente');
    </script>
</body>
</html>
