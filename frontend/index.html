<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Virtual ATA - I.E. 80002 Antonio Torres Araujo</title>
    <link rel="icon" type="image/x-icon" href="./assets/images/INSIGNIA_I.E.ANTONIO_TORRES_ARAUJO.ico">
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Variables CSS con colores institucionales ATA */
        :root {
            --color-ata-verde: #006B3F;
            --color-ata-verde-claro: #4CAF50;
            --color-ata-rojo: #C1272D;
            --color-ata-rojo-claro: #F44336;
            --color-ata-dorado: #FFD700;
            --color-ata-azul: #1E90FF;
            --color-ata-negro: #2C3E50;
            --color-ata-gris: #7F8C8D;
            --color-ata-gris-claro: #ECF0F1;
            
            /* Sombras */
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 8px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 16px rgba(0, 0, 0, 0.2);
            
            /* Fuentes */
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Reset y base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: #f8f9fa;
            color: var(--color-ata-negro);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--color-ata-verde) 0%, var(--color-ata-verde-claro) 100%);
            color: white;
            padding: 15px 0;
            box-shadow: var(--shadow-medium);
            position: relative;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 55px;
            height: 55px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: var(--color-ata-verde);
            padding: 6px;
        }

        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        .header-text h1 {
            font-size: 24px;
            margin: 0;
        }

        .header-text p {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
        }

        /* Navegación principal */
        .main-nav {
            background: var(--color-ata-verde);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .main-nav .nav-menu {
            display: flex;
            gap: 20px;
            list-style: none;
            justify-content: center;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
            list-style: none;
        }

        .nav-item a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item a:hover,
        .nav-item a.active {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-ata-verde) 0%, var(--color-ata-azul) 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: var(--shadow-heavy);
            width: 100%;
            max-width: 500px;
            max-height: 95vh;
            text-align: center;
            overflow-y: auto;
            position: relative;
        }

        /* Mejorar scroll de la card de login */
        .login-card::-webkit-scrollbar {
            width: 6px;
        }

        .login-card::-webkit-scrollbar-track {
            background: transparent;
        }

        .login-card::-webkit-scrollbar-thumb {
            background: var(--color-ata-verde);
            border-radius: 3px;
        }

        .login-logo {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: white;
            font-size: 32px;
            padding: 15px;
            box-shadow: var(--shadow-medium);
        }

        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--color-ata-negro);
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--color-ata-gris);
            margin-bottom: 30px;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-ata-negro);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        /* Estilos para input-group con ícono de lupa */
        .input-group {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-group .form-input {
            padding-right: 45px;
        }

        .input-group-append {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            z-index: 2;
        }

        .input-group-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 100%;
            color: #6c757d;
            background: transparent;
            pointer-events: none;
        }

        /* Estilos para autocompletado de búsqueda */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--color-ata-verde);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #e8f5e9;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item .student-name {
            font-weight: 600;
            color: #333;
        }

        .autocomplete-item .student-info {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .autocomplete-loading {
            padding: 15px;
            text-align: center;
            color: #666;
        }

        .autocomplete-empty {
            padding: 15px;
            text-align: center;
            color: #999;
            font-style: italic;
        }

        .input-group-icon i {
            font-size: 16px;
        }

        .form-input:focus + .input-group-append .input-group-icon {
            color: var(--color-ata-verde);
        }

        .password-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            background: none;
            border: none;
            color: var(--color-ata-gris);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            z-index: 10;
            transition: color 0.3s ease;
        }

        .password-toggle:hover {
            color: var(--color-ata-verde);
        }

        .password-input {
            padding-right: 45px;
        }

        /* Estilos para el flujo de login en pasos */
        .login-step {
            overflow: hidden;
        }

        .login-step.hidden {
            display: none;
        }

        .login-step.visible {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
            }
        }

        /* Spinner de carga */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner-border {
            display: inline-block;
            width: 3rem;
            height: 3rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }

        .role-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .role-btn {
            padding: 15px 10px;
            border: 2px solid #e9ecef;
            background: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-ata-gris);
        }

        .role-btn:hover {
            border-color: var(--color-ata-verde);
            background: #f8f9fa;
            color: var(--color-ata-verde);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 107, 63, 0.15);
        }

        .role-btn.selected {
            border-color: var(--color-ata-verde);
            background: var(--color-ata-verde);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 107, 63, 0.25);
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-ata-verde);
            margin-bottom: 15px;
            text-align: center;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-ata-verde);
            box-shadow: 0 0 0 3px rgba(0, 107, 63, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn-primary {
            background: var(--color-ata-verde);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-ata-verde-claro);
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Main App Content (hidden initially) */
        .main-app {
            display: none !important;
            min-height: 100vh;
            flex-direction: column;
        }
        
        .main-app.show {
            display: flex !important;
        }

        .main-content {
            padding: 30px 0;
            flex: 1;
        }

        .page-title {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title h2 {
            font-size: 32px;
            color: var(--color-ata-verde);
            margin-bottom: 10px;
        }

        .page-title p {
            font-size: 18px;
            color: var(--color-ata-gris);
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-light);
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .card h3 {
            color: var(--color-ata-verde);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 25px;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Estadísticas */
        .stats-card {
            text-align: center;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow-light);
            border-left: 4px solid var(--color-ata-verde);
        }

        .stats-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--color-ata-verde);
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 14px;
            color: var(--color-ata-gris);
            margin-bottom: 10px;
        }

        .stats-trend {
            font-size: 12px;
            font-weight: bold;
        }

        .trend-up {
            color: var(--color-ata-rojo);
        }

        .trend-down {
            color: var(--color-ata-verde);
        }

        /* Botones */
        .btn-secondary {
            background: var(--color-ata-azul);
            color: white;
        }

        .btn-secondary:hover {
            background: #0066CC;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--color-ata-rojo);
            color: white;
        }

        .btn-danger:hover {
            background: var(--color-ata-rojo-claro);
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--color-ata-dorado);
            color: var(--color-ata-negro);
        }

        .btn-warning:hover {
            background: #FFC107;
            transform: translateY(-2px);
        }

        /* Estilos para sistema de solicitud de cuentas */
        .account-options {
            margin: 15px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--color-ata-verde);
            max-height: 500px;
            overflow-y: auto;
        }

        .demo-warning {
            margin-bottom: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            border-left: 4px solid var(--color-ata-dorado);
        }

        .demo-warning .alert {
            margin: 0;
            padding: 0;
            background: none;
            border: none;
            color: #856404;
        }

        .demo-actions {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .demo-actions .btn {
            flex: 1;
            min-width: 180px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: 2px solid #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
            transform: translateY(-2px);
        }

        .request-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .request-form.visible {
            display: block;
            animation: slideDown 0.3s ease-in-out;
        }

        /* Mejorar el scroll del formulario */
        .request-form::-webkit-scrollbar {
            width: 8px;
        }

        .request-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .request-form::-webkit-scrollbar-thumb {
            background: var(--color-ata-verde);
            border-radius: 4px;
        }

        .request-form::-webkit-scrollbar-thumb:hover {
            background: var(--color-ata-gris);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-section h5 {
            color: var(--color-ata-verde);
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: 600;
        }

        .verification-requirements {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--color-ata-azul);
        }

        .verification-requirements h6 {
            color: var(--color-ata-azul);
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .verification-requirements ul {
            margin: 0;
            padding-left: 20px;
            color: #1565c0;
            font-size: 13px;
        }

        .verification-requirements li {
            margin-bottom: 5px;
        }

        /* Mensajes de error/éxito inline */
        .form-message {
            margin-top: 10px;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
            animation: slideInDown 0.3s ease-out;
        }

        .form-message.show {
            display: block;
        }

        .form-message.error {
            background: #fee;
            border-left: 4px solid var(--color-ata-rojo);
            color: #c62828;
        }

        .form-message.success {
            background: #e8f5e8;
            border-left: 4px solid var(--color-ata-verde);
            color: #2e7d32;
        }

        .form-message.info {
            background: #e3f2fd;
            border-left: 4px solid var(--color-ata-azul);
            color: #1565c0;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-message i {
            margin-right: 8px;
        }

        .form-message code {
            background-color: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: bold;
        }

        .form-message small {
            opacity: 0.8;
            font-size: 12px;
        }

        /* Estilos eliminados: .demo-banner - ya no se usa banner DEMO */

        /* Alertas */
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-danger {
            background: #ffebee;
            color: #c62828;
            border-left-color: var(--color-ata-rojo);
        }

        .alert-warning {
            background: #fff9e6;
            color: #f57f17;
            border-left-color: var(--color-ata-dorado);
        }

        .alert-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left-color: var(--color-ata-azul);
        }

        .alert-success {
            background: #e8f5e8;
            color: #2e7d32;
            border-left-color: var(--color-ata-verde);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .badge-merito {
            background: rgba(33, 150, 243, 0.1);
            color: #1976d2;
        }

        .badge-leve {
            background: rgba(76, 175, 80, 0.1);
            color: var(--color-ata-verde);
        }

        .badge-grave {
            background: rgba(255, 215, 0, 0.2);
            color: #f57f17;
        }

        .badge-muy-grave {
            background: rgba(193, 39, 45, 0.1);
            color: var(--color-ata-rojo);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .modal-container {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            background: var(--color-ata-verde);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .detalle-row {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .detalle-row:last-child {
            border-bottom: none;
        }

        .detalle-label {
            font-weight: 600;
            color: var(--color-ata-verde);
            width: 140px;
            flex-shrink: 0;
        }

        .detalle-value {
            color: #333;
            flex: 1;
        }

        .detalle-descripcion {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            line-height: 1.6;
        }

        /* Tablas */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--color-ata-verde);
            color: white;
            padding: 16px;
            text-align: left;
            font-weight: 600;
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        /* Footer */
        .footer {
            background: var(--color-ata-negro);
            color: white;
            text-align: center;
            padding: 30px 0;
            margin-top: auto;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .footer-text {
            flex: 1;
        }

        .footer-links {
            display: flex;
            gap: 20px;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: var(--color-ata-dorado);
        }

        /* User info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .logout-btn {
            background: var(--color-ata-rojo);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--color-ata-rojo-claro);
        }

        /* Estilos específicos para administrador */
        .admin-card {
            border-left: 4px solid var(--color-ata-dorado);
            background: linear-gradient(135deg, #ffffff, #fffbf0);
        }

        .admin-card h3 {
            color: var(--color-ata-dorado);
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }

        .mini-stat {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .admin-stats {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        /* Estilos eliminados: .demo-banner responsive - ya no se usa */

        @media (max-width: 768px) {
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
            }

            .logo {
                width: 50px;
                height: 50px;
            }

            .login-logo {
                width: 100px;
                height: 100px;
                padding: 12px;
            }

            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }

            .page-title h2 {
                font-size: 24px;
            }

            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .stats-number {
                font-size: 24px;
            }

            .footer-content {
                flex-direction: column;
                text-align: center;
            }

            .login-card {
                padding: 30px 20px;
                max-width: 95%;
                max-height: 95vh;
            }

            .request-form {
                max-height: 400px;
                padding: 15px;
            }

            .account-options {
                max-height: 350px;
                padding: 15px;
            }

            .demo-actions {
                flex-direction: column;
            }

            .demo-actions .btn {
                min-width: auto;
                width: 100%;
            }

            .role-selection {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Login -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">
                <img src="./assets/images/INSIGNIA_I.E.ANTONIO_TORRES_ARAUJO.png" alt="Logo ATA" />
            </div>
            <h2 class="login-title">Agenda Virtual ATA</h2>
            <p class="login-subtitle">I.E. 80002 Antonio Torres Araujo<br>Sistema de Gestión de Incidencias</p>
            
            <form id="loginForm">
                <!-- Paso 1: Selección de tipo de cuenta -->
                <div id="step1" class="login-step visible">
                    <div class="step-title">
                        <i class="fas fa-user-tag"></i> Elige tu tipo de cuenta
                    </div>
                    <div class="role-selection">
                        <button type="button" class="role-btn" onclick="selectRole('docente')">
                            <i class="fas fa-chalkboard-teacher"></i><br>
                            Docente
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('tutor')">
                            <i class="fas fa-user-graduate"></i><br>
                            Tutor
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('auxiliar')">
                            <i class="fas fa-hands-helping"></i><br>
                            Auxiliar
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('toe')">
                            <i class="fas fa-user-shield"></i><br>
                            TOE
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('direccion')">
                            <i class="fas fa-user-tie"></i><br>
                            Dirección
                        </button>
                        <button type="button" class="role-btn" onclick="selectRole('padre')">
                            <i class="fas fa-user-friends"></i><br>
                            Padre/Madre
                        </button>
                    </div>
                    
                    <!-- Botón Administrador centrado y destacado -->
                    <div style="display: flex; justify-content: center; margin-top: 15px;">
                        <button type="button" class="role-btn admin-btn" onclick="selectRoleAdmin()" 
                                style="border: 2px solid var(--color-ata-dorado); background: #fff9e6; width: 160px; height: 80px; font-size: 14px;">
                            <i class="fas fa-user-cog" style="color: var(--color-ata-dorado); font-size: 20px;"></i><br>
                            <span style="color: var(--color-ata-dorado); font-weight: bold;">Administrador</span>
                        </button>
                    </div>
                </div>

                <!-- Paso 1b: Opciones de cuenta (Solicitar vs Demo) -->
                <div id="step1b" class="login-step hidden">
                    <div class="account-options">
                        <div class="alert alert-success" style="margin-bottom: 15px; background: #e8f5e8; border: none; color: var(--color-ata-verde);">
                            <i class="fas fa-check-circle"></i>
                            <span>Tipo de cuenta seleccionado: <strong id="selectedRoleText">Rol</strong></span>
                            <button type="button" onclick="backToRoleSelection()" style="background: none; border: none; color: var(--color-ata-verde); float: right; cursor: pointer; font-size: 16px;">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>

                        <div class="demo-warning">
                            <div class="alert">
                                <i class="fas fa-info-circle"></i>
                                <strong>¿Qué deseas hacer?</strong> Selecciona una opción para continuar
                            </div>
                            
                            <div class="demo-actions">
                                <button type="button" class="btn btn-primary" onclick="showDemoLogin()">
                                    <i class="fas fa-sign-in-alt"></i>
                                    Iniciar sesión
                                </button>
                                <button type="button" class="btn btn-warning" onclick="showActivarCuenta()">
                                    <i class="fas fa-key"></i>
                                    Activar cuenta por primera vez
                                </button>
                            </div>
                        </div>

                        <!-- Formulario de solicitud -->
                        <div id="requestForm" class="request-form">
                            <h5><i class="fas fa-file-alt"></i> Solicitud de Cuenta Oficial</h5>
                            
                            <div class="verification-requirements" id="roleRequirements">
                                <!-- Los requisitos se llenarán dinámicamente -->
                            </div>

                            <div class="form-section">
                                <h6>Datos Personales</h6>
                                <div class="form-group">
                                    <label class="form-label">Nombres y Apellidos Completos</label>
                                    <input type="text" class="form-input" placeholder="Ingrese su nombre completo" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">DNI</label>
                                    <input type="text" class="form-input" placeholder="Número de DNI" maxlength="8" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email Institucional o Personal</label>
                                    <input type="email" class="form-input" placeholder="correo@ejemplo.com" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Teléfono/Celular</label>
                                    <input type="tel" class="form-input" placeholder="999 999 999" required>
                                </div>
                            </div>

                            <div class="form-section" id="specificFields">
                                <!-- Campos específicos según el rol -->
                            </div>

                            <div class="demo-actions">
                                <button type="button" class="btn btn-secondary" onclick="cancelRequest()">
                                    <i class="fas fa-times"></i>
                                    Cancelar
                                </button>
                                <button type="button" class="btn btn-primary" onclick="submitRequest()">
                                    <i class="fas fa-paper-plane"></i>
                                    Enviar Solicitud
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Paso 3: Activación de cuenta (Verificación + Contraseña) -->
                <div id="step3" class="login-step hidden">
                    <div id="selectedRoleActivacion" class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <span>Activando cuenta: <strong id="roleTextActivacion">Rol seleccionado</strong></span>
                        <button type="button" onclick="backToRoleSelection()" style="background: none; border: none; color: var(--color-ata-verde); float: right; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    
                    <!-- Paso 3a: Verificar cuenta existe -->
                    <div id="step3a" style="display: block;">
                        <h5 style="color: var(--color-ata-verde); margin-bottom: 15px;">
                            <i class="fas fa-user-check"></i> Verifica que tu cuenta existe
                        </h5>
                        
                        <div class="alert" style="background: #e3f2fd; border-left: 4px solid var(--color-ata-azul); padding: 12px; margin-bottom: 20px;">
                            <i class="fas fa-info-circle" style="color: var(--color-ata-azul);"></i>
                            <strong style="color: var(--color-ata-azul);">Ingresa tu DNI o tu Nombre Completo</strong>
                            <p style="margin: 5px 0 0 0; font-size: 13px; color: #1565c0;">Puedes buscar por uno u otro campo</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-id-card"></i> DNI (8 dígitos) - Opcional
                            </label>
                            <input type="text" id="verificar_dni" class="form-input" placeholder="Ej: 12345678" maxlength="8" pattern="[0-9]{8}">
                            <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> Solo números, sin guiones ni espacios
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-user"></i> Nombre Completo - Opcional
                            </label>
                            <input type="text" id="verificar_nombre" class="form-input" placeholder="GARCIA PEREZ JUAN CARLOS" style="text-transform: uppercase;">
                            <small style="color: #6c757d; font-size: 12px; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> <strong>Formato:</strong> APELLIDO PATERNO + APELLIDO MATERNO + NOMBRES
                            </small>
                            <small style="color: #856404; background: #fff3cd; padding: 8px; border-radius: 4px; font-size: 11px; display: block; margin-top: 8px;">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Todo en MAYÚSCULAS, sin tildes, sin comas. 
                                <strong>Ejemplo:</strong> GARCIA PEREZ JUAN CARLOS
                            </small>
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="verificarCuentaExiste()" id="btnVerificar">
                            <i class="fas fa-search"></i>
                            Verificar
                        </button>
                        
                        <!-- Spinner de carga -->
                        <div id="verificarSpinner" style="display: none; text-align: center; margin-top: 20px;">
                            <div class="spinner-border" style="width: 3rem; height: 3rem; border: 4px solid #f3f3f3; border-top: 4px solid var(--color-ata-verde); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 10px; color: var(--color-ata-verde); font-weight: bold;">Verificando en el sistema...</p>
                        </div>
                        
                        <!-- Mensaje de verificación -->
                        <div id="verificarMessage" class="form-message"></div>
                    </div>
                    
                    <!-- Paso 3b: Registrar datos y crear contraseña (solo si verificación exitosa) -->
                    <div id="step3b" style="display: none;">
                        <div class="alert alert-success" style="margin-bottom: 20px;">
                            <i class="fas fa-check-circle"></i>
                            <strong>¡Cuenta encontrada!</strong> Completa tu información y crea tu contraseña.
                        </div>
                        
                        <!-- PASO 1: Verificar/Registrar DNI -->
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-id-card"></i> DNI (8 dígitos)
                                <span style="color: red;">*</span>
                            </label>
                            <div style="position: relative;">
                                <input type="text" id="dni_activacion" class="form-input" placeholder="12345678" maxlength="8" pattern="[0-9]{8}" style="padding-right: 50px;">
                                <span id="dniCheckIcon" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: none;">
                                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 20px;"></i>
                                </span>
                            </div>
                            <div id="dniVerificacionMessage" class="form-message" style="margin-top: 10px;"></div>
                        </div>
                        
                        <!-- PASO 2: Verificar/Registrar Email -->
                        <div class="form-group" id="emailSection" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-envelope"></i> Correo Electrónico
                                <span style="color: red;">*</span>
                            </label>
                            <div style="position: relative;">
                                <input type="email" id="email_activacion" class="form-input" placeholder="ejemplo@correo.com" style="padding-right: 120px;">
                                <button type="button" onclick="verificarEmailDisponible()" class="btn btn-secondary" id="btnVerificarEmail" style="position: absolute; right: 5px; top: 5px; padding: 8px 12px; font-size: 13px; width: auto;">
                                    <i class="fas fa-search"></i> Verificar
                                </button>
                            </div>
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> Necesario para recuperar contraseña y recibir notificaciones
                            </small>
                            <div id="emailVerificacionMessage" class="form-message" style="margin-top: 10px;"></div>
                        </div>
                        
                        <!-- PASO 3: Verificar/Registrar Teléfono (Opcional) -->
                        <div class="form-group" id="telefonoSection" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-phone"></i> Número de Teléfono
                                <span style="color: #999; font-weight: normal; font-size: 12px;">(Opcional)</span>
                            </label>
                            <div style="position: relative;">
                                <input type="tel" id="telefono_activacion" class="form-input" placeholder="999999999" maxlength="9" pattern="[0-9]{9}" style="padding-right: 50px;">
                                <span id="telefonoCheckIcon" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); display: none;">
                                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 20px;"></i>
                                </span>
                            </div>
                            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> Opcional: Para contacto y notificaciones SMS
                            </small>
                            <div id="telefonoVerificacionMessage" class="form-message" style="margin-top: 10px;"></div>
                            <button type="button" onclick="continuarSinTelefono()" class="btn btn-secondary" style="width: 100%; margin-top: 10px; font-size: 13px;">
                                Continuar sin teléfono
                            </button>
                        </div>
                        
                        <!-- PASO 4: Crear Contraseña -->
                        <div id="passwordSection" style="display: none;">
                            <hr style="margin: 25px 0; border: none; border-top: 1px solid #e0e0e0;">
                            
                            <h6 style="color: var(--color-ata-azul); margin-bottom: 15px; font-size: 15px; font-weight: 600;">
                                <i class="fas fa-key"></i> Crear Contraseña
                            </h6>
                            
                            <!-- Indicadores de requisitos de contraseña -->
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--color-ata-azul);">
                                <h6 style="color: var(--color-ata-azul); margin-bottom: 10px; font-size: 14px; font-weight: 600;">
                                    <i class="fas fa-shield-alt"></i> Requisitos de seguridad:
                                </h6>
                                <ul style="margin: 0; padding-left: 20px; color: #1565c0; font-size: 13px;">
                                    <li id="req-length" style="margin-bottom: 5px;">
                                        <i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i>
                                        Mínimo 6 caracteres
                                    </li>
                                    <li id="req-match" style="margin-bottom: 5px;">
                                        <i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i>
                                        Las contraseñas deben coincidir
                                    </li>
                                </ul>
                            </div>
                            
                            <!-- Medidor de seguridad de contraseña -->
                            <div id="password-strength-container" style="margin-bottom: 20px; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 13px; font-weight: 600; color: #666;">Nivel de seguridad:</span>
                                    <span id="password-strength-text" style="font-size: 13px; font-weight: bold;">-</span>
                                </div>
                                <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                    <div id="password-strength-bar" style="height: 100%; width: 0%; transition: all 0.3s ease; border-radius: 4px;"></div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Nueva Contraseña</label>
                                <div class="password-container">
                                    <input type="password" id="nueva_password" class="form-input password-input" placeholder="Mínimo 6 caracteres" required oninput="validarPasswordRequisitos()">
                                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('nueva_password', 'nueva_password_icon')">
                                        <i class="fas fa-eye" id="nueva_password_icon"></i>
                                    </button>
                                </div>
                            </div>
                        
                            <div class="form-group">
                                <label class="form-label">Confirmar Contraseña</label>
                                <div class="password-container">
                                    <input type="password" id="confirmar_password" class="form-input password-input" placeholder="Repite la contraseña" required oninput="validarPasswordRequisitos()">
                                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmar_password', 'confirmar_password_icon')">
                                        <i class="fas fa-eye" id="confirmar_password_icon"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-success" onclick="activarCuentaFinal()" id="btnActivar">
                                <i class="fas fa-check-circle"></i>
                                Crear Contraseña y Activar Cuenta
                            </button>
                            
                            <div id="activarMessage" class="form-message"></div>
                        </div>
                        
                        <button type="button" class="btn btn-secondary" onclick="volverAVerificar()" style="margin-top: 10px;">
                            <i class="fas fa-arrow-left"></i>
                            Volver a verificar
                        </button>
                    </div>
                </div>

                <!-- Paso 4: Recuperación de contraseña -->
                <div id="step4" class="login-step hidden">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <i class="fas fa-key" style="font-size: 48px; color: var(--color-ata-azul);"></i>
                        <h3 class="step-title">Recuperar Contraseña</h3>
                        <p style="color: var(--color-ata-gris); font-size: 14px;">Ingresa tu DNI o Nombre Completo</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">DNI (8 dígitos) - Opcional</label>
                        <input type="text" id="recuperar_dni" class="form-input" placeholder="Ej: 12345678" maxlength="8" pattern="[0-9]{8}">
                        <small style="color: #666; font-size: 12px;">
                            <i class="fas fa-info-circle"></i> Solo números, sin guiones ni espacios
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nombre Completo - Opcional</label>
                        <input type="text" id="recuperar_nombre" class="form-input" placeholder="APELLIDO PATERNO + APELLIDO MATERNO + NOMBRES" style="text-transform: uppercase;">
                        <small style="color: #666; font-size: 12px;">
                            ⚠️ Todo en MAYÚSCULAS, sin tildes, sin comas. <strong>Ejemplo:</strong> GARCIA PEREZ JUAN CARLOS
                        </small>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="verificarDNIparaRecuperar()" id="btnVerificarRecuperar">
                        <i class="fas fa-search"></i>
                        Buscar mi cuenta
                    </button>
                    
                    <button type="button" class="btn btn-secondary" onclick="volverALogin()" style="margin-top: 10px;">
                        <i class="fas fa-arrow-left"></i>
                        Volver al login
                    </button>
                    
                    <div id="recuperarMessage" class="form-message"></div>
                    
                    <!-- Formulario para verificar email (oculto hasta verificar DNI) -->
                    <div id="step4b" style="display: none; margin-top: 25px;">
                        <div class="alert alert-success" style="margin-bottom: 20px;">
                            <i class="fas fa-check-circle"></i>
                            <strong>Identidad verificada</strong><br>
                            <small id="nombreUsuarioRecuperar"></small>
                        </div>
                        
                        <!-- Campo de email para verificar identidad -->
                        <div class="form-group">
                            <label class="form-label">Correo Electrónico <span style="color: red;">*</span></label>
                            <input type="email" id="email_verificar_recuperar" class="form-input" placeholder="ejemplo@correo.com" style="text-transform: lowercase;">
                            <small style="color: #666; font-size: 12px;">
                                <i class="fas fa-info-circle"></i> Ingresa tu correo electrónico completo para verificar tu identidad
                            </small>
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="enviarEmailRecuperacion()" id="btnEnviarRecuperacion">
                            <i class="fas fa-envelope"></i>
                            Enviar enlace de recuperación
                        </button>
                        
                        <button type="button" class="btn btn-secondary" onclick="volverALogin()" style="margin-top: 10px;">
                            <i class="fas fa-arrow-left"></i>
                            Cancelar
                        </button>
                        
                        <div id="cambiarMessage" class="form-message"></div>
                    </div>
                    
                    <!-- Step 5: Email enviado (animación) -->
                    <div id="step5" style="display: none; margin-top: 30px; text-align: center;">
                        <div style="margin-bottom: 20px;">
                            <div style="display: inline-block; width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                                <i class="fas fa-envelope-circle-check" style="font-size: 40px; color: white;"></i>
                            </div>
                        </div>
                        
                        <h3 style="color: #28a745; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> ¡Correo Enviado!
                        </h3>
                        
                        <p style="color: #666; font-size: 15px; line-height: 1.6; margin-bottom: 20px;">
                            Hemos enviado un enlace de recuperación a tu correo electrónico:<br>
                            <strong id="emailEnviadoDestino" style="color: #007bff;"></strong>
                        </p>
                        
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 20px;">
                            <p style="margin: 0; font-size: 13px; color: #004085; text-align: left;">
                                <i class="fas fa-lightbulb"></i> <strong>Próximos pasos:</strong><br>
                                1. Revisa tu bandeja de entrada<br>
                                2. Haz clic en el enlace del correo<br>
                                3. Crea tu nueva contraseña<br>
                                <small style="color: #666;"><i class="fas fa-clock"></i> El enlace es válido por 1 hora</small>
                            </p>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="volverALogin()" style="width: 100%;">
                            <i class="fas fa-arrow-left"></i>
                            Volver al inicio de sesión
                        </button>
                    </div>
                </div>

                <!-- Paso 2: Campos de usuario y contraseña -->
                <div id="step2" class="login-step hidden">
                    <div id="selectedRole" class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <span>Tipo de cuenta: <strong id="roleText">Rol seleccionado</strong></span>
                        <button type="button" onclick="backToRoleSelection()" style="background: none; border: none; color: var(--color-ata-verde); float: right; cursor: pointer; font-size: 16px;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">DNI o Correo Electrónico</label>
                        <input type="text" id="username" class="form-input" placeholder="Ej: 12345678 o usuario@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contraseña</label>
                        <div class="password-container">
                            <input type="password" id="password" class="form-input password-input" placeholder="Ingrese su contraseña" required>
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                                <i class="fas fa-eye" id="password-icon"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="handleLoginClick()">
                        <i class="fas fa-sign-in-alt"></i>
                        Iniciar Sesión
                    </button>
                    
                    <!-- Enlace "Olvidé mi contraseña" -->
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" onclick="mostrarRecuperacionPassword(); return false;" style="color: var(--color-ata-azul); font-size: 14px; text-decoration: none;">
                            <i class="fas fa-key"></i> ¿Olvidaste tu contraseña?
                        </a>
                    </div>
                    
                    <!-- Contenedor para mensajes de login -->
                    <div id="loginMessage" class="form-message">
                        <!-- Los mensajes aparecerán aquí -->
                    </div>
                    
                    <!-- Enlace para activar cuenta -->
                    <div id="activarCuentaLink" style="display: none; text-align: center; margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <i class="fas fa-info-circle" style="color: #856404;"></i>
                        <span style="color: #856404; font-size: 14px;">
                            ¿Aún no has activado tu cuenta? 
                            <a href="#" onclick="backToStep1bAndActivate(); return false;" style="color: var(--color-ata-verde); font-weight: bold; text-decoration: underline;">Activa tu cuenta aquí</a>
                        </span>
                    </div>
                    
                    <!-- Enlace para solicitar registro -->
                    <div id="solicitarRegistroLink" style="display: none; text-align: center; margin-top: 15px; padding: 12px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <i class="fas fa-exclamation-circle" style="color: #721c24;"></i>
                        <span style="color: #721c24; font-size: 14px;">
                            ¿Tu cuenta no está en el sistema? 
                            <a href="#" onclick="backToStep1bAndRequestForm(); return false;" style="color: var(--color-ata-verde); font-weight: bold; text-decoration: underline;">Solicita tu registro aquí</a>
                        </span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Aplicación Principal (oculta inicialmente) -->
    <div id="mainApp" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo">
                            <img src="./assets/images/INSIGNIA_I.E.ANTONIO_TORRES_ARAUJO.png" alt="Logo ATA" />
                        </div>
                        <div class="header-text">
                            <h1>Agenda Virtual ATA</h1>
                            <p>I.E. 80002 Antonio Torres Araujo</p>
                        </div>
                    </div>
                    
                    <div class="user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div id="userName" style="font-weight: 500;">Usuario</div>
                            <div id="userRole" style="font-size: 12px; opacity: 0.8;">Rol</div>
                        </div>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            Salir
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navegación según rol -->
        <nav id="mainNav" class="main-nav" style="background: var(--color-ata-verde); padding: 10px 0; position: sticky; top: 0; z-index: 900;">
            <div class="container">
                <ul class="nav-menu" style="justify-content: center;">
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                            <i class="fas fa-home"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item nav-incidencias" style="display: none;">
                        <a href="#incidencias" class="nav-link" onclick="showSection('incidencias')">
                            <i class="fas fa-plus-circle"></i>
                            Nueva Incidencia
                        </a>
                    </li>
                    <li class="nav-item nav-historial" style="display: none;">
                        <a href="#historial" class="nav-link" onclick="showSection('historial')">
                            <i class="fas fa-history"></i>
                            Historial
                        </a>
                    </li>
                    <li class="nav-item nav-reportes" style="display: none;">
                        <a href="#reportes" class="nav-link" onclick="showSection('reportes')">
                            <i class="fas fa-chart-bar"></i>
                            Reportes
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <main class="main-content">
            <div class="container">
                <!-- Dashboard -->
                <div id="dashboardSection" class="content-section">
                    <div class="page-title">
                        <h2 id="dashboardTitle">Panel de Control</h2>
                        <p id="dashboardSubtitle">Sistema de Gestión de Incidencias Escolares</p>
                    </div>

                    <!-- Estadísticas principales -->
                    <div class="grid grid-4" id="statsGrid">
                        <div class="stats-card">
                            <div class="stats-number" id="statTotalIncidencias">0</div>
                            <div class="stats-label">Total Incidencias</div>
                            <div class="stats-trend" id="trendTotal">
                                <i class="fas fa-minus"></i> --
                            </div>
                        </div>
                        
                        <div class="stats-card">
                            <div class="stats-number" id="statEsteMes">0</div>
                            <div class="stats-label">Este Mes</div>
                            <div class="stats-trend" id="trendMes">
                                <i class="fas fa-minus"></i> --
                            </div>
                        </div>
                        
                        <div class="stats-card">
                            <div class="stats-number" id="statPendientes">0</div>
                            <div class="stats-label">Pendientes</div>
                            <div class="stats-trend" id="trendPendientes">
                                <i class="fas fa-minus"></i> --
                            </div>
                        </div>
                        
                        <div class="stats-card">
                            <div class="stats-number" id="statCasosGraves">0</div>
                            <div class="stats-label">Casos Graves</div>
                            <div class="stats-trend" id="trendGraves">
                                <i class="fas fa-minus"></i> --
                            </div>
                        </div>
                    </div>

                    <!-- Vista específica según rol -->
                    <div id="roleSpecificContent">
                        <!-- Se carga dinámicamente según el rol -->
                    </div>
                </div>

                <!-- Sección de Incidencias -->
                <div id="incidenciasSection" class="content-section" style="display: none;">
                    <div class="page-title">
                        <h2>Registro de Nueva Incidencia</h2>
                        <p>Complete los datos de la incidencia</p>
                    </div>

                    <div class="card">
                        <h3>
                            <i class="fas fa-plus-circle"></i>
                            Datos de la Incidencia
                        </h3>
                        
                        <form id="incidenciaForm" onsubmit="submitIncident(event)">
                            <div class="grid grid-2">
                                <div class="form-group" style="position: relative;">
                                    <label class="form-label">Buscar Estudiante</label>
                                    <div class="input-group">
                                        <input type="text" class="form-input" id="studentSearch" 
                                               placeholder="Escriba el nombre del estudiante..." 
                                               autocomplete="off"
                                               oninput="handleStudentSearch(this.value)">
                                        <input type="hidden" id="studentId">
                                        <div class="input-group-append">
                                            <span class="input-group-icon">
                                                <i class="fas fa-search"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <!-- Dropdown de resultados -->
                                    <div id="studentSearchResults" class="autocomplete-dropdown" style="display: none;">
                                        <!-- Se llena dinámicamente -->
                                    </div>
                                    <!-- Info del estudiante seleccionado -->
                                    <div id="studentSelectedInfo" style="display: none; margin-top: 8px; padding: 10px; background: #e8f5e9; border-radius: 8px; font-size: 13px;">
                                        <i class="fas fa-check-circle" style="color: var(--color-ata-verde);"></i>
                                        <span id="studentSelectedName"></span>
                                        <button type="button" onclick="clearStudentSelection()" style="float: right; background: none; border: none; color: #999; cursor: pointer;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Nivel y Aula</label>
                                    <select class="form-input" id="aulaSelect" required>
                                        <option value="">Seleccionar nivel y aula</option>
                                        
                                        <optgroup label="🧸 INICIAL">
                                            <option value="3A">3 años - A</option>
                                            <option value="3B">3 años - B</option>
                                            <option value="4A">4 años - A</option>
                                            <option value="4B">4 años - B</option>
                                            <option value="4C">4 años - C</option>
                                            <option value="5A">5 años - A</option>
                                            <option value="5B">5 años - B</option>
                                            <option value="5C">5 años - C</option>
                                        </optgroup>
                                        
                                        <optgroup label="📚 PRIMARIA">
                                            <option value="1PA">1° Primaria - A</option>
                                            <option value="1PB">1° Primaria - B</option>
                                            <option value="1PC">1° Primaria - C</option>
                                            <option value="2PA">2° Primaria - A</option>
                                            <option value="2PB">2° Primaria - B</option>
                                            <option value="2PC">2° Primaria - C</option>
                                            <option value="3PA">3° Primaria - A</option>
                                            <option value="3PB">3° Primaria - B</option>
                                            <option value="3PC">3° Primaria - C</option>
                                            <option value="4PA">4° Primaria - A</option>
                                            <option value="4PB">4° Primaria - B</option>
                                            <option value="4PC">4° Primaria - C</option>
                                            <option value="5PA">5° Primaria - A</option>
                                            <option value="5PB">5° Primaria - B</option>
                                            <option value="6PA">6° Primaria - A</option>
                                            <option value="6PB">6° Primaria - B</option>
                                        </optgroup>
                                        
                                        <optgroup label="🎓 SECUNDARIA">
                                            <option value="1SA">1° Secundaria - A</option>
                                            <option value="1SB">1° Secundaria - B</option>
                                            <option value="1SC">1° Secundaria - C</option>
                                            <option value="1SD">1° Secundaria - D</option>
                                            <option value="2SA">2° Secundaria - A</option>
                                            <option value="2SB">2° Secundaria - B</option>
                                            <option value="2SC">2° Secundaria - C</option>
                                            <option value="3SA">3° Secundaria - A</option>
                                            <option value="3SB">3° Secundaria - B</option>
                                            <option value="3SC">3° Secundaria - C</option>
                                            <option value="4SA">4° Secundaria - A</option>
                                            <option value="4SB">4° Secundaria - B</option>
                                            <option value="5SA">5° Secundaria - A</option>
                                            <option value="5SB">5° Secundaria - B</option>
                                            <option value="5SC">5° Secundaria - C</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Selector de Tipo: Mérito o Demérito -->
                            <div class="grid grid-2">
                                <div class="form-group">
                                    <label class="form-label">Tipo de Registro</label>
                                    <select class="form-input" id="tipoRegistro" onchange="toggleMeritosDemeritosSections()" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="merito">🏆 MÉRITO (Reconocimiento)</option>
                                        <option value="demerito">⚠️ DEMÉRITO (Falta)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="severidadInfo" style="display: none;">
                                    <label class="form-label">Severidad (Automática)</label>
                                    <div class="severity-info" id="severidadDisplay" style="padding: 8px; background: #f8f9fa; border-radius: 4px; color: #666;">
                                        Se calcula automáticamente según el tipo y historial
                                    </div>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN DE MÉRITOS -->
                            <div id="meritosSection" class="form-section" style="display: none;">
                                <h4 style="color: var(--color-ata-verde); margin: 20px 0 10px 0;"><i class="fas fa-star"></i> MÉRITOS - Seleccione el reconocimiento</h4>
                                
                                <div class="form-group">
                                    <label class="form-label">Categoría y Mérito</label>
                                    <select class="form-input" id="meritoSelect">
                                        <option value="">Seleccionar mérito</option>
                                        
                                        <optgroup label="🎯 RESPONSABILIDAD">
                                            <option value="RESP-A">A. Participación destacada en actos cívicos u otros eventos internos</option>
                                            <option value="RESP-B">B. Mantiene adecuada presentación personal durante un mes</option>
                                            <option value="RESP-C">C. Puntualidad y asistencia a actividades académicas</option>
                                            <option value="RESP-D">D. Porta siempre su diario/agenda de comportamiento</option>
                                            <option value="RESP-E">E. Cuida mobiliario e infraestructura</option>
                                            <option value="RESP-F">F. Colabora espontáneamente con la limpieza del aula y el plantel</option>
                                            <option value="RESP-G">G. Mantiene la agenda/diario en buen estado</option>
                                            <option value="RESP-H">H. Cumple los compromisos establecidos</option>
                                        </optgroup>
                                        
                                        <optgroup label="🤝 RESPETO">
                                            <option value="RESP-I">I. Saluda con cortesía a miembros de la I.E. y adultos</option>
                                            <option value="RESP-J">J. Respeta pertenencias de compañeros y devuelve objetos/dinero hallados</option>
                                            <option value="RESP-K">K. Cuida infraestructura, áreas verdes, mobiliario y equipos</option>
                                        </optgroup>
                                        
                                        <optgroup label="❤️ SOLIDARIDAD">
                                            <option value="SOL-N">N. Participa en campañas de mejora institucional</option>
                                            <option value="SOL-O">O. Participa responsablemente en actividades comunales</option>
                                            <option value="SOL-P">P. Apoya a compañeros en dificultad</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- SECCIÓN DE DEMÉRITOS -->
                            <div id="demeritosSection" class="form-section" style="display: none;">
                                <h4 style="color: #dc3545; margin: 20px 0 10px 0;"><i class="fas fa-exclamation-triangle"></i> DEMÉRITOS - Seleccione la falta</h4>
                                
                                <div class="form-group">
                                    <label class="form-label">Categoría y Falta</label>
                                    <select class="form-input" id="demeritoSelect" onchange="updateSeverityInfo(); handleOtrasSelection();">
                                        <option value="">Seleccionar falta</option>
                                        
                                        <!-- FALTAS LEVES -->
                                        <optgroup label="🟡 FALTAS LEVES">
                                            <optgroup label="    📅 ASISTENCIA">
                                                <option value="LEVE-A" data-severity="leve">A. Inasistencia injustificada</option>
                                                <option value="LEVE-B" data-severity="leve">B. Evadirse de la I.E. (salida no autorizada)</option>
                                                <option value="LEVE-C" data-severity="leve">C. Llegar tarde a la I.E./aula o ingreso indebido</option>
                                                <option value="LEVE-D" data-severity="leve">D. No ingresar a clase por permanecer en kiosco/baño/patio, etc.</option>
                                            </optgroup>
                                            <optgroup label="    📋 RESPONSABILIDAD">
                                                <option value="LEVE-E" data-severity="leve">E. Incumple funciones asignadas (brigadier, delegado)</option>
                                                <option value="LEVE-F" data-severity="leve">F. No cumple tareas educativas</option>
                                                <option value="LEVE-G" data-severity="leve">G. Interrumpe al docente durante la sesión</option>
                                                <option value="LEVE-H" data-severity="leve">H. Realiza trabajos ajenos en hora de clase</option>
                                                <option value="LEVE-I" data-severity="leve">I. Fomenta desorden en ambientes/actividades de la I.E.</option>
                                                <option value="LEVE-K" data-severity="leve">K. Juega pelota en aula o pasillos</option>
                                                <option value="LEVE-L" data-severity="leve">L. Sale de clase sin autorización del docente</option>
                                                <option value="LEVE-M" data-severity="leve">M. Cómplice en una falta</option>
                                                <option value="LEVE-N" data-severity="leve">N. No porta la agenda/diario, la pierde o la conserva en mal estado</option>
                                                <option value="LEVE-O" data-severity="leve">O. No hace firmar la agenda por el apoderado</option>
                                                <option value="LEVE-P" data-severity="leve">P. Incumple normas y acuerdos de convivencia del aula</option>
                                                <option value="LEVE-Q" data-severity="leve">Q. Otras que la autoridad indique</option>
                                            </optgroup>
                                            <optgroup label="    👔 IMAGEN PERSONAL">
                                                <option value="LEVE-T" data-severity="leve">T. Uniforme incompleto o prendas ajenas al uniforme</option>
                                                <option value="LEVE-U" data-severity="leve">U. Usa uniforme de E.F. fuera de su horario</option>
                                                <option value="LEVE-V" data-severity="leve">V. Falta de higiene personal (cuello, cabello, uñas)</option>
                                                <option value="LEVE-W" data-severity="leve">W. Cabello fuera de norma (varón sin recorte; mujer sin recogido)</option>
                                                <option value="LEVE-X" data-severity="leve">X. Ingreso maquillado(a)</option>
                                                <option value="LEVE-Y" data-severity="leve">Y. Uso de adornos (pulseras, aretes, gorros, etc.) no permitidos</option>
                                            </optgroup>
                                            <optgroup label="    🧹 LIMPIEZA">
                                                <option value="LEVE-Z" data-severity="leve">Z. No colabora con la limpieza de ambientes (aula, patio, baños)</option>
                                            </optgroup>
                                            <optgroup label="    🤝 RESPETO - Relaciones">
                                                <option value="LEVE-Ra" data-severity="leve">a. Agresión verbal o moral a compañeros (sin daño físico)</option>
                                                <option value="LEVE-Rc" data-severity="leve">c. Vocabulario soez o descalificante</option>
                                                <option value="LEVE-Re" data-severity="leve">e. No saluda a profesores/adultos</option>
                                            </optgroup>
                                            <optgroup label="    🇵🇪 CIUDADANÍA">
                                                <option value="LEVE-Ca" data-severity="leve">a. No entona himnos con respeto</option>
                                                <option value="LEVE-Cb" data-severity="leve">b. No participa y conversa en formaciones</option>
                                                <option value="LEVE-Cc" data-severity="leve">c. No porta escarapela en aniversario patrio</option>
                                            </optgroup>
                                            <optgroup label="    🎭 HONRADEZ">
                                                <option value="LEVE-Hb" data-severity="leve">b. Miente o calla para eludir responsabilidades o encubrir</option>
                                            </optgroup>
                                            <optgroup label="    💝 SOLIDARIDAD">
                                                <option value="LEVE-Sa" data-severity="leve">a. Indiferencia ante campañas escolares</option>
                                                <option value="LEVE-Sb" data-severity="leve">b. No presta ayuda cuando se solicita</option>
                                            </optgroup>
                                        </optgroup>
                                        
                                        <!-- FALTAS GRAVES -->
                                        <optgroup label="🟠 FALTAS GRAVES">
                                            <option value="GRAVE-a" data-severity="grave">a) Destruir propiedad ajena</option>
                                            <option value="GRAVE-b" data-severity="grave">b) Deteriorar infraestructura, mobiliario o enseres de la I.E.</option>
                                            <option value="GRAVE-c" data-severity="grave">c) Fraude en pruebas, trabajos o asignaciones</option>
                                            <option value="GRAVE-d" data-severity="grave">d) Portar material pornográfico</option>
                                            <option value="GRAVE-e" data-severity="grave">e) Falta de respeto grave a directivos, docentes, administrativos, personal de servicio, autoridades estudiantiles, compañeros o padres</option>
                                            <option value="GRAVE-f" data-severity="grave">f) Evadirse de clase/I.E. o de actividades programadas</option>
                                            <option value="GRAVE-g" data-severity="grave">g) Manchar paredes/puertas/sillas/pizarras con inscripciones</option>
                                            <option value="GRAVE-h" data-severity="grave">h) Bullying o ciberbullying dentro de la I.E.</option>
                                            <option value="GRAVE-i" data-severity="grave">i) Comentarios que dañen integridad/reputación de alumnos, personal o la I.E.</option>
                                            <option value="GRAVE-j" data-severity="grave">j) Juegos de riesgo para la integridad física/emocional</option>
                                            <optgroup label="    🎭 HONRADEZ - Graves">
                                                <option value="GRAVE-Hc" data-severity="grave">c. Alterar calificaciones en exámenes/agenda/boleta</option>
                                                <option value="GRAVE-Hd" data-severity="grave">d. Tomar pertenencias ajenas sin autorización (hurto)</option>
                                                <option value="GRAVE-He" data-severity="grave">e. Copiar o filtrar claves en evaluaciones</option>
                                            </optgroup>
                                        </optgroup>
                                        
                                        <!-- FALTAS MUY GRAVES -->
                                        <optgroup label="🔴 FALTAS MUY GRAVES">
                                            <option value="MUY_GRAVE-a" data-severity="muy_grave">a) Fomentar violencia en la vía pública vistiendo el uniforme</option>
                                            <option value="MUY_GRAVE-b" data-severity="muy_grave">b) Agresión física y/o psicológica a compañeros(as)</option>
                                            <option value="MUY_GRAVE-c" data-severity="muy_grave">c) Portar/usar objetos punzocortantes o armas (reales o réplicas)</option>
                                            <option value="MUY_GRAVE-d" data-severity="muy_grave">d) Inducir a otros a fraudes, delitos o peleas</option>
                                            <option value="MUY_GRAVE-e" data-severity="muy_grave">e) Amenazar o agredir físicamente al personal de la I.E.</option>
                                            <option value="MUY_GRAVE-f" data-severity="muy_grave">f) Usar el nombre de la I.E. en actividades sin autorización</option>
                                            <option value="MUY_GRAVE-g" data-severity="muy_grave">g) Introducir/consumir drogas, cigarrillos o alcohol en la I.E. o portarlos con uniforme fuera de la I.E.</option>
                                            <option value="MUY_GRAVE-h" data-severity="muy_grave">h) Portar celulares/cámaras para registrar y difundir contenido que vulnere derechos</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Descripción Detallada</label>
                                <textarea class="form-input" id="descripcionDetallada" style="min-height: 100px; resize: vertical;" placeholder="Describa la situación detalladamente..." required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Testigos (opcional)</label>
                                <input type="text" class="form-input" id="testigos" placeholder="Nombres de testigos">
                            </div>
                            
                            <!-- Información de Escalamiento (si aplica) -->
                            <div id="escalamientoInfo" class="alert" style="display: none; margin-top: 15px;">
                                <div class="alert-content">
                                    <strong><i class="fas fa-info-circle"></i> Sistema de Escalamiento Automático:</strong>
                                    <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                                        <li><strong>Faltas Leves:</strong> 3 en una semana → Alerta a tutor/padre | 5 en un bimestre → Citación TOE</li>
                                        <li><strong>Faltas Graves/Muy Graves:</strong> Derivación inmediata a TOE/Dirección</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                                <button type="button" class="btn btn-secondary" onclick="showSection('dashboard')">
                                    <i class="fas fa-times"></i>
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Registrar Incidencia
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Sección de Historial -->
                <div id="historialSection" class="content-section" style="display: none;">
                    <div class="page-title">
                        <h2>Historial de Incidencias</h2>
                        <p>Consulte el registro histórico</p>
                    </div>

                    <div class="card">
                        <h3>
                            <i class="fas fa-history"></i>
                            Incidencias Registradas
                        </h3>
                        
                        <div class="table-container">
                            <table class="table" id="historialTable">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Estudiante</th>
                                        <th>Aula</th>
                                        <th>Tipo</th>
                                        <th>Severidad</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historialTableBody">
                                    <!-- Se carga dinámicamente desde Supabase -->
                                    <tr id="historialEmpty">
                                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                                            No hay incidencias registradas aún.<br>
                                            <small>Las incidencias que registres aparecerán aquí.</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sección de Reportes -->
                <div id="reportesSection" class="content-section" style="display: none;">
                    <div class="page-title">
                        <h2>Reportes e Indicadores</h2>
                        <p>Análisis y estadísticas institucionales</p>
                    </div>

                    <div class="card">
                        <h3>
                            <i class="fas fa-chart-pie"></i>
                            Resumen por Aulas - <span id="reportesMesActual">Cargando...</span>
                        </h3>
                        
                        <div id="reportesAulasContainer" class="grid grid-3">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #666;"></i>
                                <p style="color: #666; margin-top: 10px;">Cargando estadísticas...</p>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 20px;">
                        <h3>
                            <i class="fas fa-chart-bar"></i>
                            Resumen General
                        </h3>
                        <div id="reportesResumenGeneral" class="grid grid-4">
                            <div class="stats-card">
                                <div class="stats-number" id="reporteTotalIncidencias">0</div>
                                <div class="stats-label">Total Incidencias</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="reporteTotalMeritos">0</div>
                                <div class="stats-label">Méritos</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="reporteTotalDemeritos">0</div>
                                <div class="stats-label">Deméritos</div>
                            </div>
                            <div class="stats-card">
                                <div class="stats-number" id="reporteTotalEstudiantes">796</div>
                                <div class="stats-label">Estudiantes</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Administración (Solo para Administradores) -->
                <div id="adminSection" class="content-section" style="display: none;">
                    <div class="page-title">
                        <h2>Panel de Administración</h2>
                        <p>Gestión completa del sistema ATA</p>
                    </div>
                    
                    <div class="grid grid-3">
                        <!-- Gestión de Usuarios -->
                        <div class="card admin-card">
                            <h3><i class="fas fa-users-cog"></i> Gestión de Usuarios</h3>
                            <div class="grid grid-2" style="gap: 10px; margin-top: 15px;">
                                <button class="btn btn-primary btn-sm" onclick="showUserManagement()">
                                    <i class="fas fa-plus-circle"></i> Crear Usuario
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="showUserList()">
                                    <i class="fas fa-list"></i> Ver Usuarios
                                </button>
                            </div>
                        </div>
                        
                        <!-- Solicitudes Pendientes -->
                        <div class="card admin-card">
                            <h3><i class="fas fa-clipboard-check"></i> Solicitudes Pendientes</h3>
                            <div class="stats-number" id="adminSolicitudesPendientes" style="color: var(--color-ata-rojo);">0</div>
                            <div class="stats-label">Pendientes de aprobación</div>
                            <button class="btn btn-warning btn-sm" onclick="showPendingRequests()" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-eye"></i> Revisar Solicitudes
                            </button>
                        </div>
                        
                        <!-- Configuración del Sistema -->
                        <div class="card admin-card">
                            <h3><i class="fas fa-cogs"></i> Configuración Sistema</h3>
                            <div class="grid grid-2" style="gap: 10px; margin-top: 15px;">
                                <button class="btn btn-success btn-sm" onclick="showClassroomConfig()">
                                    <i class="fas fa-school"></i> Aulas
                                </button>
                                <button class="btn btn-info btn-sm" onclick="showStudentConfig()">
                                    <i class="fas fa-graduation-cap"></i> Estudiantes
                                </button>
                            </div>
                        </div>
                        
                        <!-- Reportes Administrativos -->
                        <div class="card admin-card">
                            <h3><i class="fas fa-chart-bar"></i> Reportes Administrativos</h3>
                            <div class="grid grid-2" style="gap: 10px; margin-top: 15px;">
                                <button class="btn btn-primary btn-sm" onclick="generateSystemReport()">
                                    <i class="fas fa-file-pdf"></i> Reporte Sistema
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="exportUsers()">
                                    <i class="fas fa-download"></i> Exportar Usuarios
                                </button>
                            </div>
                        </div>
                        
                        <!-- Estadísticas Sistema -->
                        <div class="card admin-card">
                            <h3><i class="fas fa-tachometer-alt"></i> Estadísticas Sistema</h3>
                            <div class="grid grid-2" style="gap: 15px; margin-top: 10px;">
                                <div class="mini-stat">
                                    <div class="stats-number" id="adminTotalUsuarios" style="font-size: 18px;">0</div>
                                    <div class="stats-label" style="font-size: 11px;">Total Usuarios</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="stats-number" id="adminTotalIncidencias" style="font-size: 18px;">0</div>
                                    <div class="stats-label" style="font-size: 11px;">Incidencias</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="stats-number" id="adminIncidenciasMes" style="font-size: 18px;">0</div>
                                    <div class="stats-label" style="font-size: 11px;">Este Mes</div>
                                </div>
                                <div class="mini-stat">
                                    <div class="stats-number" style="font-size: 18px;">24</div>
                                    <div class="stats-label" style="font-size: 11px;">Aulas</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Backup y Mantenimiento -->
                        <div class="card admin-card">
                            <h3><i class="fas fa-database"></i> Backup y Mantenimiento</h3>
                            <div class="alert alert-info" style="margin: 10px 0; font-size: 12px;">
                                <i class="fas fa-info-circle"></i>
                                Base de datos en Supabase (backup automático)
                            </div>
                            <button class="btn btn-warning btn-sm" onclick="performBackup()" style="width: 100%;">
                                <i class="fas fa-save"></i> Exportar Datos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal para detalles de incidencia -->
        <div id="modalDetalleIncidencia" class="modal-overlay" style="display: none;">
            <div class="modal-container">
                <div class="modal-header">
                    <h3 id="modalTitulo"><i class="fas fa-file-alt"></i> Detalle de Incidencia</h3>
                    <button class="modal-close" onclick="cerrarModalDetalle()">&times;</button>
                </div>
                <div class="modal-body" id="modalContenido">
                    <p>Cargando...</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="cerrarModalDetalle()">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-text">
                        <p>&copy; 2025 I.E. 80002 Antonio Torres Araujo - Agenda Virtual ATA</p>
                        <p>Sistema de Gestión de Incidencias Escolares</p>
                    </div>
                    <div class="footer-links">
                        <a href="#ayuda">
                            <i class="fas fa-question-circle"></i>
                            Ayuda
                        </a>
                        <a href="#manual">
                            <i class="fas fa-book"></i>
                            Manual
                        </a>
                        <a href="#contacto">
                            <i class="fas fa-envelope"></i>
                            Contacto
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://jbdjlivrfkrcivkrnuio.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpiZGpsaXZyZmtyY2l2a3JudWlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNDA5ODgsImV4cCI6MjA3ODcxNjk4OH0.eZnzV0EJgVtYe_evH-xQX5gmT8T6uKI09D3PRUB0fcI';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Usuarios de prueba según roles acordados en las charlas
        const users = {
            // Usuarios originales
            'docente': {
                password: '123',
                name: 'Prof. María González',
                role: 'Docente',
                permissions: ['dashboard', 'incidencias', 'historial']
            },
            'tutor': {
                password: '123',
                name: 'Prof. Kelly Rodríguez',
                role: 'Tutor 1°B',
                permissions: ['dashboard', 'incidencias', 'historial']
            },
            'auxiliar': {
                password: '123',
                name: 'Aux. Carmen López',
                role: 'Auxiliar de Educación',
                permissions: ['dashboard', 'incidencias', 'historial']
            },
            'toe': {
                password: '123',
                name: 'Psic. Ana Morales',
                role: 'Coordinador TOE',
                permissions: ['dashboard', 'incidencias', 'historial', 'reportes']
            },
            'direccion': {
                password: '123',
                name: 'Dir. Carlos Vásquez',
                role: 'Director',
                permissions: ['dashboard', 'historial', 'reportes']
            },
            'padre': {
                password: '123',
                name: 'Sr. José Pérez',
                role: 'Padre de Familia',
                permissions: ['dashboard']
            },
            'admin': {
                password: '123',
                name: 'Admin. Sistema ATA',
                role: 'Administrador del Sistema',
                permissions: ['dashboard', 'incidencias', 'historial', 'reportes', 'admin', 'solicitudes']
            },
            // Usuarios demo auto-generados
            'demo_docente': {
                password: '123',
                name: 'Demo - Docente',
                role: 'Docente',
                permissions: ['dashboard', 'incidencias', 'historial'],
                isDemo: true
            },
            'demo_tutor': {
                password: '123',
                name: 'Demo - Tutor 1°B',
                role: 'Tutor',
                permissions: ['dashboard', 'incidencias', 'historial'],
                isDemo: true
            },
            'demo_auxiliar': {
                password: '123',
                name: 'Demo - Auxiliar de Educación',
                role: 'Auxiliar de Educación',
                permissions: ['dashboard', 'incidencias', 'historial'],
                isDemo: true
            },
            'demo_toe': {
                password: '123',
                name: 'Demo - Coordinador TOE',
                role: 'Coordinador TOE',
                permissions: ['dashboard', 'incidencias', 'historial', 'reportes'],
                isDemo: true
            },
            'demo_direccion': {
                password: '123',
                name: 'Demo - Director',
                role: 'Dirección',
                permissions: ['dashboard', 'historial', 'reportes'],
                isDemo: true
            },
            'demo_padre': {
                password: '123',
                name: 'Demo - Padre de Familia',
                role: 'Padre/Madre',
                permissions: ['dashboard'],
                isDemo: true
            },
            'demo_admin': {
                password: '123',
                name: 'Demo - Administrador Sistema',
                role: 'Administrador del Sistema',
                permissions: ['dashboard', 'incidencias', 'historial', 'reportes', 'admin', 'solicitudes'],
                isDemo: true
            }
        };

        let currentUser = null;

        // ============================================================================
        // FUNCIONES DE CONSULTA A SUPABASE - DATOS REALES
        // ============================================================================

        // Cache para evitar consultas repetidas
        let estudiantesCache = null;
        let catalogoMeritosCache = null;
        let catalogoDemeritosCache = null;
        let periodosCache = null;

        // Obtener período activo actual
        async function getPeriodoActivo() {
            if (periodosCache) return periodosCache;
            
            try {
                const { data, error } = await supabase
                    .from('periodos')
                    .select('*')
                    .eq('activo', true)
                    .single();
                
                if (error) throw error;
                periodosCache = data;
                return data;
            } catch (err) {
                console.error('Error obteniendo período activo:', err);
                return null;
            }
        }

        // Obtener estadísticas del dashboard para el usuario actual
        async function getEstadisticasUsuario(userId) {
            try {
                const periodo = await getPeriodoActivo();
                const periodoId = periodo?.id;
                const now = new Date();
                const inicioMes = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                
                // Total de incidencias registradas por este usuario
                const { count: totalIncidencias } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .eq('registrado_por', userId);
                
                // Incidencias de este mes
                const { count: esteMes } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .eq('registrado_por', userId)
                    .gte('fecha', inicioMes);
                
                // Incidencias pendientes
                const { count: pendientes } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .eq('registrado_por', userId)
                    .eq('estado', 'pendiente');
                
                // Casos graves y muy graves
                const { count: casosGraves } = await supabase
                    .from('incidencias')
                    .select('*', { count: 'exact', head: true })
                    .eq('registrado_por', userId)
                    .in('severidad', ['grave', 'muy_grave']);
                
                return {
                    totalIncidencias: totalIncidencias || 0,
                    esteMes: esteMes || 0,
                    pendientes: pendientes || 0,
                    casosGraves: casosGraves || 0
                };
            } catch (err) {
                console.error('Error obteniendo estadísticas:', err);
                return { totalIncidencias: 0, esteMes: 0, pendientes: 0, casosGraves: 0 };
            }
        }

        // Actualizar UI del dashboard con estadísticas reales
        async function actualizarDashboardStats() {
            if (!currentUser || !currentUser.id) return;
            
            const stats = await getEstadisticasUsuario(currentUser.id);
            
            // Actualizar números en el dashboard
            const statTotal = document.getElementById('statTotalIncidencias');
            const statMes = document.getElementById('statEsteMes');
            const statPendientes = document.getElementById('statPendientes');
            const statGraves = document.getElementById('statCasosGraves');
            
            if (statTotal) statTotal.textContent = stats.totalIncidencias;
            if (statMes) statMes.textContent = stats.esteMes;
            if (statPendientes) statPendientes.textContent = stats.pendientes;
            if (statGraves) statGraves.textContent = stats.casosGraves;
        }

        // Obtener historial de incidencias del usuario actual
        async function getHistorialIncidencias(userId, limit = 50) {
            try {
                const { data, error } = await supabase
                    .from('incidencias')
                    .select(`
                        id,
                        fecha,
                        tipo,
                        severidad,
                        estado,
                        descripcion,
                        estudiante:estudiantes(id, nombre_completo, grado, seccion),
                        catalogo_demerito:catalogo_demeritos(nombre),
                        catalogo_merito:catalogo_meritos(nombre)
                    `)
                    .eq('registrado_por', userId)
                    .order('fecha', { ascending: false })
                    .limit(limit);
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Error obteniendo historial:', err);
                return [];
            }
        }

        // Renderizar tabla de historial
        async function renderizarHistorial() {
            if (!currentUser || !currentUser.id) return;
            
            const tbody = document.getElementById('historialTableBody');
            if (!tbody) return;
            
            const incidencias = await getHistorialIncidencias(currentUser.id);
            
            if (incidencias.length === 0) {
                tbody.innerHTML = `
                    <tr id="historialEmpty">
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            No hay incidencias registradas aún.<br>
                            <small>Las incidencias que registres aparecerán aquí.</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = incidencias.map(inc => {
                const estudiante = inc.estudiante;
                const aula = estudiante ? `${estudiante.grado}°${estudiante.seccion}` : '-';
                const nombreEstudiante = estudiante ? estudiante.nombre_completo : 'Desconocido';
                const tipoNombre = inc.tipo === 'merito' 
                    ? (inc.catalogo_merito?.nombre || 'Mérito')
                    : (inc.catalogo_demerito?.nombre || 'Demérito');
                
                const severidadClass = inc.severidad === 'leve' ? 'badge-leve' 
                    : inc.severidad === 'grave' ? 'badge-grave' 
                    : inc.severidad === 'muy_grave' ? 'badge-muy-grave' : '';
                
                const severidadText = inc.severidad === 'leve' ? 'Leve'
                    : inc.severidad === 'grave' ? 'Grave'
                    : inc.severidad === 'muy_grave' ? 'Muy Grave' : '-';
                
                const estadoText = inc.estado === 'pendiente' ? 'Pendiente'
                    : inc.estado === 'revisado' ? 'Revisado'
                    : inc.estado === 'resuelto' ? 'Resuelto' : inc.estado;
                
                const fecha = new Date(inc.fecha).toLocaleDateString('es-PE');
                
                return `
                    <tr>
                        <td>${fecha}</td>
                        <td>${nombreEstudiante}</td>
                        <td>${aula}</td>
                        <td>${tipoNombre}</td>
                        <td><span class="badge ${severidadClass}">${severidadText}</span></td>
                        <td>${estadoText}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="verDetalleIncidencia('${inc.id}')" style="padding: 6px 12px; font-size: 12px; width: auto;">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Ver detalle de una incidencia
        async function verDetalleIncidencia(incidenciaId) {
            const modal = document.getElementById('modalDetalleIncidencia');
            const contenido = document.getElementById('modalContenido');
            const titulo = document.getElementById('modalTitulo');
            
            modal.style.display = 'flex';
            contenido.innerHTML = '<p style="text-align: center;"><i class="fas fa-spinner fa-spin"></i> Cargando detalles...</p>';
            
            try {
                const { data: inc, error } = await supabase
                    .from('incidencias')
                    .select(`
                        *,
                        estudiante:estudiantes(id, nombre_completo, dni, grado, seccion, nivel),
                        catalogo_demerito:catalogo_demeritos(codigo, nombre, descripcion, severidad, categoria),
                        catalogo_merito:catalogo_meritos(codigo, nombre, descripcion, area),
                        registrador:users!registrado_por(nombres, apellidos, role)
                    `)
                    .eq('id', incidenciaId)
                    .single();
                
                if (error) throw error;
                
                // Determinar tipo y color
                const esMerito = inc.tipo === 'merito';
                const icono = esMerito ? 'fa-trophy' : 'fa-exclamation-triangle';
                const colorTipo = esMerito ? '#1976d2' : '#c1272d';
                
                titulo.innerHTML = `<i class="fas ${icono}" style="color: ${esMerito ? '#ffd700' : '#fff'}"></i> ${esMerito ? 'Mérito' : 'Demérito'} - Detalle`;
                
                const estudiante = inc.estudiante;
                const catalogo = esMerito ? inc.catalogo_merito : inc.catalogo_demerito;
                const registrador = inc.registrador;
                
                // Formatear fecha
                const fecha = new Date(inc.fecha).toLocaleDateString('es-PE', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                });
                const fechaCreacion = new Date(inc.created_at).toLocaleString('es-PE');
                
                // Severidad badge
                let severidadHTML = '';
                if (!esMerito && inc.severidad) {
                    const sevClass = inc.severidad === 'leve' ? 'badge-leve' 
                        : inc.severidad === 'grave' ? 'badge-grave' : 'badge-muy-grave';
                    const sevText = inc.severidad === 'leve' ? 'Leve' 
                        : inc.severidad === 'grave' ? 'Grave' : 'Muy Grave';
                    severidadHTML = `<span class="badge ${sevClass}">${sevText}</span>`;
                }
                
                // Estado badge
                const estadoClass = inc.estado === 'resuelto' ? 'badge-leve' 
                    : inc.estado === 'revisado' ? 'badge-grave' : '';
                const estadoText = inc.estado === 'pendiente' ? 'Pendiente'
                    : inc.estado === 'revisado' ? 'Revisado' : 'Resuelto';
                
                contenido.innerHTML = `
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-user-graduate"></i> Estudiante:</div>
                        <div class="detalle-value">
                            <strong>${estudiante?.nombre_completo || 'N/A'}</strong>
                            <br><small>DNI: ${estudiante?.dni || 'N/A'} | ${estudiante?.grado}° ${estudiante?.seccion} - ${estudiante?.nivel}</small>
                        </div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-calendar"></i> Fecha:</div>
                        <div class="detalle-value">${fecha}</div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-tag"></i> Tipo:</div>
                        <div class="detalle-value">
                            <span style="color: ${colorTipo}; font-weight: 600;">
                                ${esMerito ? '🏆 MÉRITO' : '⚠️ DEMÉRITO'}
                            </span>
                            ${severidadHTML}
                        </div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-list-alt"></i> Categoría:</div>
                        <div class="detalle-value">
                            <strong>${catalogo?.nombre || 'N/A'}</strong>
                            <br><small>Código: ${catalogo?.codigo || inc.codigo || 'N/A'}</small>
                            ${catalogo?.descripcion ? `<br><small style="color: #666;">${catalogo.descripcion}</small>` : ''}
                        </div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-info-circle"></i> Estado:</div>
                        <div class="detalle-value"><span class="badge ${estadoClass}">${estadoText}</span></div>
                    </div>
                    
                    <div class="detalle-row">
                        <div class="detalle-label"><i class="fas fa-user-tie"></i> Registrado por:</div>
                        <div class="detalle-value">
                            ${registrador ? `${registrador.nombres} ${registrador.apellidos}` : 'N/A'}
                            <br><small>Rol: ${registrador?.role || 'N/A'}</small>
                            <br><small>Fecha registro: ${fechaCreacion}</small>
                        </div>
                    </div>
                    
                    ${inc.descripcion ? `
                    <div style="margin-top: 20px;">
                        <div class="detalle-label" style="width: 100%; margin-bottom: 10px;">
                            <i class="fas fa-comment-alt"></i> Descripción / Observaciones:
                        </div>
                        <div class="detalle-descripcion">
                            ${inc.descripcion.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${inc.accion_requerida ? `
                    <div style="margin-top: 15px;">
                        <div class="detalle-label" style="width: 100%; margin-bottom: 10px;">
                            <i class="fas fa-tasks"></i> Acción Requerida:
                        </div>
                        <div class="detalle-descripcion" style="background: #fff3e0;">
                            ${inc.accion_requerida}
                        </div>
                    </div>
                    ` : ''}
                `;
                
            } catch (err) {
                console.error('Error obteniendo detalle:', err);
                contenido.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #e74c3c;">
                        <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>Error al cargar los detalles</p>
                        <small>${err.message}</small>
                    </div>
                `;
            }
        }
        
        // Cerrar modal de detalle
        function cerrarModalDetalle() {
            document.getElementById('modalDetalleIncidencia').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('modalDetalleIncidencia');
            if (e.target === modal) {
                cerrarModalDetalle();
            }
        });

        // Buscar estudiantes para autocompletado
        async function buscarEstudiantes(query) {
            if (!query || query.length < 2) return [];
            
            try {
                const { data, error } = await supabase
                    .from('estudiantes')
                    .select('id, nombre_completo, dni, grado, seccion, nivel')
                    .ilike('nombre_completo', `%${query}%`)
                    .eq('activo', true)
                    .limit(10);
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Error buscando estudiantes:', err);
                return [];
            }
        }

        // Obtener catálogo de méritos
        async function getCatalogoMeritos() {
            if (catalogoMeritosCache) return catalogoMeritosCache;
            
            try {
                const { data, error } = await supabase
                    .from('catalogo_meritos')
                    .select('*')
                    .eq('vigente', true)
                    .order('codigo');
                
                if (error) throw error;
                catalogoMeritosCache = data || [];
                return catalogoMeritosCache;
            } catch (err) {
                console.error('Error obteniendo catálogo de méritos:', err);
                return [];
            }
        }

        // Obtener catálogo de deméritos
        async function getCatalogoDemeritros() {
            if (catalogoDemeritosCache) return catalogoDemeritosCache;
            
            try {
                const { data, error } = await supabase
                    .from('catalogo_demeritos')
                    .select('*')
                    .eq('vigente', true)
                    .order('severidad', { ascending: true })
                    .order('codigo');
                
                if (error) throw error;
                catalogoDemeritosCache = data || [];
                return catalogoDemeritosCache;
            } catch (err) {
                console.error('Error obteniendo catálogo de deméritos:', err);
                return [];
            }
        }

        // Registrar nueva incidencia en Supabase
        async function registrarIncidencia(incidenciaData) {
            try {
                const periodo = await getPeriodoActivo();
                if (!periodo) {
                    throw new Error('No hay un período académico activo');
                }
                
                const { data, error } = await supabase
                    .from('incidencias')
                    .insert({
                        estudiante_id: incidenciaData.estudianteId,
                        periodo_id: periodo.id,
                        tipo: incidenciaData.tipo,
                        catalogo_merito_id: incidenciaData.catalogoMeritoId || null,
                        catalogo_demerito_id: incidenciaData.catalogoDemeritoId || null,
                        codigo: incidenciaData.codigo || null,
                        descripcion: incidenciaData.descripcion,
                        severidad: incidenciaData.severidad || null,
                        registrado_por: currentUser.id,
                        estado: 'pendiente',
                        fecha: new Date().toISOString().split('T')[0]
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                console.log('✅ Incidencia registrada:', data);
                return { success: true, data };
            } catch (err) {
                console.error('❌ Error registrando incidencia:', err);
                return { success: false, error: err.message };
            }
        }

        // Obtener hijos del padre actual (para Portal de Padres)
        async function getHijosDelPadre(padreId) {
            try {
                const { data, error } = await supabase
                    .from('estudiantes')
                    .select('id, nombre_completo, dni, grado, seccion, nivel')
                    .or(`padre_id.eq.${padreId},madre_id.eq.${padreId},apoderado_id.eq.${padreId}`)
                    .eq('activo', true);
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Error obteniendo hijos:', err);
                return [];
            }
        }

        // Obtener incidencias de un estudiante (para que el padre vea)
        async function getIncidenciasEstudiante(estudianteId) {
            try {
                const { data, error } = await supabase
                    .from('incidencias')
                    .select(`
                        id,
                        fecha,
                        tipo,
                        severidad,
                        estado,
                        descripcion,
                        catalogo_demerito:catalogo_demeritos(nombre, categoria),
                        catalogo_merito:catalogo_meritos(nombre, area)
                    `)
                    .eq('estudiante_id', estudianteId)
                    .order('fecha', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (err) {
                console.error('Error obteniendo incidencias del estudiante:', err);
                return [];
            }
        }

        // Estadísticas para el Portal del Padre
        async function getEstadisticasPadre(padreId) {
            try {
                const hijos = await getHijosDelPadre(padreId);
                const estadisticas = [];
                
                for (const hijo of hijos) {
                    const incidencias = await getIncidenciasEstudiante(hijo.id);
                    const now = new Date();
                    const inicioMes = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    const incidenciasMes = incidencias.filter(i => new Date(i.fecha) >= inicioMes);
                    const casosGraves = incidencias.filter(i => i.severidad === 'grave' || i.severidad === 'muy_grave');
                    const meritos = incidencias.filter(i => i.tipo === 'merito');
                    
                    estadisticas.push({
                        estudiante: hijo,
                        totalIncidencias: incidencias.length,
                        incidenciasMes: incidenciasMes.length,
                        casosGraves: casosGraves.length,
                        meritos: meritos.length,
                        ultimasIncidencias: incidencias.slice(0, 5)
                    });
                }
                
                return estadisticas;
            } catch (err) {
                console.error('Error obteniendo estadísticas del padre:', err);
                return [];
            }
        }

        // Variable para almacenar estudiante seleccionado
        let estudianteSeleccionado = null;

        // ============================================================================
        // FIN FUNCIONES DE CONSULTA A SUPABASE
        // ============================================================================

        // Función para mostrar mensajes inline
        function showLoginMessage(message, type = 'error') {
            const messageContainer = document.getElementById('loginMessage');
            
            // Limpiar mensaje anterior
            messageContainer.className = 'form-message';
            
            // Configurar nuevo mensaje
            const icons = {
                'error': 'fas fa-exclamation-circle',
                'success': 'fas fa-check-circle',
                'info': 'fas fa-info-circle'
            };
            
            messageContainer.innerHTML = `<i class="${icons[type]}"></i>${message}`;
            messageContainer.classList.add(type, 'show');
            
            // Auto-ocultar después de 5 segundos
            setTimeout(() => {
                messageContainer.classList.remove('show');
            }, 5000);
        }

        // Función para limpiar mensajes de login
        function clearLoginMessage() {
            const messageContainer = document.getElementById('loginMessage');
            if (messageContainer) {
                messageContainer.classList.remove('show');
                messageContainer.innerHTML = '';
            }
        }

        // Función que se ejecuta al hacer clic en "Iniciar Sesión"
        // Función que se ejecuta al hacer clic en "Iniciar Sesión"
        async function handleLoginClick() {
            console.log('🔥 BOTÓN CLICKEADO - handleLoginClick ejecutado!');
            
            // Limpiar mensaje anterior
            clearLoginMessage();
            
            // Verificar que se haya seleccionado un rol
            if (!selectedUserRole) {
                console.log('❌ No role selected');
                showLoginMessage('Por favor, selecciona tu tipo de cuenta primero', 'error');
                backToRoleSelection();
                return;
            }
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            console.log('📝 Usuario:', username);
            
            // Validar campos vacíos
            if (!username || !password) {
                console.log('❌ Empty fields');
                showLoginMessage('Por favor, complete todos los campos', 'error');
                return;
            }
            
            try {
                // 🔐 AUTENTICACIÓN REAL CON SUPABASE
                showLoginMessage('<i class="fas fa-spinner fa-spin"></i> Verificando credenciales...', 'info');
                
                // Paso 1: Buscar usuario en la tabla users (por DNI o email)
                let query = supabase.from('users').select('*');
                
                // Determinar si es DNI (solo números) o email (contiene @)
                if (/^\d{8}$/.test(username)) {
                    // Es DNI
                    query = query.eq('dni', username);
                    console.log('🔍 Buscando por DNI:', username);
                } else {
                    // Es email
                    query = query.eq('email', username.toLowerCase());
                    console.log('🔍 Buscando por email:', username);
                }
                
                const { data: userData, error: dbError } = await query.maybeSingle();
                
                if (dbError) {
                    console.error('❌ Error DB:', dbError);
                    showLoginMessage('Error al verificar credenciales', 'error');
                    return;
                }
                
                if (!userData) {
                    console.log('❌ Usuario no encontrado');
                    showLoginMessage('Usuario no encontrado en el sistema', 'error');
                    document.getElementById('solicitarRegistroLink').style.display = 'block';
                    return;
                }
                
                // Paso 2: Verificar que la cuenta esté activada
                if (!userData.activado) {
                    console.log('⚠️ Cuenta no activada');
                    showLoginMessage('Tu cuenta aún no ha sido activada', 'info');
                    document.getElementById('activarCuentaLink').style.display = 'block';
                    return;
                }
                
                // Paso 3: Verificar rol
                const userRole = userData.role.toLowerCase();
                const expectedRole = selectedUserRole;
                
                if (userRole !== expectedRole) {
                    console.log('❌ Rol incorrecto:', userRole, 'vs', expectedRole);
                    const roleNames = {
                        'docente': 'Docente',
                        'tutor': 'Tutor',
                        'auxiliar': 'Auxiliar',
                        'toe': 'TOE',
                        'direccion': 'Dirección',
                        'padre': 'Padre/Madre',
                        'admin': 'Administrador'
                    };
                    showLoginMessage(
                        `Este usuario no corresponde al rol ${roleNames[expectedRole]}`,
                        'error'
                    );
                    return;
                }
                
                // Paso 4: Autenticar con Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                    email: userData.email,
                    password: password
                });
                
                if (authError) {
                    console.error('❌ Error auth:', authError);
                    if (authError.message.includes('Invalid login credentials')) {
                        showLoginMessage('Contraseña incorrecta', 'error');
                    } else {
                        showLoginMessage(`Error de autenticación: ${authError.message}`, 'error');
                    }
                    return;
                }
                
                // ✅ LOGIN EXITOSO
                console.log('✅ Login exitoso!');
                showLoginMessage('Iniciando sesión...', 'success');
                
                // Definir permisos según el rol
                const rolePermissions = {
                    'docente': ['incidencias', 'historial'],
                    'tutor': ['incidencias', 'historial', 'reportes'],
                    'auxiliar': ['incidencias', 'historial'],
                    'toe': ['incidencias', 'historial', 'reportes'],
                    'direccion': ['incidencias', 'historial', 'reportes'],
                    'padre': ['historial'],
                    'admin': ['incidencias', 'historial', 'reportes']
                };
                
                setTimeout(() => {
                    currentUser = {
                        username: userData.dni || userData.email,
                        email: userData.email,
                        role: userData.role,
                        name: userData.nombre_completo || 'Usuario',
                        nombre: userData.nombre_completo,
                        dni: userData.dni,
                        id: userData.id,
                        permissions: rolePermissions[userData.role] || ['historial'],
                        isDemo: userData.email && userData.email.includes('.demo@')
                    };
                    console.log('👤 Current user set:', currentUser);
                    login();
                }, 1000);
                
            } catch (err) {
                console.error('❌ Error inesperado:', err);
                showLoginMessage('Error al iniciar sesión. Intenta nuevamente.', 'error');
            }
        }

        // Función de login exitoso
        async function login() {
            document.getElementById('loginScreen').style.display = 'none';
            const mainApp = document.getElementById('mainApp');
            mainApp.classList.add('show');
            
            // Actualizar información del usuario
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
            
            // Configurar navegación según permisos
            setupNavigation();
            
            // Configurar dashboard según rol
            setupDashboard();
            
            // Cargar datos reales desde Supabase
            await cargarDatosReales();
        }
        
        // Cargar datos reales del usuario desde Supabase
        async function cargarDatosReales() {
            if (!currentUser || !currentUser.id) return;
            
            console.log('📊 Cargando datos reales desde Supabase...');
            
            // Si es padre, cargar portal especial
            if (currentUser.role === 'padre') {
                await cargarPortalPadre();
            } else {
                // Actualizar estadísticas del dashboard para roles institucionales
                await actualizarDashboardStats();
                
                // Cargar datos específicos según el rol
                await cargarDatosEspecificosRol();
            }
            
            // Cargar historial de incidencias
            await renderizarHistorial();
            
            console.log('✅ Datos cargados correctamente');
        }
        
        // Cargar datos específicos del panel según rol
        async function cargarDatosEspecificosRol() {
            if (!currentUser) return;
            
            const rol = currentUser.role.toLowerCase();
            
            try {
                // Obtener mis incidencias de hoy
                const hoy = new Date().toISOString().split('T')[0];
                const { data: incidenciasHoy, error } = await supabase
                    .from('incidencias')
                    .select('*')
                    .eq('registrado_por', currentUser.id)
                    .gte('fecha_hora', hoy + 'T00:00:00')
                    .lte('fecha_hora', hoy + 'T23:59:59');
                
                const totalHoy = incidenciasHoy ? incidenciasHoy.length : 0;
                const pendientes = incidenciasHoy ? incidenciasHoy.filter(i => i.estado === 'pendiente').length : 0;
                
                // Actualizar panel según rol
                if (rol.includes('docente')) {
                    const container = document.getElementById('docenteIncidenciasHoy');
                    if (container) {
                        container.innerHTML = `
                            <p><strong>${totalHoy}</strong> incidencias registradas hoy</p>
                            <p><strong>${pendientes}</strong> pendientes de seguimiento</p>
                        `;
                    }
                } else if (rol.includes('tutor')) {
                    const aulaInfo = document.getElementById('tutorAulaInfo');
                    const actividadReciente = document.getElementById('tutorActividadReciente');
                    
                    // Contar estudiantes del aula del tutor (si tiene aula asignada)
                    if (aulaInfo) {
                        const { data: stats } = await supabase
                            .from('incidencias')
                            .select('id')
                            .eq('registrado_por', currentUser.id);
                        
                        aulaInfo.innerHTML = `
                            <p><strong>${stats ? stats.length : 0}</strong> incidencias registradas</p>
                            <p><strong>${totalHoy}</strong> hoy</p>
                        `;
                    }
                    
                    if (actividadReciente) {
                        actividadReciente.innerHTML = `
                            <p>${totalHoy > 0 ? totalHoy + ' registros hoy' : 'Sin actividad hoy'}</p>
                        `;
                    }
                } else if (rol.includes('auxiliar')) {
                    const container = document.getElementById('auxiliarRegistrosRecientes');
                    if (container) {
                        container.innerHTML = `
                            <p><strong>${totalHoy}</strong> registros hoy</p>
                            <p>${pendientes > 0 ? pendientes + ' pendientes' : 'Todo al día'}</p>
                        `;
                    }
                } else if (rol.includes('toe')) {
                    const casosInfo = document.getElementById('toeCasosInfo');
                    if (casosInfo) {
                        // Contar casos graves/muy_graves como "seguimiento"
                        const { data: casosGraves } = await supabase
                            .from('incidencias')
                            .select('id')
                            .in('gravedad', ['grave', 'muy_grave']);
                        
                        casosInfo.innerHTML = `
                            <p><strong>${casosGraves ? casosGraves.length : 0}</strong> casos graves/muy graves</p>
                            <p><strong>${totalHoy}</strong> registros hoy</p>
                        `;
                    }
                } else if (rol.includes('direc')) {
                    const resumen = document.getElementById('direccionResumen');
                    if (resumen) {
                        // Estadísticas generales
                        const { data: totalIncidencias } = await supabase
                            .from('incidencias')
                            .select('id');
                        
                        const { data: casosGraves } = await supabase
                            .from('incidencias')
                            .select('id')
                            .in('gravedad', ['grave', 'muy_grave']);
                        
                        resumen.innerHTML = `
                            <p><strong>${totalIncidencias ? totalIncidencias.length : 0}</strong> incidencias totales</p>
                            <p><strong>${casosGraves ? casosGraves.length : 0}</strong> casos graves</p>
                            <p>796 estudiantes registrados</p>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error cargando datos específicos del rol:', error);
            }
        }
        
        // Cargar datos de reportes (cuando se accede a la sección)
        async function cargarDatosReportes() {
            console.log('📊 Cargando datos de reportes...');
            
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                          'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const mesActual = meses[new Date().getMonth()];
            const anioActual = new Date().getFullYear();
            
            const mesLabel = document.getElementById('reportesMesActual');
            if (mesLabel) mesLabel.textContent = `${mesActual} ${anioActual}`;
            
            try {
                // Obtener todas las incidencias con información de estudiantes
                const { data: incidencias, error } = await supabase
                    .from('incidencias')
                    .select(`
                        id,
                        tipo,
                        gravedad,
                        estudiante_id,
                        estudiantes (
                            grado,
                            seccion
                        )
                    `);
                
                if (error) throw error;
                
                // Agrupar por grado y sección
                const porAula = {};
                let totalMeritos = 0;
                let totalDemeritos = 0;
                
                if (incidencias) {
                    incidencias.forEach(inc => {
                        if (inc.tipo === 'merito') totalMeritos++;
                        else totalDemeritos++;
                        
                        if (inc.estudiantes) {
                            const aula = `${inc.estudiantes.grado}°${inc.estudiantes.seccion}`;
                            if (!porAula[aula]) {
                                porAula[aula] = { total: 0, leve: 0, grave: 0, muy_grave: 0, merito: 0 };
                            }
                            porAula[aula].total++;
                            if (inc.tipo === 'merito') {
                                porAula[aula].merito++;
                            } else if (inc.gravedad) {
                                porAula[aula][inc.gravedad]++;
                            }
                        }
                    });
                }
                
                // Actualizar resumen general
                document.getElementById('reporteTotalIncidencias').textContent = incidencias ? incidencias.length : 0;
                document.getElementById('reporteTotalMeritos').textContent = totalMeritos;
                document.getElementById('reporteTotalDemeritos').textContent = totalDemeritos;
                
                // Renderizar cards por aula
                const container = document.getElementById('reportesAulasContainer');
                if (container) {
                    if (Object.keys(porAula).length === 0) {
                        container.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <i class="fas fa-inbox" style="font-size: 48px; color: #ccc;"></i>
                                <p style="color: #666; margin-top: 15px;">No hay incidencias registradas aún</p>
                            </div>
                        `;
                    } else {
                        // Ordenar aulas
                        const aulasOrdenadas = Object.keys(porAula).sort();
                        
                        container.innerHTML = aulasOrdenadas.map(aula => {
                            const data = porAula[aula];
                            return `
                                <div class="stats-card">
                                    <div class="stats-number">${aula}</div>
                                    <div class="stats-label">${data.total} incidencias</div>
                                    <div style="margin-top: 10px;">
                                        ${data.merito > 0 ? `<span class="badge badge-merito">${data.merito} méritos</span>` : ''}
                                        ${data.leve > 0 ? `<span class="badge badge-leve">${data.leve} leves</span>` : ''}
                                        ${data.grave > 0 ? `<span class="badge badge-grave">${data.grave} graves</span>` : ''}
                                        ${data.muy_grave > 0 ? `<span class="badge badge-muy-grave">${data.muy_grave} muy graves</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                console.log('✅ Reportes cargados');
                
            } catch (error) {
                console.error('Error cargando reportes:', error);
                const container = document.getElementById('reportesAulasContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c;"></i>
                            <p style="color: #666; margin-top: 15px;">Error al cargar los reportes</p>
                        </div>
                    `;
                }
            }
        }
        
        // Cargar datos de admin
        async function cargarDatosAdmin() {
            console.log('📊 Cargando datos de administración...');
            
            try {
                // Contar usuarios
                const { data: usuarios } = await supabase
                    .from('users')
                    .select('id');
                
                // Contar incidencias
                const { data: incidencias } = await supabase
                    .from('incidencias')
                    .select('id');
                
                // Contar incidencias del mes actual
                const inicioMes = new Date();
                inicioMes.setDate(1);
                inicioMes.setHours(0, 0, 0, 0);
                
                const { data: incidenciasMes } = await supabase
                    .from('incidencias')
                    .select('id')
                    .gte('fecha_hora', inicioMes.toISOString());
                
                // Contar solicitudes pendientes (usuarios inactivos)
                const { data: pendientes } = await supabase
                    .from('users')
                    .select('id')
                    .eq('activo', false);
                
                // Actualizar UI
                const totalUsuariosEl = document.getElementById('adminTotalUsuarios');
                const totalIncidenciasEl = document.getElementById('adminTotalIncidencias');
                const incidenciasMesEl = document.getElementById('adminIncidenciasMes');
                const solicitudesEl = document.getElementById('adminSolicitudesPendientes');
                
                if (totalUsuariosEl) totalUsuariosEl.textContent = usuarios ? usuarios.length : 0;
                if (totalIncidenciasEl) totalIncidenciasEl.textContent = incidencias ? incidencias.length : 0;
                if (incidenciasMesEl) incidenciasMesEl.textContent = incidenciasMes ? incidenciasMes.length : 0;
                if (solicitudesEl) solicitudesEl.textContent = pendientes ? pendientes.length : 0;
                
                console.log('✅ Datos de admin cargados');
                
            } catch (error) {
                console.error('Error cargando datos de admin:', error);
            }
        }

        // Configurar navegación según permisos
        function setupNavigation() {
            const navItems = {
                'incidencias': document.querySelector('.nav-incidencias'),
                'historial': document.querySelector('.nav-historial'),
                'reportes': document.querySelector('.nav-reportes')
            };

            // Ocultar todos los elementos de navegación
            Object.values(navItems).forEach(item => {
                if (item) item.style.display = 'none';
            });

            // Verificar que currentUser y permissions existan
            if (currentUser && currentUser.permissions && Array.isArray(currentUser.permissions)) {
                // Mostrar solo los permitidos
                currentUser.permissions.forEach(permission => {
                    if (navItems[permission]) {
                        navItems[permission].style.display = 'list-item';
                    }
                });
            }
        }

        // Configurar dashboard según rol
        function setupDashboard() {
            const title = document.getElementById('dashboardTitle');
            const subtitle = document.getElementById('dashboardSubtitle');
            const content = document.getElementById('roleSpecificContent');
            
            // Determinar el tipo de rol basado en el rol del usuario (no en el username)
            const userRole = currentUser.role.toLowerCase();
            let roleType = '';
            
            if (userRole.includes('docente')) {
                roleType = 'docente';
            } else if (userRole.includes('tutor')) {
                roleType = 'tutor';
            } else if (userRole.includes('auxiliar')) {
                roleType = 'auxiliar';
            } else if (userRole.includes('toe') || userRole.includes('coordinador')) {
                roleType = 'toe';
            } else if (userRole.includes('dirección') || userRole.includes('director')) {
                roleType = 'direccion';
            } else if (userRole.includes('padre') || userRole.includes('madre')) {
                roleType = 'padre';
            } else if (userRole.includes('administrador')) {
                roleType = 'admin';
            }
            
            // Configurar contenido según el tipo de rol
            switch (roleType) {
                case 'docente':
                    title.textContent = 'Panel del Docente';
                    subtitle.textContent = 'Gestión de incidencias en aula';
                    content.innerHTML = getDocenteContent();
                    break;
                case 'tutor':
                    title.textContent = 'Panel del Tutor - 1°B';
                    subtitle.textContent = 'Seguimiento integral del aula';
                    content.innerHTML = getTutorContent();
                    break;
                case 'auxiliar':
                    title.textContent = 'Panel del Auxiliar';
                    subtitle.textContent = 'Supervisión disciplinaria';
                    content.innerHTML = getAuxiliarContent();
                    break;
                case 'toe':
                    title.textContent = 'Panel de Coordinación TOE';
                    subtitle.textContent = 'Gestión psicopedagógica institucional';
                    content.innerHTML = getTOEContent();
                    break;
                case 'direccion':
                    title.textContent = 'Panel de Dirección';
                    subtitle.textContent = 'Vista ejecutiva institucional';
                    content.innerHTML = getDireccionContent();
                    break;
                case 'padre':
                    title.textContent = 'Portal de Padres';
                    subtitle.textContent = 'Seguimiento de su hijo/a';
                    content.innerHTML = getPadreContent();
                    break;
                case 'admin':
                    title.textContent = 'Panel de Administración';
                    subtitle.textContent = 'Gestión completa del sistema ATA';
                    content.innerHTML = getAdminContent();
                    setupAdminNavigation();
                    break;
                default:
                    title.textContent = 'Panel de Usuario';
                    subtitle.textContent = 'Bienvenido al sistema';
                    content.innerHTML = '<div class="card"><p>Bienvenido al sistema ATA.</p></div>';
            }
        }

        // Contenido específico por rol
        function getDocenteContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-plus-circle"></i> Acciones Rápidas</h3>
                        <div class="grid grid-2" style="gap: 15px;">
                            <button class="btn btn-primary" onclick="showSection('incidencias')">
                                <i class="fas fa-plus"></i> Nueva Incidencia
                            </button>
                            <button class="btn btn-secondary" onclick="showSection('historial')">
                                <i class="fas fa-history"></i> Ver Historial
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-clock"></i> Mis Incidencias Hoy</h3>
                        <div id="docenteIncidenciasHoy">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getTutorContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-users"></i> Mi Aula</h3>
                        <div id="tutorAulaInfo">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                        <button class="btn btn-primary" onclick="showSection('incidencias')" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Registrar Incidencia
                        </button>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-history"></i> Actividad Reciente</h3>
                        <div id="tutorActividadReciente">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getAuxiliarContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-eye"></i> Supervisión General</h3>
                        <p>Rondas por patios y pasillos</p>
                        <p>Control de disciplina</p>
                        <button class="btn btn-primary" onclick="showSection('incidencias')">
                            <i class="fas fa-plus"></i> Reportar Incidencia
                        </button>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-history"></i> Mis Registros Recientes</h3>
                        <div id="auxiliarRegistrosRecientes">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function getTOEContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-brain"></i> Casos en Seguimiento</h3>
                        <div id="toeCasosInfo">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                        <button class="btn btn-primary" onclick="showSection('incidencias')" style="margin-top: 15px;">
                            <i class="fas fa-plus"></i> Registrar Incidencia
                        </button>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-chart-line"></i> Indicadores</h3>
                        <button class="btn btn-primary" onclick="showSection('reportes')">
                            <i class="fas fa-chart-bar"></i> Ver Reportes
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('historial')">
                            <i class="fas fa-history"></i> Ver Historial
                        </button>
                    </div>
                </div>
            `;
        }

        function getDireccionContent() {
            return `
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-building"></i> Vista Institucional</h3>
                        <div id="direccionResumen">
                            <p style="color: #666;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-file-pdf"></i> Acciones</h3>
                        <button class="btn btn-primary" onclick="showSection('reportes')" style="width: 100%; margin-bottom: 10px;">
                            <i class="fas fa-chart-bar"></i> Ver Reportes
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('historial')" style="width: 100%;">
                            <i class="fas fa-history"></i> Ver Historial
                        </button>
                    </div>
                </div>
            `;
        }

        function getPadreContent() {
            // Contenido inicial - se actualizará dinámicamente
            return `
                <div id="padrePortalContent">
                    <div class="card" style="text-align: center; padding: 40px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--color-ata-verde); margin-bottom: 15px;"></i>
                        <p>Cargando información de sus hijos...</p>
                    </div>
                </div>
            `;
        }
        
        // Cargar datos reales del padre
        async function cargarPortalPadre() {
            if (!currentUser || currentUser.role !== 'padre') return;
            
            const container = document.getElementById('padrePortalContent');
            if (!container) return;
            
            try {
                const estadisticas = await getEstadisticasPadre(currentUser.id);
                
                if (estadisticas.length === 0) {
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <i class="fas fa-user-graduate" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                            <h3>No se encontraron hijos registrados</h3>
                            <p style="color: #666;">Si cree que esto es un error, contacte a la administración del colegio.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                for (const stat of estadisticas) {
                    const hijo = stat.estudiante;
                    html += `
                        <div class="card" style="margin-bottom: 20px;">
                            <h3><i class="fas fa-child"></i> Seguimiento de ${hijo.nombre_completo}</h3>
                            <p style="color: #666; margin-bottom: 15px;">${hijo.grado}° ${hijo.seccion} - ${hijo.nivel.charAt(0).toUpperCase() + hijo.nivel.slice(1)}</p>
                            
                            <div class="grid grid-4">
                                <div class="stats-card">
                                    <div class="stats-number">${stat.totalIncidencias}</div>
                                    <div class="stats-label">Total Incidencias</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-number">${stat.incidenciasMes}</div>
                                    <div class="stats-label">Este Mes</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-number" style="color: ${stat.casosGraves > 0 ? '#dc3545' : 'inherit'};">${stat.casosGraves}</div>
                                    <div class="stats-label">Casos Graves</div>
                                </div>
                                <div class="stats-card">
                                    <div class="stats-number" style="color: var(--color-ata-verde);">${stat.meritos}</div>
                                    <div class="stats-label">Méritos</div>
                                </div>
                            </div>
                            
                            ${stat.ultimasIncidencias.length > 0 ? `
                                <h4 style="margin-top: 20px;"><i class="fas fa-history"></i> Últimas Incidencias</h4>
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Fecha</th>
                                                <th>Tipo</th>
                                                <th>Descripción</th>
                                                <th>Severidad</th>
                                                <th>Detalle</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${stat.ultimasIncidencias.map(inc => {
                                                const fecha = new Date(inc.fecha).toLocaleDateString('es-PE');
                                                const tipoIcon = inc.tipo === 'merito' ? '🏆' : '⚠️';
                                                const nombre = inc.tipo === 'merito' 
                                                    ? (inc.catalogo_merito?.nombre || 'Mérito')
                                                    : (inc.catalogo_demerito?.nombre || 'Demérito');
                                                const severidadClass = inc.severidad === 'leve' ? 'badge-leve' 
                                                    : inc.severidad === 'grave' ? 'badge-grave' 
                                                    : inc.severidad === 'muy_grave' ? 'badge-muy-grave' : '';
                                                const severidadText = inc.tipo === 'merito' ? 'Reconocimiento'
                                                    : inc.severidad === 'leve' ? 'Leve'
                                                    : inc.severidad === 'grave' ? 'Grave'
                                                    : inc.severidad === 'muy_grave' ? 'Muy Grave' : '-';
                                                
                                                return `
                                                    <tr>
                                                        <td>${fecha}</td>
                                                        <td>${tipoIcon} ${nombre}</td>
                                                        <td>${inc.descripcion ? inc.descripcion.substring(0, 50) + (inc.descripcion.length > 50 ? '...' : '') : '-'}</td>
                                                        <td><span class="badge ${severidadClass}">${severidadText}</span></td>
                                                        <td>
                                                            <button class="btn btn-secondary" onclick="verDetalleIncidencia('${inc.id}')" style="padding: 5px 10px; font-size: 11px; width: auto;">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : `
                                <div class="alert alert-success" style="margin-top: 20px;">
                                    <i class="fas fa-check-circle"></i>
                                    <div>¡Excelente! No hay incidencias registradas para este estudiante.</div>
                                </div>
                            `}
                        </div>
                    `;
                }
                
                container.innerHTML = html;
                
            } catch (err) {
                console.error('Error cargando portal del padre:', err);
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc3545; margin-bottom: 15px;"></i>
                        <h3>Error al cargar información</h3>
                        <p style="color: #666;">Por favor recargue la página o contacte soporte.</p>
                    </div>
                `;
            }
        }

        function getAdminContent() {
            return `
                <div class="grid grid-3" style="margin-bottom: 30px;">
                    <div class="card admin-card">
                        <h3><i class="fas fa-users-cog"></i> Gestión de Usuarios</h3>
                        <div class="grid grid-2" style="gap: 10px; margin-top: 15px;">
                            <button class="btn btn-primary btn-sm" onclick="showUserManagement()">
                                <i class="fas fa-plus-circle"></i> Crear Usuario
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="showUserList()">
                                <i class="fas fa-list"></i> Ver Usuarios
                            </button>
                        </div>
                    </div>
                    
                    <div class="card admin-card">
                        <h3><i class="fas fa-clipboard-check"></i> Solicitudes Pendientes</h3>
                        <div class="stats-number" style="color: var(--color-ata-rojo);">5</div>
                        <div class="stats-label">Pendientes de aprobación</div>
                        <button class="btn btn-warning btn-sm" onclick="showPendingRequests()" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-eye"></i> Revisar Solicitudes
                        </button>
                    </div>
                    
                    <div class="card admin-card">
                        <h3><i class="fas fa-chart-bar"></i> Estadísticas Sistema</h3>
                        <div class="grid grid-2" style="gap: 15px; margin-top: 10px;">
                            <div class="mini-stat">
                                <div class="stats-number" style="font-size: 18px;">156</div>
                                <div class="stats-label" style="font-size: 11px;">Total Usuarios</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stats-number" style="font-size: 18px;">89</div>
                                <div class="stats-label" style="font-size: 11px;">Activos Hoy</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-2">
                    <div class="card">
                        <h3><i class="fas fa-cogs"></i> Configuración del Sistema</h3>
                        <div class="grid grid-2" style="gap: 10px; margin-top: 15px;">
                            <button class="btn btn-info btn-sm" onclick="showClassroomConfig()">
                                <i class="fas fa-school"></i> Gestionar Aulas
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showStudentConfig()">
                                <i class="fas fa-user-graduate"></i> Estudiantes
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showIncidentConfig()">
                                <i class="fas fa-exclamation-circle"></i> Tipos Incidencias
                            </button>
                            <button class="btn btn-info btn-sm" onclick="showSystemConfig()">
                                <i class="fas fa-wrench"></i> Sistema
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-shield-alt"></i> Incidencias - Control Total</h3>
                        <div class="admin-stats">
                            <div class="mini-stat">
                                <div class="stats-number" style="color: var(--color-ata-rojo);">23</div>
                                <div class="stats-label">Críticas</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stats-number" style="color: var(--color-ata-dorado);">45</div>
                                <div class="stats-label">Moderadas</div>
                            </div>
                            <div class="mini-stat">
                                <div class="stats-number" style="color: var(--color-ata-verde);">67</div>
                                <div class="stats-label">Leves</div>
                            </div>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="showAllIncidents()" style="width: 100%; margin-top: 15px;">
                            <i class="fas fa-eye"></i> Gestionar Todas las Incidencias
                        </button>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3><i class="fas fa-file-export"></i> Reportes Administrativos</h3>
                    <div class="grid grid-4" style="gap: 10px; margin-top: 15px;">
                        <button class="btn btn-success btn-sm" onclick="exportUsers()">
                            <i class="fas fa-users"></i> Exportar Usuarios
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportIncidents()">
                            <i class="fas fa-file-alt"></i> Exportar Incidencias
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportStats()">
                            <i class="fas fa-chart-pie"></i> Estadísticas
                        </button>
                        <button class="btn btn-success btn-sm" onclick="generateReport()">
                            <i class="fas fa-file-pdf"></i> Reporte UGEL
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Configurar navegación especial para administrador
        function setupAdminNavigation() {
            // El admin puede ver todas las secciones
            const navItems = document.querySelectorAll('.nav-link');
            navItems.forEach(item => {
                item.style.display = 'list-item';
            });
            
            // Agregar sección especial de administración si no existe
            const nav = document.querySelector('.nav-menu');
            const adminNav = document.getElementById('adminNavItem');
            if (!adminNav) {
                const adminNavItem = document.createElement('li');
                adminNavItem.id = 'adminNavItem';
                adminNavItem.innerHTML = `
                    <a href="#" class="nav-link" onclick="showSection('admin')" style="background: linear-gradient(135deg, var(--color-ata-dorado), #FFC107); color: #000; font-weight: 600;">
                        <i class="fas fa-crown"></i> Administración
                    </a>
                `;
                nav.appendChild(adminNavItem);
            }
        }

        // Navegación entre secciones
        function showSection(section) {
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(s => {
                s.style.display = 'none';
            });
            
            // Remover clase active de todos los enlaces
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Mostrar la sección seleccionada
            const sectionElement = document.getElementById(section + 'Section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
            
            // Activar el enlace correspondiente
            const activeLink = document.querySelector(`[onclick="showSection('${section}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            // Cargar datos específicos de la sección
            if (section === 'reportes') {
                cargarDatosReportes();
            } else if (section === 'admin') {
                cargarDatosAdmin();
            }
        }

        // Función de logout
        async function logout() {
            try {
                // Cerrar sesión en Supabase Auth
                await supabase.auth.signOut();
                console.log('🚪 Sesión cerrada en Supabase');
            } catch (err) {
                console.error('Error al cerrar sesión:', err);
            }
            
            // Limpiar estado del usuario
            currentUser = null;
            selectedUserRole = null;
            
            // Ocultar aplicación principal
            const mainApp = document.getElementById('mainApp');
            mainApp.classList.remove('show');
            
            // Mostrar pantalla de login
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Limpiar formularios
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Resetear todos los steps
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step1').classList.add('visible');
            document.getElementById('step1').style.display = '';
            
            document.getElementById('step1b').classList.add('hidden');
            document.getElementById('step1b').classList.remove('visible');
            document.getElementById('step1b').style.display = '';
            
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step2').classList.remove('visible');
            document.getElementById('step2').style.display = '';
            
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step3').classList.remove('visible');
            document.getElementById('step4').classList.add('hidden');
            document.getElementById('step4').classList.remove('visible');
            
            // Volver a la sección dashboard
            showSection('dashboard');
            
            console.log('✅ Logout completado - Volviendo a selección de cuenta');
        }

        // Verificar si hay sesión activa al cargar la página
        async function checkExistingSession() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session && session.user) {
                    console.log('🔐 Sesión activa encontrada:', session.user.email);
                    
                    // Obtener datos del usuario desde la tabla users
                    const { data: userData, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('email', session.user.email)
                        .single();
                    
                    if (userData && !error) {
                        // Definir permisos según el rol
                        const rolePermissions = {
                            'docente': ['incidencias', 'historial'],
                            'tutor': ['incidencias', 'historial', 'reportes'],
                            'auxiliar': ['incidencias', 'historial'],
                            'toe': ['incidencias', 'historial', 'reportes'],
                            'direccion': ['incidencias', 'historial', 'reportes'],
                            'padre': ['historial'],
                            'admin': ['incidencias', 'historial', 'reportes']
                        };
                        
                        currentUser = {
                            username: userData.dni || userData.email,
                            email: userData.email,
                            role: userData.role,
                            name: userData.nombre_completo || 'Usuario',
                            nombre: userData.nombre_completo,
                            dni: userData.dni,
                            id: userData.id,
                            permissions: rolePermissions[userData.role] || ['historial'],
                            isDemo: userData.email && userData.email.includes('.demo@')
                        };
                        
                        selectedUserRole = userData.role;
                        console.log('✅ Sesión restaurada para:', currentUser.name);
                        login();
                        return true;
                    }
                }
            } catch (err) {
                console.log('No hay sesión activa:', err.message);
            }
            return false;
        }

        // Efectos visuales
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar sesión existente primero
            const hasSession = await checkExistingSession();
            
            if (!hasSession) {
                // 🔒 FORZAR OCULTAMIENTO DE STEPS AL CARGAR (solo si no hay sesión)
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step2').classList.remove('visible');
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step3').classList.remove('visible');
                document.getElementById('step4').classList.add('hidden');
                document.getElementById('step4').classList.remove('visible');
                document.getElementById('step1b').classList.add('hidden');
                document.getElementById('step1b').classList.remove('visible');
            }
            
            // Configurar event listener del formulario de login
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('🚀 FORM SUBMIT TRIGGERED!');
                console.log('selectedUserRole:', selectedUserRole);
                
                // Limpiar mensaje anterior
                clearLoginMessage();
                
                // Verificar que se haya seleccionado un rol
                if (!selectedUserRole) {
                    console.log('❌ No role selected');
                    showLoginMessage('Por favor, selecciona tu tipo de cuenta primero', 'error');
                    backToRoleSelection();
                    return;
                }
                
                const username = document.getElementById('username').value.toLowerCase();
                const password = document.getElementById('password').value;
                console.log('📝 Username:', username, 'Password:', password);
                
                // Validar campos vacíos
                if (!username || !password) {
                    console.log('❌ Empty fields');
                    showLoginMessage('Por favor, complete todos los campos', 'error');
                    return;
                }
                
                if (users[username] && users[username].password === password) {
                    console.log('✅ User found and password correct');
                    // Validar que el usuario corresponde al rol seleccionado
                    const userRole = users[username].role.toLowerCase();
                    const expectedRole = selectedUserRole;
                    console.log('🔍 User role:', userRole, 'Expected:', expectedRole);
                    
                    // Mapear roles para validación (incluye variaciones para usuarios demo)
                    const roleMapping = {
                        'docente': ['docente'],
                        'tutor': ['tutor', 'tutor 1°b'],
                        'auxiliar': ['auxiliar', 'auxiliar de educación'],
                        'toe': ['toe', 'coordinador toe'],
                        'direccion': ['dirección', 'director'],
                        'padre': ['padre/madre'],
                        'admin': ['administrador del sistema']
                    };
                    
                    // Verificar si el rol del usuario coincide con alguna variación esperada
                    const expectedRoles = roleMapping[expectedRole] || [];
                    const isValidRole = expectedRoles.some(role => role === userRole);
                    console.log('🎯 Expected roles:', expectedRoles, 'Valid role:', isValidRole);
                    
                    if (isValidRole) {
                        console.log('🎉 Role validation successful');
                        // Mostrar mensaje de éxito antes de redirigir
                        showLoginMessage('Iniciando sesión...', 'success');
                        setTimeout(() => {
                            currentUser = { username, ...users[username] };
                            console.log('👤 Current user set:', currentUser);
                            console.log('🔥 CALLING LOGIN FUNCTION');
                            login();
                        }, 1000);
                    } else {
                        console.log('❌ Invalid role');
                        const roleNames = {
                            'docente': 'Docente',
                            'tutor': 'Tutor',
                            'auxiliar': 'Auxiliar',
                            'toe': 'TOE',
                            'direccion': 'Dirección',
                            'padre': 'Padre/Madre',
                            'admin': 'Administrador'
                        };
                        showLoginMessage(
                            `Este usuario no corresponde al rol ${roleNames[selectedUserRole]}. Por favor verifica tus credenciales.`, 
                            'error'
                        );
                    }
                } else {
                    console.log('❌ User not found or wrong password');
                    // Mensaje mejorado para credenciales incorrectas
                    showLoginMessage(
                        `<strong>Credenciales incorrectas.</strong><br>
                        Verifica tu usuario y contraseña.`, 
                        'error'
                    );
                    
                    // Mostrar enlace de activación de cuenta
                    document.getElementById('activarCuentaLink').style.display = 'block';
                    document.getElementById('solicitarRegistroLink').style.display = 'none';
                }
            });

            // Configurar event listener del formulario de incidencia
            document.getElementById('incidenciaForm').addEventListener('submit', function(e) {
                e.preventDefault();
                alert('Incidencia registrada exitosamente');
                showSection('dashboard');
            });

            // Efectos hover para las cards
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                });
                
                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });

        // Variables para el flujo de login
        let selectedUserRole = null;

        // Función para seleccionar rol y avanzar al paso de opciones
        function selectRole(role) {
            selectedUserRole = role;
            
            // Actualizar texto del rol seleccionado
            const roleText = {
                'docente': 'Docente',
                'tutor': 'Tutor',
                'auxiliar': 'Auxiliar',
                'toe': 'TOE',
                'direccion': 'Dirección',
                'padre': 'Padre/Madre',
                'admin': 'Administrador del Sistema'
            };
            
            document.getElementById('selectedRoleText').textContent = roleText[role];
            
            // Transición entre pasos
            const step1 = document.getElementById('step1');
            const step1b = document.getElementById('step1b');
            
            // Ocultar paso 1 y limpiar estilos inline
            step1.classList.remove('visible');
            step1.classList.add('hidden');
            step1.style.display = '';
            
            // Mostrar paso 1b después de un breve delay
            setTimeout(() => {
                step1b.style.display = '';
                step1b.classList.remove('hidden');
                step1b.classList.add('visible');
            }, 300);
        }

        // Función especial para administrador (acceso directo)
        function selectRoleAdmin() {
            selectedUserRole = 'admin';
            
            // Actualizar texto del rol seleccionado
            document.getElementById('roleText').textContent = 'Administrador del Sistema';
            
            // Ir directamente al login sin pasar por solicitud
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            
            // Ocultar paso 1
            step1.classList.remove('visible');
            step1.classList.add('hidden');
            
            // Mostrar paso 2 directamente
            setTimeout(() => {
                step2.classList.remove('hidden');
                step2.classList.add('visible');
                
                // Enfocar en el campo de usuario
                document.getElementById('username').focus();
                
                // Mostrar mensaje especial para admin
                const adminAlert = document.createElement('div');
                adminAlert.innerHTML = `
                    <div class="alert alert-warning" style="margin-bottom: 15px;">
                        <i class="fas fa-crown"></i>
                        <strong>ACCESO ADMINISTRATIVO:</strong> Ingrese las credenciales del administrador del sistema.
                    </div>
                `;
                step2.insertBefore(adminAlert, step2.firstChild);
            }, 300);
        }

        // Función para volver a la selección de roles
        // Función para volver a la selección de roles
        function backToRoleSelection() {
            selectedUserRole = null;
            
            // Limpiar mensajes
            clearLoginMessage();
            
            const step1 = document.getElementById('step1');
            const step1b = document.getElementById('step1b');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const step4 = document.getElementById('step4');
            const requestForm = document.getElementById('requestForm');
            
            // Ocultar TODOS los pasos excepto step1 y limpiar estilos inline
            step1b.classList.remove('visible');
            step1b.classList.add('hidden');
            step1b.style.display = '';
            
            step2.classList.remove('visible');
            step2.classList.add('hidden');
            step2.style.display = '';
            
            step3.classList.remove('visible');
            step3.classList.add('hidden');
            step3.style.display = '';
            
            step4.classList.remove('visible');
            step4.classList.add('hidden');
            step4.style.display = '';
            
            // Ocultar formulario de solicitud
            requestForm.classList.remove('visible');
            
            // Resetear step3 (activación)
            document.getElementById('step3a').style.display = 'block';
            document.getElementById('step3b').style.display = 'none';
            document.getElementById('verificar_dni').value = '';
            document.getElementById('verificar_nombre').value = '';
            document.getElementById('verificarMessage').innerHTML = '';
            document.getElementById('verificarMessage').classList.remove('show');
            document.getElementById('nueva_password').value = '';
            document.getElementById('confirmar_password').value = '';
            document.getElementById('activarMessage').innerHTML = '';
            document.getElementById('activarMessage').classList.remove('show');
            window.cuentaVerificada = null;
            
            // Mostrar paso 1 después de un breve delay
            setTimeout(() => {
                step1.style.display = '';
                step1.classList.remove('hidden');
                step1.classList.add('visible');
                
                // Limpiar formulario de login
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }, 300);
        }

        // Función para mostrar el formulario de login
        function showDemoLogin() {
            const roleText = {
                'docente': 'Docente',
                'tutor': 'Tutor', 
                'auxiliar': 'Auxiliar',
                'toe': 'TOE',
                'direccion': 'Dirección',
                'padre': 'Padre/Madre',
                'admin': 'Administrador del Sistema'
            };
            
            document.getElementById('roleText').textContent = roleText[selectedUserRole];
            
            const step1b = document.getElementById('step1b');
            const step2 = document.getElementById('step2');
            
            // Ocultar paso 1b
            step1b.classList.remove('visible');
            step1b.classList.add('hidden');
            
            // Mostrar paso 2 después de un breve delay
            setTimeout(() => {
                step2.classList.remove('hidden');
                step2.classList.add('visible');
                
                // Ocultar enlaces de ayuda al iniciar sesión normal
                document.getElementById('activarCuentaLink').style.display = 'none';
                document.getElementById('solicitarRegistroLink').style.display = 'none';
                
                // Limpiar los campos para que el usuario ingrese sus credenciales
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Enfocar en el campo de usuario
                setTimeout(() => {
                    document.getElementById('username').focus();
                }, 500);
            }, 300);
        }

        // Función para mostrar formulario de activación de cuenta
        function showActivarCuenta() {
            const roleText = {
                'docente': 'Docente',
                'tutor': 'Tutor', 
                'auxiliar': 'Auxiliar',
                'toe': 'TOE',
                'direccion': 'Dirección',
                'padre': 'Padre/Madre',
                'admin': 'Administrador del Sistema'
            };
            
            const step1b = document.getElementById('step1b');
            const step3 = document.getElementById('step3');
            
            // Actualizar el título para activación
            document.getElementById('roleTextActivacion').textContent = roleText[selectedUserRole];
            
            // Ocultar paso 1b
            step1b.classList.remove('visible');
            step1b.classList.add('hidden');
            
            // Resetear formularios
            document.getElementById('step3a').style.display = 'block';
            document.getElementById('step3b').style.display = 'none';
            document.getElementById('verificar_dni').value = '';
            document.getElementById('verificar_nombre').value = '';
            document.getElementById('verificarMessage').innerHTML = '';
            document.getElementById('verificarMessage').classList.remove('show');
            
            // Mostrar paso 3 después de un breve delay
            setTimeout(() => {
                step3.classList.remove('hidden');
                step3.classList.add('visible');
                
                // Enfocar en el campo DNI
                setTimeout(() => {
                    document.getElementById('verificar_dni').focus();
                }, 500);
            }, 300);
        }
        
        // Función para verificar si la cuenta existe en Supabase
        async function verificarCuentaExiste() {
            const dni = document.getElementById('verificar_dni').value.trim();
            const nombreCompleto = document.getElementById('verificar_nombre').value.trim().toUpperCase();
            
            // Validar que al menos uno esté lleno
            if (!dni && !nombreCompleto) {
                showVerificarMessage('Por favor ingresa tu DNI o tu Nombre Completo', 'error');
                return;
            }
            
            // Validar DNI si se ingresó
            if (dni && (dni.length !== 8 || !/^\d{8}$/.test(dni))) {
                showVerificarMessage('El DNI debe tener exactamente 8 dígitos', 'error');
                return;
            }
            
            // Mostrar spinner
            document.getElementById('btnVerificar').disabled = true;
            document.getElementById('verificarSpinner').style.display = 'block';
            document.getElementById('verificarMessage').classList.remove('show');
            
            try {
                console.log('🔍 Buscando usuario con:', { dni, nombreCompleto });
                
                // Construir consulta según lo que se ingresó
                let query = supabase
                    .from('users')
                    .select('id, nombre_completo, role, activado, email, dni');
                
                if (dni && nombreCompleto) {
                    // Si ambos están llenos, buscar por DNI Y nombre (nombre con ilike para flexibilidad)
                    query = query.eq('dni', dni).ilike('nombre_completo', nombreCompleto);
                } else if (dni) {
                    // Solo DNI
                    query = query.eq('dni', dni);
                } else {
                    // Solo nombre (búsqueda flexible con ilike)
                    query = query.ilike('nombre_completo', nombreCompleto);
                }
                
                const { data, error } = await query.maybeSingle();
                
                console.log('📊 Respuesta de Supabase:', { data, error });
                
                // Ocultar spinner
                document.getElementById('verificarSpinner').style.display = 'none';
                document.getElementById('btnVerificar').disabled = false;
                
                if (error) {
                    console.error('❌ Error de Supabase:', error);
                    showVerificarMessage(
                        `<strong>Error de conexión</strong><br>
                        ${error.message}<br>
                        <small>Por favor intenta nuevamente o contacta al administrador.</small>`,
                        'error'
                    );
                    return;
                }
                
                if (!data) {
                    // No encontrado
                    const criterio = dni ? `DNI <strong>${dni}</strong>` : `nombre <strong>${nombreCompleto}</strong>`;
                    showVerificarMessage(
                        `<strong><i class="fas fa-times-circle"></i> Cuenta no encontrada</strong><br>
                        No existe una cuenta con ${criterio} en nuestro sistema.<br>
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <i class="fas fa-info-circle" style="color: #856404;"></i>
                            <span style="color: #856404;">
                                ¿Tu cuenta no está registrada? 
                                <a href="#" onclick="backToStep1bAndRequestForm(); return false;" style="color: var(--color-ata-verde); font-weight: bold; text-decoration: underline;">Solicita tu registro aquí</a>
                            </span>
                        </div>`,
                        'error'
                    );
                    return;
                }
                
                // Verificar nombre completo solo si ambos fueron ingresados
                if (dni && nombreCompleto) {
                    const nombreDB = data.nombre_completo.toUpperCase().trim();
                    if (nombreDB !== nombreCompleto) {
                        showVerificarMessage(
                            `<strong><i class="fas fa-exclamation-triangle"></i> Nombre no coincide</strong><br>
                            El nombre ingresado no coincide con el registrado para el DNI <strong>${dni}</strong>.<br>
                            <small>Nombre en sistema: <strong>${nombreDB}</strong></small>`,
                            'error'
                        );
                        return;
                    }
                }
                
                // 🔐 VERIFICAR SI LA CUENTA TIENE TODOS LOS DATOS COMPLETOS
                // Una cuenta se considera COMPLETAMENTE ACTIVADA solo si tiene:
                // 1. DNI registrado
                // 2. Email registrado
                // 3. Password creada (verificamos con password_hash)
                
                const tieneDNI = data.dni && data.dni.trim() !== '';
                const tieneEmail = data.email && data.email.trim() !== '';
                const tienePassword = data.password_hash && data.password_hash.trim() !== '';
                
                // Solo si tiene TODO completo → Ir a iniciar sesión
                if (tieneDNI && tieneEmail && tienePassword) {
                    showVerificarMessage(
                        `<strong><i class="fas fa-check-circle"></i> Cuenta completada</strong><br>
                        Tu cuenta ya tiene todos los datos registrados.<br><br>
                        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid var(--color-ata-azul);">
                            <i class="fas fa-sign-in-alt" style="color: #1565c0;"></i>
                            <span style="color: #1565c0;">
                                Si olvidaste tu contraseña, 
                                <a href="#" onclick="mostrarRecuperacionPassword(); return false;" style="color: var(--color-ata-verde); font-weight: bold; text-decoration: underline;">haz clic aquí</a>
                            </span>
                        </div>
                        <button onclick="irAIniciarSesion()" class="btn btn-primary" style="width: 100%; margin-top: 15px;">
                            <i class="fas fa-sign-in-alt"></i> Ir a Iniciar Sesión
                        </button>`,
                        'info'
                    );
                    
                    window.cuentaVerificada = data;
                    return;
                }
                
                // Si falta DNI, Email o Contraseña → Proceso progresivo
                showVerificarMessage(
                    `<strong><i class="fas fa-user-check"></i> Cuenta encontrada en el sistema</strong><br>
                    Completa el registro de tus datos para activar tu cuenta.<br><br>
                    <button onclick="mostrarCrearContrasena()" class="btn btn-success" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-key"></i> Completar Registro y Crear Contraseña
                    </button>`,
                    'success'
                );
                
                // Guardar referencia para el proceso progresivo
                window.cuentaVerificada = data;
                return;
                
            } catch (err) {
                console.error('Error verificando cuenta:', err);
                document.getElementById('verificarSpinner').style.display = 'none';
                document.getElementById('btnVerificar').disabled = false;
                showVerificarMessage('Error al conectar con el servidor. Intenta nuevamente.', 'error');
            }
        }
        
        // Función para mostrar mensajes de verificación
        function showVerificarMessage(message, type = 'error') {
            const messageContainer = document.getElementById('verificarMessage');
            messageContainer.innerHTML = message;
            messageContainer.className = `form-message ${type} show`;
        }
        
        // Función para volver a verificar
        function volverAVerificar() {
            // Mostrar step3a, ocultar step3b
            document.getElementById('step3a').style.display = 'block';
            document.getElementById('step3b').style.display = 'none';
            
            // Limpiar todos los campos de verificación
            document.getElementById('verificar_dni').value = '';
            document.getElementById('verificar_nombre').value = '';
            document.getElementById('verificarMessage').innerHTML = '';
            document.getElementById('verificarMessage').classList.remove('show');
            
            // Limpiar campos de contraseña
            document.getElementById('nueva_password').value = '';
            document.getElementById('confirmar_password').value = '';
            document.getElementById('activarMessage').innerHTML = '';
            document.getElementById('activarMessage').classList.remove('show');
            
            // Resetear medidor de seguridad
            const strengthContainer = document.getElementById('password-strength-container');
            if (strengthContainer) strengthContainer.style.display = 'none';
            
            // Limpiar validación de requisitos
            validarPasswordRequisitos();
            
            // Habilitar botón de activar
            const btnActivar = document.getElementById('btnActivar');
            if (btnActivar) btnActivar.disabled = false;
            
            window.cuentaVerificada = null;
        }
        
        // Función para activar cuenta final (crear contraseña)
        async function activarCuentaFinal() {
            const password = document.getElementById('nueva_password').value;
            const confirmarPassword = document.getElementById('confirmar_password').value;
            const messageContainer = document.getElementById('activarMessage');
            
            // Validaciones
            if (!password || !confirmarPassword) {
                messageContainer.innerHTML = 'Por favor completa todos los campos';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (password.length < 6) {
                messageContainer.innerHTML = 'La contraseña debe tener al menos 6 caracteres';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (password !== confirmarPassword) {
                messageContainer.innerHTML = 'Las contraseñas no coinciden';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (!window.cuentaVerificada) {
                messageContainer.innerHTML = 'Error: No hay cuenta verificada';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // 🔐 VALIDAR QUE EMAIL ESTÉ VERIFICADO
            if (!window.emailVerificado) {
                messageContainer.innerHTML = 'Por favor verifica primero tu correo electrónico';
                messageContainer.className = 'form-message error show';
                document.getElementById('email_activacion').focus();
                return;
            }
            
            // Deshabilitar botón
            document.getElementById('btnActivar').disabled = true;
            messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando cuenta...';
            messageContainer.className = 'form-message info show';
            
            try {
                // Crear usuario en Supabase Auth con el email verificado
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: window.emailVerificado,
                    password: password
                });
                
                if (authError) {
                    throw authError;
                }
                
                // Actualizar campos en la tabla users: DNI + email + teléfono + activado=true
                const updateData = { 
                    email: window.emailVerificado,
                    activado: true 
                };
                
                // Agregar DNI si se registró
                if (window.cuentaVerificada.dni) {
                    updateData.dni = window.cuentaVerificada.dni;
                }
                
                // Agregar teléfono si se registró
                if (window.cuentaVerificada.telefono) {
                    updateData.telefono = window.cuentaVerificada.telefono;
                }
                
                const { error: updateError } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', window.cuentaVerificada.id);
                
                if (updateError) {
                    throw updateError;
                }
                
                messageContainer.innerHTML = `
                    <strong><i class="fas fa-check-circle"></i> ¡Cuenta activada exitosamente!</strong><br>
                    Iniciando sesión automáticamente...
                `;
                messageContainer.className = 'form-message success show';
                
                // Auto-login: Configurar usuario actual y entrar a la app
                setTimeout(() => {
                    currentUser = {
                        username: window.cuentaVerificada.dni || window.emailVerificado,
                        email: window.emailVerificado,
                        role: window.cuentaVerificada.role,
                        nombre: window.cuentaVerificada.nombre_completo,
                        dni: window.cuentaVerificada.dni,
                        id: window.cuentaVerificada.id
                    };
                    
                    console.log('✅ Auto-login después de activación:', currentUser);
                    
                    // Entrar directamente a la aplicación
                    login();
                }, 2000);
                
            } catch (err) {
                console.error('Error activando cuenta:', err);
                document.getElementById('btnActivar').disabled = false;
                messageContainer.innerHTML = `Error al activar cuenta: ${err.message}`;
                messageContainer.className = 'form-message error show';
            }
        }
        
        // Función para mostrar recuperación de contraseña
        async function mostrarRecuperarContrasena() {
            if (!window.cuentaVerificada || !window.cuentaVerificada.email) {
                showVerificarMessage('Error: No hay cuenta verificada', 'error');
                return;
            }
            
            const confirmar = confirm(
                `¿Enviar correo de recuperación a:\n${window.cuentaVerificada.email}?\n\n` +
                `Recibirás un enlace para restablecer tu contraseña.`
            );
            
            if (!confirmar) return;
            
            try {
                showVerificarMessage('<i class="fas fa-spinner fa-spin"></i> Enviando correo...', 'info');
                
                const { error } = await supabase.auth.resetPasswordForEmail(
                    window.cuentaVerificada.email,
                    {
                        redirectTo: window.location.origin + '/reset-password'
                    }
                );
                
                if (error) throw error;
                
                showVerificarMessage(
                    `<strong><i class="fas fa-envelope-circle-check"></i> Correo enviado</strong><br>
                    Revisa tu bandeja de entrada en <strong>${window.cuentaVerificada.email}</strong><br>
                    <small>Si no lo ves, revisa la carpeta de spam.</small>`,
                    'success'
                );
                
            } catch (err) {
                console.error('Error enviando correo:', err);
                showVerificarMessage(
                    `<strong>Error al enviar correo</strong><br>
                    ${err.message}<br>
                    <small>Contacta al administrador del sistema.</small>`,
                    'error'
                );
            }
        }
        
        // ==================== FUNCIONES DE RECUPERACIÓN DE CONTRASEÑA ====================
        
        // Función para mostrar pantalla de recuperación desde login
        function mostrarRecuperacionPassword() {
            const step2 = document.getElementById('step2');
            const step4 = document.getElementById('step4');
            
            // Ocultar step2 (login)
            step2.classList.remove('visible');
            step2.classList.add('hidden');
            
            // Limpiar formulario de recuperación y resetear estado
            document.getElementById('recuperar_dni').value = '';
            document.getElementById('recuperar_nombre').value = '';
            document.getElementById('recuperarMessage').innerHTML = '';
            document.getElementById('recuperarMessage').className = 'form-message';
            document.getElementById('step4b').style.display = 'none';
            document.getElementById('step5').style.display = 'none';
            window.usuarioRecuperar = null;
            
            // IMPORTANTE: Resetear el botón de verificar
            const btnVerificar = document.getElementById('btnVerificarRecuperar');
            if (btnVerificar) {
                btnVerificar.disabled = false;
                btnVerificar.innerHTML = '<i class="fas fa-search"></i> Buscar mi cuenta';
            }
            
            // Mostrar step4 (recuperación)
            setTimeout(() => {
                step4.classList.remove('hidden');
                step4.classList.add('visible');
                setTimeout(() => {
                    document.getElementById('recuperar_dni').focus();
                }, 300);
            }, 300);
        }
        
        // Función para volver al login desde recuperación
        function volverALogin() {
            const step4 = document.getElementById('step4');
            const step1 = document.getElementById('step1');
            const step1b = document.getElementById('step1b');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            
            // Resetear variables globales
            selectedUserRole = null;
            window.usuarioRecuperar = null;
            
            // Limpiar campos de recuperación
            document.getElementById('recuperar_dni').value = '';
            document.getElementById('recuperar_nombre').value = '';
            document.getElementById('email_verificar_recuperar').value = '';
            document.getElementById('recuperarMessage').innerHTML = '';
            document.getElementById('recuperarMessage').className = 'form-message';
            document.getElementById('cambiarMessage').innerHTML = '';
            
            // IMPORTANTE: Resetear el botón de verificar para que funcione de nuevo
            const btnVerificar = document.getElementById('btnVerificarRecuperar');
            if (btnVerificar) {
                btnVerificar.disabled = false;
                btnVerificar.innerHTML = '<i class="fas fa-search"></i> Buscar mi cuenta';
            }
            
            // Ocultar sub-steps de recuperación
            document.getElementById('step4b').style.display = 'none';
            document.getElementById('step5').style.display = 'none';
            
            // Ocultar TODOS los steps y limpiar estilos inline
            step4.classList.remove('visible');
            step4.classList.add('hidden');
            step4.style.display = '';
            
            step1b.classList.remove('visible');
            step1b.classList.add('hidden');
            step1b.style.display = '';
            
            step2.classList.remove('visible');
            step2.classList.add('hidden');
            step2.style.display = '';
            
            step3.classList.remove('visible');
            step3.classList.add('hidden');
            step3.style.display = '';
            
            // Mostrar step1 (selección de tipo de cuenta) después del delay
            setTimeout(() => {
                step1.style.display = '';
                step1.classList.remove('hidden');
                step1.classList.add('visible');
            }, 350);
        }
        
        // Función para verificar DNI o Nombre y mostrar hint de email
        async function verificarDNIparaRecuperar() {
            const dni = document.getElementById('recuperar_dni').value.trim();
            const nombre = document.getElementById('recuperar_nombre').value.trim().toUpperCase();
            const messageContainer = document.getElementById('recuperarMessage');
            const btnVerificar = document.getElementById('btnVerificarRecuperar');
            
            // Validar que al menos uno esté lleno
            if (!dni && !nombre) {
                messageContainer.innerHTML = 'Por favor ingresa tu DNI o Nombre Completo';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // Validar DNI si se proporcionó
            if (dni && (dni.length !== 8 || !/^\d{8}$/.test(dni))) {
                messageContainer.innerHTML = 'El DNI debe tener exactamente 8 dígitos';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            try {
                btnVerificar.disabled = true;
                messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando cuenta...';
                messageContainer.className = 'form-message info show';
                
                // Construir query flexible (DNI OR Nombre)
                let query = supabase
                    .from('users')
                    .select('id, nombre_completo, email, dni, role, activado');
                
                if (dni && nombre) {
                    // Ambos: Buscar por DNI O nombre
                    query = query.or(`dni.eq.${dni},nombre_completo.ilike.%${nombre}%`);
                } else if (dni) {
                    // Solo DNI
                    query = query.eq('dni', dni);
                } else {
                    // Solo nombre
                    query = query.ilike('nombre_completo', `%${nombre}%`);
                }
                
                const { data, error } = await query.maybeSingle();
                
                if (error) throw error;
                
                if (!data) {
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-times-circle"></i> No encontrado</strong><br>
                        No existe una cuenta con ${dni ? `DNI <strong>${dni}</strong>` : ''}${dni && nombre ? ' o ' : ''}${nombre ? `nombre <strong>${nombre}</strong>` : ''} en el sistema.
                    `;
                    messageContainer.className = 'form-message error show';
                    btnVerificar.disabled = false;
                    return;
                }
                
                if (!data.activado) {
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-info-circle"></i> Cuenta no activada</strong><br>
                        Tu cuenta aún no ha sido activada. Por favor, usa "Activar cuenta" en lugar de recuperar contraseña.
                    `;
                    messageContainer.className = 'form-message info show';
                    btnVerificar.disabled = false;
                    return;
                }
                
                // Guardar usuario para recuperación
                window.usuarioRecuperar = data;
                
                // Verificar si tiene email válido
                const tieneEmail = data.email && data.email !== null && data.email.trim() !== '';
                
                if (!tieneEmail) {
                    // Usuario SIN email → No puede recuperar contraseña
                    messageContainer.innerHTML = `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
                            <strong style="color: #856404;">No tienes email registrado</strong><br>
                            <p style="color: #856404; margin: 10px 0 0 0; font-size: 13px;">
                                Para recuperar tu contraseña necesitas tener un correo electrónico registrado.<br>
                                Por favor, contacta al administrador del sistema.
                            </p>
                        </div>
                    `;
                    messageContainer.className = 'form-message error show';
                    btnVerificar.disabled = false;
                    return;
                }
                
                // Usuario CON email → Mostrar nombre y pedir email completo
                document.getElementById('nombreUsuarioRecuperar').innerHTML = `
                    Usuario: <strong>${data.nombre_completo}</strong>
                `;
                
                messageContainer.innerHTML = '';
                messageContainer.classList.remove('show');
                
                // Mostrar step4b (formulario de email)
                document.getElementById('step4b').style.display = 'block';
                
                setTimeout(() => {
                    document.getElementById('email_verificar_recuperar').focus();
                }, 300);
                
            } catch (err) {
                console.error('Error verificando DNI:', err);
                messageContainer.innerHTML = `Error al buscar cuenta: ${err.message}`;
                messageContainer.className = 'form-message error show';
                btnVerificar.disabled = false;
            }
        }
        
        // Función auxiliar para censurar email
        function censurarEmail(email) {
            if (!email || !email.includes('@')) return '***@***.***';
            
            const [local, domain] = email.split('@');
            const [domainName, domainExt] = domain.split('.');
            
            // Censurar parte local (mostrar primeros 2 y últimos 2)
            let localCensurado;
            if (local.length <= 4) {
                localCensurado = local[0] + '***';
            } else {
                localCensurado = local.substring(0, 2) + '***' + local.substring(local.length - 2);
            }
            
            // Censurar dominio (mostrar primeras 2 letras)
            const dominioCensurado = domainName.substring(0, 2) + '***';
            
            return `${localCensurado}@${dominioCensurado}.${domainExt}`;
        }
        
        // Función para validar contraseña de recuperación
        function validarPasswordRecuperar() {
            const password = document.getElementById('nueva_password_recuperar')?.value || '';
            const confirmPassword = document.getElementById('confirmar_password_recuperar')?.value || '';
            
            const strengthContainer = document.getElementById('password-strength-container-2');
            const strengthBar = document.getElementById('password-strength-bar-2');
            const strengthText = document.getElementById('password-strength-text-2');
            
            // Calcular nivel de seguridad (mismo algoritmo)
            if (password.length > 0) {
                strengthContainer.style.display = 'block';
                let strength = 0;
                
                if (password.length >= 6) strength += 25;
                if (password.length >= 8) strength += 15;
                if (password.length >= 10) strength += 10;
                if (/[a-z]/.test(password)) strength += 10;
                if (/[A-Z]/.test(password)) strength += 15;
                if (/[0-9]/.test(password)) strength += 15;
                if (/[^a-zA-Z0-9]/.test(password)) strength += 10;
                
                let strengthLabel = '';
                let strengthColor = '';
                
                if (strength < 40) {
                    strengthLabel = 'Baja';
                    strengthColor = '#f44336';
                } else if (strength < 70) {
                    strengthLabel = 'Media';
                    strengthColor = '#ff9800';
                } else {
                    strengthLabel = 'Alta';
                    strengthColor = '#4caf50';
                }
                
                strengthBar.style.width = strength + '%';
                strengthBar.style.background = strengthColor;
                strengthText.textContent = strengthLabel;
                strengthText.style.color = strengthColor;
            } else {
                strengthContainer.style.display = 'none';
            }
        }
        
        // Función para enviar email de recuperación
        async function enviarEmailRecuperacion() {
            const emailIngresado = document.getElementById('email_verificar_recuperar').value.trim().toLowerCase();
            const messageContainer = document.getElementById('cambiarMessage');
            const btnEnviar = document.getElementById('btnEnviarRecuperacion');
            
            // Validaciones
            if (!emailIngresado) {
                messageContainer.innerHTML = 'Por favor ingresa tu correo electrónico';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(emailIngresado)) {
                messageContainer.innerHTML = 'Por favor ingresa un correo electrónico válido';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (!window.usuarioRecuperar) {
                messageContainer.innerHTML = 'Error: No hay usuario verificado';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // Verificar que el email coincida con el registrado
            const emailRegistrado = window.usuarioRecuperar.email.trim().toLowerCase();
            if (emailIngresado !== emailRegistrado) {
                messageContainer.innerHTML = `
                    <strong><i class="fas fa-times-circle"></i> Email incorrecto</strong><br>
                    El correo ingresado no coincide con el registrado en tu cuenta.<br>
                    <small>Por favor, ingresa el email correcto para verificar tu identidad.</small>
                `;
                messageContainer.className = 'form-message error show';
                return;
            }
            
            try {
                btnEnviar.disabled = true;
                messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando correo de recuperación...';
                messageContainer.className = 'form-message info show';
                
                // Enviar email de recuperación con Supabase Auth
                const { error: resetError } = await supabase.auth.resetPasswordForEmail(
                    emailRegistrado,
                    {
                        redirectTo: window.location.origin + '/?reset=true'
                    }
                );
                
                if (resetError) throw resetError;
                
                // Ocultar step4b
                document.getElementById('step4b').style.display = 'none';
                
                // Mostrar step5 con animación
                document.getElementById('emailEnviadoDestino').textContent = emailRegistrado;
                document.getElementById('step5').style.display = 'block';
                
                // Scroll suave hacia step5
                setTimeout(() => {
                    document.getElementById('step5').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);
                
            } catch (err) {
                console.error('Error enviando email:', err);
                messageContainer.innerHTML = `Error al enviar correo: ${err.message}`;
                messageContainer.className = 'form-message error show';
                btnEnviar.disabled = false;
            }
        }
        
        // Función para cambiar contraseña final
        async function cambiarPasswordFinal() {
            const password = document.getElementById('nueva_password_recuperar').value;
            const confirmarPassword = document.getElementById('confirmar_password_recuperar').value;
            const nombreCompleto = document.getElementById('nombre_completo_recuperar').value.trim().toUpperCase();
            const messageContainer = document.getElementById('cambiarMessage');
            const btnCambiar = document.getElementById('btnCambiarPassword');
            
            // Validaciones básicas
            if (!password || !confirmarPassword) {
                messageContainer.innerHTML = 'Por favor completa todos los campos';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (password.length < 6) {
                messageContainer.innerHTML = 'La contraseña debe tener al menos 6 caracteres';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (password !== confirmarPassword) {
                messageContainer.innerHTML = 'Las contraseñas no coinciden';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            if (!window.usuarioRecuperar) {
                messageContainer.innerHTML = 'Error: No hay usuario verificado';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            // Verificar si tiene email real
            const tieneEmail = window.usuarioRecuperar.email && !window.usuarioRecuperar.email.includes('@ata.local');
            
            // Si NO tiene email, validar nombre completo
            if (!tieneEmail) {
                if (!nombreCompleto) {
                    messageContainer.innerHTML = 'Por favor ingresa tu nombre completo para verificar tu identidad';
                    messageContainer.className = 'form-message error show';
                    return;
                }
                
                // Validar que el nombre coincida
                const nombreDB = window.usuarioRecuperar.nombre_completo.toUpperCase().trim();
                if (nombreDB !== nombreCompleto) {
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-times-circle"></i> Nombre no coincide</strong><br>
                        El nombre ingresado no coincide con el registrado.<br>
                        <small>Nombre esperado: <strong>${nombreDB}</strong></small>
                    `;
                    messageContainer.className = 'form-message error show';
                    return;
                }
            }
            
            try {
                btnCambiar.disabled = true;
                messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando contraseña...';
                messageContainer.className = 'form-message info show';
                
                if (tieneEmail) {
                    // CASO 1: Usuario CON email → Enviar correo de recuperación
                    const { error: resetError } = await supabase.auth.resetPasswordForEmail(
                        window.usuarioRecuperar.email,
                        {
                            redirectTo: window.location.origin + '/reset-password.html'
                        }
                    );
                    
                    if (resetError) throw resetError;
                    
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-envelope-circle-check"></i> Correo enviado</strong><br>
                        Hemos enviado un enlace de recuperación a <strong>${censurarEmail(window.usuarioRecuperar.email)}</strong><br>
                        <small>Revisa tu bandeja de entrada y sigue las instrucciones.</small>
                    `;
                    messageContainer.className = 'form-message success show';
                    
                    // Volver al login después de 5 segundos
                    setTimeout(() => {
                        volverALogin();
                    }, 5000);
                    
                } else {
                    // CASO 2: Usuario SIN email → Cambiar contraseña DIRECTAMENTE
                    // Necesitamos usar Admin API (no disponible en frontend)
                    // WORKAROUND: Crear cuenta Auth con email ficticio
                    
                    const emailFicticio = `${window.usuarioRecuperar.dni}@ata.local`;
                    
                    // Intentar crear/actualizar cuenta en Supabase Auth
                    const { data: authData, error: signUpError } = await supabase.auth.signUp({
                        email: emailFicticio,
                        password: password
                    });
                    
                    if (signUpError && !signUpError.message.includes('already registered')) {
                        throw signUpError;
                    }
                    
                    // Si ya existía, intentar login para actualizar contraseña
                    if (signUpError && signUpError.message.includes('already registered')) {
                        // Usuario ya tiene cuenta, necesitamos Admin API para cambiar contraseña
                        // Por ahora, mostrar mensaje pidiendo contactar admin
                        messageContainer.innerHTML = `
                            <strong><i class="fas fa-exclamation-triangle"></i> Cuenta ya existe</strong><br>
                            Tu cuenta ya tiene una contraseña registrada. Para cambiarla, contacta al administrador del sistema.<br>
                            <small>Email: soporte@ata.edu.pe</small>
                        `;
                        messageContainer.className = 'form-message error show';
                        btnCambiar.disabled = false;
                        return;
                    }
                    
                    // Actualizar email en tabla users si era ficticio
                    if (!window.usuarioRecuperar.email || window.usuarioRecuperar.email.includes('@ata.local')) {
                        await supabase
                            .from('users')
                            .update({ email: emailFicticio })
                            .eq('id', window.usuarioRecuperar.id);
                    }
                    
                    messageContainer.innerHTML = `
                        <strong><i class="fas fa-check-circle"></i> ¡Contraseña actualizada!</strong><br>
                        Tu contraseña ha sido cambiada exitosamente. Ya puedes iniciar sesión con tu DNI y la nueva contraseña.
                    `;
                    messageContainer.className = 'form-message success show';
                    
                    // Volver al login después de 3 segundos
                    setTimeout(() => {
                        volverALogin();
                    }, 3000);
                }
                
            } catch (err) {
                console.error('Error cambiando contraseña:', err);
                btnCambiar.disabled = false;
                messageContainer.innerHTML = `Error: ${err.message}`;
                messageContainer.className = 'form-message error show';
            }
        }
        
        // Función para volver a login
        function backToStep1bAndLogin() {
            const step3 = document.getElementById('step3');
            const step1b = document.getElementById('step1b');
            
            step3.classList.remove('visible');
            step3.classList.add('hidden');
            
            setTimeout(() => {
                step1b.classList.remove('hidden');
                step1b.classList.add('visible');
                
                setTimeout(() => {
                    showDemoLogin();
                }, 300);
            }, 300);
        }
        
        // Función para ir directamente a iniciar sesión desde verificación
        function irAIniciarSesion() {
            const step3 = document.getElementById('step3');
            const step2 = document.getElementById('step2');
            
            // Ocultar step3
            step3.classList.remove('visible');
            step3.classList.add('hidden');
            
            // Resetear step3a
            document.getElementById('step3a').style.display = 'block';
            document.getElementById('step3b').style.display = 'none';
            document.getElementById('verificar_dni').value = '';
            document.getElementById('verificar_nombre').value = '';
            document.getElementById('verificarMessage').innerHTML = '';
            document.getElementById('verificarMessage').classList.remove('show');
            window.cuentaVerificada = null;
            
            // Mostrar step2 (login)
            setTimeout(() => {
                step2.classList.remove('hidden');
                step2.classList.add('visible');
                
                setTimeout(() => {
                    document.getElementById('username').focus();
                }, 300);
            }, 300);
        }
        
        // Función para mostrar el formulario de crear contraseña (step3b)
        function mostrarCrearContrasena() {
            if (!window.cuentaVerificada) {
                showVerificarMessage('Error: No hay cuenta verificada', 'error');
                return;
            }
            
            // Ocultar step3a, mostrar step3b
            document.getElementById('step3a').style.display = 'none';
            document.getElementById('step3b').style.display = 'block';
            
            // Limpiar todos los campos
            document.getElementById('dni_activacion').value = '';
            document.getElementById('email_activacion').value = '';
            document.getElementById('telefono_activacion').value = '';
            document.getElementById('nueva_password').value = '';
            document.getElementById('confirmar_password').value = '';
            
            // Ocultar todas las secciones inicialmente
            document.getElementById('emailSection').style.display = 'none';
            document.getElementById('telefonoSection').style.display = 'none';
            document.getElementById('passwordSection').style.display = 'none';
            
            // Limpiar mensajes
            document.getElementById('dniVerificacionMessage').innerHTML = '';
            document.getElementById('emailVerificacionMessage').innerHTML = '';
            document.getElementById('telefonoVerificacionMessage').innerHTML = '';
            document.getElementById('activarMessage').innerHTML = '';
            
            // Resetear íconos
            document.getElementById('dniCheckIcon').style.display = 'none';
            document.getElementById('telefonoCheckIcon').style.display = 'none';
            
            // Variables globales
            window.emailVerificado = null;
            window.datosRegistro = {
                dniVerificado: false,
                emailVerificado: false,
                telefonoVerificado: false
            };
            
            // PASO 1: VERIFICAR DNI
            verificarDNIExistente();
        }
        
        // Función para verificar si el usuario ya tiene DNI
        function verificarDNIExistente() {
            const usuario = window.cuentaVerificada;
            const messageContainer = document.getElementById('dniVerificacionMessage');
            const dniInput = document.getElementById('dni_activacion');
            const dniIcon = document.getElementById('dniCheckIcon');
            
            if (usuario.dni && usuario.dni.trim() !== '') {
                // YA TIENE DNI - NO mostrar el DNI completo
                dniInput.value = '';
                dniInput.disabled = true;
                dniInput.placeholder = 'DNI ya registrado en el sistema';
                dniIcon.style.display = 'block';
                
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                    <strong style="color: #28a745;">✓ DNI existente para este usuario</strong><br>
                    <small>Tu DNI ya está verificado en el sistema</small>
                `;
                messageContainer.className = 'form-message success show';
                
                window.datosRegistro.dniVerificado = true;
                
                // Pasar automáticamente a verificar EMAIL
                setTimeout(() => {
                    verificarEmailExistente();
                }, 500);
            } else {
                // NO TIENE DNI - Debe introducirlo
                dniInput.disabled = false;
                dniInput.placeholder = '12345678';
                dniInput.focus();
                
                messageContainer.innerHTML = `
                    <i class="fas fa-info-circle" style="color: #0066cc;"></i> 
                    <strong>Debes registrar tu DNI</strong><br>
                    <small>Ingresa tu documento de identidad de 8 dígitos</small>
                `;
                messageContainer.className = 'form-message info show';
                
                // Agregar evento para validar DNI cuando lo escriba
                dniInput.addEventListener('input', function() {
                    const dni = this.value.trim();
                    if (dni.length === 8 && /^\d{8}$/.test(dni)) {
                        validarDNIIngresado(dni);
                    }
                });
            }
        }
        
        // Función para validar DNI ingresado manualmente
        async function validarDNIIngresado(dni) {
            const messageContainer = document.getElementById('dniVerificacionMessage');
            const dniIcon = document.getElementById('dniCheckIcon');
            
            try {
                // Verificar que el DNI no esté ya registrado
                const { data, error } = await supabase
                    .from('users')
                    .select('id')
                    .eq('dni', dni)
                    .maybeSingle();
                
                if (data) {
                    // DNI ya existe en otro usuario
                    messageContainer.innerHTML = `
                        <i class="fas fa-times-circle"></i> 
                        <strong>DNI ya registrado</strong><br>
                        <small>Este DNI ya está asignado a otra cuenta</small>
                    `;
                    messageContainer.className = 'form-message error show';
                    dniIcon.style.display = 'none';
                    window.datosRegistro.dniVerificado = false;
                    return;
                }
                
                // DNI válido y disponible
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                    <strong style="color: #28a745;">DNI válido</strong>
                `;
                messageContainer.className = 'form-message success show';
                dniIcon.style.display = 'block';
                document.getElementById('dni_activacion').disabled = true;
                
                window.datosRegistro.dniVerificado = true;
                
                // Guardar DNI en cuentaVerificada
                window.cuentaVerificada.dni = dni;
                
                // Pasar a EMAIL
                setTimeout(() => {
                    verificarEmailExistente();
                }, 500);
                
            } catch (err) {
                messageContainer.innerHTML = 'Error al validar DNI';
                messageContainer.className = 'form-message error show';
            }
        }
        
        // Función para verificar si el usuario ya tiene EMAIL
        function verificarEmailExistente() {
            const usuario = window.cuentaVerificada;
            const messageContainer = document.getElementById('emailVerificacionMessage');
            const emailInput = document.getElementById('email_activacion');
            const emailSection = document.getElementById('emailSection');
            
            // Mostrar sección de email
            emailSection.style.display = 'block';
            
            if (usuario.email && usuario.email.trim() !== '') {
                // YA TIENE EMAIL - NO mostrar el email completo
                window.emailVerificado = usuario.email;
                emailInput.value = '';
                emailInput.disabled = true;
                emailInput.placeholder = 'Email ya registrado en el sistema';
                document.getElementById('btnVerificarEmail').style.display = 'none';
                
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                    <strong style="color: #28a745;">✓ Email registrado</strong><br>
                    <small>Ya tienes un correo electrónico asociado (no se muestra por seguridad)</small>
                `;
                messageContainer.className = 'form-message success show';
                
                window.datosRegistro.emailVerificado = true;
                
                // Pasar automáticamente a TELÉFONO
                setTimeout(() => {
                    verificarTelefonoExistente();
                }, 500);
            } else {
                // NO TIENE EMAIL - Debe introducirlo (validación automática)
                emailInput.disabled = false;
                emailInput.value = '';
                emailInput.placeholder = 'ejemplo@correo.com';
                document.getElementById('btnVerificarEmail').style.display = 'none'; // OCULTAR botón verificar
                
                messageContainer.innerHTML = `
                    <i class="fas fa-exclamation-circle" style="color: #ff6b6b;"></i> 
                    <strong style="color: #ff6b6b;">Este usuario no tiene correo electrónico registrado</strong><br>
                    <small>Ingresa tu email para continuar (se validará automáticamente)</small>
                `;
                messageContainer.className = 'form-message error show';
                
                // Validación automática mientras escribe
                emailInput.addEventListener('blur', async function() {
                    const email = this.value.trim().toLowerCase();
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    
                    if (!email) return;
                    
                    if (!emailRegex.test(email)) {
                        messageContainer.innerHTML = `
                            <i class="fas fa-times-circle"></i> 
                            <strong style="color: #dc3545;">Email inválido</strong><br>
                            <small>Por favor ingresa un correo válido</small>
                        `;
                        messageContainer.className = 'form-message error show';
                        return;
                    }
                    
                    // Verificar unicidad en la base de datos
                    try {
                        messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validando email...';
                        messageContainer.className = 'form-message info show';
                        
                        const { data, error } = await supabase
                            .from('users')
                            .select('id')
                            .eq('email', email)
                            .maybeSingle();
                        
                        if (error) throw error;
                        
                        if (data) {
                            // Email ya existe
                            messageContainer.innerHTML = `
                                <i class="fas fa-times-circle"></i> 
                                <strong style="color: #dc3545;">Email ya registrado</strong><br>
                                <small>Este correo ya está en uso. Usa otro.</small>
                            `;
                            messageContainer.className = 'form-message error show';
                            emailInput.value = '';
                            emailInput.focus();
                            return;
                        }
                        
                        // Email disponible ✅
                        messageContainer.innerHTML = `
                            <i class="fas fa-check-circle"></i> 
                            <strong style="color: #28a745;">✓ Email disponible</strong><br>
                            <small>Este correo se usará para tu cuenta</small>
                        `;
                        messageContainer.className = 'form-message success show';
                        
                        window.emailVerificado = email;
                        window.cuentaVerificada.email = email;
                        window.datosRegistro.emailVerificado = true;
                        emailInput.disabled = true;
                        
                        // Pasar automáticamente a TELÉFONO
                        setTimeout(() => {
                            verificarTelefonoExistente();
                        }, 500);
                        
                    } catch (err) {
                        console.error('Error:', err);
                        messageContainer.innerHTML = 'Error al validar email';
                        messageContainer.className = 'form-message error show';
                    }
                });
                
                setTimeout(() => {
                    emailInput.focus();
                }, 300);
            }
        }
        
        // Función para verificar si el usuario ya tiene TELÉFONO
        function verificarTelefonoExistente() {
            const usuario = window.cuentaVerificada;
            const messageContainer = document.getElementById('telefonoVerificacionMessage');
            const telefonoInput = document.getElementById('telefono_activacion');
            const telefonoSection = document.getElementById('telefonoSection');
            const telefonoIcon = document.getElementById('telefonoCheckIcon');
            
            // Mostrar sección de teléfono
            telefonoSection.style.display = 'block';
            
            if (usuario.telefono && usuario.telefono.trim() !== '') {
                // YA TIENE TELÉFONO - NO mostrar el número completo
                telefonoInput.value = '';
                telefonoInput.disabled = true;
                telefonoInput.placeholder = 'Teléfono ya registrado en el sistema';
                telefonoIcon.style.display = 'block';
                
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #28a745;"></i> 
                    <strong style="color: #28a745;">✓ Teléfono registrado</strong><br>
                    <small>Ya tienes un número asociado (no se muestra por seguridad)</small>
                `;
                messageContainer.className = 'form-message success show';
                
                window.datosRegistro.telefonoVerificado = true;
                
                // Pasar automáticamente a CONTRASEÑA
                setTimeout(() => {
                    mostrarSeccionPassword();
                }, 500);
            } else {
                // NO TIENE TELÉFONO - Es opcional
                telefonoInput.disabled = false;
                telefonoInput.value = '';
                telefonoInput.placeholder = '987654321';
                
                messageContainer.innerHTML = `
                    <i class="fas fa-info-circle" style="color: #0066cc;"></i> 
                    <strong>Teléfono opcional</strong><br>
                    <small>Puedes ingresar tu número o continuar sin él</small>
                `;
                messageContainer.className = 'form-message info show';
                
                // Agregar validación en tiempo real
                telefonoInput.addEventListener('input', function() {
                    const tel = this.value.trim();
                    if (tel.length === 9 && /^\d{9}$/.test(tel)) {
                        telefonoIcon.style.display = 'block';
                        window.datosRegistro.telefonoVerificado = true;
                        window.cuentaVerificada.telefono = tel;
                        
                        // Auto-continuar a contraseña
                        setTimeout(() => {
                            mostrarSeccionPassword();
                        }, 800);
                    } else {
                        telefonoIcon.style.display = 'none';
                    }
                });
                
                setTimeout(() => {
                    telefonoInput.focus();
                }, 300);
            }
        }
        
        // Función para continuar sin teléfono
        function continuarSinTelefono() {
            window.datosRegistro.telefonoVerificado = true; // Marcar como completado
            mostrarSeccionPassword();
        }
        
        // Función para mostrar sección de contraseña
        function mostrarSeccionPassword() {
            document.getElementById('passwordSection').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('nueva_password').focus();
                // Scroll suave
                document.getElementById('passwordSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 300);
        }
        
        // Función para verificar que el email no esté ya registrado
        async function verificarEmailDisponible() {
            const email = document.getElementById('email_activacion').value.trim().toLowerCase();
            const messageContainer = document.getElementById('emailVerificacionMessage');
            
            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email || !emailRegex.test(email)) {
                messageContainer.innerHTML = '<i class="fas fa-times-circle"></i> Por favor ingresa un email válido';
                messageContainer.className = 'form-message error show';
                return;
            }
            
            try {
                messageContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando email...';
                messageContainer.className = 'form-message info show';
                
                // Buscar si el email ya existe en la tabla users
                const { data, error } = await supabase
                    .from('users')
                    .select('id, email')
                    .eq('email', email)
                    .maybeSingle();
                
                if (error) throw error;
                
                if (data) {
                    // Email ya existe
                    messageContainer.innerHTML = `
                        <i class="fas fa-times-circle"></i> 
                        <strong>Email ya registrado</strong><br>
                        Este correo ya está en uso. Por favor usa otro.
                    `;
                    messageContainer.className = 'form-message error show';
                    window.emailVerificado = null;
                    return;
                }
                
                // Email disponible
                messageContainer.innerHTML = `
                    <i class="fas fa-check-circle"></i> 
                    <strong>Email disponible</strong><br>
                    Puedes usar este correo para tu cuenta.
                `;
                messageContainer.className = 'form-message success show';
                
                // Guardar email verificado
                window.emailVerificado = email;
                window.cuentaVerificada.email = email;
                window.datosRegistro.emailVerificado = true;
                
                // Deshabilitar campo email
                document.getElementById('email_activacion').disabled = true;
                document.getElementById('btnVerificarEmail').style.display = 'none';
                
                // Pasar automáticamente a TELÉFONO
                setTimeout(() => {
                    verificarTelefonoExistente();
                }, 500);
                
            } catch (err) {
                console.error('Error verificando email:', err);
                messageContainer.innerHTML = `Error: ${err.message}`;
                messageContainer.className = 'form-message error show';
                window.emailVerificado = null;
            }
        }
                step2.classList.remove('hidden');
                step2.classList.add('visible');
                
                // Limpiar campos
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
                // Mostrar mensaje informativo sobre activación
        // Función para volver a step1b y mostrar activación
        function backToStep1bAndActivate() {
            const step2 = document.getElementById('step2');
            const step1b = document.getElementById('step1b');
            
            // Ocultar step2
            step2.classList.remove('visible');
            step2.classList.add('hidden');
            
            // Mostrar step1b
            setTimeout(() => {
                step1b.classList.remove('hidden');
                step1b.classList.add('visible');
                
                // Hacer clic automático en el botón de activar cuenta
                setTimeout(() => {
                    showActivarCuenta();
                }, 300);
            }, 300);
        }
        
        // Función para volver a step1b y mostrar formulario de solicitud
        // Función para volver a step1b y mostrar formulario de solicitud
        function backToStep1bAndRequestForm() {
            const step2 = document.getElementById('step2');
            const step1b = document.getElementById('step1b');
            const step3a = document.getElementById('step3a');
            
            // Ocultar todos los steps
            if (step2) {
                step2.classList.remove('visible');
                step2.classList.add('hidden');
            }
            if (step3a) {
                step3a.style.display = 'none';
            }
            
            // Mostrar step1b
            step1b.classList.remove('hidden');
            step1b.classList.add('visible');
            step1b.style.display = 'block';
            
            // Hacer scroll arriba
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Abrir el formulario de solicitud después de un breve delay
            setTimeout(() => {
                showRequestForm();
            }, 500);
        }

        // Función eliminada: showDemoBanner() - sistema ya no muestra banner DEMO

        // Función eliminada: hideDemoBanner() - banner DEMO ya no se usa

        // Función para mostrar el formulario de solicitud
        function showRequestForm() {
            const requestForm = document.getElementById('requestForm');
            const roleRequirements = document.getElementById('roleRequirements');
            const specificFields = document.getElementById('specificFields');
            
            // Configurar requisitos según el rol
            const requirements = {
                'docente': {
                    title: 'Requisitos para Cuenta de Docente',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Constancia de trabajo vigente en la I.E. 80002',
                        'Resolución de nombramiento (si aplica)',
                        'Foto tamaño carnet actualizada'
                    ],
                    fields: `
                        <h6>Información Profesional</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_docente" required>
                                <option value="">Seleccione el rol</option>
                                <option value="docente">Docente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Especialidad</label>
                            <select class="form-input" required>
                                <option value="">Seleccione su especialidad</option>
                                <option value="matematica">Matemática</option>
                                <option value="comunicacion">Comunicación</option>
                                <option value="ciencias">Ciencias Naturales</option>
                                <option value="sociales">Ciencias Sociales</option>
                                <option value="ingles">Inglés</option>
                                <option value="educacion-fisica">Educación Física</option>
                                <option value="arte">Arte y Cultura</option>
                                <option value="religion">Educación Religiosa</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Años de experiencia en la I.E.</label>
                            <input type="number" class="form-input" placeholder="Ej: 5" min="0" required>
                        </div>
                    `
                },
                'tutor': {
                    title: 'Requisitos para Cuenta de Tutor',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Resolución de designación como tutor',
                        'Constancia de trabajo en la I.E.',
                        'Capacitación en tutoría (si aplica)'
                    ],
                    fields: `
                        <h6>Información de Tutoría</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_tutor" required>
                                <option value="">Seleccione el rol</option>
                                <option value="tutor">Tutor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Grado y Sección asignada</label>
                            <select class="form-input" required>
                                <option value="">Seleccione el grado</option>
                                <option value="1a">1° A</option>
                                <option value="1b">1° B</option>
                                <option value="2a">2° A</option>
                                <option value="2b">2° B</option>
                                <option value="3a">3° A</option>
                                <option value="3b">3° B</option>
                                <option value="4a">4° A</option>
                                <option value="4b">4° B</option>
                                <option value="5a">5° A</option>
                                <option value="5b">5° B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Número aproximado de estudiantes</label>
                            <input type="number" class="form-input" placeholder="Ej: 25" min="1" max="40" required>
                        </div>
                    `
                },
                'auxiliar': {
                    title: 'Requisitos para Cuenta de Auxiliar',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Contrato o constancia como auxiliar de educación',
                        'Certificado de antecedentes penales',
                        'Certificado de antecedentes policiales'
                    ],
                    fields: `
                        <h6>Información de Trabajo</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_auxiliar" required>
                                <option value="">Seleccione el rol</option>
                                <option value="auxiliar">Auxiliar</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nivel asignado</label>
                            <select class="form-input" required>
                                <option value="">Seleccione el nivel</option>
                                <option value="primaria">Primaria</option>
                                <option value="secundaria">Secundaria</option>
                                <option value="ambos">Ambos niveles</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Turno de trabajo</label>
                            <select class="form-input" required>
                                <option value="">Seleccione el turno</option>
                                <option value="mañana">Mañana</option>
                                <option value="tarde">Tarde</option>
                                <option value="completo">Jornada completa</option>
                            </select>
                        </div>
                    `
                },
                'toe': {
                    title: 'Requisitos para Cuenta de Coordinador TOE',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Resolución de designación como Coordinador TOE',
                        'Título profesional en Psicología, Trabajo Social o afines',
                        'Certificación en programas TOE (si aplica)'
                    ],
                    fields: `
                        <h6>Información Profesional TOE</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_toe" required>
                                <option value="">Seleccione el rol</option>
                                <option value="toe">TOE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Profesión</label>
                            <select class="form-input" required>
                                <option value="">Seleccione su profesión</option>
                                <option value="psicologo">Psicólogo(a)</option>
                                <option value="trabajador-social">Trabajador(a) Social</option>
                                <option value="docente-especializado">Docente Especializado</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Años de experiencia en TOE</label>
                            <input type="number" class="form-input" placeholder="Ej: 3" min="0" required>
                        </div>
                    `
                },
                'direccion': {
                    title: 'Requisitos para Cuenta de Personal Directivo',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Resolución de nombramiento en cargo directivo',
                        'Título profesional en Educación',
                        'Estudios de especialización en gestión (si aplica)'
                    ],
                    fields: `
                        <h6>Información Directiva</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_direccion" required>
                                <option value="">Seleccione el rol</option>
                                <option value="direccion">Dirección</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Años en cargo directivo</label>
                            <input type="number" class="form-input" placeholder="Ej: 2" min="0" required>
                        </div>
                    `
                },
                'padre': {
                    title: 'Requisitos para Cuenta de Padre/Madre de Familia',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Ficha de matrícula del estudiante',
                        'Constancia de apoderado (si no es padre/madre biológico)',
                        'Número de celular activo para notificaciones'
                    ],
                    fields: `
                        <h6>Información del Estudiante</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_padre" required>
                                <option value="">Seleccione el rol</option>
                                <option value="padre">Padre/Madre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nombre completo del estudiante</label>
                            <input type="text" class="form-input" placeholder="Nombres y apellidos del hijo(a)" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Grado y sección del estudiante</label>
                            <select class="form-input" required>
                                <option value="">Seleccione grado y sección</option>
                                <option value="1a">1° A</option>
                                <option value="1b">1° B</option>
                                <option value="2a">2° A</option>
                                <option value="2b">2° B</option>
                                <option value="3a">3° A</option>
                                <option value="3b">3° B</option>
                                <option value="4a">4° A</option>
                                <option value="4b">4° B</option>
                                <option value="5a">5° A</option>
                                <option value="5b">5° B</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Parentesco</label>
                            <select class="form-input" required>
                                <option value="">Seleccione parentesco</option>
                                <option value="padre">Padre</option>
                                <option value="madre">Madre</option>
                                <option value="abuelo">Abuelo(a)</option>
                                <option value="tio">Tío(a)</option>
                                <option value="tutor-legal">Tutor Legal</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    `
                },
                'admin': {
                    title: 'Requisitos para Cuenta de Administrador del Sistema',
                    docs: [
                        'Copia de DNI (ambos lados)',
                        'Resolución o carta de autorización de la Dirección',
                        'Certificación en administración de sistemas (si aplica)',
                        'Compromiso de confidencialidad firmado'
                    ],
                    fields: `
                        <h6>Información del Administrador</h6>
                        <div class="form-group">
                            <label class="form-label">Rol solicitado</label>
                            <select class="form-input" id="rol_admin" required>
                                <option value="">Seleccione el rol</option>
                                <option value="admin">Administrador del Sistema</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Justificación para acceso administrativo</label>
                            <textarea class="form-input" rows="3" placeholder="Explique por qué necesita acceso administrativo al sistema" required></textarea>
                        </div>
                        <div class="alert alert-warning" style="font-size: 12px; margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>IMPORTANTE:</strong> Las cuentas de administrador requieren aprobación especial de la Dirección y pueden tardar hasta 72 horas en procesarse.
                        </div>
                    `
                }
            };
            
            const roleReq = requirements[selectedUserRole];
            roleRequirements.innerHTML = `
                <h6>${roleReq.title}</h6>
                <ul>
                    ${roleReq.docs.map(doc => `<li>${doc}</li>`).join('')}
                </ul>
            `;
            
            specificFields.innerHTML = roleReq.fields;
            
            requestForm.classList.add('visible');
            
            // Scroll mejorado con delay para que la animación termine
            setTimeout(() => {
                requestForm.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',
                    inline: 'nearest'
                });
                
                // También hacer scroll del contenedor padre si es necesario
                const loginCard = document.querySelector('.login-card');
                if (loginCard) {
                    loginCard.scrollTop = loginCard.scrollHeight - loginCard.clientHeight;
                }
            }, 100);
        }

        // Función para cancelar solicitud
        function cancelRequest() {
            const requestForm = document.getElementById('requestForm');
            requestForm.classList.remove('visible');
        }

        // Función para enviar solicitud
        function submitRequest() {
            const roleNames = {
                'docente': 'Docente',
                'tutor': 'Tutor',
                'auxiliar': 'Auxiliar',
                'toe': 'Coordinador TOE',
                'direccion': 'Personal Directivo',
                'padre': 'Padre/Madre de Familia',
                'admin': 'Administrador del Sistema'
            };
            
            alert(`Solicitud enviada exitosamente!\n\n` +
                  `Tipo de cuenta: ${roleNames[selectedUserRole]}\n\n` +
                  `Su solicitud será revisada por el administrador del sistema.\n` +
                  `Recibirá una respuesta en las próximas 24-48 horas al correo proporcionado.\n\n` +
                  `Nota: Asegúrese de tener todos los documentos requeridos listos para el proceso de verificación.`);
            
            // Volver al inicio
            backToRoleSelection();
        }

        // Función para mostrar/ocultar contraseña
        // Función para mostrar/ocultar contraseña
        function togglePasswordVisibility(fieldId = 'password', iconId = 'password-icon') {
            const passwordField = document.getElementById(fieldId);
            const passwordIcon = document.getElementById(iconId);
            
            if (!passwordField || !passwordIcon) return;
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                passwordIcon.classList.remove('fa-eye');
                passwordIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                passwordIcon.classList.remove('fa-eye-slash');
                passwordIcon.classList.add('fa-eye');
            }
        }
        
        // Función para validar requisitos de contraseña en tiempo real
        function validarPasswordRequisitos() {
            const password = document.getElementById('nueva_password')?.value || '';
            const confirmPassword = document.getElementById('confirmar_password')?.value || '';
            
            const reqLength = document.getElementById('req-length');
            const reqMatch = document.getElementById('req-match');
            const strengthContainer = document.getElementById('password-strength-container');
            const strengthBar = document.getElementById('password-strength-bar');
            const strengthText = document.getElementById('password-strength-text');
            
            if (!reqLength || !reqMatch) return;
            
            // Validar longitud mínima
            if (password.length >= 6) {
                reqLength.style.color = '#2e7d32';
                reqLength.innerHTML = '<i class="fas fa-check-circle" style="font-size: 12px; margin-right: 5px;"></i> Mínimo 6 caracteres';
            } else {
                reqLength.style.color = '#1565c0';
                reqLength.innerHTML = '<i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i> Mínimo 6 caracteres';
            }
            
            // Validar que coincidan (solo si ambos campos tienen texto)
            if (password && confirmPassword) {
                if (password === confirmPassword) {
                    reqMatch.style.color = '#2e7d32';
                    reqMatch.innerHTML = '<i class="fas fa-check-circle" style="font-size: 12px; margin-right: 5px;"></i> Las contraseñas coinciden';
                } else {
                    reqMatch.style.color = '#c62828';
                    reqMatch.innerHTML = '<i class="fas fa-times-circle" style="font-size: 12px; margin-right: 5px;"></i> Las contraseñas NO coinciden';
                }
            } else {
                reqMatch.style.color = '#1565c0';
                reqMatch.innerHTML = '<i class="fas fa-circle" style="font-size: 8px; margin-right: 5px;"></i> Las contraseñas deben coincidir';
            }
            
            // Calcular nivel de seguridad
            if (password.length > 0) {
                strengthContainer.style.display = 'block';
                let strength = 0;
                let strengthLabel = '';
                let strengthColor = '';
                
                // Criterios de seguridad
                if (password.length >= 6) strength += 25;
                if (password.length >= 8) strength += 15;
                if (password.length >= 10) strength += 10;
                if (/[a-z]/.test(password)) strength += 10; // Minúsculas
                if (/[A-Z]/.test(password)) strength += 15; // Mayúsculas
                if (/[0-9]/.test(password)) strength += 15; // Números
                if (/[^a-zA-Z0-9]/.test(password)) strength += 10; // Símbolos
                
                // Determinar nivel
                if (strength < 40) {
                    strengthLabel = 'Baja';
                    strengthColor = '#f44336';
                } else if (strength < 70) {
                    strengthLabel = 'Media';
                    strengthColor = '#ff9800';
                } else {
                    strengthLabel = 'Alta';
                    strengthColor = '#4caf50';
                }
                
                strengthBar.style.width = strength + '%';
                strengthBar.style.background = strengthColor;
                strengthText.textContent = strengthLabel;
                strengthText.style.color = strengthColor;
            } else {
                strengthContainer.style.display = 'none';
            }
        }

        // ==================== FUNCIONES DE ADMINISTRACIÓN ====================
        
        // Gestión de Usuarios
        function showUserManagement() {
            alert('🔧 FUNCIÓN EN DESARROLLO\n\n' +
                  '• Crear nuevos usuarios\n' +
                  '• Asignar roles y permisos\n' +
                  '• Configurar aulas y especialidades\n' +
                  '• Generar credenciales automáticas\n\n' +
                  'Esta función estará disponible en la versión completa con backend.');
        }

        function showUserList() {
            const userCount = Object.keys(users).length;
            alert('👥 USUARIOS REGISTRADOS EN EL SISTEMA\n\n' +
                  `Total de usuarios: ${userCount}\n\n` +
                  '📋 USUARIOS ACTIVOS:\n' +
                  '• Docentes: 45 usuarios\n' +
                  '• Tutores: 12 usuarios\n' +
                  '• Auxiliares: 8 usuarios\n' +
                  '• Personal TOE: 3 usuarios\n' +
                  '• Dirección: 2 usuarios\n' +
                  '• Padres de Familia: 86 usuarios\n' +
                  '• Administradores: 1 usuario\n\n' +
                  '🔧 En la versión completa podrá:\n' +
                  '• Editar información de usuarios\n' +
                  '• Suspender/activar cuentas\n' +
                  '• Resetear contraseñas\n' +
                  '• Exportar listas de usuarios');
        }

        // Gestión de Solicitudes
        function showPendingRequests() {
            alert('📋 SOLICITUDES PENDIENTES DE APROBACIÓN\n\n' +
                  '🔍 5 solicitudes esperando revisión:\n\n' +
                  '📝 NUEVAS SOLICITUDES:\n' +
                  '• María González (Docente) - Matemática\n' +
                  '• Carlos Ruiz (Padre) - Estudiante: Ana Ruiz 2°A\n' +
                  '• Luis Torres (Tutor) - Grado 3°B\n' +
                  '• Patricia Morales (TOE) - Psicóloga\n' +
                  '• Roberto Silva (Auxiliar) - Nivel Secundaria\n\n' +
                  '⚡ ACCIONES DISPONIBLES:\n' +
                  '• Revisar documentos adjuntos\n' +
                  '• Aprobar solicitud\n' +
                  '• Rechazar con observaciones\n' +
                  '• Solicitar documentos adicionales\n\n' +
                  '🔧 Función completa disponible con backend.');
        }

        // Configuración del Sistema
        function showClassroomConfig() {
            alert('🏫 GESTIÓN DE AULAS Y SECCIONES\n\n' +
                  '📚 CONFIGURACIÓN ACTUAL:\n' +
                  '• 1° Grado: Sección A (28 alumnos), Sección B (26 alumnos)\n' +
                  '• 2° Grado: Sección A (30 alumnos), Sección B (29 alumnos)\n' +
                  '• 3° Grado: Sección A (27 alumnos), Sección B (31 alumnos)\n' +
                  '• 4° Grado: Sección A (29 alumnos), Sección B (28 alumnos)\n' +
                  '• 5° Grado: Sección A (32 alumnos), Sección B (30 alumnos)\n\n' +
                  '🔧 FUNCIONES ADMINISTRATIVAS:\n' +
                  '• Crear nuevas secciones\n' +
                  '• Reasignar estudiantes\n' +
                  '• Configurar tutores por aula\n' +
                  '• Generar códigos de aula\n' +
                  '• Exportar listas por sección');
        }

        function showStudentConfig() {
            alert('👨‍🎓 GESTIÓN DE ESTUDIANTES\n\n' +
                  '📊 RESUMEN ESTUDIANTIL:\n' +
                  '• Total estudiantes: 290\n' +
                  '• Estudiantes activos: 287\n' +
                  '• Estudiantes con seguimiento TOE: 23\n' +
                  '• Casos críticos: 5\n\n' +
                  '📋 FUNCIONES DISPONIBLES:\n' +
                  '• Importar lista de matrícula\n' +
                  '• Asignar estudiantes a padres\n' +
                  '• Generar códigos estudiantiles\n' +
                  '• Configurar alertas automáticas\n' +
                  '• Exportar base de datos\n\n' +
                  '🔧 Panel completo en desarrollo.');
        }

        function showIncidentConfig() {
            alert('⚠️ CONFIGURACIÓN DE TIPOS DE INCIDENCIAS\n\n' +
                  '📋 TIPOS ACTUALES CONFIGURADOS:\n' +
                  '• 🟢 Leves: Tardanza, olvido de materiales, uniforme\n' +
                  '• 🟡 Moderadas: Falta de respeto, interrupciones\n' +
                  '• 🟠 Graves: Agresión verbal, daño a propiedad\n' +
                  '• 🔴 Muy Graves: Violencia física, conductas peligrosas\n\n' +
                  '⚙️ CONFIGURACIONES DISPONIBLES:\n' +
                  '• Crear nuevos tipos de incidencia\n' +
                  '• Modificar niveles de gravedad\n' +
                  '• Configurar escalamiento automático\n' +
                  '• Definir acciones por tipo\n' +
                  '• Personalizar formularios\n\n' +
                  '🔧 Personalización completa próximamente.');
        }

        function showSystemConfig() {
            alert('🔧 CONFIGURACIÓN GENERAL DEL SISTEMA\n\n' +
                  '⚙️ CONFIGURACIONES DISPONIBLES:\n\n' +
                  '🏫 INSTITUCIÓN:\n' +
                  '• Nombre: I.E. 80002 Antonio Torres Araujo\n' +
                  '• Código Modular: 0224477\n' +
                  '• Dirección: Trujillo, La Libertad\n\n' +
                  '📧 NOTIFICACIONES:\n' +
                  '• Email automático a padres: ✅ Activado\n' +
                  '• SMS de emergencia: ✅ Activado\n' +
                  '• Reportes semanales: ✅ Activado\n\n' +
                  '🔒 SEGURIDAD:\n' +
                  '• Autenticación de 2 factores: En desarrollo\n' +
                  '• Backup automático: ✅ Diario\n' +
                  '• Logs de auditoría: ✅ Activo\n\n' +
                  '⏰ HORARIOS:\n' +
                  '• Año escolar: 2025\n' +
                  '• Trimestre actual: III\n' +
                  '• Horario de atención: 7:00 AM - 6:00 PM');
        }

        // Gestión de Incidencias Administrativas
        function showAllIncidents() {
            alert('🔍 GESTIÓN COMPLETA DE INCIDENCIAS\n\n' +
                  '📊 RESUMEN GENERAL:\n' +
                  '• Total incidencias: 135\n' +
                  '• Críticas pendientes: 23\n' +
                  '• Moderadas en seguimiento: 45\n' +
                  '• Leves resueltas: 67\n\n' +
                  '👑 PODERES DE ADMINISTRADOR:\n' +
                  '• Ver TODAS las incidencias del sistema\n' +
                  '• Modificar cualquier reporte\n' +
                  '• Eliminar incidencias (con justificación)\n' +
                  '• Reasignar casos entre personal\n' +
                  '• Generar reportes personalizados\n' +
                  '• Exportar para UGEL/DREC\n\n' +
                  '⚠️ CASOS CRÍTICOS ACTUALES:\n' +
                  '• Violencia entre estudiantes (3 casos)\n' +
                  '• Problemas familiares graves (2 casos)\n' +
                  '• Necesitan intervención externa (1 caso)\n\n' +
                  '🔧 Panel completo en desarrollo.');
        }

        // Reportes y Exportación
        function exportUsers() {
            alert('📤 EXPORTAR USUARIOS DEL SISTEMA\n\n' +
                  '📋 FORMATOS DISPONIBLES:\n' +
                  '• Excel (.xlsx) - Recomendado\n' +
                  '• PDF - Para impresión\n' +
                  '• CSV - Para importar a otros sistemas\n\n' +
                  '📊 INFORMACIÓN INCLUIDA:\n' +
                  '• Datos personales (DNI, nombres)\n' +
                  '• Rol y permisos\n' +
                  '• Fecha de registro\n' +
                  '• Estado de cuenta\n' +
                  '• Última actividad\n\n' +
                  '⚠️ Nota: Se respeta la privacidad de datos personales según ley.\n\n' +
                  '🔧 Función de exportación en desarrollo.');
        }

        function exportIncidents() {
            alert('📤 EXPORTAR INCIDENCIAS\n\n' +
                  '📋 OPCIONES DE EXPORTACIÓN:\n' +
                  '• Todas las incidencias\n' +
                  '• Por rango de fechas\n' +
                  '• Por nivel de gravedad\n' +
                  '• Por grado/sección\n' +
                  '• Por tipo de incidencia\n\n' +
                  '📊 INFORMACIÓN EXPORTADA:\n' +
                  '• Datos del estudiante\n' +
                  '• Descripción de la incidencia\n' +
                  '• Nivel de gravedad\n' +
                  '• Personal que reportó\n' +
                  '• Acciones tomadas\n' +
                  '• Seguimiento realizado\n\n' +
                  '🔒 Datos anonimizados para proteger privacidad.\n\n' +
                  '🔧 Función completa próximamente.');
        }

        function exportStats() {
            alert('📊 EXPORTAR ESTADÍSTICAS\n\n' +
                  '📈 REPORTES DISPONIBLES:\n' +
                  '• Estadísticas generales por mes\n' +
                  '• Comparativo anual\n' +
                  '• Análisis por grado/sección\n' +
                  '• Indicadores de mejora\n' +
                  '• Tendencias disciplinarias\n\n' +
                  '📋 MÉTRICAS INCLUIDAS:\n' +
                  '• Número de incidencias por tipo\n' +
                  '• Efectividad de intervenciones\n' +
                  '• Casos recurrentes\n' +
                  '• Mejoras conductuales\n' +
                  '• Participación de padres\n\n' +
                  '🎯 Útil para presentar a UGEL y Dirección.\n\n' +
                  '🔧 Dashboard de estadísticas en desarrollo.');
        }

        function generateReport() {
            alert('📋 GENERAR REPORTE PARA UGEL\n\n' +
                  '🏛️ REPORTE OFICIAL UGEL/DREC:\n' +
                  '• Cumple formato oficial requerido\n' +
                  '• Incluye sellos y firmas digitales\n' +
                  '• Datos estadísticos validados\n' +
                  '• Anexos de casos relevantes\n\n' +
                  '📊 CONTENIDO DEL REPORTE:\n' +
                  '• Resumen ejecutivo\n' +
                  '• Estadísticas mensuales/trimestrales\n' +
                  '• Casos críticos y su manejo\n' +
                  '• Programas de mejora implementados\n' +
                  '• Recomendaciones y necesidades\n\n' +
                  '⏱️ FRECUENCIA:\n' +
                  '• Mensual (obligatorio)\n' +
                  '• Trimestral (detallado)\n' +
                  '• Anual (memoria institucional)\n\n' +
                  '🔧 Generador automático en desarrollo.');
        }

        // ==================== SISTEMA DE MÉRITOS Y DEMÉRITOS ====================
        
        // Base de datos simulada para historial de incidencias por estudiante
        const studentIncidentHistory = {
            // Simulando algunos estudiantes con historial
            'ana_garcia_torres': [
                { date: '2025-09-20', type: 'LEVE-C', severity: 'leve', description: 'Llegó tarde a clase' },
                { date: '2025-09-18', type: 'LEVE-T', severity: 'leve', description: 'Uniforme incompleto' }
            ],
            'luis_morales_cruz': [
                { date: '2025-09-19', type: 'LEVE-C', severity: 'leve', description: 'Tardanza reiterada' },
                { date: '2025-09-17', type: 'LEVE-C', severity: 'leve', description: 'Llegó tarde nuevamente' },
                { date: '2025-09-16', type: 'LEVE-C', severity: 'leve', description: 'Tercera tardanza esta semana' }
            ]
        };

        // Toggle entre secciones de méritos y deméritos
        function toggleMeritosDemeritosSections() {
            const tipoRegistro = document.getElementById('tipoRegistro').value;
            const meritosSection = document.getElementById('meritosSection');
            const demeritosSection = document.getElementById('demeritosSection');
            const severidadInfo = document.getElementById('severidadInfo');
            const escalamientoInfo = document.getElementById('escalamientoInfo');
            
            // Reset de selecciones previas
            document.getElementById('meritoSelect').selectedIndex = 0;
            document.getElementById('demeritoSelect').selectedIndex = 0;
            
            if (tipoRegistro === 'merito') {
                meritosSection.style.display = 'block';
                demeritosSection.style.display = 'none';
                severidadInfo.style.display = 'none';
                escalamientoInfo.style.display = 'none';
                document.getElementById('severidadDisplay').innerHTML = '✅ Los méritos no tienen severidad - son reconocimientos positivos';
                document.getElementById('severidadDisplay').style.background = '#d4edda';
                document.getElementById('severidadDisplay').style.color = '#155724';
            } else if (tipoRegistro === 'demerito') {
                meritosSection.style.display = 'none';
                demeritosSection.style.display = 'block';
                severidadInfo.style.display = 'block';
                escalamientoInfo.style.display = 'block';
                document.getElementById('severidadDisplay').innerHTML = 'Se calculará automáticamente según el tipo de falta y historial';
                document.getElementById('severidadDisplay').style.background = '#f8f9fa';
                document.getElementById('severidadDisplay').style.color = '#666';
            } else {
                meritosSection.style.display = 'none';
                demeritosSection.style.display = 'none';
                severidadInfo.style.display = 'none';
                escalamientoInfo.style.display = 'none';
            }
        }

        // Actualizar información de severidad automática
        function updateSeverityInfo() {
            const demeritoSelect = document.getElementById('demeritoSelect');
            const selectedOption = demeritoSelect.options[demeritoSelect.selectedIndex];
            const severidadDisplay = document.getElementById('severidadDisplay');
            const studentName = document.getElementById('studentSearch').value.toLowerCase().replace(/\s+/g, '_');
            
            if (!selectedOption || !selectedOption.value) {
                severidadDisplay.innerHTML = 'Se calculará automáticamente según el tipo de falta y historial';
                severidadDisplay.style.background = '#f8f9fa';
                severidadDisplay.style.color = '#666';
                return;
            }

            const baseSeverity = selectedOption.getAttribute('data-severity');
            const faltaCode = selectedOption.value;
            
            // Simular verificación de historial del estudiante
            const studentHistory = studentIncidentHistory[studentName] || [];
            const currentWeekIncidents = countIncidentsInCurrentWeek(studentHistory);
            const currentBimesterIncidents = countIncidentsInCurrentBimester(studentHistory);
            
            let finalSeverity = baseSeverity;
            let escalationInfo = '';
            let alertStyle = '';

            if (baseSeverity === 'leve') {
                // Aplicar reglas de escalamiento para faltas leves
                if (currentWeekIncidents >= 2) {
                    // Ya tiene 2+ faltas esta semana, la siguiente sería la 3ra (Alerta)
                    finalSeverity = 'alerta';
                    escalationInfo = '⚠️ ESCALAMIENTO: 3+ faltas leves en una semana → ALERTA A TUTOR/PADRE';
                    alertStyle = 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;';
                } else if (currentBimesterIncidents >= 4) {
                    // Ya tiene 4+ faltas este bimestre, la siguiente sería la 5ta (TOE)
                    finalSeverity = 'toe';
                    escalationInfo = '🚨 ESCALAMIENTO: 5+ faltas leves en bimestre → CITACIÓN FORMAL EN TOE';
                    alertStyle = 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;';
                } else {
                    escalationInfo = `📊 Historial: ${currentWeekIncidents} falta(s) esta semana, ${currentBimesterIncidents} este bimestre`;
                    alertStyle = 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;';
                }
            } else if (baseSeverity === 'grave' || baseSeverity === 'muy_grave') {
                escalationInfo = '🔴 DERIVACIÓN INMEDIATA A TOE/DIRECCIÓN (sin esperar conteos)';
                alertStyle = 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; font-weight: bold;';
            }

            // Mostrar información de severidad final
            let severityColor = getSeverityColor(finalSeverity);
            let severityLabel = getSeverityLabel(finalSeverity);
            
            severidadDisplay.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="background: ${severityColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                        ${severityLabel.toUpperCase()}
                    </span>
                    <span>${escalationInfo}</span>
                </div>
            `;
            severidadDisplay.style.cssText = alertStyle + ' padding: 12px; border-radius: 6px;';
        }

        // Funciones auxiliares para conteo de incidencias
        function countIncidentsInCurrentWeek(history) {
            const now = new Date();
            const currentWeekStart = new Date(now);
            currentWeekStart.setDate(now.getDate() - now.getDay()); // Inicio de semana (domingo)
            
            return history.filter(incident => {
                const incidentDate = new Date(incident.date);
                return incidentDate >= currentWeekStart && incident.severity === 'leve';
            }).length;
        }

        function countIncidentsInCurrentBimester(history) {
            const now = new Date();
            const currentBimesterStart = new Date(now.getFullYear(), Math.floor(now.getMonth() / 2) * 2, 1);
            
            return history.filter(incident => {
                const incidentDate = new Date(incident.date);
                return incidentDate >= currentBimesterStart && incident.severity === 'leve';
            }).length;
        }

        function getSeverityColor(severity) {
            const colors = {
                'leve': '#28a745',
                'alerta': '#ffc107',
                'toe': '#fd7e14',
                'grave': '#dc3545',
                'muy_grave': '#6f42c1'
            };
            return colors[severity] || '#6c757d';
        }

        function getSeverityLabel(severity) {
            const labels = {
                'leve': 'Leve',
                'alerta': 'Alerta - Tutor',
                'toe': 'TOE - Citación',
                'grave': 'Grave',
                'muy_grave': 'Muy Grave'
            };
            return labels[severity] || 'No definida';
        }

        // Manejar selección de "Otras que la autoridad indique"
        function handleOtrasSelection() {
            const demeritoSelect = document.getElementById('demeritoSelect');
            const selectedOption = demeritoSelect.options[demeritoSelect.selectedIndex];
            const descripcionTextarea = document.getElementById('descripcionDetallada');
            
            // Si se seleccionó "Q. Otras que la autoridad indique", enfocar en descripción
            if (selectedOption && selectedOption.value === 'LEVE-Q') {
                setTimeout(() => {
                    descripcionTextarea.focus();
                    descripcionTextarea.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    
                    // Cambiar el placeholder para dar más contexto
                    descripcionTextarea.placeholder = '📝 Describa detalladamente la otra falta cometida por el estudiante (especifique qué norma o acuerdo incumplió)...';
                    
                    // Agregar un efecto visual temporal
                    descripcionTextarea.style.border = '2px solid var(--color-ata-dorado)';
                    descripcionTextarea.style.boxShadow = '0 0 10px rgba(255, 193, 7, 0.3)';
                    
                    setTimeout(() => {
                        descripcionTextarea.style.border = '2px solid #e9ecef';
                        descripcionTextarea.style.boxShadow = 'none';
                    }, 2000);
                }, 100);
            } else {
                // Restablecer el placeholder original
                descripcionTextarea.placeholder = 'Describa la situación detalladamente...';
            }
        }

        // Procesar envío del formulario de incidencia (REAL - Supabase)
        async function submitIncident(event) {
            event.preventDefault();
            
            // Verificar que hay estudiante seleccionado
            if (!estudianteSeleccionado) {
                alert('❌ Por favor seleccione un estudiante de la lista');
                document.getElementById('studentSearch').focus();
                return;
            }
            
            const tipoRegistro = document.getElementById('tipoRegistro').value;
            const descripcion = document.getElementById('descripcionDetallada').value;
            const testigos = document.getElementById('testigos').value;
            
            if (!tipoRegistro) {
                alert('❌ Por favor seleccione el tipo de registro (Mérito o Demérito)');
                return;
            }
            
            // Preparar datos de la incidencia
            let incidenciaData = {
                estudianteId: estudianteSeleccionado.id,
                tipo: tipoRegistro,
                descripcion: descripcion + (testigos ? `\n\nTestigos: ${testigos}` : ''),
                catalogoMeritoId: null,
                catalogoDemeritoId: null,
                severidad: null,
                codigo: null
            };

            if (tipoRegistro === 'merito') {
                const meritoSelect = document.getElementById('meritoSelect');
                const meritoValue = meritoSelect.value;
                if (!meritoValue) {
                    alert('Por favor seleccione un mérito');
                    return;
                }
                // Buscar el ID del mérito en el catálogo
                const meritos = await getCatalogoMeritos();
                const merito = meritos.find(m => m.codigo === meritoValue.split('-')[1] || m.codigo === meritoValue);
                if (merito) {
                    incidenciaData.catalogoMeritoId = merito.id;
                    incidenciaData.codigo = merito.codigo;
                }
                
            } else if (tipoRegistro === 'demerito') {
                const demeritoSelect = document.getElementById('demeritoSelect');
                const demeritoValue = demeritoSelect.value;
                if (!demeritoValue) {
                    alert('Por favor seleccione una falta');
                    return;
                }
                
                const selectedOption = demeritoSelect.options[demeritoSelect.selectedIndex];
                const severidad = selectedOption.getAttribute('data-severity');
                
                // Buscar el ID del demérito en el catálogo
                const demeritos = await getCatalogoDemeritros();
                const demerito = demeritos.find(d => d.codigo === demeritoValue.split('-')[1] || d.codigo === demeritoValue);
                if (demerito) {
                    incidenciaData.catalogoDemeritoId = demerito.id;
                    incidenciaData.codigo = demerito.codigo;
                    incidenciaData.severidad = demerito.severidad || severidad;
                } else {
                    incidenciaData.severidad = severidad;
                }
            }
            
            // Mostrar loading
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
            submitBtn.disabled = true;
            
            // Registrar en Supabase
            const resultado = await registrarIncidencia(incidenciaData);
            
            // Restaurar botón
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            
            if (resultado.success) {
                const tipoTexto = tipoRegistro === 'merito' ? '🏆 MÉRITO' : '⚠️ DEMÉRITO';
                alert(`✅ ${tipoTexto} REGISTRADO EXITOSAMENTE\n\n` +
                      `👨‍🎓 Estudiante: ${estudianteSeleccionado.nombre_completo}\n` +
                      `🏫 Aula: ${estudianteSeleccionado.grado}°${estudianteSeleccionado.seccion}\n\n` +
                      `📝 La incidencia ha sido guardada en el sistema.\n` +
                      `📧 El padre de familia será notificado.`);
                
                // Reset del formulario
                document.getElementById('incidenciaForm').reset();
                clearStudentSelection();
                toggleMeritosDemeritosSections();
                
                // Actualizar estadísticas y historial
                await actualizarDashboardStats();
                await renderizarHistorial();
                
                // Volver al dashboard
                setTimeout(() => {
                    showSection('dashboard');
                }, 1500);
            } else {
                alert(`❌ Error al registrar incidencia:\n${resultado.error}\n\nPor favor intente nuevamente.`);
            }
        }

        // Funciones para el buscador de estudiantes
        let searchTimeout = null;
        
        async function handleStudentSearch(query) {
            const resultsContainer = document.getElementById('studentSearchResults');
            
            // Limpiar timeout anterior
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (!query || query.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Mostrar loading
            resultsContainer.innerHTML = '<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
            resultsContainer.style.display = 'block';
            
            // Debounce de 300ms
            searchTimeout = setTimeout(async () => {
                const estudiantes = await buscarEstudiantes(query);
                
                if (estudiantes.length === 0) {
                    resultsContainer.innerHTML = '<div class="autocomplete-empty">No se encontraron estudiantes</div>';
                } else {
                    resultsContainer.innerHTML = estudiantes.map(est => `
                        <div class="autocomplete-item" onclick="selectStudent(${JSON.stringify(est).replace(/"/g, '&quot;')})">
                            <div class="student-name">${est.nombre_completo}</div>
                            <div class="student-info">
                                ${est.grado}° ${est.seccion} - ${est.nivel.charAt(0).toUpperCase() + est.nivel.slice(1)}
                                ${est.dni ? ` | DNI: ${est.dni}` : ''}
                            </div>
                        </div>
                    `).join('');
                }
            }, 300);
        }
        
        function selectStudent(estudiante) {
            estudianteSeleccionado = estudiante;
            
            // Actualizar UI
            document.getElementById('studentSearch').value = estudiante.nombre_completo;
            document.getElementById('studentId').value = estudiante.id;
            document.getElementById('studentSearchResults').style.display = 'none';
            
            // Mostrar info del estudiante seleccionado
            document.getElementById('studentSelectedInfo').style.display = 'block';
            document.getElementById('studentSelectedName').textContent = 
                `${estudiante.nombre_completo} - ${estudiante.grado}°${estudiante.seccion}`;
            
            // Auto-seleccionar el aula
            const aulaValue = `${estudiante.grado}S${estudiante.seccion}`;
            const aulaSelect = document.getElementById('aulaSelect');
            for (let option of aulaSelect.options) {
                if (option.value === aulaValue) {
                    aulaSelect.value = aulaValue;
                    break;
                }
            }
        }
        
        function clearStudentSelection() {
            estudianteSeleccionado = null;
            document.getElementById('studentSearch').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentSelectedInfo').style.display = 'none';
            document.getElementById('aulaSelect').value = '';
        }

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.form-group[style*="position: relative"]');
            const resultsContainer = document.getElementById('studentSearchResults');
            if (searchContainer && resultsContainer && !searchContainer.contains(e.target)) {
                resultsContainer.style.display = 'none';
            }
        });

        // ==================== FUNCIONES ADMINISTRATIVAS ADICIONALES ====================
        
        // Sistema de Backup
        function performBackup() {
            alert('💾 BACKUP DEL SISTEMA\n\n' +
                  '🔄 Iniciando backup completo...\n\n' +
                  '📋 INCLUYE:\n' +
                  '• Base de datos de usuarios\n' +
                  '• Historial completo de incidencias\n' +
                  '• Configuración del sistema\n' +
                  '• Archivos adjuntos y documentos\n' +
                  '• Logs de auditoría\n\n' +
                  '💾 Ubicación: /backups/backup_20250924_' + new Date().getHours().toString().padStart(2, '0') + 
                  new Date().getMinutes().toString().padStart(2, '0') + '.sql\n\n' +
                  '⏱️ Tiempo estimado: 3-5 minutos\n' +
                  '✅ El sistema seguirá funcionando normalmente\n\n' +
                  '🔧 Función completa disponible con backend.');
        }

        // Reportes del Sistema
        function generateSystemReport() {
            alert('📊 REPORTE GENERAL DEL SISTEMA\n\n' +
                  '📈 ESTADÍSTICAS DE USO (Septiembre 2025):\n' +
                  '• Sesiones de usuario: 1,847\n' +
                  '• Incidencias registradas: 89\n' +
                  '• Usuarios activos: 156\n' +
                  '• Promedio diario: 12 incidencias\n\n' +
                  '🏆 TOP USUARIOS MÁS ACTIVOS:\n' +
                  '• Prof. María González (Docente) - 23 registros\n' +
                  '• Ana Torres (Auxiliar) - 18 registros\n' +
                  '• Carlos Ruiz (Tutor) - 15 registros\n\n' +
                  '🎯 INDICADORES CLAVE:\n' +
                  '• Tiempo respuesta promedio: 2.3 horas\n' +
                  '• Satisfacción usuarios: 94%\n' +
                  '• Casos resueltos: 87%\n\n' +
                  '🔧 Reporte completo en PDF disponible con backend.');
        }

        // Configuración Avanzada de Estudiantes
        function showStudentConfig() {
            alert('👨‍🎓 GESTIÓN AVANZADA DE ESTUDIANTES\n\n' +
                  '📊 CONFIGURACIÓN ACTUAL:\n' +
                  '• Total estudiantes: 847\n' +
                  '• Promedio por aula: 28.2 estudiantes\n' +
                  '• Edad promedio: 9.3 años\n\n' +
                  '📋 DATOS DISPONIBLES:\n' +
                  '• Información personal completa\n' +
                  '• Historial académico\n' +
                  '• Contactos de emergencia\n' +
                  '• Problemas de salud registrados\n' +
                  '• Evaluaciones TOE\n\n' +
                  '🔧 FUNCIONES ADMINISTRATIVAS:\n' +
                  '• Matricular nuevos estudiantes\n' +
                  '• Transferir entre secciones\n' +
                  '• Actualizar datos personales\n' +
                  '• Generar carnés estudiantiles\n' +
                  '• Exportar listas por grado/sección\n\n' +
                  '📊 REPORTES ESPECIALIZADOS:\n' +
                  '• Lista por edad y género\n' +
                  '• Estudiantes con necesidades especiales\n' +
                  '• Contactos de emergencia\n\n' +
                  '🔧 Panel completo en desarrollo.');
        }

        // 🚨 FUNCIÓN DE DEBUG TEMPORAL - Para probar login
        function debugLogin() {
            console.log('🧪 === DEBUG LOGIN ===');
            console.log('selectedUserRole:', selectedUserRole);
            console.log('users object:', users);
            console.log('loginForm element:', document.getElementById('loginForm'));
            console.log('username value:', document.getElementById('username').value);
            console.log('password value:', document.getElementById('password').value);
            
            // Forzar login con demo_docente
            selectedUserRole = 'docente';
            currentUser = { username: 'demo_docente', ...users['demo_docente'] };
            console.log('currentUser set:', currentUser);
            login();
        }
        
        // Hacer función disponible globalmente
        window.debugLogin = debugLogin;
        
        // Función de prueba simple para verificar que JavaScript funciona
        function testButton() {
            alert('¡JavaScript funciona! El botón responde.');
            console.log('🎯 TEST: El botón funciona correctamente');
        }
        
        // Hacer la función de prueba disponible globalmente
        window.testButton = testButton;
        window.handleLoginClick = handleLoginClick;
        
        console.log('🚀 JavaScript cargado completamente');
    </script>
</body>
</html>
